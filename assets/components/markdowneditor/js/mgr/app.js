Ext.ns("MarkdownEditor"),MarkdownEditor=function(e){e=e||{},MarkdownEditor.superclass.constructor.call(this,e)},Ext.extend(MarkdownEditor,Ext.Component,{window:{},config:{}}),Ext.reg("markdowneditor",MarkdownEditor),markdownEditor=new MarkdownEditor,markdownEditor.Editor=function(e){e=e||{},markdownEditor.Editor.superclass.constructor.call(this,e)},Ext.extend(markdownEditor.Editor,Ext.Component,{window:{},remarkable:"",initComponent:function(){MarkdownEditor.superclass.initComponent.call(this),Ext.onReady(this.render,this)},parseRequest:"",parse:function(e){var t=this.remarkable.render(e);if(t=t.replace(/%5B/g,"["),t=t.replace(/%5D/g,"]"),1==MODx.config["markdowneditor.lp.parse_modx_tags"]){this.parseRequest&&clearTimeout(this.parseRequest);var o=parseInt(MODx.config["markdowneditor.lp.parse_modx_tags_timeout"]||300);this.parseRequest=setTimeout(function(){MODx.Ajax.request({url:markdownEditor.config.connectorUrl,params:{action:"mgr/editor/processcontent",content:t,resource:MODx.request.id},isUpload:!0,listeners:{success:{fn:function(e){Ext.get("preview-md").update(e.data)},scope:this}}})},o)}else Ext.get("preview-md").update(t);return this.taMarkdown.dom.value=this.editor.getValue(),this.textarea.dom.value=t,t},buildUI:function(){this.textarea.setDisplayed("none"),this.textarea.setWidth(0),this.textarea.setHeight(0),Ext.DomHelper.insertBefore(this.textarea,{tag:"textarea",name:"ta_markdown",id:"ta_markdown"}),this.taMarkdown=Ext.get("ta_markdown"),this.taMarkdown.setDisplayed("none"),this.taMarkdown.setWidth(0),this.taMarkdown.setHeight(0);var e=Ext.DomHelper.insertBefore(this.textarea,{tag:"div","class":"markdown-container"});Ext.DomHelper.append(e,{tag:"div",id:"content-md","class":this.textarea.dom.className}),Ext.DomHelper.append(e,{tag:"div",id:"preview-md","class":"markdown-body"}),Ext.DomHelper.append(e,{tag:"div",id:"toolbox",cn:[{tag:"span",id:"preview-button",html:'<i class="icon icon-toggle-off"></i> Preview'},{tag:"span",id:"fullscreen-button",html:'<i class="icon icon-expand"></i>'}]}),Ext.DomHelper.append(e,{tag:"div",id:"status-bar",html:'<input class="hidden" id="inputFile" name="file" type="file" multiple>Attach files by dragging & dropping or <label for="inputFile" class="link">selecting them</label>.'}),Ext.get("inputFile").on("change",function(e,t){this.handleFiles(t.files),t.value=""},this),Ext.DomHelper.append(e,{tag:"span",style:"clear: both"})},registerAce:function(){this.editor=ace.edit(Ext.DomQuery.selectNode("div#content-md")),this.editor.setOptions({maxLines:1/0,minLines:25,enableBasicAutocompletion:!0}),this.editor.renderer.setShowGutter(!0),this.editor.renderer.setScrollMargin(10,10),this.editor.getSession().setValue(this.textarea.getValue()),this.editor.getSession().setMode("ace/mode/markdown"),this.editor.setTheme("ace/theme/"+(MODx.config["markdowneditor.general.theme"]||"monokai"));var e=ace.require("ace/ext/language_tools"),t={getCompletions:function(e,t,o,i,r){return 0===i.length?(r(null,[]),void 0):(MODx.Ajax.request({url:markdownEditor.config.connectorUrl,params:{action:"mgr/resource/getlist",prefix:i},listeners:{success:{fn:function(e){r(null,e.results)},scope:this}}}),void 0)}};e.addCompleter(t),this.editor.container.addEventListener("dragenter",this.catchAndDoNothing,!1),this.editor.container.addEventListener("dragover",this.catchAndDoNothing,!1),this.editor.container.addEventListener("drop",this.drop.bind(this),!1)},catchAndDoNothing:function(e){e.stopPropagation(),e.preventDefault()},drop:function(e){e.stopPropagation(),e.preventDefault(),this.handleFiles(e.dataTransfer.files)},handleFiles:function(e){Ext.each(e,function(e){var t=/^image\//.test(e.type);t?1==MODx.config["markdowneditor.cropper.enable_cropper"]?MODx.load({xtype:"markdowneditor-window-cropper",file:e,md:this}).show():this.uploadFile(e,"image"):this.uploadFile(e,"file")},this)},uploadFile:function(e,t){t||(t="file");var o=Ext.get("status-bar"),i=Ext.DomHelper.insertFirst(o,{tag:"div",id:"upload_progress",html:'<div class="progress"></div><i class="icon icon-spinner icon-spin"></i> Uploading '+t+": "+e.name}),r=new FormData;r.append("file",e),r.append("action","mgr/editor/"+t+"upload"),r.append("name",e.name);var a=new XMLHttpRequest;a.open("POST",markdownEditor.config.connectorUrl),a.setRequestHeader("Powered-By","MODx"),a.setRequestHeader("modAuth",Ext.Ajax.defaultHeaders.modAuth),a.upload.onprogress=function(e){if(e.lengthComputable){var t=e.loaded/e.total*100|0;o.child(".progress").setWidth(t+"%")}},a.onload=function(){if(200===a.status){var e=JSON.parse(a.responseText);if(1==e.success){i.remove();var o="image"==t?"!":"";this.editor.insert(o+"["+e.object.name+"]("+e.object.path+' "'+e.object.name+'")\n')}}}.bind(this),a.send(r)},registerMarked:function(){this.remarkable=new Remarkable({html:!0,highlight:function(e,t){if(t&&hljs.getLanguage(t))try{return hljs.highlight(t,e).value}catch(o){}try{return hljs.highlightAuto(e).value}catch(o){}return""}}),this.remarkable.inline.ruler.disable(["backticks"])},render:function(){var e=this;this.textarea=Ext.get("ta"),this.buildUI(),this.registerAce(),this.registerMarked();var t=Ext.get("preview-button"),o=Ext.get("fullscreen-button"),i=Ext.get("preview-md"),r=Ext.get("content-md"),a=Ext.get("status-bar"),n=r.parent(),s=MODx.load({xtype:"modx-treedrop",target:r,targetEl:r,onInsert:function(e){return this.insert(e),this.focus(),!0}.bind(this.editor),iframe:!0});this.textarea.on("destroy",function(){s.destroy()}),t.addListener("click",function(){i.isVisible()?(i.setDisplayed("none"),r.setDisplayed("block"),a.setDisplayed("block"),t.child("i").removeClass("icon-toggle-on"),t.child("i").addClass("icon-toggle-off")):(i.setDisplayed("block"),r.setDisplayed("none"),a.setDisplayed("none"),t.child("i").removeClass("icon-toggle-off"),t.child("i").addClass("icon-toggle-on"))}),o.addListener("click",function(){var e=o.child("i");e.hasClass("icon-expand")?(e.removeClass("icon-expand"),e.addClass("icon-compress"),i.setDisplayed("block"),r.setDisplayed("block"),t.hide(),n.addClass("fullscreen"),this.editor.setOption("maxLines",null)):(e.addClass("icon-expand"),e.removeClass("icon-compress"),i.setDisplayed("none"),r.setDisplayed("block"),t.show(),n.removeClass("fullscreen"),this.editor.setOption("maxLines",1/0)),a.setDisplayed("block"),this.editor.resize(!0)},this),markdownEditor.content.content&&this.editor.setValue(markdownEditor.content.content),this.editor.selection.clearSelection(),i.update(this.parse(this.editor.getValue())),this.editor.getSession().on("change",function(){e.parse(e.editor.getValue())})}}),MODx.loadRTE=function(){new markdownEditor.Editor},markdownEditor.window.Cropper=function(config){config=config||{},config.cropperSelector=config.cropperSelector||".image-upload-wrapper > img",Ext.applyIf(config,{modal:!1,layout:"auto",closeAction:"hide",shadow:!0,resizable:!0,collapsible:!0,maximizable:!1,autoHeight:!1,autoScroll:!0,allowDrop:!0,width:800,title:"Crop the image",cls:"modx-window",html:'<div class="image-upload-wrapper"><img src="'+URL.createObjectURL(config.file)+'"></div>',tbar:[{text:'<i class="icon icon-arrows"></i> Move',scope:this,param:"move",action:"setDragMode",handler:this.callCropperAction},{text:'<i class="icon icon-crop"></i> Crop',scope:this,param:"crop",action:"setDragMode",handler:this.callCropperAction},{text:'<i class="icon icon-search-plus"></i> Zoom In',scope:this,param:.1,action:"zoom",handler:this.callCropperAction},{text:'<i class="icon icon-search-minus"></i> Zoom Out',scope:this,param:-.1,action:"zoom",handler:this.callCropperAction},{text:'<i class="icon icon-rotate-left"></i> Rotate left',scope:this,param:-90,action:"rotate",handler:this.callCropperAction},{text:'<i class="icon icon-rotate-right"></i> Rotate right',scope:this,param:90,action:"rotate",handler:this.callCropperAction},{text:'<i class="icon icon-remove"></i> Clear cropper',scope:this,param:null,action:"clear",handler:this.callCropperAction}],buttons:[{text:_("cancel"),scope:this,handler:this.close},{text:"Upload",cls:"primary-button",scope:this,crop:0,handler:this.upload},{text:"Crop & Upload",cls:"primary-button",scope:this,crop:1,handler:this.upload}],listeners:{show:{fn:function(){var cropperOptions={},ratio=MODx.config["markdowneditor.cropper.aspect_ratio"];ratio&&(ratio.replace(/[^-:x()\d/*+.]/g,""),ratio=eval(ratio),cropperOptions.aspectRatio=ratio),cropperOptions.crop=function(e){this.imageData=['{"x":'+e.x,'"y":'+e.y,'"height":'+e.height,'"width":'+e.width,'"rotate":'+e.rotate+"}"].join()}.bind(this),$(config.cropperSelector).cropper(cropperOptions)},scope:this}}}),markdownEditor.window.Cropper.superclass.constructor.call(this,config),this.config=config},Ext.extend(markdownEditor.window.Cropper,Ext.Window,{imageData:"",upload:function(e){var t=Ext.get("status-bar"),o=Ext.DomHelper.insertFirst(t,{tag:"div",id:"upload_progress",html:'<div class="progress"></div><i class="icon icon-spinner icon-spin"></i> Uploading image: '+this.config.file.name}),i=new FormData;i.append("file",this.config.file),i.append("action","mgr/editor/imageupload"),i.append("imageData",this.imageData),i.append("name",this.config.file.name),i.append("crop",e.crop);var r=new XMLHttpRequest;r.open("POST",markdownEditor.config.connectorUrl),r.setRequestHeader("Powered-By","MODx"),r.setRequestHeader("modAuth",Ext.Ajax.defaultHeaders.modAuth),r.upload.onprogress=function(e){if(e.lengthComputable){var o=e.loaded/e.total*100|0;t.child(".progress").setWidth(o+"%")}},r.onload=function(){if(200===r.status){var e=JSON.parse(r.responseText);1==e.success&&(o.remove(),this.config.md.editor.insert("!["+e.object.name+"]("+e.object.path+' "'+e.object.name+'")\n'))}}.bind(this),r.send(i),$(this.config.cropperSelector).cropper("destroy"),this.close()},callCropperAction:function(e){$(this.config.cropperSelector).cropper(e.action,e.param)}}),Ext.reg("markdowneditor-window-cropper",markdownEditor.window.Cropper);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsIm1hcmtkb3duZWRpdG9yLndpbmRvdy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxJQUFBLEdBQUEsa0JBQ0EsZUFBQSxTQUFBLEdBQ0EsRUFBQSxNQUNBLGVBQUEsV0FBQSxZQUFBLEtBQUEsS0FBQSxJQUVBLElBQUEsT0FBQSxlQUFBLElBQUEsV0FDQSxVQUFBLFlBRUEsSUFBQSxJQUFBLGlCQUFBLGdCQUNBLGVBQUEsR0FBQSxnQkFFQSxlQUFBLE9BQUEsU0FBQSxHQUNBLEVBQUEsTUFDQSxlQUFBLE9BQUEsV0FBQSxZQUFBLEtBQUEsS0FBQSxJQUVBLElBQUEsT0FBQSxlQUFBLE9BQUEsSUFBQSxXQUNBLFVBQ0EsV0FBQSxHQUNBLGNBQUEsV0FDQSxlQUFBLFdBQUEsY0FBQSxLQUFBLE1BRUEsSUFBQSxRQUFBLEtBQUEsT0FBQSxPQUdBLGFBQUEsR0FDQSxNQUFBLFNBQUEsR0FDQSxHQUFBLEdBQUEsS0FBQSxXQUFBLE9BQUEsRUFLQSxJQUhBLEVBQUEsRUFBQSxRQUFBLE9BQUEsS0FDQSxFQUFBLEVBQUEsUUFBQSxPQUFBLEtBRUEsR0FBQSxLQUFBLE9BQUEscUNBQUEsQ0FDQSxLQUFBLGNBQ0EsYUFBQSxLQUFBLGFBR0EsSUFBQSxHQUFBLFNBQUEsS0FBQSxPQUFBLDhDQUFBLElBRUEsTUFBQSxhQUFBLFdBQUEsV0FDQSxLQUFBLEtBQUEsU0FDQSxJQUFBLGVBQUEsT0FBQSxhQUNBLFFBQ0EsT0FBQSw0QkFDQSxRQUFBLEVBQ0EsU0FBQSxLQUFBLFFBQUEsSUFFQSxVQUFBLEVBQ0EsV0FDQSxTQUNBLEdBQUEsU0FBQSxHQUNBLElBQUEsSUFBQSxjQUFBLE9BQUEsRUFBQSxPQUVBLE1BQUEsVUFJQSxPQUVBLEtBQUEsSUFBQSxjQUFBLE9BQUEsRUFNQSxPQUhBLE1BQUEsV0FBQSxJQUFBLE1BQUEsS0FBQSxPQUFBLFdBQ0EsS0FBQSxTQUFBLElBQUEsTUFBQSxFQUVBLEdBR0EsUUFBQSxXQUNBLEtBQUEsU0FBQSxhQUFBLFFBQ0EsS0FBQSxTQUFBLFNBQUEsR0FDQSxLQUFBLFNBQUEsVUFBQSxHQUVBLElBQUEsVUFBQSxhQUFBLEtBQUEsVUFDQSxJQUFBLFdBQ0EsS0FBQSxjQUNBLEdBQUEsZ0JBR0EsS0FBQSxXQUFBLElBQUEsSUFBQSxlQUNBLEtBQUEsV0FBQSxhQUFBLFFBQ0EsS0FBQSxXQUFBLFNBQUEsR0FDQSxLQUFBLFdBQUEsVUFBQSxFQUVBLElBQUEsR0FBQSxJQUFBLFVBQUEsYUFBQSxLQUFBLFVBQ0EsSUFBQSxNQUNBLFFBQUEsc0JBR0EsS0FBQSxVQUFBLE9BQUEsR0FDQSxJQUFBLE1BQ0EsR0FBQSxhQUNBLFFBQUEsS0FBQSxTQUFBLElBQUEsWUFHQSxJQUFBLFVBQUEsT0FBQSxHQUNBLElBQUEsTUFDQSxHQUFBLGFBQ0EsUUFBQSxrQkFHQSxJQUFBLFVBQUEsT0FBQSxHQUNBLElBQUEsTUFDQSxHQUFBLFVBQ0EsS0FDQSxJQUFBLE9BQ0EsR0FBQSxpQkFDQSxLQUFBLGlEQUVBLElBQUEsT0FDQSxHQUFBLG9CQUNBLEtBQUEsdUNBSUEsSUFBQSxVQUFBLE9BQUEsR0FDQSxJQUFBLE1BQ0EsR0FBQSxhQUNBLEtBQUEsNktBR0EsSUFBQSxJQUFBLGFBQUEsR0FBQSxTQUFBLFNBQUEsRUFBQSxHQUNBLEtBQUEsWUFBQSxFQUFBLE9BQ0EsRUFBQSxNQUFBLElBQ0EsTUFFQSxJQUFBLFVBQUEsT0FBQSxHQUNBLElBQUEsT0FDQSxNQUFBLGlCQUlBLFlBQUEsV0FDQSxLQUFBLE9BQUEsSUFBQSxLQUFBLElBQUEsU0FBQSxXQUFBLG1CQUNBLEtBQUEsT0FBQSxZQUNBLFNBQUEsSUFDQSxTQUFBLEdBQ0EsMkJBQUEsSUFFQSxLQUFBLE9BQUEsU0FBQSxlQUFBLEdBQ0EsS0FBQSxPQUFBLFNBQUEsZ0JBQUEsR0FBQSxJQUNBLEtBQUEsT0FBQSxhQUFBLFNBQUEsS0FBQSxTQUFBLFlBQ0EsS0FBQSxPQUFBLGFBQUEsUUFBQSxxQkFDQSxLQUFBLE9BQUEsU0FBQSxjQUFBLEtBQUEsT0FBQSxpQ0FBQSxXQUVBLElBQUEsR0FBQSxJQUFBLFFBQUEsMEJBQ0EsR0FDQSxlQUFBLFNBQUEsRUFBQSxFQUFBLEVBQUEsRUFBQSxHQUNBLE1BQUEsS0FBQSxFQUFBLFFBQUEsRUFBQSxTQUFBLFNBQ0EsS0FBQSxLQUFBLFNBQ0EsSUFBQSxlQUFBLE9BQUEsYUFDQSxRQUNBLE9BQUEsdUJBQ0EsT0FBQSxHQUVBLFdBQ0EsU0FDQSxHQUFBLFNBQUEsR0FDQSxFQUFBLEtBQUEsRUFBQSxVQUVBLE1BQUEsU0FYQSxTQWtCQSxHQUFBLGFBQUEsR0FFQSxLQUFBLE9BQUEsVUFBQSxpQkFBQSxZQUFBLEtBQUEsbUJBQUEsR0FDQSxLQUFBLE9BQUEsVUFBQSxpQkFBQSxXQUFBLEtBQUEsbUJBQUEsR0FDQSxLQUFBLE9BQUEsVUFBQSxpQkFBQSxPQUFBLEtBQUEsS0FBQSxLQUFBLE9BQUEsSUFHQSxrQkFBQSxTQUFBLEdBQ0EsRUFBQSxrQkFDQSxFQUFBLGtCQUdBLEtBQUEsU0FBQSxHQUNBLEVBQUEsa0JBQ0EsRUFBQSxpQkFFQSxLQUFBLFlBQUEsRUFBQSxhQUFBLFFBR0EsWUFBQSxTQUFBLEdBQ0EsSUFBQSxLQUFBLEVBQUEsU0FBQSxHQUNBLEdBQUEsR0FBQSxXQUFBLEtBQUEsRUFBQSxLQUVBLEdBQ0EsR0FBQSxLQUFBLE9BQUEseUNBQ0EsS0FBQSxNQUNBLE1BQUEsZ0NBQ0EsS0FBQSxFQUNBLEdBQUEsT0FDQSxPQUVBLEtBQUEsV0FBQSxFQUFBLFNBR0EsS0FBQSxXQUFBLEVBQUEsU0FHQSxPQUdBLFdBQUEsU0FBQSxFQUFBLEdBQ0EsSUFBQSxFQUFBLE9BRUEsSUFBQSxHQUFBLElBQUEsSUFBQSxjQUNBLEVBQUEsSUFBQSxVQUFBLFlBQUEsR0FDQSxJQUFBLE1BQ0EsR0FBQSxrQkFDQSxLQUFBLHFGQUFBLEVBQUEsS0FBQSxFQUFBLE9BR0EsRUFBQSxHQUFBLFNBQ0EsR0FBQSxPQUFBLE9BQUEsR0FDQSxFQUFBLE9BQUEsU0FBQSxjQUFBLEVBQUEsVUFDQSxFQUFBLE9BQUEsT0FBQSxFQUFBLEtBRUEsSUFBQSxHQUFBLEdBQUEsZUFDQSxHQUFBLEtBQUEsT0FBQSxlQUFBLE9BQUEsY0FDQSxFQUFBLGlCQUFBLGFBQUEsUUFDQSxFQUFBLGlCQUFBLFVBQUEsSUFBQSxLQUFBLGVBQUEsU0FFQSxFQUFBLE9BQUEsV0FBQSxTQUFBLEdBQ0EsR0FBQSxFQUFBLGlCQUFBLENBQ0EsR0FBQSxHQUFBLEVBQUEsT0FBQSxFQUFBLE1BQUEsSUFBQSxDQUNBLEdBQUEsTUFBQSxhQUFBLFNBQUEsRUFBQSxPQUlBLEVBQUEsT0FBQSxXQUNBLEdBQUEsTUFBQSxFQUFBLE9BQUEsQ0FDQSxHQUFBLEdBQUEsS0FBQSxNQUFBLEVBQUEsYUFDQSxJQUFBLEdBQUEsRUFBQSxRQUFBLENBQ0EsRUFBQSxRQUNBLElBQUEsR0FBQSxTQUFBLEVBQUEsSUFBQSxFQUNBLE1BQUEsT0FBQSxPQUFBLEVBQUEsSUFBQSxFQUFBLE9BQUEsS0FBQSxLQUFBLEVBQUEsT0FBQSxLQUFBLEtBQUEsRUFBQSxPQUFBLEtBQUEsV0FHQSxLQUFBLE1BRUEsRUFBQSxLQUFBLElBR0EsZUFBQSxXQUNBLEtBQUEsV0FBQSxHQUFBLGFBQ0EsTUFBQSxFQUNBLFVBQUEsU0FBQSxFQUFBLEdBQ0EsR0FBQSxHQUFBLEtBQUEsWUFBQSxHQUNBLElBQ0EsTUFBQSxNQUFBLFVBQUEsRUFBQSxHQUFBLE1BQ0EsTUFBQSxJQUdBLElBQ0EsTUFBQSxNQUFBLGNBQUEsR0FBQSxNQUNBLE1BQUEsSUFFQSxNQUFBLE1BR0EsS0FBQSxXQUFBLE9BQUEsTUFBQSxTQUFBLGVBR0EsT0FBQSxXQUNBLEdBQUEsR0FBQSxJQUNBLE1BQUEsU0FBQSxJQUFBLElBQUEsTUFFQSxLQUFBLFVBQ0EsS0FBQSxjQUNBLEtBQUEsZ0JBRUEsSUFBQSxHQUFBLElBQUEsSUFBQSxrQkFDQSxFQUFBLElBQUEsSUFBQSxxQkFDQSxFQUFBLElBQUEsSUFBQSxjQUNBLEVBQUEsSUFBQSxJQUFBLGNBQ0EsRUFBQSxJQUFBLElBQUEsY0FDQSxFQUFBLEVBQUEsU0FFQSxFQUFBLEtBQUEsTUFDQSxNQUFBLGdCQUNBLE9BQUEsRUFDQSxTQUFBLEVBQ0EsU0FBQSxTQUFBLEdBR0EsTUFGQSxNQUFBLE9BQUEsR0FDQSxLQUFBLFNBQ0EsR0FDQSxLQUFBLEtBQUEsUUFDQSxRQUFBLEdBRUEsTUFBQSxTQUFBLEdBQUEsVUFBQSxXQUFBLEVBQUEsWUFFQSxFQUFBLFlBQUEsUUFBQSxXQUNBLEVBQUEsYUFDQSxFQUFBLGFBQUEsUUFDQSxFQUFBLGFBQUEsU0FDQSxFQUFBLGFBQUEsU0FFQSxFQUFBLE1BQUEsS0FBQSxZQUFBLGtCQUNBLEVBQUEsTUFBQSxLQUFBLFNBQUEscUJBRUEsRUFBQSxhQUFBLFNBQ0EsRUFBQSxhQUFBLFFBQ0EsRUFBQSxhQUFBLFFBRUEsRUFBQSxNQUFBLEtBQUEsWUFBQSxtQkFDQSxFQUFBLE1BQUEsS0FBQSxTQUFBLHFCQUlBLEVBQUEsWUFBQSxRQUFBLFdBQ0EsR0FBQSxHQUFBLEVBQUEsTUFBQSxJQUVBLEdBQUEsU0FBQSxnQkFDQSxFQUFBLFlBQUEsZUFDQSxFQUFBLFNBQUEsaUJBRUEsRUFBQSxhQUFBLFNBQ0EsRUFBQSxhQUFBLFNBRUEsRUFBQSxPQUVBLEVBQUEsU0FBQSxjQUVBLEtBQUEsT0FBQSxVQUFBLFdBQUEsUUFHQSxFQUFBLFNBQUEsZUFDQSxFQUFBLFlBQUEsaUJBRUEsRUFBQSxhQUFBLFFBQ0EsRUFBQSxhQUFBLFNBRUEsRUFBQSxPQUVBLEVBQUEsWUFBQSxjQUVBLEtBQUEsT0FBQSxVQUFBLFdBQUEsTUFHQSxFQUFBLGFBQUEsU0FFQSxLQUFBLE9BQUEsUUFBQSxJQUNBLE1BRUEsZUFBQSxRQUFBLFNBQ0EsS0FBQSxPQUFBLFNBQUEsZUFBQSxRQUFBLFNBRUEsS0FBQSxPQUFBLFVBQUEsaUJBRUEsRUFBQSxPQUFBLEtBQUEsTUFBQSxLQUFBLE9BQUEsYUFFQSxLQUFBLE9BQUEsYUFBQSxHQUFBLFNBQUEsV0FDQSxFQUFBLE1BQUEsRUFBQSxPQUFBLGlCQUtBLEtBQUEsUUFBQSxXQUNBLEdBQUEsZ0JBQUEsUUMxV0EsZUFBQSxPQUFBLFFBQUEsU0FBQSxRQUNBLE9BQUEsV0FDQSxPQUFBLGdCQUFBLE9BQUEsaUJBQUEsOEJBRUEsSUFBQSxRQUFBLFFBQ0EsT0FBQSxFQUNBLE9BQUEsT0FDQSxZQUFBLE9BQ0EsUUFBQSxFQUNBLFdBQUEsRUFDQSxhQUFBLEVBQ0EsYUFBQSxFQUNBLFlBQUEsRUFDQSxZQUFBLEVBQ0EsV0FBQSxFQUNBLE1BQUEsSUFDQSxNQUFBLGlCQUNBLElBQUEsY0FDQSxLQUFBLCtDQUFBLElBQUEsZ0JBQUEsT0FBQSxNQUFBLFdBQ0EsT0FDQSxLQUFBLHdDQUNBLE1BQUEsS0FDQSxNQUFBLE9BQ0EsT0FBQSxjQUNBLFFBQUEsS0FBQSxvQkFFQSxLQUFBLHNDQUNBLE1BQUEsS0FDQSxNQUFBLE9BQ0EsT0FBQSxjQUNBLFFBQUEsS0FBQSxvQkFFQSxLQUFBLGdEQUNBLE1BQUEsS0FDQSxNQUFBLEdBQ0EsT0FBQSxPQUNBLFFBQUEsS0FBQSxvQkFFQSxLQUFBLGtEQUNBLE1BQUEsS0FDQSxPQUFBLEdBQ0EsT0FBQSxPQUNBLFFBQUEsS0FBQSxvQkFFQSxLQUFBLG9EQUNBLE1BQUEsS0FDQSxNQUFBLElBQ0EsT0FBQSxTQUNBLFFBQUEsS0FBQSxvQkFFQSxLQUFBLHNEQUNBLE1BQUEsS0FDQSxNQUFBLEdBQ0EsT0FBQSxTQUNBLFFBQUEsS0FBQSxvQkFFQSxLQUFBLGlEQUNBLE1BQUEsS0FDQSxNQUFBLEtBQ0EsT0FBQSxRQUNBLFFBQUEsS0FBQSxvQkFFQSxVQUNBLEtBQUEsRUFBQSxVQUNBLE1BQUEsS0FDQSxRQUFBLEtBQUEsUUFFQSxLQUFBLFNBQ0EsSUFBQSxpQkFDQSxNQUFBLEtBQ0EsS0FBQSxFQUNBLFFBQUEsS0FBQSxTQUVBLEtBQUEsZ0JBQ0EsSUFBQSxpQkFDQSxNQUFBLEtBQ0EsS0FBQSxFQUNBLFFBQUEsS0FBQSxTQUVBLFdBQ0EsTUFDQSxHQUFBLFdBQ0EsR0FBQSxtQkFFQSxNQUFBLEtBQUEsT0FBQSxzQ0FDQSxTQUNBLE1BQUEsUUFBQSxrQkFBQSxJQUNBLE1BQUEsS0FBQSxPQUVBLGVBQUEsWUFBQSxPQUdBLGVBQUEsS0FBQSxTQUFBLEdBQ0EsS0FBQSxXQUNBLFFBQUEsRUFBQSxFQUNBLE9BQUEsRUFBQSxFQUNBLFlBQUEsRUFBQSxPQUNBLFdBQUEsRUFBQSxNQUNBLFlBQUEsRUFBQSxPQUFBLEtBQ0EsUUFDQSxLQUFBLE1BRUEsRUFBQSxPQUFBLGlCQUFBLFFBQUEsaUJBRUEsTUFBQSxTQUlBLGVBQUEsT0FBQSxRQUFBLFdBQUEsWUFBQSxLQUFBLEtBQUEsUUFDQSxLQUFBLE9BQUEsUUFHQSxJQUFBLE9BQUEsZUFBQSxPQUFBLFFBQUEsSUFBQSxRQUNBLFVBQUEsR0FDQSxPQUFBLFNBQUEsR0FDQSxHQUFBLEdBQUEsSUFBQSxJQUFBLGNBQ0EsRUFBQSxJQUFBLFVBQUEsWUFBQSxHQUNBLElBQUEsTUFDQSxHQUFBLGtCQUNBLEtBQUEsNEZBQUEsS0FBQSxPQUFBLEtBQUEsT0FHQSxFQUFBLEdBQUEsU0FDQSxHQUFBLE9BQUEsT0FBQSxLQUFBLE9BQUEsTUFDQSxFQUFBLE9BQUEsU0FBQSwwQkFDQSxFQUFBLE9BQUEsWUFBQSxLQUFBLFdBQ0EsRUFBQSxPQUFBLE9BQUEsS0FBQSxPQUFBLEtBQUEsTUFDQSxFQUFBLE9BQUEsT0FBQSxFQUFBLEtBRUEsSUFBQSxHQUFBLEdBQUEsZUFDQSxHQUFBLEtBQUEsT0FBQSxlQUFBLE9BQUEsY0FDQSxFQUFBLGlCQUFBLGFBQUEsUUFDQSxFQUFBLGlCQUFBLFVBQUEsSUFBQSxLQUFBLGVBQUEsU0FFQSxFQUFBLE9BQUEsV0FBQSxTQUFBLEdBQ0EsR0FBQSxFQUFBLGlCQUFBLENBQ0EsR0FBQSxHQUFBLEVBQUEsT0FBQSxFQUFBLE1BQUEsSUFBQSxDQUNBLEdBQUEsTUFBQSxhQUFBLFNBQUEsRUFBQSxPQUlBLEVBQUEsT0FBQSxXQUNBLEdBQUEsTUFBQSxFQUFBLE9BQUEsQ0FDQSxHQUFBLEdBQUEsS0FBQSxNQUFBLEVBQUEsYUFDQSxJQUFBLEVBQUEsVUFDQSxFQUFBLFNBQ0EsS0FBQSxPQUFBLEdBQUEsT0FBQSxPQUFBLEtBQUEsRUFBQSxPQUFBLEtBQUEsS0FBQSxFQUFBLE9BQUEsS0FBQSxLQUFBLEVBQUEsT0FBQSxLQUFBLFdBR0EsS0FBQSxNQUVBLEVBQUEsS0FBQSxHQUVBLEVBQUEsS0FBQSxPQUFBLGlCQUFBLFFBQUEsV0FDQSxLQUFBLFNBR0Esa0JBQUEsU0FBQSxHQUNBLEVBQUEsS0FBQSxPQUFBLGlCQUFBLFFBQUEsRUFBQSxPQUFBLEVBQUEsVUFHQSxJQUFBLElBQUEsZ0NBQUEsZUFBQSxPQUFBIiwiZmlsZSI6ImFwcC5qcyIsInNvdXJjZXNDb250ZW50IjpbIkV4dC5ucygnTWFya2Rvd25FZGl0b3InKTtcbk1hcmtkb3duRWRpdG9yID0gZnVuY3Rpb24oY29uZmlnKSB7XG4gICAgY29uZmlnID0gY29uZmlnIHx8IHt9O1xuICAgIE1hcmtkb3duRWRpdG9yLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLGNvbmZpZyk7XG59O1xuRXh0LmV4dGVuZChNYXJrZG93bkVkaXRvcixFeHQuQ29tcG9uZW50LHtcbiAgICB3aW5kb3c6e30sY29uZmlnOiB7fVxufSk7XG5FeHQucmVnKCdtYXJrZG93bmVkaXRvcicsTWFya2Rvd25FZGl0b3IpO1xubWFya2Rvd25FZGl0b3IgPSBuZXcgTWFya2Rvd25FZGl0b3IoKTtcblxubWFya2Rvd25FZGl0b3IuRWRpdG9yID0gZnVuY3Rpb24oY29uZmlnKSB7XG4gICAgY29uZmlnID0gY29uZmlnIHx8IHt9O1xuICAgIG1hcmtkb3duRWRpdG9yLkVkaXRvci5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcyxjb25maWcpO1xufTtcbkV4dC5leHRlbmQobWFya2Rvd25FZGl0b3IuRWRpdG9yLEV4dC5Db21wb25lbnQse1xuICAgIHdpbmRvdzoge31cbiAgICAscmVtYXJrYWJsZTogJydcbiAgICAsaW5pdENvbXBvbmVudDogZnVuY3Rpb24oKSB7XG4gICAgICAgIE1hcmtkb3duRWRpdG9yLnN1cGVyY2xhc3MuaW5pdENvbXBvbmVudC5jYWxsKHRoaXMpO1xuXG4gICAgICAgIEV4dC5vblJlYWR5KHRoaXMucmVuZGVyLCB0aGlzKTtcbiAgICB9XG5cbiAgICAscGFyc2VSZXF1ZXN0OiAnJ1xuICAgICxwYXJzZTogZnVuY3Rpb24oaW5wdXQpIHtcbiAgICAgICAgdmFyIG91dHB1dCA9IHRoaXMucmVtYXJrYWJsZS5yZW5kZXIoaW5wdXQpO1xuXG4gICAgICAgIG91dHB1dCA9IG91dHB1dC5yZXBsYWNlKC8lNUIvZywgJ1snKTtcbiAgICAgICAgb3V0cHV0ID0gb3V0cHV0LnJlcGxhY2UoLyU1RC9nLCAnXScpO1xuXG4gICAgICAgIGlmIChNT0R4LmNvbmZpZ1snbWFya2Rvd25lZGl0b3IubHAucGFyc2VfbW9keF90YWdzJ10gPT0gMSkge1xuICAgICAgICAgICAgaWYgKHRoaXMucGFyc2VSZXF1ZXN0KSB7XG4gICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMucGFyc2VSZXF1ZXN0KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdmFyIHRpbWVvdXQgPSBwYXJzZUludChNT0R4LmNvbmZpZ1snbWFya2Rvd25lZGl0b3IubHAucGFyc2VfbW9keF90YWdzX3RpbWVvdXQnXSB8fCAzMDApO1xuXG4gICAgICAgICAgICB0aGlzLnBhcnNlUmVxdWVzdCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKXtcbiAgICAgICAgICAgICAgICBNT0R4LkFqYXgucmVxdWVzdCh7XG4gICAgICAgICAgICAgICAgICAgIHVybDogbWFya2Rvd25FZGl0b3IuY29uZmlnLmNvbm5lY3RvclVybFxuICAgICAgICAgICAgICAgICAgICAscGFyYW1zOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb246ICdtZ3IvZWRpdG9yL3Byb2Nlc3Njb250ZW50J1xuICAgICAgICAgICAgICAgICAgICAgICAgLGNvbnRlbnQ6IG91dHB1dFxuICAgICAgICAgICAgICAgICAgICAgICAgLHJlc291cmNlOiBNT0R4LnJlcXVlc3QuaWRcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgaXNVcGxvYWQgOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnM6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuOiBmdW5jdGlvbihyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEV4dC5nZXQoJ3ByZXZpZXctbWQnKS51cGRhdGUoci5kYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0sIHRpbWVvdXQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgRXh0LmdldCgncHJldmlldy1tZCcpLnVwZGF0ZShvdXRwdXQpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy50YU1hcmtkb3duLmRvbS52YWx1ZSA9IHRoaXMuZWRpdG9yLmdldFZhbHVlKCk7XG4gICAgICAgIHRoaXMudGV4dGFyZWEuZG9tLnZhbHVlID0gb3V0cHV0O1xuXG4gICAgICAgIHJldHVybiBvdXRwdXQ7XG4gICAgfVxuXG4gICAgLGJ1aWxkVUk6IGZ1bmN0aW9uKCkge1xuICAgICAgICB0aGlzLnRleHRhcmVhLnNldERpc3BsYXllZCgnbm9uZScpO1xuICAgICAgICB0aGlzLnRleHRhcmVhLnNldFdpZHRoKDApO1xuICAgICAgICB0aGlzLnRleHRhcmVhLnNldEhlaWdodCgwKTtcblxuICAgICAgICBFeHQuRG9tSGVscGVyLmluc2VydEJlZm9yZSh0aGlzLnRleHRhcmVhLCB7XG4gICAgICAgICAgICB0YWc6ICd0ZXh0YXJlYScsXG4gICAgICAgICAgICBuYW1lOiAndGFfbWFya2Rvd24nLFxuICAgICAgICAgICAgaWQ6ICd0YV9tYXJrZG93bidcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy50YU1hcmtkb3duID0gRXh0LmdldCgndGFfbWFya2Rvd24nKTtcbiAgICAgICAgdGhpcy50YU1hcmtkb3duLnNldERpc3BsYXllZCgnbm9uZScpO1xuICAgICAgICB0aGlzLnRhTWFya2Rvd24uc2V0V2lkdGgoMCk7XG4gICAgICAgIHRoaXMudGFNYXJrZG93bi5zZXRIZWlnaHQoMCk7XG5cbiAgICAgICAgdmFyIHdyYXBwZXIgPSBFeHQuRG9tSGVscGVyLmluc2VydEJlZm9yZSh0aGlzLnRleHRhcmVhLCB7XG4gICAgICAgICAgICB0YWc6ICdkaXYnLFxuICAgICAgICAgICAgY2xhc3M6ICdtYXJrZG93bi1jb250YWluZXInXG4gICAgICAgIH0pO1xuXG4gICAgICAgIEV4dC5Eb21IZWxwZXIuYXBwZW5kKHdyYXBwZXIse1xuICAgICAgICAgICAgdGFnOiAnZGl2JyxcbiAgICAgICAgICAgIGlkOiAnY29udGVudC1tZCcsXG4gICAgICAgICAgICBjbGFzczogdGhpcy50ZXh0YXJlYS5kb20uY2xhc3NOYW1lXG4gICAgICAgIH0pO1xuXG4gICAgICAgIEV4dC5Eb21IZWxwZXIuYXBwZW5kKHdyYXBwZXIse1xuICAgICAgICAgICAgdGFnOiAnZGl2JyxcbiAgICAgICAgICAgIGlkOiAncHJldmlldy1tZCcsXG4gICAgICAgICAgICBjbGFzczogJ21hcmtkb3duLWJvZHknXG4gICAgICAgIH0pO1xuXG4gICAgICAgIEV4dC5Eb21IZWxwZXIuYXBwZW5kKHdyYXBwZXIse1xuICAgICAgICAgICAgdGFnOiAnZGl2JyxcbiAgICAgICAgICAgIGlkOiAndG9vbGJveCcsXG4gICAgICAgICAgICBjbjogW3tcbiAgICAgICAgICAgICAgICB0YWc6ICdzcGFuJyxcbiAgICAgICAgICAgICAgICBpZDogJ3ByZXZpZXctYnV0dG9uJyxcbiAgICAgICAgICAgICAgICBodG1sOiAnPGkgY2xhc3M9XCJpY29uIGljb24tdG9nZ2xlLW9mZlwiPjwvaT4gUHJldmlldydcbiAgICAgICAgICAgIH0se1xuICAgICAgICAgICAgICAgIHRhZzogJ3NwYW4nLFxuICAgICAgICAgICAgICAgIGlkOiAnZnVsbHNjcmVlbi1idXR0b24nLFxuICAgICAgICAgICAgICAgIGh0bWw6ICc8aSBjbGFzcz1cImljb24gaWNvbi1leHBhbmRcIj48L2k+J1xuICAgICAgICAgICAgfV1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgRXh0LkRvbUhlbHBlci5hcHBlbmQod3JhcHBlcix7XG4gICAgICAgICAgICB0YWc6ICdkaXYnLFxuICAgICAgICAgICAgaWQ6ICdzdGF0dXMtYmFyJyxcbiAgICAgICAgICAgIGh0bWw6ICc8aW5wdXQgY2xhc3M9XCJoaWRkZW5cIiBpZD1cImlucHV0RmlsZVwiIG5hbWU9XCJmaWxlXCIgdHlwZT1cImZpbGVcIiBtdWx0aXBsZT5BdHRhY2ggZmlsZXMgYnkgZHJhZ2dpbmcgJiBkcm9wcGluZyBvciA8bGFiZWwgZm9yPVwiaW5wdXRGaWxlXCIgY2xhc3M9XCJsaW5rXCI+c2VsZWN0aW5nIHRoZW08L2xhYmVsPi4nXG4gICAgICAgIH0pO1xuXG4gICAgICAgIEV4dC5nZXQoJ2lucHV0RmlsZScpLm9uKCdjaGFuZ2UnLCBmdW5jdGlvbihlLCBpbnB1dCkge1xuICAgICAgICAgICAgdGhpcy5oYW5kbGVGaWxlcyhpbnB1dC5maWxlcyk7XG4gICAgICAgICAgICBpbnB1dC52YWx1ZSA9IFwiXCI7XG4gICAgICAgIH0sIHRoaXMpO1xuXG4gICAgICAgIEV4dC5Eb21IZWxwZXIuYXBwZW5kKHdyYXBwZXIse1xuICAgICAgICAgICAgdGFnOiAnc3BhbicsXG4gICAgICAgICAgICBzdHlsZTogJ2NsZWFyOiBib3RoJ1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAscmVnaXN0ZXJBY2U6IGZ1bmN0aW9uKCkge1xuICAgICAgICB0aGlzLmVkaXRvciA9IGFjZS5lZGl0KEV4dC5Eb21RdWVyeS5zZWxlY3ROb2RlKCdkaXYjY29udGVudC1tZCcpKTtcbiAgICAgICAgdGhpcy5lZGl0b3Iuc2V0T3B0aW9ucyh7XG4gICAgICAgICAgICBtYXhMaW5lczogSW5maW5pdHksXG4gICAgICAgICAgICBtaW5MaW5lczogMjUsXG4gICAgICAgICAgICBlbmFibGVCYXNpY0F1dG9jb21wbGV0aW9uOiB0cnVlXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmVkaXRvci5yZW5kZXJlci5zZXRTaG93R3V0dGVyKHRydWUpO1xuICAgICAgICB0aGlzLmVkaXRvci5yZW5kZXJlci5zZXRTY3JvbGxNYXJnaW4oMTAsIDEwKTtcbiAgICAgICAgdGhpcy5lZGl0b3IuZ2V0U2Vzc2lvbigpLnNldFZhbHVlKHRoaXMudGV4dGFyZWEuZ2V0VmFsdWUoKSk7XG4gICAgICAgIHRoaXMuZWRpdG9yLmdldFNlc3Npb24oKS5zZXRNb2RlKFwiYWNlL21vZGUvbWFya2Rvd25cIik7XG4gICAgICAgIHRoaXMuZWRpdG9yLnNldFRoZW1lKFwiYWNlL3RoZW1lL1wiICsgKE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci5nZW5lcmFsLnRoZW1lJ10gfHwgJ21vbm9rYWknKSk7XG5cbiAgICAgICAgdmFyIGxhbmdUb29scyA9IGFjZS5yZXF1aXJlKFwiYWNlL2V4dC9sYW5ndWFnZV90b29sc1wiKTtcbiAgICAgICAgdmFyIHJoeW1lQ29tcGxldGVyID0ge1xuICAgICAgICAgICAgZ2V0Q29tcGxldGlvbnM6IGZ1bmN0aW9uKGVkaXRvciwgc2Vzc2lvbiwgcG9zLCBwcmVmaXgsIGNhbGxiYWNrKSB7XG4gICAgICAgICAgICAgICAgaWYgKHByZWZpeC5sZW5ndGggPT09IDApIHsgY2FsbGJhY2sobnVsbCwgW10pOyByZXR1cm4gfVxuICAgICAgICAgICAgICAgIE1PRHguQWpheC5yZXF1ZXN0KHtcbiAgICAgICAgICAgICAgICAgICAgdXJsOiBtYXJrZG93bkVkaXRvci5jb25maWcuY29ubmVjdG9yVXJsXG4gICAgICAgICAgICAgICAgICAgICxwYXJhbXM6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbjogJ21nci9yZXNvdXJjZS9nZXRsaXN0J1xuICAgICAgICAgICAgICAgICAgICAgICAgLHByZWZpeDogcHJlZml4XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyczoge1xuICAgICAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm46IGZ1bmN0aW9uKHIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgci5yZXN1bHRzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBsYW5nVG9vbHMuYWRkQ29tcGxldGVyKHJoeW1lQ29tcGxldGVyKTtcblxuICAgICAgICB0aGlzLmVkaXRvci5jb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcihcImRyYWdlbnRlclwiLCB0aGlzLmNhdGNoQW5kRG9Ob3RoaW5nLCBmYWxzZSk7XG4gICAgICAgIHRoaXMuZWRpdG9yLmNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKFwiZHJhZ292ZXJcIiwgdGhpcy5jYXRjaEFuZERvTm90aGluZywgZmFsc2UpO1xuICAgICAgICB0aGlzLmVkaXRvci5jb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcihcImRyb3BcIiwgdGhpcy5kcm9wLmJpbmQodGhpcyksIGZhbHNlKTtcbiAgICB9XG5cbiAgICAsY2F0Y2hBbmREb05vdGhpbmc6IGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIH1cblxuICAgICxkcm9wOiBmdW5jdGlvbihlKSB7XG4gICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgICB0aGlzLmhhbmRsZUZpbGVzKGUuZGF0YVRyYW5zZmVyLmZpbGVzKTtcbiAgICB9XG5cbiAgICAsaGFuZGxlRmlsZXM6IGZ1bmN0aW9uKGZpbGVzKSB7XG4gICAgICAgIEV4dC5lYWNoKGZpbGVzLCBmdW5jdGlvbihmaWxlKSB7XG4gICAgICAgICAgICB2YXIgaXNJbWFnZSA9IC9eaW1hZ2VcXC8vLnRlc3QoZmlsZS50eXBlKTtcblxuICAgICAgICAgICAgaWYgKGlzSW1hZ2UpIHtcbiAgICAgICAgICAgICAgICBpZiAoTU9EeC5jb25maWdbJ21hcmtkb3duZWRpdG9yLmNyb3BwZXIuZW5hYmxlX2Nyb3BwZXInXSA9PSAxKSB7XG4gICAgICAgICAgICAgICAgICAgIE1PRHgubG9hZCh7XG4gICAgICAgICAgICAgICAgICAgICAgICB4dHlwZTogJ21hcmtkb3duZWRpdG9yLXdpbmRvdy1jcm9wcGVyJ1xuICAgICAgICAgICAgICAgICAgICAgICAgLGZpbGU6IGZpbGVcbiAgICAgICAgICAgICAgICAgICAgICAgICxtZDogdGhpc1xuICAgICAgICAgICAgICAgICAgICB9KS5zaG93KCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGxvYWRGaWxlKGZpbGUsICdpbWFnZScpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy51cGxvYWRGaWxlKGZpbGUsICdmaWxlJyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSwgdGhpcyk7XG4gICAgfVxuXG4gICAgLHVwbG9hZEZpbGU6IGZ1bmN0aW9uKGZpbGUsIHR5cGUpIHtcbiAgICAgICAgaWYgKCF0eXBlKSB0eXBlID0gJ2ZpbGUnO1xuXG4gICAgICAgIHZhciBzYiA9IEV4dC5nZXQoJ3N0YXR1cy1iYXInKTtcbiAgICAgICAgdmFyIHVwbG9hZGVyID0gRXh0LkRvbUhlbHBlci5pbnNlcnRGaXJzdChzYix7XG4gICAgICAgICAgICB0YWc6ICdkaXYnLFxuICAgICAgICAgICAgaWQ6ICd1cGxvYWRfcHJvZ3Jlc3MnLFxuICAgICAgICAgICAgaHRtbDogJzxkaXYgY2xhc3M9XCJwcm9ncmVzc1wiPjwvZGl2PjxpIGNsYXNzPVwiaWNvbiBpY29uLXNwaW5uZXIgaWNvbi1zcGluXCI+PC9pPiBVcGxvYWRpbmcgJyArIHR5cGUgKyAnOiAnICsgZmlsZS5uYW1lXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHZhciBmb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSgpO1xuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ2ZpbGUnLCBmaWxlKTtcbiAgICAgICAgZm9ybURhdGEuYXBwZW5kKCdhY3Rpb24nLCAnbWdyL2VkaXRvci8nICsgdHlwZSArICd1cGxvYWQnKTtcbiAgICAgICAgZm9ybURhdGEuYXBwZW5kKCduYW1lJywgZmlsZS5uYW1lKTtcblxuICAgICAgICB2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG4gICAgICAgIHhoci5vcGVuKCdQT1NUJywgbWFya2Rvd25FZGl0b3IuY29uZmlnLmNvbm5lY3RvclVybCk7XG4gICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdQb3dlcmVkLUJ5JywgJ01PRHgnKTtcbiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ21vZEF1dGgnLCBFeHQuQWpheC5kZWZhdWx0SGVhZGVycy5tb2RBdXRoKTtcblxuICAgICAgICB4aHIudXBsb2FkLm9ucHJvZ3Jlc3MgPSBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgICAgICAgIGlmIChldmVudC5sZW5ndGhDb21wdXRhYmxlKSB7XG4gICAgICAgICAgICAgICAgdmFyIGNvbXBsZXRlID0gKGV2ZW50LmxvYWRlZCAvIGV2ZW50LnRvdGFsICogMTAwIHwgMCk7XG4gICAgICAgICAgICAgICAgc2IuY2hpbGQoJy5wcm9ncmVzcycpLnNldFdpZHRoKGNvbXBsZXRlICsgJyUnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICB4aHIub25sb2FkID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKHhoci5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgICAgICAgICAgIHZhciByZXMgPSBKU09OLnBhcnNlKHhoci5yZXNwb25zZVRleHQpO1xuICAgICAgICAgICAgICAgIGlmIChyZXMuc3VjY2VzcyA9PSB0cnVlKSB7XG4gICAgICAgICAgICAgICAgICAgIHVwbG9hZGVyLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgaW1hZ2VQcmVmaXggPSAodHlwZSA9PSAnaW1hZ2UnKSA/ICchJyA6ICcnO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVkaXRvci5pbnNlcnQoaW1hZ2VQcmVmaXggKyAnWycgKyByZXMub2JqZWN0Lm5hbWUgKyAnXSgnICsgcmVzLm9iamVjdC5wYXRoICsgJyBcIicgKyByZXMub2JqZWN0Lm5hbWUgKyAnXCIpXFxuJyk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9LmJpbmQodGhpcyk7XG5cbiAgICAgICAgeGhyLnNlbmQoZm9ybURhdGEpO1xuICAgIH1cblxuICAgICxyZWdpc3Rlck1hcmtlZDogZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMucmVtYXJrYWJsZSA9IG5ldyBSZW1hcmthYmxlKHtcbiAgICAgICAgICAgIGh0bWw6IHRydWUsXG4gICAgICAgICAgICBoaWdobGlnaHQ6IGZ1bmN0aW9uIChzdHIsIGxhbmcpIHtcbiAgICAgICAgICAgICAgICBpZiAobGFuZyAmJiBobGpzLmdldExhbmd1YWdlKGxhbmcpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGxqcy5oaWdobGlnaHQobGFuZywgc3RyKS52YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7fVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBobGpzLmhpZ2hsaWdodEF1dG8oc3RyKS52YWx1ZTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHt9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gJyc7IC8vIHVzZSBleHRlcm5hbCBkZWZhdWx0IGVzY2FwaW5nXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnJlbWFya2FibGUuaW5saW5lLnJ1bGVyLmRpc2FibGUoWyAnYmFja3RpY2tzJyBdKTtcbiAgICB9XG5cbiAgICAscmVuZGVyOiBmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyIG1kZSA9IHRoaXM7XG4gICAgICAgIHRoaXMudGV4dGFyZWEgPSBFeHQuZ2V0KCd0YScpO1xuXG4gICAgICAgIHRoaXMuYnVpbGRVSSgpO1xuICAgICAgICB0aGlzLnJlZ2lzdGVyQWNlKCk7XG4gICAgICAgIHRoaXMucmVnaXN0ZXJNYXJrZWQoKTtcblxuICAgICAgICB2YXIgcHJldmlld0J1dHRvbiA9IEV4dC5nZXQoJ3ByZXZpZXctYnV0dG9uJyk7XG4gICAgICAgIHZhciBmdWxsc2NyZWVuQnV0dG9uID0gRXh0LmdldCgnZnVsbHNjcmVlbi1idXR0b24nKTtcbiAgICAgICAgdmFyIHByZXZpZXcgPSBFeHQuZ2V0KCdwcmV2aWV3LW1kJyk7XG4gICAgICAgIHZhciBjb250ZW50ID0gRXh0LmdldCgnY29udGVudC1tZCcpO1xuICAgICAgICB2YXIgc3RhdHVzQmFyID0gRXh0LmdldCgnc3RhdHVzLWJhcicpO1xuICAgICAgICB2YXIgd3JhcHBlciA9IGNvbnRlbnQucGFyZW50KCk7XG5cbiAgICAgICAgdmFyIGRyb3BUYXJnZXQgPSBNT0R4LmxvYWQoe1xuICAgICAgICAgICAgeHR5cGU6ICdtb2R4LXRyZWVkcm9wJyxcbiAgICAgICAgICAgIHRhcmdldDogY29udGVudCxcbiAgICAgICAgICAgIHRhcmdldEVsOiBjb250ZW50LFxuICAgICAgICAgICAgb25JbnNlcnQ6IChmdW5jdGlvbihzKXtcbiAgICAgICAgICAgICAgICB0aGlzLmluc2VydChzKTtcbiAgICAgICAgICAgICAgICB0aGlzLmZvY3VzKCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9KS5iaW5kKHRoaXMuZWRpdG9yKSxcbiAgICAgICAgICAgIGlmcmFtZTogdHJ1ZVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy50ZXh0YXJlYS5vbignZGVzdHJveScsIGZ1bmN0aW9uKCkge2Ryb3BUYXJnZXQuZGVzdHJveSgpO30pO1xuXG4gICAgICAgIHByZXZpZXdCdXR0b24uYWRkTGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKHByZXZpZXcuaXNWaXNpYmxlKCkpIHtcbiAgICAgICAgICAgICAgICBwcmV2aWV3LnNldERpc3BsYXllZCgnbm9uZScpO1xuICAgICAgICAgICAgICAgIGNvbnRlbnQuc2V0RGlzcGxheWVkKCdibG9jaycpO1xuICAgICAgICAgICAgICAgIHN0YXR1c0Jhci5zZXREaXNwbGF5ZWQoJ2Jsb2NrJyk7XG5cbiAgICAgICAgICAgICAgICBwcmV2aWV3QnV0dG9uLmNoaWxkKCdpJykucmVtb3ZlQ2xhc3MoJ2ljb24tdG9nZ2xlLW9uJyk7XG4gICAgICAgICAgICAgICAgcHJldmlld0J1dHRvbi5jaGlsZCgnaScpLmFkZENsYXNzKCdpY29uLXRvZ2dsZS1vZmYnKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcHJldmlldy5zZXREaXNwbGF5ZWQoJ2Jsb2NrJyk7XG4gICAgICAgICAgICAgICAgY29udGVudC5zZXREaXNwbGF5ZWQoJ25vbmUnKTtcbiAgICAgICAgICAgICAgICBzdGF0dXNCYXIuc2V0RGlzcGxheWVkKCdub25lJyk7XG5cbiAgICAgICAgICAgICAgICBwcmV2aWV3QnV0dG9uLmNoaWxkKCdpJykucmVtb3ZlQ2xhc3MoJ2ljb24tdG9nZ2xlLW9mZicpO1xuICAgICAgICAgICAgICAgIHByZXZpZXdCdXR0b24uY2hpbGQoJ2knKS5hZGRDbGFzcygnaWNvbi10b2dnbGUtb24nKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgZnVsbHNjcmVlbkJ1dHRvbi5hZGRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgaWNvbiA9IGZ1bGxzY3JlZW5CdXR0b24uY2hpbGQoJ2knKTtcblxuICAgICAgICAgICAgaWYgKGljb24uaGFzQ2xhc3MoJ2ljb24tZXhwYW5kJykpIHtcbiAgICAgICAgICAgICAgICBpY29uLnJlbW92ZUNsYXNzKCdpY29uLWV4cGFuZCcpO1xuICAgICAgICAgICAgICAgIGljb24uYWRkQ2xhc3MoJ2ljb24tY29tcHJlc3MnKTtcblxuICAgICAgICAgICAgICAgIHByZXZpZXcuc2V0RGlzcGxheWVkKCdibG9jaycpO1xuICAgICAgICAgICAgICAgIGNvbnRlbnQuc2V0RGlzcGxheWVkKCdibG9jaycpO1xuXG4gICAgICAgICAgICAgICAgcHJldmlld0J1dHRvbi5oaWRlKCk7XG5cbiAgICAgICAgICAgICAgICB3cmFwcGVyLmFkZENsYXNzKCdmdWxsc2NyZWVuJyk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmVkaXRvci5zZXRPcHRpb24oJ21heExpbmVzJywgbnVsbCk7XG5cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWNvbi5hZGRDbGFzcygnaWNvbi1leHBhbmQnKTtcbiAgICAgICAgICAgICAgICBpY29uLnJlbW92ZUNsYXNzKCdpY29uLWNvbXByZXNzJyk7XG5cbiAgICAgICAgICAgICAgICBwcmV2aWV3LnNldERpc3BsYXllZCgnbm9uZScpO1xuICAgICAgICAgICAgICAgIGNvbnRlbnQuc2V0RGlzcGxheWVkKCdibG9jaycpO1xuXG4gICAgICAgICAgICAgICAgcHJldmlld0J1dHRvbi5zaG93KCk7XG5cbiAgICAgICAgICAgICAgICB3cmFwcGVyLnJlbW92ZUNsYXNzKCdmdWxsc2NyZWVuJyk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmVkaXRvci5zZXRPcHRpb24oJ21heExpbmVzJywgSW5maW5pdHkpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBzdGF0dXNCYXIuc2V0RGlzcGxheWVkKCdibG9jaycpO1xuXG4gICAgICAgICAgICB0aGlzLmVkaXRvci5yZXNpemUodHJ1ZSk7XG4gICAgICAgIH0sIHRoaXMpO1xuXG4gICAgICAgIGlmIChtYXJrZG93bkVkaXRvci5jb250ZW50LmNvbnRlbnQpIHtcbiAgICAgICAgICAgIHRoaXMuZWRpdG9yLnNldFZhbHVlKG1hcmtkb3duRWRpdG9yLmNvbnRlbnQuY29udGVudCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5lZGl0b3Iuc2VsZWN0aW9uLmNsZWFyU2VsZWN0aW9uKCk7XG5cbiAgICAgICAgcHJldmlldy51cGRhdGUodGhpcy5wYXJzZSh0aGlzLmVkaXRvci5nZXRWYWx1ZSgpKSk7XG5cbiAgICAgICAgdGhpcy5lZGl0b3IuZ2V0U2Vzc2lvbigpLm9uKCdjaGFuZ2UnLCBmdW5jdGlvbihlKXtcbiAgICAgICAgICAgIG1kZS5wYXJzZShtZGUuZWRpdG9yLmdldFZhbHVlKCkpO1xuICAgICAgICB9KTtcbiAgICB9XG59KTtcblxuTU9EeC5sb2FkUlRFID0gZnVuY3Rpb24oaWQpIHtcbiAgICBuZXcgbWFya2Rvd25FZGl0b3IuRWRpdG9yKCk7XG59O1xuIiwibWFya2Rvd25FZGl0b3Iud2luZG93LkNyb3BwZXIgPSBmdW5jdGlvbihjb25maWcpIHtcbiAgICBjb25maWcgPSBjb25maWcgfHwge307XG4gICAgY29uZmlnLmNyb3BwZXJTZWxlY3RvciA9IGNvbmZpZy5jcm9wcGVyU2VsZWN0b3IgfHwgJy5pbWFnZS11cGxvYWQtd3JhcHBlciA+IGltZyc7XG5cbiAgICBFeHQuYXBwbHlJZihjb25maWcse1xuICAgICAgICBtb2RhbDogZmFsc2VcbiAgICAgICAgLGxheW91dDogJ2F1dG8nXG4gICAgICAgICxjbG9zZUFjdGlvbjogJ2hpZGUnXG4gICAgICAgICxzaGFkb3c6IHRydWVcbiAgICAgICAgLHJlc2l6YWJsZTogdHJ1ZVxuICAgICAgICAsY29sbGFwc2libGU6IHRydWVcbiAgICAgICAgLG1heGltaXphYmxlOiBmYWxzZVxuICAgICAgICAsYXV0b0hlaWdodDogZmFsc2VcbiAgICAgICAgLGF1dG9TY3JvbGw6IHRydWVcbiAgICAgICAgLGFsbG93RHJvcDogdHJ1ZVxuICAgICAgICAsd2lkdGg6IDgwMFxuICAgICAgICAsdGl0bGU6ICdDcm9wIHRoZSBpbWFnZSdcbiAgICAgICAgLGNsczogJ21vZHgtd2luZG93J1xuICAgICAgICAsaHRtbDogJzxkaXYgY2xhc3M9XCJpbWFnZS11cGxvYWQtd3JhcHBlclwiPjxpbWcgc3JjPVwiJyArIFVSTC5jcmVhdGVPYmplY3RVUkwoY29uZmlnLmZpbGUpICsgJ1wiPjwvZGl2PidcbiAgICAgICAgLHRiYXI6IFt7XG4gICAgICAgICAgICB0ZXh0OiAnPGkgY2xhc3M9XCJpY29uIGljb24tYXJyb3dzXCI+PC9pPiBNb3ZlJ1xuICAgICAgICAgICAgLHNjb3BlOiB0aGlzXG4gICAgICAgICAgICAscGFyYW06ICdtb3ZlJ1xuICAgICAgICAgICAgLGFjdGlvbjogJ3NldERyYWdNb2RlJ1xuICAgICAgICAgICAgLGhhbmRsZXI6IHRoaXMuY2FsbENyb3BwZXJBY3Rpb25cbiAgICAgICAgfSx7XG4gICAgICAgICAgICB0ZXh0OiAnPGkgY2xhc3M9XCJpY29uIGljb24tY3JvcFwiPjwvaT4gQ3JvcCdcbiAgICAgICAgICAgICxzY29wZTogdGhpc1xuICAgICAgICAgICAgLHBhcmFtOiAnY3JvcCdcbiAgICAgICAgICAgICxhY3Rpb246ICdzZXREcmFnTW9kZSdcbiAgICAgICAgICAgICxoYW5kbGVyOiB0aGlzLmNhbGxDcm9wcGVyQWN0aW9uXG4gICAgICAgIH0se1xuICAgICAgICAgICAgdGV4dDogJzxpIGNsYXNzPVwiaWNvbiBpY29uLXNlYXJjaC1wbHVzXCI+PC9pPiBab29tIEluJ1xuICAgICAgICAgICAgLHNjb3BlOiB0aGlzXG4gICAgICAgICAgICAscGFyYW06IDAuMVxuICAgICAgICAgICAgLGFjdGlvbjogJ3pvb20nXG4gICAgICAgICAgICAsaGFuZGxlcjogdGhpcy5jYWxsQ3JvcHBlckFjdGlvblxuICAgICAgICB9LHtcbiAgICAgICAgICAgIHRleHQ6ICc8aSBjbGFzcz1cImljb24gaWNvbi1zZWFyY2gtbWludXNcIj48L2k+IFpvb20gT3V0J1xuICAgICAgICAgICAgLHNjb3BlOiB0aGlzXG4gICAgICAgICAgICAscGFyYW06IC0wLjFcbiAgICAgICAgICAgICxhY3Rpb246ICd6b29tJ1xuICAgICAgICAgICAgLGhhbmRsZXI6IHRoaXMuY2FsbENyb3BwZXJBY3Rpb25cbiAgICAgICAgfSx7XG4gICAgICAgICAgICB0ZXh0OiAnPGkgY2xhc3M9XCJpY29uIGljb24tcm90YXRlLWxlZnRcIj48L2k+IFJvdGF0ZSBsZWZ0J1xuICAgICAgICAgICAgLHNjb3BlOiB0aGlzXG4gICAgICAgICAgICAscGFyYW06IC05MFxuICAgICAgICAgICAgLGFjdGlvbjogJ3JvdGF0ZSdcbiAgICAgICAgICAgICxoYW5kbGVyOiB0aGlzLmNhbGxDcm9wcGVyQWN0aW9uXG4gICAgICAgIH0se1xuICAgICAgICAgICAgdGV4dDogJzxpIGNsYXNzPVwiaWNvbiBpY29uLXJvdGF0ZS1yaWdodFwiPjwvaT4gUm90YXRlIHJpZ2h0J1xuICAgICAgICAgICAgLHNjb3BlOiB0aGlzXG4gICAgICAgICAgICAscGFyYW06IDkwXG4gICAgICAgICAgICAsYWN0aW9uOiAncm90YXRlJ1xuICAgICAgICAgICAgLGhhbmRsZXI6IHRoaXMuY2FsbENyb3BwZXJBY3Rpb25cbiAgICAgICAgfSx7XG4gICAgICAgICAgICB0ZXh0OiAnPGkgY2xhc3M9XCJpY29uIGljb24tcmVtb3ZlXCI+PC9pPiBDbGVhciBjcm9wcGVyJ1xuICAgICAgICAgICAgLHNjb3BlOiB0aGlzXG4gICAgICAgICAgICAscGFyYW06IG51bGxcbiAgICAgICAgICAgICxhY3Rpb246ICdjbGVhcidcbiAgICAgICAgICAgICxoYW5kbGVyOiB0aGlzLmNhbGxDcm9wcGVyQWN0aW9uXG4gICAgICAgIH1dXG4gICAgICAgICxidXR0b25zOiBbe1xuICAgICAgICAgICAgdGV4dDogXygnY2FuY2VsJylcbiAgICAgICAgICAgICxzY29wZTogdGhpc1xuICAgICAgICAgICAgLGhhbmRsZXI6IHRoaXMuY2xvc2VcbiAgICAgICAgfSx7XG4gICAgICAgICAgICB0ZXh0OiAnVXBsb2FkJ1xuICAgICAgICAgICAgLGNsczogJ3ByaW1hcnktYnV0dG9uJ1xuICAgICAgICAgICAgLHNjb3BlOiB0aGlzXG4gICAgICAgICAgICAsY3JvcDogMFxuICAgICAgICAgICAgLGhhbmRsZXI6IHRoaXMudXBsb2FkXG4gICAgICAgIH0se1xuICAgICAgICAgICAgdGV4dDogJ0Nyb3AgJiBVcGxvYWQnXG4gICAgICAgICAgICAsY2xzOiAncHJpbWFyeS1idXR0b24nXG4gICAgICAgICAgICAsc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICxjcm9wOiAxXG4gICAgICAgICAgICAsaGFuZGxlcjogdGhpcy51cGxvYWRcbiAgICAgICAgfV1cbiAgICAgICAgLGxpc3RlbmVyczoge1xuICAgICAgICAgICAgJ3Nob3cnOiB7XG4gICAgICAgICAgICAgICAgZm46IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgY3JvcHBlck9wdGlvbnMgPSB7fTtcblxuICAgICAgICAgICAgICAgICAgICB2YXIgcmF0aW8gPSBNT0R4LmNvbmZpZ1snbWFya2Rvd25lZGl0b3IuY3JvcHBlci5hc3BlY3RfcmF0aW8nXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJhdGlvKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByYXRpby5yZXBsYWNlKC9bXi06eCgpXFxkLyorLl0vZywgJycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmF0aW8gPSBldmFsKHJhdGlvKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgY3JvcHBlck9wdGlvbnMuYXNwZWN0UmF0aW8gPSByYXRpbztcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGNyb3BwZXJPcHRpb25zLmNyb3AgPSBmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbWFnZURhdGEgPSBbXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3tcInhcIjonICsgZGF0YS54LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdcInlcIjonICsgZGF0YS55LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdcImhlaWdodFwiOicgKyBkYXRhLmhlaWdodCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnXCJ3aWR0aFwiOicgKyBkYXRhLndpZHRoLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdcInJvdGF0ZVwiOicgKyBkYXRhLnJvdGF0ZSArICd9J1xuICAgICAgICAgICAgICAgICAgICAgICAgXS5qb2luKCk7XG4gICAgICAgICAgICAgICAgICAgIH0uYmluZCh0aGlzKTtcblxuICAgICAgICAgICAgICAgICAgICAkKGNvbmZpZy5jcm9wcGVyU2VsZWN0b3IpLmNyb3BwZXIoY3JvcHBlck9wdGlvbnMpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgc2NvcGU6IHRoaXNcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0pO1xuICAgIG1hcmtkb3duRWRpdG9yLndpbmRvdy5Dcm9wcGVyLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLGNvbmZpZyk7XG4gICAgdGhpcy5jb25maWcgPSBjb25maWc7XG5cbn07XG5FeHQuZXh0ZW5kKG1hcmtkb3duRWRpdG9yLndpbmRvdy5Dcm9wcGVyLCBFeHQuV2luZG93LHtcbiAgICBpbWFnZURhdGE6ICcnXG4gICAgLHVwbG9hZDogZnVuY3Rpb24oYnV0dG9uKSB7XG4gICAgICAgIHZhciBzYiA9IEV4dC5nZXQoJ3N0YXR1cy1iYXInKTtcbiAgICAgICAgdmFyIHVwbG9hZGVyID0gRXh0LkRvbUhlbHBlci5pbnNlcnRGaXJzdChzYix7XG4gICAgICAgICAgICB0YWc6ICdkaXYnLFxuICAgICAgICAgICAgaWQ6ICd1cGxvYWRfcHJvZ3Jlc3MnLFxuICAgICAgICAgICAgaHRtbDogJzxkaXYgY2xhc3M9XCJwcm9ncmVzc1wiPjwvZGl2PjxpIGNsYXNzPVwiaWNvbiBpY29uLXNwaW5uZXIgaWNvbi1zcGluXCI+PC9pPiBVcGxvYWRpbmcgaW1hZ2U6ICcgKyB0aGlzLmNvbmZpZy5maWxlLm5hbWVcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdmFyIGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnZmlsZScsIHRoaXMuY29uZmlnLmZpbGUpO1xuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ2FjdGlvbicsICdtZ3IvZWRpdG9yL2ltYWdldXBsb2FkJyk7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnaW1hZ2VEYXRhJywgdGhpcy5pbWFnZURhdGEpO1xuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ25hbWUnLCB0aGlzLmNvbmZpZy5maWxlLm5hbWUpO1xuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ2Nyb3AnLCBidXR0b24uY3JvcCk7XG5cbiAgICAgICAgdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgICAgICB4aHIub3BlbignUE9TVCcsIG1hcmtkb3duRWRpdG9yLmNvbmZpZy5jb25uZWN0b3JVcmwpO1xuICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignUG93ZXJlZC1CeScsICdNT0R4Jyk7XG4gICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdtb2RBdXRoJywgRXh0LkFqYXguZGVmYXVsdEhlYWRlcnMubW9kQXV0aCk7XG5cbiAgICAgICAgeGhyLnVwbG9hZC5vbnByb2dyZXNzID0gZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgICAgICBpZiAoZXZlbnQubGVuZ3RoQ29tcHV0YWJsZSkge1xuICAgICAgICAgICAgICAgIHZhciBjb21wbGV0ZSA9IChldmVudC5sb2FkZWQgLyBldmVudC50b3RhbCAqIDEwMCB8IDApO1xuICAgICAgICAgICAgICAgIHNiLmNoaWxkKCcucHJvZ3Jlc3MnKS5zZXRXaWR0aChjb21wbGV0ZSArICclJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgeGhyLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmICh4aHIuc3RhdHVzID09PSAyMDApIHtcbiAgICAgICAgICAgICAgICB2YXIgcmVzID0gSlNPTi5wYXJzZSh4aHIucmVzcG9uc2VUZXh0KTtcbiAgICAgICAgICAgICAgICBpZiAocmVzLnN1Y2Nlc3MgPT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgICAgICB1cGxvYWRlci5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb25maWcubWQuZWRpdG9yLmluc2VydCgnIVsnICsgcmVzLm9iamVjdC5uYW1lICsgJ10oJyArIHJlcy5vYmplY3QucGF0aCArICcgXCInICsgcmVzLm9iamVjdC5uYW1lICsgJ1wiKVxcbicpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfS5iaW5kKHRoaXMpO1xuXG4gICAgICAgIHhoci5zZW5kKGZvcm1EYXRhKTtcblxuICAgICAgICAkKHRoaXMuY29uZmlnLmNyb3BwZXJTZWxlY3RvcikuY3JvcHBlcihcImRlc3Ryb3lcIik7XG4gICAgICAgIHRoaXMuY2xvc2UoKTtcbiAgICB9XG5cbiAgICAsY2FsbENyb3BwZXJBY3Rpb246IGZ1bmN0aW9uKGJ0bikge1xuICAgICAgICAkKHRoaXMuY29uZmlnLmNyb3BwZXJTZWxlY3RvcikuY3JvcHBlcihidG4uYWN0aW9uLCBidG4ucGFyYW0pO1xuICAgIH1cbn0pO1xuRXh0LnJlZygnbWFya2Rvd25lZGl0b3Itd2luZG93LWNyb3BwZXInLG1hcmtkb3duRWRpdG9yLndpbmRvdy5Dcm9wcGVyKTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==