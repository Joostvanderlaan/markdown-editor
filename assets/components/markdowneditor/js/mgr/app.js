var MarkdownEditor=function(e){e=e||{},MarkdownEditor.superclass.constructor.call(this,e)};Ext.override(MODx.panel.Resource,{}),Ext.extend(MarkdownEditor,Ext.Component,{remarkable:"",initComponent:function(){MarkdownEditor.superclass.initComponent.call(this),Ext.onReady(this.render,this)},parseRequest:"",parse:function(e){var t=this.remarkable.render(e);return t=t.replace(/%5B/g,"["),t=t.replace(/%5D/g,"]"),this.parseRequest&&clearTimeout(this.parseRequest),this.parseRequest=setTimeout(function(){MODx.Ajax.request({url:MarkdownEditor_config.connectorUrl,params:{action:"mgr/editor/processcontent",content:t,resource:MODx.request.id},isUpload:!0,listeners:{success:{fn:function(e){Ext.get("preview-md").update(e.data)},scope:this}}})},150),this.taMarkdown.dom.value=this.editor.getValue(),this.textarea.dom.value=t,t},buildUI:function(){this.textarea.setDisplayed("none"),this.textarea.setWidth(0),this.textarea.setHeight(0),Ext.DomHelper.insertBefore(this.textarea,{tag:"textarea",name:"ta_markdown",id:"ta_markdown"}),this.taMarkdown=Ext.get("ta_markdown"),this.taMarkdown.setDisplayed("none"),this.taMarkdown.setWidth(0),this.taMarkdown.setHeight(0);var e=Ext.DomHelper.insertBefore(this.textarea,{tag:"div","class":"markdown-container"});Ext.DomHelper.append(e,{tag:"div",id:"content-md","class":this.textarea.dom.className}),Ext.DomHelper.append(e,{tag:"div",id:"preview-md","class":"markdown-body"}),Ext.DomHelper.append(e,{tag:"div",id:"toolbox",cn:[{tag:"span",id:"preview-button",html:'<i class="icon icon-toggle-off"></i> Preview'},{tag:"span",id:"fullscreen-button",html:'<i class="icon icon-expand"></i>'}]}),Ext.DomHelper.append(e,{tag:"span",style:"clear: both"})},registerAce:function(){this.editor=ace.edit(Ext.DomQuery.selectNode("div#content-md")),this.editor.setOptions({maxLines:1/0,minLines:25,enableBasicAutocompletion:!0}),this.editor.renderer.setShowGutter(!0),this.editor.renderer.setScrollMargin(10,10),this.editor.getSession().setValue(this.textarea.getValue()),this.editor.getSession().setMode("ace/mode/markdown"),this.editor.setTheme("ace/theme/monokai");var e=ace.require("ace/ext/language_tools"),t={getCompletions:function(e,t,i,s,o){return 0===s.length?(o(null,[]),void 0):(MODx.Ajax.request({url:MarkdownEditor_config.connectorUrl,params:{action:"mgr/resource/getlist",prefix:s},listeners:{success:{fn:function(e){o(null,e.results)},scope:this}}}),void 0)}};e.addCompleter(t),this.editor.container.addEventListener("dragenter",this.catchAndDoNothing,!1),this.editor.container.addEventListener("dragover",this.catchAndDoNothing,!1),this.editor.container.addEventListener("drop",this.drop.bind(this),!1)},catchAndDoNothing:function(e){e.stopPropagation(),e.preventDefault()},drop:function(e){e.stopPropagation(),e.preventDefault(),Ext.each(e.dataTransfer.files,function(e){var t=new FormData;t.append("file",e),t.append("action","mgr/editor/upload");var i=new XMLHttpRequest;i.open("POST",MarkdownEditor_config.connectorUrl),i.setRequestHeader("Powered-By","MODx"),i.setRequestHeader("modAuth",Ext.Ajax.defaultHeaders.modAuth),i.onload=function(){if(200===i.status){var e=JSON.parse(i.responseText);1==e.success&&(console.log(e),this.editor.insert("!["+e.name+"]("+e.path+")")),console.log("all done: "+i.status)}else console.log("Something went terribly wrong...")}.bind(this),i.send(t)},this)},registerMarked:function(){this.remarkable=new Remarkable({html:!0,highlight:function(e,t){if(t&&hljs.getLanguage(t))try{return hljs.highlight(t,e).value}catch(i){}try{return hljs.highlightAuto(e).value}catch(i){}return""}}),this.remarkable.inline.ruler.disable(["backticks"])},render:function(){var e=this;this.textarea=Ext.get("ta"),this.buildUI(),this.registerAce(),this.registerMarked();var t=Ext.get("preview-button"),i=Ext.get("fullscreen-button"),s=Ext.get("preview-md"),o=Ext.get("content-md"),n=o.parent(),r=MODx.load({xtype:"modx-treedrop",target:o,targetEl:o,onInsert:function(e){return this.insert(e),this.focus(),!0}.bind(this.editor),iframe:!0});this.textarea.on("destroy",function(){r.destroy()}),t.addListener("click",function(){s.isVisible()?(s.setDisplayed("none"),o.setDisplayed("block"),t.child("i").removeClass("icon-toggle-on"),t.child("i").addClass("icon-toggle-off")):(s.setDisplayed("block"),o.setDisplayed("none"),t.child("i").removeClass("icon-toggle-off"),t.child("i").addClass("icon-toggle-on"))}),i.addListener("click",function(){var e=i.child("i");e.hasClass("icon-expand")?(e.removeClass("icon-expand"),e.addClass("icon-compress"),s.setDisplayed("block"),o.setDisplayed("block"),t.hide(),n.addClass("fullscreen"),this.editor.setOption("maxLines",null)):(e.addClass("icon-expand"),e.removeClass("icon-compress"),s.setDisplayed("none"),o.setDisplayed("block"),t.show(),n.removeClass("fullscreen"),this.editor.setOption("maxLines",1/0)),this.editor.resize(!0)},this),this.editor.setValue(MarkdownEditor_content.content),this.editor.selection.clearSelection(),s.update(this.parse(this.editor.getValue())),this.editor.getSession().on("change",function(){e.parse(e.editor.getValue())})}}),MarkdownEditor=new MarkdownEditor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxHQUFBLGdCQUFBLFNBQUEsR0FDQSxFQUFBLE1BQ0EsZUFBQSxXQUFBLFlBQUEsS0FBQSxLQUFBLEdBRUEsS0FBQSxTQUFBLEtBQUEsTUFBQSxhQUVBLElBQUEsT0FBQSxlQUFBLElBQUEsV0FDQSxXQUFBLEdBQ0EsY0FBQSxXQUNBLGVBQUEsV0FBQSxjQUFBLEtBQUEsTUFFQSxJQUFBLFFBQUEsS0FBQSxPQUFBLE9BR0EsYUFBQSxHQUNBLE1BQUEsU0FBQSxHQUNBLEdBQUEsR0FBQSxLQUFBLFdBQUEsT0FBQSxFQWdDQSxPQTlCQSxHQUFBLEVBQUEsUUFBQSxPQUFBLEtBQ0EsRUFBQSxFQUFBLFFBQUEsT0FBQSxLQUVBLEtBQUEsY0FDQSxhQUFBLEtBQUEsY0FHQSxLQUFBLGFBQUEsV0FBQSxXQUNBLEtBQUEsS0FBQSxTQUNBLElBQUEsc0JBQUEsYUFDQSxRQUNBLE9BQUEsNEJBQ0EsUUFBQSxFQUNBLFNBQUEsS0FBQSxRQUFBLElBRUEsVUFBQSxFQUNBLFdBQ0EsU0FDQSxHQUFBLFNBQUEsR0FDQSxJQUFBLElBQUEsY0FBQSxPQUFBLEVBQUEsT0FFQSxNQUFBLFVBSUEsS0FFQSxLQUFBLFdBQUEsSUFBQSxNQUFBLEtBQUEsT0FBQSxXQUNBLEtBQUEsU0FBQSxJQUFBLE1BQUEsRUFFQSxHQUdBLFFBQUEsV0FDQSxLQUFBLFNBQUEsYUFBQSxRQUNBLEtBQUEsU0FBQSxTQUFBLEdBQ0EsS0FBQSxTQUFBLFVBQUEsR0FFQSxJQUFBLFVBQUEsYUFBQSxLQUFBLFVBQ0EsSUFBQSxXQUNBLEtBQUEsY0FDQSxHQUFBLGdCQUdBLEtBQUEsV0FBQSxJQUFBLElBQUEsZUFDQSxLQUFBLFdBQUEsYUFBQSxRQUNBLEtBQUEsV0FBQSxTQUFBLEdBQ0EsS0FBQSxXQUFBLFVBQUEsRUFFQSxJQUFBLEdBQUEsSUFBQSxVQUFBLGFBQUEsS0FBQSxVQUNBLElBQUEsTUFDQSxRQUFBLHNCQUdBLEtBQUEsVUFBQSxPQUFBLEdBQ0EsSUFBQSxNQUNBLEdBQUEsYUFDQSxRQUFBLEtBQUEsU0FBQSxJQUFBLFlBR0EsSUFBQSxVQUFBLE9BQUEsR0FDQSxJQUFBLE1BQ0EsR0FBQSxhQUNBLFFBQUEsa0JBR0EsSUFBQSxVQUFBLE9BQUEsR0FDQSxJQUFBLE1BQ0EsR0FBQSxVQUNBLEtBQ0EsSUFBQSxPQUNBLEdBQUEsaUJBQ0EsS0FBQSxpREFFQSxJQUFBLE9BQ0EsR0FBQSxvQkFDQSxLQUFBLHVDQUlBLElBQUEsVUFBQSxPQUFBLEdBQ0EsSUFBQSxPQUNBLE1BQUEsaUJBSUEsWUFBQSxXQUVBLEtBQUEsT0FBQSxJQUFBLEtBQUEsSUFBQSxTQUFBLFdBQUEsbUJBQ0EsS0FBQSxPQUFBLFlBQ0EsU0FBQSxJQUNBLFNBQUEsR0FDQSwyQkFBQSxJQUVBLEtBQUEsT0FBQSxTQUFBLGVBQUEsR0FDQSxLQUFBLE9BQUEsU0FBQSxnQkFBQSxHQUFBLElBQ0EsS0FBQSxPQUFBLGFBQUEsU0FBQSxLQUFBLFNBQUEsWUFDQSxLQUFBLE9BQUEsYUFBQSxRQUFBLHFCQUNBLEtBQUEsT0FBQSxTQUFBLG9CQUVBLElBQUEsR0FBQSxJQUFBLFFBQUEsMEJBQ0EsR0FDQSxlQUFBLFNBQUEsRUFBQSxFQUFBLEVBQUEsRUFBQSxHQUNBLE1BQUEsS0FBQSxFQUFBLFFBQUEsRUFBQSxTQUFBLFNBQ0EsS0FBQSxLQUFBLFNBQ0EsSUFBQSxzQkFBQSxhQUNBLFFBQ0EsT0FBQSx1QkFDQSxPQUFBLEdBRUEsV0FDQSxTQUNBLEdBQUEsU0FBQSxHQUNBLEVBQUEsS0FBQSxFQUFBLFVBRUEsTUFBQSxTQVhBLFNBa0JBLEdBQUEsYUFBQSxHQUVBLEtBQUEsT0FBQSxVQUFBLGlCQUFBLFlBQUEsS0FBQSxtQkFBQSxHQUNBLEtBQUEsT0FBQSxVQUFBLGlCQUFBLFdBQUEsS0FBQSxtQkFBQSxHQUNBLEtBQUEsT0FBQSxVQUFBLGlCQUFBLE9BQUEsS0FBQSxLQUFBLEtBQUEsT0FBQSxJQUdBLGtCQUFBLFNBQUEsR0FDQSxFQUFBLGtCQUNBLEVBQUEsa0JBR0EsS0FBQSxTQUFBLEdBQ0EsRUFBQSxrQkFDQSxFQUFBLGlCQUVBLElBQUEsS0FBQSxFQUFBLGFBQUEsTUFBQSxTQUFBLEdBQ0EsR0FBQSxHQUFBLEdBQUEsU0FDQSxHQUFBLE9BQUEsT0FBQSxHQUNBLEVBQUEsT0FBQSxTQUFBLG9CQUVBLElBQUEsR0FBQSxHQUFBLGVBQ0EsR0FBQSxLQUFBLE9BQUEsc0JBQUEsY0FDQSxFQUFBLGlCQUFBLGFBQUEsUUFDQSxFQUFBLGlCQUFBLFVBQUEsSUFBQSxLQUFBLGVBQUEsU0FTQSxFQUFBLE9BQUEsV0FDQSxHQUFBLE1BQUEsRUFBQSxPQUFBLENBQ0EsR0FBQSxHQUFBLEtBQUEsTUFBQSxFQUFBLGFBQ0EsSUFBQSxFQUFBLFVBQ0EsUUFBQSxJQUFBLEdBQ0EsS0FBQSxPQUFBLE9BQUEsS0FBQSxFQUFBLEtBQUEsS0FBQSxFQUFBLEtBQUEsTUFFQSxRQUFBLElBQUEsYUFBQSxFQUFBLFlBRUEsU0FBQSxJQUFBLHFDQUVBLEtBQUEsTUFFQSxFQUFBLEtBQUEsSUFFQSxPQUlBLGVBQUEsV0FFQSxLQUFBLFdBQUEsR0FBQSxhQUNBLE1BQUEsRUFDQSxVQUFBLFNBQUEsRUFBQSxHQUNBLEdBQUEsR0FBQSxLQUFBLFlBQUEsR0FDQSxJQUNBLE1BQUEsTUFBQSxVQUFBLEVBQUEsR0FBQSxNQUNBLE1BQUEsSUFHQSxJQUNBLE1BQUEsTUFBQSxjQUFBLEdBQUEsTUFDQSxNQUFBLElBRUEsTUFBQSxNQUdBLEtBQUEsV0FBQSxPQUFBLE1BQUEsU0FBQSxlQUdBLE9BQUEsV0FDQSxHQUFBLEdBQUEsSUFDQSxNQUFBLFNBQUEsSUFBQSxJQUFBLE1BRUEsS0FBQSxVQUNBLEtBQUEsY0FDQSxLQUFBLGdCQVVBLElBQUEsR0FBQSxJQUFBLElBQUEsa0JBQ0EsRUFBQSxJQUFBLElBQUEscUJBQ0EsRUFBQSxJQUFBLElBQUEsY0FDQSxFQUFBLElBQUEsSUFBQSxjQUNBLEVBQUEsRUFBQSxTQUVBLEVBQUEsS0FBQSxNQUNBLE1BQUEsZ0JBQ0EsT0FBQSxFQUNBLFNBQUEsRUFDQSxTQUFBLFNBQUEsR0FHQSxNQUZBLE1BQUEsT0FBQSxHQUNBLEtBQUEsU0FDQSxHQUNBLEtBQUEsS0FBQSxRQUNBLFFBQUEsR0FFQSxNQUFBLFNBQUEsR0FBQSxVQUFBLFdBQUEsRUFBQSxZQUVBLEVBQUEsWUFBQSxRQUFBLFdBQ0EsRUFBQSxhQUNBLEVBQUEsYUFBQSxRQUNBLEVBQUEsYUFBQSxTQUVBLEVBQUEsTUFBQSxLQUFBLFlBQUEsa0JBQ0EsRUFBQSxNQUFBLEtBQUEsU0FBQSxxQkFFQSxFQUFBLGFBQUEsU0FDQSxFQUFBLGFBQUEsUUFFQSxFQUFBLE1BQUEsS0FBQSxZQUFBLG1CQUNBLEVBQUEsTUFBQSxLQUFBLFNBQUEscUJBSUEsRUFBQSxZQUFBLFFBQUEsV0FDQSxHQUFBLEdBQUEsRUFBQSxNQUFBLElBRUEsR0FBQSxTQUFBLGdCQUNBLEVBQUEsWUFBQSxlQUNBLEVBQUEsU0FBQSxpQkFFQSxFQUFBLGFBQUEsU0FDQSxFQUFBLGFBQUEsU0FFQSxFQUFBLE9BRUEsRUFBQSxTQUFBLGNBRUEsS0FBQSxPQUFBLFVBQUEsV0FBQSxRQUlBLEVBQUEsU0FBQSxlQUNBLEVBQUEsWUFBQSxpQkFFQSxFQUFBLGFBQUEsUUFDQSxFQUFBLGFBQUEsU0FFQSxFQUFBLE9BRUEsRUFBQSxZQUFBLGNBRUEsS0FBQSxPQUFBLFVBQUEsV0FBQSxNQUtBLEtBQUEsT0FBQSxRQUFBLElBQ0EsTUFFQSxLQUFBLE9BQUEsU0FBQSx1QkFBQSxTQUNBLEtBQUEsT0FBQSxVQUFBLGlCQUVBLEVBQUEsT0FBQSxLQUFBLE1BQUEsS0FBQSxPQUFBLGFBRUEsS0FBQSxPQUFBLGFBQUEsR0FBQSxTQUFBLFdBQ0EsRUFBQSxNQUFBLEVBQUEsT0FBQSxpQkFTQSxlQUFBLEdBQUEiLCJmaWxlIjoiYXBwLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIE1hcmtkb3duRWRpdG9yID0gZnVuY3Rpb24oY29uZmlnKSB7XG4gICAgY29uZmlnID0gY29uZmlnIHx8IHt9O1xuICAgIE1hcmtkb3duRWRpdG9yLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLGNvbmZpZyk7XG59O1xuRXh0Lm92ZXJyaWRlKE1PRHgucGFuZWwuUmVzb3VyY2UsIHt9KTtcblxuRXh0LmV4dGVuZChNYXJrZG93bkVkaXRvcixFeHQuQ29tcG9uZW50LHtcbiAgICByZW1hcmthYmxlOiAnJ1xuICAgICxpbml0Q29tcG9uZW50OiBmdW5jdGlvbigpIHtcbiAgICAgICAgTWFya2Rvd25FZGl0b3Iuc3VwZXJjbGFzcy5pbml0Q29tcG9uZW50LmNhbGwodGhpcyk7XG5cbiAgICAgICAgRXh0Lm9uUmVhZHkodGhpcy5yZW5kZXIsIHRoaXMpO1xuICAgIH1cblxuICAgICxwYXJzZVJlcXVlc3Q6ICcnXG4gICAgLHBhcnNlOiBmdW5jdGlvbihpbnB1dCkge1xuICAgICAgICB2YXIgb3V0cHV0ID0gdGhpcy5yZW1hcmthYmxlLnJlbmRlcihpbnB1dCk7XG5cbiAgICAgICAgb3V0cHV0ID0gb3V0cHV0LnJlcGxhY2UoLyU1Qi9nLCAnWycpO1xuICAgICAgICBvdXRwdXQgPSBvdXRwdXQucmVwbGFjZSgvJTVEL2csICddJyk7XG5cbiAgICAgICAgaWYgKHRoaXMucGFyc2VSZXF1ZXN0KSB7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5wYXJzZVJlcXVlc3QpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5wYXJzZVJlcXVlc3QgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICBNT0R4LkFqYXgucmVxdWVzdCh7XG4gICAgICAgICAgICAgICAgdXJsOiBNYXJrZG93bkVkaXRvcl9jb25maWcuY29ubmVjdG9yVXJsXG4gICAgICAgICAgICAgICAgLHBhcmFtczoge1xuICAgICAgICAgICAgICAgICAgICBhY3Rpb246ICdtZ3IvZWRpdG9yL3Byb2Nlc3Njb250ZW50J1xuICAgICAgICAgICAgICAgICAgICAsY29udGVudDogb3V0cHV0XG4gICAgICAgICAgICAgICAgICAgICxyZXNvdXJjZTogTU9EeC5yZXF1ZXN0LmlkXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBpc1VwbG9hZCA6IHRydWUsXG4gICAgICAgICAgICAgICAgbGlzdGVuZXJzOiB7XG4gICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm46IGZ1bmN0aW9uKHIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBFeHQuZ2V0KCdwcmV2aWV3LW1kJykudXBkYXRlKHIuZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9LCAxNTApO1xuXG4gICAgICAgIHRoaXMudGFNYXJrZG93bi5kb20udmFsdWUgPSB0aGlzLmVkaXRvci5nZXRWYWx1ZSgpO1xuICAgICAgICB0aGlzLnRleHRhcmVhLmRvbS52YWx1ZSA9IG91dHB1dDtcblxuICAgICAgICByZXR1cm4gb3V0cHV0O1xuICAgIH1cblxuICAgICxidWlsZFVJOiBmdW5jdGlvbigpIHtcbiAgICAgICAgdGhpcy50ZXh0YXJlYS5zZXREaXNwbGF5ZWQoJ25vbmUnKTtcbiAgICAgICAgdGhpcy50ZXh0YXJlYS5zZXRXaWR0aCgwKTtcbiAgICAgICAgdGhpcy50ZXh0YXJlYS5zZXRIZWlnaHQoMCk7XG5cbiAgICAgICAgRXh0LkRvbUhlbHBlci5pbnNlcnRCZWZvcmUodGhpcy50ZXh0YXJlYSwge1xuICAgICAgICAgICAgdGFnOiAndGV4dGFyZWEnLFxuICAgICAgICAgICAgbmFtZTogJ3RhX21hcmtkb3duJyxcbiAgICAgICAgICAgIGlkOiAndGFfbWFya2Rvd24nXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMudGFNYXJrZG93biA9IEV4dC5nZXQoJ3RhX21hcmtkb3duJyk7XG4gICAgICAgIHRoaXMudGFNYXJrZG93bi5zZXREaXNwbGF5ZWQoJ25vbmUnKTtcbiAgICAgICAgdGhpcy50YU1hcmtkb3duLnNldFdpZHRoKDApO1xuICAgICAgICB0aGlzLnRhTWFya2Rvd24uc2V0SGVpZ2h0KDApO1xuXG4gICAgICAgIHZhciB3cmFwcGVyID0gRXh0LkRvbUhlbHBlci5pbnNlcnRCZWZvcmUodGhpcy50ZXh0YXJlYSwge1xuICAgICAgICAgICAgdGFnOiAnZGl2JyxcbiAgICAgICAgICAgIGNsYXNzOiAnbWFya2Rvd24tY29udGFpbmVyJ1xuICAgICAgICB9KTtcblxuICAgICAgICBFeHQuRG9tSGVscGVyLmFwcGVuZCh3cmFwcGVyLHtcbiAgICAgICAgICAgIHRhZzogJ2RpdicsXG4gICAgICAgICAgICBpZDogJ2NvbnRlbnQtbWQnLFxuICAgICAgICAgICAgY2xhc3M6IHRoaXMudGV4dGFyZWEuZG9tLmNsYXNzTmFtZVxuICAgICAgICB9KTtcblxuICAgICAgICBFeHQuRG9tSGVscGVyLmFwcGVuZCh3cmFwcGVyLHtcbiAgICAgICAgICAgIHRhZzogJ2RpdicsXG4gICAgICAgICAgICBpZDogJ3ByZXZpZXctbWQnLFxuICAgICAgICAgICAgY2xhc3M6ICdtYXJrZG93bi1ib2R5J1xuICAgICAgICB9KTtcblxuICAgICAgICBFeHQuRG9tSGVscGVyLmFwcGVuZCh3cmFwcGVyLHtcbiAgICAgICAgICAgIHRhZzogJ2RpdicsXG4gICAgICAgICAgICBpZDogJ3Rvb2xib3gnLFxuICAgICAgICAgICAgY246IFt7XG4gICAgICAgICAgICAgICAgdGFnOiAnc3BhbicsXG4gICAgICAgICAgICAgICAgaWQ6ICdwcmV2aWV3LWJ1dHRvbicsXG4gICAgICAgICAgICAgICAgaHRtbDogJzxpIGNsYXNzPVwiaWNvbiBpY29uLXRvZ2dsZS1vZmZcIj48L2k+IFByZXZpZXcnXG4gICAgICAgICAgICB9LHtcbiAgICAgICAgICAgICAgICB0YWc6ICdzcGFuJyxcbiAgICAgICAgICAgICAgICBpZDogJ2Z1bGxzY3JlZW4tYnV0dG9uJyxcbiAgICAgICAgICAgICAgICBodG1sOiAnPGkgY2xhc3M9XCJpY29uIGljb24tZXhwYW5kXCI+PC9pPidcbiAgICAgICAgICAgIH1dXG4gICAgICAgIH0pO1xuXG4gICAgICAgIEV4dC5Eb21IZWxwZXIuYXBwZW5kKHdyYXBwZXIse1xuICAgICAgICAgICAgdGFnOiAnc3BhbicsXG4gICAgICAgICAgICBzdHlsZTogJ2NsZWFyOiBib3RoJyxcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLHJlZ2lzdGVyQWNlOiBmdW5jdGlvbigpIHtcbiAgICAgICAgdmFyIG1kZSA9IHRoaXM7XG4gICAgICAgIHRoaXMuZWRpdG9yID0gYWNlLmVkaXQoRXh0LkRvbVF1ZXJ5LnNlbGVjdE5vZGUoJ2RpdiNjb250ZW50LW1kJykpO1xuICAgICAgICB0aGlzLmVkaXRvci5zZXRPcHRpb25zKHtcbiAgICAgICAgICAgIG1heExpbmVzOiBJbmZpbml0eSxcbiAgICAgICAgICAgIG1pbkxpbmVzOiAyNSxcbiAgICAgICAgICAgIGVuYWJsZUJhc2ljQXV0b2NvbXBsZXRpb246IHRydWVcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuZWRpdG9yLnJlbmRlcmVyLnNldFNob3dHdXR0ZXIodHJ1ZSk7XG4gICAgICAgIHRoaXMuZWRpdG9yLnJlbmRlcmVyLnNldFNjcm9sbE1hcmdpbigxMCwgMTApO1xuICAgICAgICB0aGlzLmVkaXRvci5nZXRTZXNzaW9uKCkuc2V0VmFsdWUodGhpcy50ZXh0YXJlYS5nZXRWYWx1ZSgpKTtcbiAgICAgICAgdGhpcy5lZGl0b3IuZ2V0U2Vzc2lvbigpLnNldE1vZGUoXCJhY2UvbW9kZS9tYXJrZG93blwiKTtcbiAgICAgICAgdGhpcy5lZGl0b3Iuc2V0VGhlbWUoXCJhY2UvdGhlbWUvbW9ub2thaVwiKTtcblxuICAgICAgICB2YXIgbGFuZ1Rvb2xzID0gYWNlLnJlcXVpcmUoXCJhY2UvZXh0L2xhbmd1YWdlX3Rvb2xzXCIpO1xuICAgICAgICB2YXIgcmh5bWVDb21wbGV0ZXIgPSB7XG4gICAgICAgICAgICBnZXRDb21wbGV0aW9uczogZnVuY3Rpb24oZWRpdG9yLCBzZXNzaW9uLCBwb3MsIHByZWZpeCwgY2FsbGJhY2spIHtcbiAgICAgICAgICAgICAgICBpZiAocHJlZml4Lmxlbmd0aCA9PT0gMCkgeyBjYWxsYmFjayhudWxsLCBbXSk7IHJldHVybiB9XG4gICAgICAgICAgICAgICAgTU9EeC5BamF4LnJlcXVlc3Qoe1xuICAgICAgICAgICAgICAgICAgICB1cmw6IE1hcmtkb3duRWRpdG9yX2NvbmZpZy5jb25uZWN0b3JVcmxcbiAgICAgICAgICAgICAgICAgICAgLHBhcmFtczoge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uOiAnbWdyL3Jlc291cmNlL2dldGxpc3QnXG4gICAgICAgICAgICAgICAgICAgICAgICAscHJlZml4OiBwcmVmaXhcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAnc3VjY2Vzcyc6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbjogZnVuY3Rpb24ocikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCByLnJlc3VsdHMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIGxhbmdUb29scy5hZGRDb21wbGV0ZXIocmh5bWVDb21wbGV0ZXIpO1xuXG4gICAgICAgIHRoaXMuZWRpdG9yLmNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKFwiZHJhZ2VudGVyXCIsIHRoaXMuY2F0Y2hBbmREb05vdGhpbmcsIGZhbHNlKTtcbiAgICAgICAgdGhpcy5lZGl0b3IuY29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoXCJkcmFnb3ZlclwiLCB0aGlzLmNhdGNoQW5kRG9Ob3RoaW5nLCBmYWxzZSk7XG4gICAgICAgIHRoaXMuZWRpdG9yLmNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKFwiZHJvcFwiLCB0aGlzLmRyb3AuYmluZCh0aGlzKSwgZmFsc2UpO1xuICAgIH1cblxuICAgICxjYXRjaEFuZERvTm90aGluZzogZnVuY3Rpb24oZSkge1xuICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgfVxuXG4gICAgLGRyb3A6IGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAgIEV4dC5lYWNoKGUuZGF0YVRyYW5zZmVyLmZpbGVzLCBmdW5jdGlvbihmaWxlKSB7XG4gICAgICAgICAgICB2YXIgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcbiAgICAgICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnZmlsZScsIGZpbGUpO1xuICAgICAgICAgICAgZm9ybURhdGEuYXBwZW5kKCdhY3Rpb24nLCAnbWdyL2VkaXRvci91cGxvYWQnKTtcblxuICAgICAgICAgICAgdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgICAgICAgICAgeGhyLm9wZW4oJ1BPU1QnLCBNYXJrZG93bkVkaXRvcl9jb25maWcuY29ubmVjdG9yVXJsKTtcbiAgICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdQb3dlcmVkLUJ5JywgJ01PRHgnKTtcbiAgICAgICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdtb2RBdXRoJywgRXh0LkFqYXguZGVmYXVsdEhlYWRlcnMubW9kQXV0aCk7XG5cbiAgICAgICAgICAgIC8veGhyLnVwbG9hZC5vbnByb2dyZXNzID0gZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgICAgICAvLyAgICBpZiAoZXZlbnQubGVuZ3RoQ29tcHV0YWJsZSkge1xuICAgICAgICAgICAgLy8gICAgICAgIHZhciBjb21wbGV0ZSA9IChldmVudC5sb2FkZWQgLyBldmVudC50b3RhbCAqIDEwMCB8IDApO1xuICAgICAgICAgICAgLy8gICAgICAgIHByb2dyZXNzLnZhbHVlID0gcHJvZ3Jlc3MuaW5uZXJIVE1MID0gY29tcGxldGU7XG4gICAgICAgICAgICAvLyAgICB9XG4gICAgICAgICAgICAvL307XG5cbiAgICAgICAgICAgIHhoci5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgaWYgKHhoci5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgcmVzID0gSlNPTi5wYXJzZSh4aHIucmVzcG9uc2VUZXh0KTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJlcy5zdWNjZXNzID09IHRydWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHJlcyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmVkaXRvci5pbnNlcnQoJyFbJyArIHJlcy5uYW1lICsgJ10oJyArIHJlcy5wYXRoICsgJyknKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnYWxsIGRvbmU6ICcgKyB4aHIuc3RhdHVzKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnU29tZXRoaW5nIHdlbnQgdGVycmlibHkgd3JvbmcuLi4nKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LmJpbmQodGhpcyk7XG5cbiAgICAgICAgICAgIHhoci5zZW5kKGZvcm1EYXRhKTtcblxuICAgICAgICB9LCB0aGlzKTtcblxuICAgIH1cblxuICAgICxyZWdpc3Rlck1hcmtlZDogZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciBtZGUgPSB0aGlzO1xuICAgICAgICB0aGlzLnJlbWFya2FibGUgPSBuZXcgUmVtYXJrYWJsZSh7XG4gICAgICAgICAgICBodG1sOiB0cnVlLFxuICAgICAgICAgICAgaGlnaGxpZ2h0OiBmdW5jdGlvbiAoc3RyLCBsYW5nKSB7XG4gICAgICAgICAgICAgICAgaWYgKGxhbmcgJiYgaGxqcy5nZXRMYW5ndWFnZShsYW5nKSkge1xuICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhsanMuaGlnaGxpZ2h0KGxhbmcsIHN0cikudmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge31cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGxqcy5oaWdobGlnaHRBdXRvKHN0cikudmFsdWU7XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7fVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuICcnOyAvLyB1c2UgZXh0ZXJuYWwgZGVmYXVsdCBlc2NhcGluZ1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5yZW1hcmthYmxlLmlubGluZS5ydWxlci5kaXNhYmxlKFsgJ2JhY2t0aWNrcycgXSk7XG4gICAgfVxuXG4gICAgLHJlbmRlcjogZnVuY3Rpb24oKSB7XG4gICAgICAgIHZhciBtZGUgPSB0aGlzO1xuICAgICAgICB0aGlzLnRleHRhcmVhID0gRXh0LmdldCgndGEnKTtcblxuICAgICAgICB0aGlzLmJ1aWxkVUkoKTtcbiAgICAgICAgdGhpcy5yZWdpc3RlckFjZSgpO1xuICAgICAgICB0aGlzLnJlZ2lzdGVyTWFya2VkKCk7XG5cblxuICAgICAgICAvLyBjb3B5IGJhY2sgdG8gdGV4dGFyZWEgb24gZm9ybSBzdWJtaXQuLi5cbiAgICAgICAgLy90ZXh0YXJlYS5jbG9zZXN0KCdmb3JtJykuc3VibWl0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgLy8gICAgdGV4dGFyZWEudmFsKGVkaXRvci5nZXRTZXNzaW9uKCkuZ2V0VmFsdWUoKSk7XG4gICAgICAgIC8vfSk7XG5cblxuXG4gICAgICAgIHZhciBwcmV2aWV3QnV0dG9uID0gRXh0LmdldCgncHJldmlldy1idXR0b24nKTtcbiAgICAgICAgdmFyIGZ1bGxzY3JlZW5CdXR0b24gPSBFeHQuZ2V0KCdmdWxsc2NyZWVuLWJ1dHRvbicpO1xuICAgICAgICB2YXIgcHJldmlldyA9IEV4dC5nZXQoJ3ByZXZpZXctbWQnKTtcbiAgICAgICAgdmFyIGNvbnRlbnQgPSBFeHQuZ2V0KCdjb250ZW50LW1kJyk7XG4gICAgICAgIHZhciB3cmFwcGVyID0gY29udGVudC5wYXJlbnQoKTtcblxuICAgICAgICB2YXIgZHJvcFRhcmdldCA9IE1PRHgubG9hZCh7XG4gICAgICAgICAgICB4dHlwZTogJ21vZHgtdHJlZWRyb3AnLFxuICAgICAgICAgICAgdGFyZ2V0OiBjb250ZW50LFxuICAgICAgICAgICAgdGFyZ2V0RWw6IGNvbnRlbnQsXG4gICAgICAgICAgICBvbkluc2VydDogKGZ1bmN0aW9uKHMpe1xuICAgICAgICAgICAgICAgIHRoaXMuaW5zZXJ0KHMpO1xuICAgICAgICAgICAgICAgIHRoaXMuZm9jdXMoKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH0pLmJpbmQodGhpcy5lZGl0b3IpLFxuICAgICAgICAgICAgaWZyYW1lOiB0cnVlXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnRleHRhcmVhLm9uKCdkZXN0cm95JywgZnVuY3Rpb24oKSB7ZHJvcFRhcmdldC5kZXN0cm95KCk7fSk7XG5cbiAgICAgICAgcHJldmlld0J1dHRvbi5hZGRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZiAocHJldmlldy5pc1Zpc2libGUoKSkge1xuICAgICAgICAgICAgICAgIHByZXZpZXcuc2V0RGlzcGxheWVkKCdub25lJyk7XG4gICAgICAgICAgICAgICAgY29udGVudC5zZXREaXNwbGF5ZWQoJ2Jsb2NrJyk7XG5cbiAgICAgICAgICAgICAgICBwcmV2aWV3QnV0dG9uLmNoaWxkKCdpJykucmVtb3ZlQ2xhc3MoJ2ljb24tdG9nZ2xlLW9uJyk7XG4gICAgICAgICAgICAgICAgcHJldmlld0J1dHRvbi5jaGlsZCgnaScpLmFkZENsYXNzKCdpY29uLXRvZ2dsZS1vZmYnKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcHJldmlldy5zZXREaXNwbGF5ZWQoJ2Jsb2NrJyk7XG4gICAgICAgICAgICAgICAgY29udGVudC5zZXREaXNwbGF5ZWQoJ25vbmUnKTtcblxuICAgICAgICAgICAgICAgIHByZXZpZXdCdXR0b24uY2hpbGQoJ2knKS5yZW1vdmVDbGFzcygnaWNvbi10b2dnbGUtb2ZmJyk7XG4gICAgICAgICAgICAgICAgcHJldmlld0J1dHRvbi5jaGlsZCgnaScpLmFkZENsYXNzKCdpY29uLXRvZ2dsZS1vbicpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBmdWxsc2NyZWVuQnV0dG9uLmFkZExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHZhciBpY29uID0gZnVsbHNjcmVlbkJ1dHRvbi5jaGlsZCgnaScpO1xuXG4gICAgICAgICAgICBpZiAoaWNvbi5oYXNDbGFzcygnaWNvbi1leHBhbmQnKSkge1xuICAgICAgICAgICAgICAgIGljb24ucmVtb3ZlQ2xhc3MoJ2ljb24tZXhwYW5kJyk7XG4gICAgICAgICAgICAgICAgaWNvbi5hZGRDbGFzcygnaWNvbi1jb21wcmVzcycpO1xuXG4gICAgICAgICAgICAgICAgcHJldmlldy5zZXREaXNwbGF5ZWQoJ2Jsb2NrJyk7XG4gICAgICAgICAgICAgICAgY29udGVudC5zZXREaXNwbGF5ZWQoJ2Jsb2NrJyk7XG5cbiAgICAgICAgICAgICAgICBwcmV2aWV3QnV0dG9uLmhpZGUoKTtcblxuICAgICAgICAgICAgICAgIHdyYXBwZXIuYWRkQ2xhc3MoJ2Z1bGxzY3JlZW4nKTtcblxuICAgICAgICAgICAgICAgIHRoaXMuZWRpdG9yLnNldE9wdGlvbignbWF4TGluZXMnLCBudWxsKTtcbiAgICAgICAgICAgICAgICAvL3RoaXMuZWRpdG9yLnNldEF1dG9TY3JvbGxFZGl0b3JJbnRvVmlldyhmYWxzZSk7XG5cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWNvbi5hZGRDbGFzcygnaWNvbi1leHBhbmQnKTtcbiAgICAgICAgICAgICAgICBpY29uLnJlbW92ZUNsYXNzKCdpY29uLWNvbXByZXNzJyk7XG5cbiAgICAgICAgICAgICAgICBwcmV2aWV3LnNldERpc3BsYXllZCgnbm9uZScpO1xuICAgICAgICAgICAgICAgIGNvbnRlbnQuc2V0RGlzcGxheWVkKCdibG9jaycpO1xuXG4gICAgICAgICAgICAgICAgcHJldmlld0J1dHRvbi5zaG93KCk7XG5cbiAgICAgICAgICAgICAgICB3cmFwcGVyLnJlbW92ZUNsYXNzKCdmdWxsc2NyZWVuJyk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmVkaXRvci5zZXRPcHRpb24oJ21heExpbmVzJywgSW5maW5pdHkpO1xuICAgICAgICAgICAgICAgIC8vdGhpcy5lZGl0b3Iuc2V0QXV0b1Njcm9sbEVkaXRvckludG9WaWV3KHRydWUpO1xuXG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuZWRpdG9yLnJlc2l6ZSh0cnVlKTtcbiAgICAgICAgfSwgdGhpcyk7XG5cbiAgICAgICAgdGhpcy5lZGl0b3Iuc2V0VmFsdWUoTWFya2Rvd25FZGl0b3JfY29udGVudC5jb250ZW50KTtcbiAgICAgICAgdGhpcy5lZGl0b3Iuc2VsZWN0aW9uLmNsZWFyU2VsZWN0aW9uKCk7XG5cbiAgICAgICAgcHJldmlldy51cGRhdGUodGhpcy5wYXJzZSh0aGlzLmVkaXRvci5nZXRWYWx1ZSgpKSk7XG5cbiAgICAgICAgdGhpcy5lZGl0b3IuZ2V0U2Vzc2lvbigpLm9uKCdjaGFuZ2UnLCBmdW5jdGlvbihlKXtcbiAgICAgICAgICAgIHZhciBwYXJzZWQgPSBtZGUucGFyc2UobWRlLmVkaXRvci5nZXRWYWx1ZSgpKTtcblxuXG4gICAgICAgICAgICAvL21kZS50ZXh0YXJlYS5kb20udmFsdWUgPSBwYXJzZWQ7XG4gICAgICAgICAgICAvL21kZS50YU1hcmtkb3duLmRvbS52YWx1ZSA9IG1kZS5lZGl0b3IuZ2V0VmFsdWUoKTtcbiAgICAgICAgICAgIC8vcHJldmlldy51cGRhdGUocGFyc2VkKTtcbiAgICAgICAgfSk7XG4gICAgfVxufSk7XG5NYXJrZG93bkVkaXRvciA9IG5ldyBNYXJrZG93bkVkaXRvcigpOyJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==