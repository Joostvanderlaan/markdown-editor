Ext.ns("MarkdownEditor"),MarkdownEditor=function(e){e=e||{},MarkdownEditor.superclass.constructor.call(this,e)},Ext.extend(MarkdownEditor,Ext.Component,{window:{},config:{}}),Ext.reg("markdowneditor",MarkdownEditor),markdownEditor=new MarkdownEditor,markdownEditor.Editor=function(e){e=e||{},e.resource=MODx.request.id||0,markdownEditor.Editor.superclass.constructor.call(this,e),this.config=e},Ext.extend(markdownEditor.Editor,Ext.Component,{remarkable:"",fullScreen:!1,initComponent:function(){MarkdownEditor.superclass.initComponent.call(this),Ext.onReady(this.render,this)},render:function(){this.textarea=Ext.get("ta"),this.buildUI(),this.registerAce(),this.registerMarked();var e=this.toolBox.child(".preview-button"),t=this.toolBox.child(".fullscreen-button"),i=this.contentMD,o=i.parent(),r=MODx.load({xtype:"modx-treedrop",target:i,targetEl:i,onInsert:function(e){return this.insert(e),this.focus(),!0}.bind(this.editor),iframe:!0});this.textarea.on("destroy",function(){r.destroy()}),e.addListener("click",function(){this.preview.isVisible()?(this.preview.setDisplayed("none"),i.setDisplayed("block"),this.statusBar.setDisplayed("block"),this.editor.focus(),e.child("i").removeClass("icon-toggle-on"),e.child("i").addClass("icon-toggle-off")):(this.preview.setDisplayed("block"),i.setDisplayed("none"),this.statusBar.setDisplayed("none"),e.child("i").removeClass("icon-toggle-off"),e.child("i").addClass("icon-toggle-on"))},this),t.addListener("click",function(){var r=t.child("i");0==this.fullScreen?(this.fullScreen=!0,r.removeClass("icon-expand"),r.addClass("icon-compress"),this.preview.setDisplayed("block"),i.setDisplayed("block"),this.editor.focus(),e.hide(),o.addClass("fullscreen"),this.editor.setOption("maxLines",null)):(this.fullScreen=!1,r.addClass("icon-expand"),r.removeClass("icon-compress"),this.preview.setDisplayed("none"),i.setDisplayed("block"),this.editor.focus(),e.show(),o.removeClass("fullscreen"),this.editor.setOption("maxLines",1/0)),this.statusBar.setDisplayed("block"),this.editor.resize(!0)},this),markdownEditor.content.content&&this.editor.setValue(markdownEditor.content.content),this.editor.selection.clearSelection(),this.preview.update(this.parse(this.editor.getValue())),this.editor.getSession().on("change",function(){this.parse(this.editor.getValue())}.bind(this))},buildUI:function(){this.textarea.setDisplayed("none"),this.textarea.setWidth(0),this.textarea.setHeight(0),this.taMarkdown=Ext.get(Ext.DomHelper.insertBefore(this.textarea,{tag:"textarea",name:"ta_markdown","class":"ta_markdown"})),this.taMarkdown.setDisplayed("none"),this.taMarkdown.setWidth(0),this.taMarkdown.setHeight(0);var e=Ext.DomHelper.insertBefore(this.textarea,{tag:"div","class":"markdown-container"});this.contentMD=Ext.get(Ext.DomHelper.append(e,{tag:"div","class":this.textarea.dom.className+" content-md"})),this.preview=Ext.get(Ext.DomHelper.append(e,{tag:"div","class":"markdown-body preview-md"})),this.toolBox=Ext.get(Ext.DomHelper.append(e,{tag:"div","class":"toolbox",cn:[{tag:"span","class":"preview-button",html:'<i class="icon icon-toggle-off"></i> '+_("markdowneditor.toolbox.preview")},{tag:"span","class":"fullscreen-button",html:'<i class="icon icon-expand"></i>'}]})),1==MODx.config["markdowneditor.upload.enable_image_upload"]||1==MODx.config["markdowneditor.upload.enable_file_upload"]?(this.statusBar=Ext.get(Ext.DomHelper.append(e,{tag:"div","class":"status-bar"})),this.statusBar.dom.innerHTML='<div class="upload-bar"> <input class="hidden" name="file" id="'+this.statusBar.id+'-file" type="file" multiple>'+_("markdowneditor.status_bar_message",{id:this.statusBar.id+"-file"})+"</div>",this.statusBar.child("input").on("change",function(e,t){this.handleFiles(t.files),t.value=""},this)):this.statusBar=Ext.get(Ext.DomHelper.append(e,{tag:"div","class":"status-bar",html:_("markdowneditor.status_bar_disabled")})),Ext.DomHelper.append(e,{tag:"span",style:"clear: both"})},registerAce:function(){this.editor=ace.edit(Ext.DomQuery.selectNode("div.content-md")),this.editor.setOptions({maxLines:1/0,minLines:25,enableBasicAutocompletion:!0}),this.editor.renderer.setShowGutter(!0),this.editor.renderer.setScrollMargin(10,10),this.editor.getSession().setValue(this.textarea.getValue()),this.editor.getSession().setMode("ace/mode/markdown"),this.editor.setTheme("ace/theme/"+(MODx.config["markdowneditor.general.theme"]||"monokai"));var e=ace.require("ace/ext/language_tools"),t={getCompletions:function(e,t,i,o,r){return 0===o.length?(r(null,[]),void 0):(MODx.Ajax.request({url:markdownEditor.config.connectorUrl,params:{action:"mgr/resource/getlist",prefix:o},listeners:{success:{fn:function(e){r(null,e.results)},scope:this}}}),void 0)}};e.addCompleter(t),this.editor.container.addEventListener("dragenter",this.catchAndDoNothing,!1),this.editor.container.addEventListener("dragover",this.catchAndDoNothing,!1),this.editor.container.addEventListener("drop",this.drop.bind(this),!1)},registerMarked:function(){this.remarkable=new Remarkable({html:!0,highlight:function(e,t){if(t&&hljs.getLanguage(t))try{return hljs.highlight(t,e).value}catch(i){}try{return hljs.highlightAuto(e).value}catch(i){}return""}}),this.remarkable.inline.ruler.disable(["backticks"])},parse:function(e){var t=this.remarkable.render(e);t=t.replace(/%5B/g,"["),t=t.replace(/%5D/g,"]");var i=t.match(/<code(.|\s)*<\/code>/g);if(Ext.each(i,function(e){var i=e.replace(/\[\[/g,"&#91;&#91;");i=i.replace(/]]/g,"&#93;&#93;"),t=t.replace(e,i)}),1==MODx.config["markdowneditor.lp.parse_modx_tags"]){this.parseRequest&&clearTimeout(this.parseRequest);var o=parseInt(MODx.config["markdowneditor.lp.parse_modx_tags_timeout"]||300);this.parseRequest=setTimeout(function(){MODx.Ajax.request({url:markdownEditor.config.connectorUrl,params:{action:"mgr/editor/processcontent",content:t,resource:MODx.request.id},isUpload:!0,listeners:{success:{fn:function(e){this.preview.update(e.data),1==this.fullScreen&&(this.preview.dom.scrollTop=this.preview.dom.scrollHeight)},scope:this}}})}.bind(this),o)}else this.preview.update(t),1==this.fullScreen&&(this.preview.dom.scrollTop=this.preview.dom.scrollHeight);return this.taMarkdown.dom.value=this.editor.getValue(),this.textarea.dom.value=t,t},catchAndDoNothing:function(e){e.stopPropagation(),e.preventDefault()},drop:function(e){e.stopPropagation(),e.preventDefault(),(1==MODx.config["markdowneditor.upload.enable_image_upload"]||1==MODx.config["markdowneditor.upload.enable_file_upload"])&&this.handleFiles(e.dataTransfer.files)},handleFiles:function(e){Ext.each(e,function(e){var t=/^image\//.test(e.type);if(t){if(0==MODx.config["markdowneditor.upload.enable_image_upload"])return!0;if(!this.checkType(MODx.config["markdowneditor.upload.image_types"],e))return this.failMessage(e,"image",_("markdowneditor.err.upload.unsupported_image")),!0;if(e.size>parseInt(MODx.config["markdowneditor.upload.max_size"]))return this.failMessage(e,"image",_("markdowneditor.err.upload.too_big")),!0;1==MODx.config["markdowneditor.cropper.enable_cropper"]?MODx.load({xtype:"markdowneditor-window-cropper",file:e,md:this}).show():(this.uploadFile(e,"image"),this.editor.focus())}else{if(0==MODx.config["markdowneditor.upload.enable_file_upload"])return!0;if(!this.checkType(MODx.config["markdowneditor.upload.file_types"],e))return this.failMessage(e,"file",_("markdowneditor.err.upload.unsupported_file")),!0;if(e.size>parseInt(MODx.config["markdowneditor.upload.max_size"]))return this.failMessage(e,"file",_("markdowneditor.err.upload.too_big")),!0;this.uploadFile(e,"file"),this.editor.focus()}},this)},checkType:function(e,t){return e=e.split(","),-1!=e.indexOf(t.name.split(".").pop())},uploadFile:function(e,t){t||(t="file");var i=this.createUploader(),o=new FormData;o.append("file",e),o.append("action","mgr/editor/"+t+"upload"),o.append("name",e.name),o.append("resource",this.config.resource);var r=new XMLHttpRequest;r.open("POST",markdownEditor.config.connectorUrl),r.setRequestHeader("Powered-By","MODx"),r.setRequestHeader("modAuth",Ext.Ajax.defaultHeaders.modAuth),r.upload.onprogress=function(e){if(e.lengthComputable){var t=e.loaded/e.total*100|0;i.child(".progress").setWidth(t+"%")}}.bind(this),r.onload=function(){if(200===r.status){var e=JSON.parse(r.responseText);if(1==e.success){i.remove();var o="image"==t?"!":"",a="image"==t?"\n\n":"\n";this.editor.insert(o+"["+e.object.name+"]("+e.object.path+' "'+e.object.name+'")'+a)}else this.failUploader(i,e.message)}}.bind(this),r.send(o)},createUploader:function(e,t){var i=Ext.DomHelper.insertFirst(this.statusBar,{tag:"div",html:'<div class="progress"><i class="icon icon-spinner icon-spin"></i> <span>'+_("markdowneditor.uploading_"+e)+t+"</span></div>"});return Ext.get(i)},failUploader:function(e,t){e.child(".progress").addClass("error"),e.child(".progress").setWidth("100%"),e.child("i").addClass("remove-message"),e.child("i").replaceClass("icon-spinner","icon-remove"),e.child("i").removeClass("icon-spin"),e.child("span").dom.innerHTML+=" failed. "+t,e.child(".remove-message").on("click",function(){e.remove()})},failMessage:function(e,t,i){var o=this.createUploader(t,e.name);this.failUploader(o,i)}}),MODx.loadRTE=function(){new markdownEditor.Editor},markdownEditor.window.Cropper=function(config){config=config||{},config.cropperSelector=config.cropperSelector||".image-upload-wrapper > img",Ext.applyIf(config,{modal:!1,layout:"auto",closeAction:"hide",shadow:!0,resizable:!0,collapsible:!0,maximizable:!1,autoHeight:!1,autoScroll:!0,allowDrop:!0,width:800,title:_("markdowneditor.cropper.crop_image"),cls:"modx-window",html:'<div class="image-upload-wrapper"><img src="'+URL.createObjectURL(config.file)+'"></div>',tbar:[{text:'<i class="icon icon-arrows"></i> '+_("markdowneditor.cropper.move"),scope:this,param:"move",action:"setDragMode",handler:this.callCropperAction},{text:'<i class="icon icon-crop"></i> '+_("markdowneditor.cropper.crop"),scope:this,param:"crop",action:"setDragMode",handler:this.callCropperAction},{text:'<i class="icon icon-search-plus"></i> '+_("markdowneditor.cropper.zoom_in"),scope:this,param:.1,action:"zoom",handler:this.callCropperAction},{text:'<i class="icon icon-search-minus"></i> '+_("markdowneditor.cropper.zoom_out"),scope:this,param:-.1,action:"zoom",handler:this.callCropperAction},{text:'<i class="icon icon-rotate-left"></i> '+_("markdowneditor.cropper.rotate_left"),scope:this,param:-90,action:"rotate",handler:this.callCropperAction},{text:'<i class="icon icon-rotate-right"></i> '+_("markdowneditor.cropper.rotate_right"),scope:this,param:90,action:"rotate",handler:this.callCropperAction},{text:'<i class="icon icon-remove"></i> '+_("markdowneditor.cropper.clear_cropper"),scope:this,param:null,action:"clear",handler:this.callCropperAction}],buttons:[{text:_("cancel"),scope:this,handler:this.close},{text:_("markdowneditor.cropper.upload"),cls:"primary-button",scope:this,crop:0,handler:this.upload},{text:_("markdowneditor.cropper.crop_upload"),cls:"primary-button",scope:this,crop:1,handler:this.upload}],listeners:{show:{fn:function(){var cropperOptions={};this.$cropperEl=$("#"+this.id+" "+config.cropperSelector);var ratio=MODx.config["markdowneditor.cropper.aspect_ratio"];ratio&&(ratio.replace(/[^-:x()\d/*+.]/g,""),ratio=eval(ratio),cropperOptions.aspectRatio=ratio),cropperOptions.crop=function(e){this.imageData=['{"x":'+e.x,'"y":'+e.y,'"height":'+e.height,'"width":'+e.width,'"rotate":'+e.rotate+"}"].join()}.bind(this),this.$cropperEl.cropper(cropperOptions)},scope:this}}}),markdownEditor.window.Cropper.superclass.constructor.call(this,config),this.config=config},Ext.extend(markdownEditor.window.Cropper,Ext.Window,{imageData:"",upload:function(e){var t=this.config.md.createUploader("image",this.config.file.name),i=new FormData;i.append("file",this.config.file),i.append("action","mgr/editor/imageupload"),i.append("imageData",this.imageData),i.append("name",this.config.file.name),i.append("crop",e.crop),i.append("resource",this.config.md.config.resource);var o=new XMLHttpRequest;o.open("POST",markdownEditor.config.connectorUrl),o.setRequestHeader("Powered-By","MODx"),o.setRequestHeader("modAuth",Ext.Ajax.defaultHeaders.modAuth),o.upload.onprogress=function(e){if(e.lengthComputable){var i=e.loaded/e.total*100|0;t.child(".progress").setWidth(i+"%")}}.bind(this),o.onload=function(){if(200===o.status){var e=JSON.parse(o.responseText);1==e.success?(t.remove(),this.config.md.editor.insert("!["+e.object.name+"]("+e.object.path+' "'+e.object.name+'")\n\n')):this.config.md.failUploader(t,e.message)}}.bind(this),o.send(i),this.close()},callCropperAction:function(e){this.$cropperEl.cropper(e.action,e.param)},close:function(){this.$cropperEl.cropper("destroy"),markdownEditor.window.Cropper.superclass.close.call(this),this.config.md.editor.focus()}}),Ext.reg("markdowneditor-window-cropper",markdownEditor.window.Cropper);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsIm1hcmtkb3duZWRpdG9yLndpbmRvdy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxJQUFBLEdBQUEsa0JBQ0EsZUFBQSxTQUFBLEdBQ0EsRUFBQSxNQUNBLGVBQUEsV0FBQSxZQUFBLEtBQUEsS0FBQSxJQUVBLElBQUEsT0FBQSxlQUFBLElBQUEsV0FDQSxVQUFBLFlBRUEsSUFBQSxJQUFBLGlCQUFBLGdCQUNBLGVBQUEsR0FBQSxnQkFFQSxlQUFBLE9BQUEsU0FBQSxHQUNBLEVBQUEsTUFDQSxFQUFBLFNBQUEsS0FBQSxRQUFBLElBQUEsRUFDQSxlQUFBLE9BQUEsV0FBQSxZQUFBLEtBQUEsS0FBQSxHQUNBLEtBQUEsT0FBQSxHQUVBLElBQUEsT0FBQSxlQUFBLE9BQUEsSUFBQSxXQUNBLFdBQUEsR0FDQSxZQUFBLEVBQ0EsY0FBQSxXQUNBLGVBQUEsV0FBQSxjQUFBLEtBQUEsTUFFQSxJQUFBLFFBQUEsS0FBQSxPQUFBLE9BR0EsT0FBQSxXQUNBLEtBQUEsU0FBQSxJQUFBLElBQUEsTUFFQSxLQUFBLFVBQ0EsS0FBQSxjQUNBLEtBQUEsZ0JBRUEsSUFBQSxHQUFBLEtBQUEsUUFBQSxNQUFBLG1CQUNBLEVBQUEsS0FBQSxRQUFBLE1BQUEsc0JBQ0EsRUFBQSxLQUFBLFVBQ0EsRUFBQSxFQUFBLFNBRUEsRUFBQSxLQUFBLE1BQ0EsTUFBQSxnQkFDQSxPQUFBLEVBQ0EsU0FBQSxFQUNBLFNBQUEsU0FBQSxHQUdBLE1BRkEsTUFBQSxPQUFBLEdBQ0EsS0FBQSxTQUNBLEdBQ0EsS0FBQSxLQUFBLFFBQ0EsUUFBQSxHQUVBLE1BQUEsU0FBQSxHQUFBLFVBQUEsV0FBQSxFQUFBLFlBRUEsRUFBQSxZQUFBLFFBQUEsV0FDQSxLQUFBLFFBQUEsYUFDQSxLQUFBLFFBQUEsYUFBQSxRQUNBLEVBQUEsYUFBQSxTQUNBLEtBQUEsVUFBQSxhQUFBLFNBRUEsS0FBQSxPQUFBLFFBRUEsRUFBQSxNQUFBLEtBQUEsWUFBQSxrQkFDQSxFQUFBLE1BQUEsS0FBQSxTQUFBLHFCQUVBLEtBQUEsUUFBQSxhQUFBLFNBQ0EsRUFBQSxhQUFBLFFBQ0EsS0FBQSxVQUFBLGFBQUEsUUFFQSxFQUFBLE1BQUEsS0FBQSxZQUFBLG1CQUNBLEVBQUEsTUFBQSxLQUFBLFNBQUEsb0JBRUEsTUFFQSxFQUFBLFlBQUEsUUFBQSxXQUNBLEdBQUEsR0FBQSxFQUFBLE1BQUEsSUFFQSxJQUFBLEtBQUEsWUFDQSxLQUFBLFlBQUEsRUFDQSxFQUFBLFlBQUEsZUFDQSxFQUFBLFNBQUEsaUJBRUEsS0FBQSxRQUFBLGFBQUEsU0FDQSxFQUFBLGFBQUEsU0FFQSxLQUFBLE9BQUEsUUFFQSxFQUFBLE9BRUEsRUFBQSxTQUFBLGNBRUEsS0FBQSxPQUFBLFVBQUEsV0FBQSxRQUdBLEtBQUEsWUFBQSxFQUNBLEVBQUEsU0FBQSxlQUNBLEVBQUEsWUFBQSxpQkFFQSxLQUFBLFFBQUEsYUFBQSxRQUNBLEVBQUEsYUFBQSxTQUVBLEtBQUEsT0FBQSxRQUVBLEVBQUEsT0FFQSxFQUFBLFlBQUEsY0FFQSxLQUFBLE9BQUEsVUFBQSxXQUFBLE1BR0EsS0FBQSxVQUFBLGFBQUEsU0FFQSxLQUFBLE9BQUEsUUFBQSxJQUNBLE1BRUEsZUFBQSxRQUFBLFNBQ0EsS0FBQSxPQUFBLFNBQUEsZUFBQSxRQUFBLFNBRUEsS0FBQSxPQUFBLFVBQUEsaUJBRUEsS0FBQSxRQUFBLE9BQUEsS0FBQSxNQUFBLEtBQUEsT0FBQSxhQUVBLEtBQUEsT0FBQSxhQUFBLEdBQUEsU0FBQSxXQUNBLEtBQUEsTUFBQSxLQUFBLE9BQUEsYUFDQSxLQUFBLFFBR0EsUUFBQSxXQUNBLEtBQUEsU0FBQSxhQUFBLFFBQ0EsS0FBQSxTQUFBLFNBQUEsR0FDQSxLQUFBLFNBQUEsVUFBQSxHQUVBLEtBQUEsV0FBQSxJQUFBLElBQUEsSUFBQSxVQUFBLGFBQUEsS0FBQSxVQUNBLElBQUEsV0FDQSxLQUFBLGNBQ0EsUUFBQSxpQkFHQSxLQUFBLFdBQUEsYUFBQSxRQUNBLEtBQUEsV0FBQSxTQUFBLEdBQ0EsS0FBQSxXQUFBLFVBQUEsRUFFQSxJQUFBLEdBQUEsSUFBQSxVQUFBLGFBQUEsS0FBQSxVQUNBLElBQUEsTUFDQSxRQUFBLHNCQUdBLE1BQUEsVUFBQSxJQUFBLElBQUEsSUFBQSxVQUFBLE9BQUEsR0FDQSxJQUFBLE1BQ0EsUUFBQSxLQUFBLFNBQUEsSUFBQSxVQUFBLGlCQUdBLEtBQUEsUUFBQSxJQUFBLElBQUEsSUFBQSxVQUFBLE9BQUEsR0FDQSxJQUFBLE1BQ0EsUUFBQSw4QkFHQSxLQUFBLFFBQUEsSUFBQSxJQUFBLElBQUEsVUFBQSxPQUFBLEdBQ0EsSUFBQSxNQUNBLFFBQUEsVUFDQSxLQUNBLElBQUEsT0FDQSxRQUFBLGlCQUNBLEtBQUEsd0NBQUEsRUFBQSxvQ0FFQSxJQUFBLE9BQ0EsUUFBQSxvQkFDQSxLQUFBLHdDQUlBLEdBQUEsS0FBQSxPQUFBLDhDQUFBLEdBQUEsS0FBQSxPQUFBLDZDQUNBLEtBQUEsVUFBQSxJQUFBLElBQUEsSUFBQSxVQUFBLE9BQUEsR0FDQSxJQUFBLE1BQ0EsUUFBQSxnQkFHQSxLQUFBLFVBQUEsSUFBQSxVQUFBLGtFQUFBLEtBQUEsVUFBQSxHQUFBLCtCQUFBLEVBQUEscUNBQUEsR0FBQSxLQUFBLFVBQUEsR0FBQSxVQUFBLFNBRUEsS0FBQSxVQUFBLE1BQUEsU0FBQSxHQUFBLFNBQUEsU0FBQSxFQUFBLEdBQ0EsS0FBQSxZQUFBLEVBQUEsT0FDQSxFQUFBLE1BQUEsSUFDQSxPQUVBLEtBQUEsVUFBQSxJQUFBLElBQUEsSUFBQSxVQUFBLE9BQUEsR0FDQSxJQUFBLE1BQ0EsUUFBQSxhQUNBLEtBQUEsRUFBQSx5Q0FJQSxJQUFBLFVBQUEsT0FBQSxHQUNBLElBQUEsT0FDQSxNQUFBLGlCQUlBLFlBQUEsV0FDQSxLQUFBLE9BQUEsSUFBQSxLQUFBLElBQUEsU0FBQSxXQUFBLG1CQUNBLEtBQUEsT0FBQSxZQUNBLFNBQUEsSUFDQSxTQUFBLEdBQ0EsMkJBQUEsSUFFQSxLQUFBLE9BQUEsU0FBQSxlQUFBLEdBQ0EsS0FBQSxPQUFBLFNBQUEsZ0JBQUEsR0FBQSxJQUNBLEtBQUEsT0FBQSxhQUFBLFNBQUEsS0FBQSxTQUFBLFlBQ0EsS0FBQSxPQUFBLGFBQUEsUUFBQSxxQkFDQSxLQUFBLE9BQUEsU0FBQSxjQUFBLEtBQUEsT0FBQSxpQ0FBQSxXQUVBLElBQUEsR0FBQSxJQUFBLFFBQUEsMEJBQ0EsR0FDQSxlQUFBLFNBQUEsRUFBQSxFQUFBLEVBQUEsRUFBQSxHQUNBLE1BQUEsS0FBQSxFQUFBLFFBQUEsRUFBQSxTQUFBLFNBRUEsS0FBQSxLQUFBLFNBQ0EsSUFBQSxlQUFBLE9BQUEsYUFDQSxRQUNBLE9BQUEsdUJBQ0EsT0FBQSxHQUVBLFdBQ0EsU0FDQSxHQUFBLFNBQUEsR0FDQSxFQUFBLEtBQUEsRUFBQSxVQUVBLE1BQUEsU0FYQSxTQWtCQSxHQUFBLGFBQUEsR0FHQSxLQUFBLE9BQUEsVUFBQSxpQkFBQSxZQUFBLEtBQUEsbUJBQUEsR0FDQSxLQUFBLE9BQUEsVUFBQSxpQkFBQSxXQUFBLEtBQUEsbUJBQUEsR0FDQSxLQUFBLE9BQUEsVUFBQSxpQkFBQSxPQUFBLEtBQUEsS0FBQSxLQUFBLE9BQUEsSUFHQSxlQUFBLFdBQ0EsS0FBQSxXQUFBLEdBQUEsYUFDQSxNQUFBLEVBQ0EsVUFBQSxTQUFBLEVBQUEsR0FDQSxHQUFBLEdBQUEsS0FBQSxZQUFBLEdBQ0EsSUFDQSxNQUFBLE1BQUEsVUFBQSxFQUFBLEdBQUEsTUFDQSxNQUFBLElBR0EsSUFDQSxNQUFBLE1BQUEsY0FBQSxHQUFBLE1BQ0EsTUFBQSxJQUVBLE1BQUEsTUFHQSxLQUFBLFdBQUEsT0FBQSxNQUFBLFNBQUEsZUFHQSxNQUFBLFNBQUEsR0FDQSxHQUFBLEdBQUEsS0FBQSxXQUFBLE9BQUEsRUFFQSxHQUFBLEVBQUEsUUFBQSxPQUFBLEtBQ0EsRUFBQSxFQUFBLFFBQUEsT0FBQSxJQUVBLElBQUEsR0FBQSxFQUFBLE1BQUEsd0JBUUEsSUFQQSxJQUFBLEtBQUEsRUFBQSxTQUFBLEdBQ0EsR0FBQSxHQUFBLEVBQUEsUUFBQSxRQUFBLGFBQ0EsR0FBQSxFQUFBLFFBQUEsTUFBQSxjQUVBLEVBQUEsRUFBQSxRQUFBLEVBQUEsS0FHQSxHQUFBLEtBQUEsT0FBQSxxQ0FBQSxDQUNBLEtBQUEsY0FDQSxhQUFBLEtBQUEsYUFHQSxJQUFBLEdBQUEsU0FBQSxLQUFBLE9BQUEsOENBQUEsSUFFQSxNQUFBLGFBQUEsV0FBQSxXQUNBLEtBQUEsS0FBQSxTQUNBLElBQUEsZUFBQSxPQUFBLGFBQ0EsUUFDQSxPQUFBLDRCQUNBLFFBQUEsRUFDQSxTQUFBLEtBQUEsUUFBQSxJQUVBLFVBQUEsRUFDQSxXQUNBLFNBQ0EsR0FBQSxTQUFBLEdBQ0EsS0FBQSxRQUFBLE9BQUEsRUFBQSxNQUVBLEdBQUEsS0FBQSxhQUNBLEtBQUEsUUFBQSxJQUFBLFVBQUEsS0FBQSxRQUFBLElBQUEsZUFHQSxNQUFBLFVBSUEsS0FBQSxNQUFBLE9BRUEsTUFBQSxRQUFBLE9BQUEsR0FFQSxHQUFBLEtBQUEsYUFDQSxLQUFBLFFBQUEsSUFBQSxVQUFBLEtBQUEsUUFBQSxJQUFBLGFBT0EsT0FIQSxNQUFBLFdBQUEsSUFBQSxNQUFBLEtBQUEsT0FBQSxXQUNBLEtBQUEsU0FBQSxJQUFBLE1BQUEsRUFFQSxHQUdBLGtCQUFBLFNBQUEsR0FDQSxFQUFBLGtCQUNBLEVBQUEsa0JBR0EsS0FBQSxTQUFBLEdBQ0EsRUFBQSxrQkFDQSxFQUFBLGtCQUVBLEdBQUEsS0FBQSxPQUFBLDhDQUFBLEdBQUEsS0FBQSxPQUFBLDhDQUNBLEtBQUEsWUFBQSxFQUFBLGFBQUEsUUFJQSxZQUFBLFNBQUEsR0FDQSxJQUFBLEtBQUEsRUFBQSxTQUFBLEdBQ0EsR0FBQSxHQUFBLFdBQUEsS0FBQSxFQUFBLEtBRUEsSUFBQSxFQUFBLENBQ0EsR0FBQSxHQUFBLEtBQUEsT0FBQSw2Q0FBQSxPQUFBLENBRUEsS0FBQSxLQUFBLFVBQUEsS0FBQSxPQUFBLHFDQUFBLEdBR0EsTUFGQSxNQUFBLFlBQUEsRUFBQSxRQUFBLEVBQUEsaURBRUEsQ0FHQSxJQUFBLEVBQUEsS0FBQSxTQUFBLEtBQUEsT0FBQSxtQ0FHQSxNQUZBLE1BQUEsWUFBQSxFQUFBLFFBQUEsRUFBQSx1Q0FFQSxDQUdBLElBQUEsS0FBQSxPQUFBLHlDQUNBLEtBQUEsTUFDQSxNQUFBLGdDQUNBLEtBQUEsRUFDQSxHQUFBLE9BQ0EsUUFFQSxLQUFBLFdBQUEsRUFBQSxTQUNBLEtBQUEsT0FBQSxhQUVBLENBQ0EsR0FBQSxHQUFBLEtBQUEsT0FBQSw0Q0FBQSxPQUFBLENBRUEsS0FBQSxLQUFBLFVBQUEsS0FBQSxPQUFBLG9DQUFBLEdBR0EsTUFGQSxNQUFBLFlBQUEsRUFBQSxPQUFBLEVBQUEsZ0RBRUEsQ0FHQSxJQUFBLEVBQUEsS0FBQSxTQUFBLEtBQUEsT0FBQSxtQ0FHQSxNQUZBLE1BQUEsWUFBQSxFQUFBLE9BQUEsRUFBQSx1Q0FFQSxDQUdBLE1BQUEsV0FBQSxFQUFBLFFBQ0EsS0FBQSxPQUFBLFVBR0EsT0FHQSxVQUFBLFNBQUEsRUFBQSxHQUdBLE1BRkEsR0FBQSxFQUFBLE1BQUEsS0FFQSxJQUFBLEVBQUEsUUFBQSxFQUFBLEtBQUEsTUFBQSxLQUFBLFFBR0EsV0FBQSxTQUFBLEVBQUEsR0FDQSxJQUFBLEVBQUEsT0FFQSxJQUFBLEdBQUEsS0FBQSxpQkFFQSxFQUFBLEdBQUEsU0FDQSxHQUFBLE9BQUEsT0FBQSxHQUNBLEVBQUEsT0FBQSxTQUFBLGNBQUEsRUFBQSxVQUNBLEVBQUEsT0FBQSxPQUFBLEVBQUEsTUFDQSxFQUFBLE9BQUEsV0FBQSxLQUFBLE9BQUEsU0FFQSxJQUFBLEdBQUEsR0FBQSxlQUNBLEdBQUEsS0FBQSxPQUFBLGVBQUEsT0FBQSxjQUNBLEVBQUEsaUJBQUEsYUFBQSxRQUNBLEVBQUEsaUJBQUEsVUFBQSxJQUFBLEtBQUEsZUFBQSxTQUVBLEVBQUEsT0FBQSxXQUFBLFNBQUEsR0FDQSxHQUFBLEVBQUEsaUJBQUEsQ0FDQSxHQUFBLEdBQUEsRUFBQSxPQUFBLEVBQUEsTUFBQSxJQUFBLENBQ0EsR0FBQSxNQUFBLGFBQUEsU0FBQSxFQUFBLE9BRUEsS0FBQSxNQUVBLEVBQUEsT0FBQSxXQUNBLEdBQUEsTUFBQSxFQUFBLE9BQUEsQ0FDQSxHQUFBLEdBQUEsS0FBQSxNQUFBLEVBQUEsYUFDQSxJQUFBLEdBQUEsRUFBQSxRQUFBLENBQ0EsRUFBQSxRQUNBLElBQUEsR0FBQSxTQUFBLEVBQUEsSUFBQSxHQUNBLEVBQUEsU0FBQSxFQUFBLE9BQUEsSUFDQSxNQUFBLE9BQUEsT0FBQSxFQUFBLElBQUEsRUFBQSxPQUFBLEtBQUEsS0FBQSxFQUFBLE9BQUEsS0FBQSxLQUFBLEVBQUEsT0FBQSxLQUFBLEtBQUEsT0FFQSxNQUFBLGFBQUEsRUFBQSxFQUFBLFdBR0EsS0FBQSxNQUVBLEVBQUEsS0FBQSxJQUdBLGVBQUEsU0FBQSxFQUFBLEdBQ0EsR0FBQSxHQUFBLElBQUEsVUFBQSxZQUFBLEtBQUEsV0FDQSxJQUFBLE1BQ0EsS0FBQSwyRUFBQSxFQUFBLDRCQUFBLEdBQUEsRUFBQSxpQkFHQSxPQUFBLEtBQUEsSUFBQSxJQUdBLGFBQUEsU0FBQSxFQUFBLEdBQ0EsRUFBQSxNQUFBLGFBQUEsU0FBQSxTQUNBLEVBQUEsTUFBQSxhQUFBLFNBQUEsUUFFQSxFQUFBLE1BQUEsS0FBQSxTQUFBLGtCQUNBLEVBQUEsTUFBQSxLQUFBLGFBQUEsZUFBQSxlQUNBLEVBQUEsTUFBQSxLQUFBLFlBQUEsYUFFQSxFQUFBLE1BQUEsUUFBQSxJQUFBLFdBQUEsWUFBQSxFQUNBLEVBQUEsTUFBQSxtQkFBQSxHQUFBLFFBQUEsV0FDQSxFQUFBLFlBSUEsWUFBQSxTQUFBLEVBQUEsRUFBQSxHQUNBLEdBQUEsR0FBQSxLQUFBLGVBQUEsRUFBQSxFQUFBLEtBQ0EsTUFBQSxhQUFBLEVBQUEsTUFJQSxLQUFBLFFBQUEsV0FDQSxHQUFBLGdCQUFBLFFDemNBLGVBQUEsT0FBQSxRQUFBLFNBQUEsUUFDQSxPQUFBLFdBQ0EsT0FBQSxnQkFBQSxPQUFBLGlCQUFBLDhCQUVBLElBQUEsUUFBQSxRQUNBLE9BQUEsRUFDQSxPQUFBLE9BQ0EsWUFBQSxPQUNBLFFBQUEsRUFDQSxXQUFBLEVBQ0EsYUFBQSxFQUNBLGFBQUEsRUFDQSxZQUFBLEVBQ0EsWUFBQSxFQUNBLFdBQUEsRUFDQSxNQUFBLElBQ0EsTUFBQSxFQUFBLHFDQUNBLElBQUEsY0FDQSxLQUFBLCtDQUFBLElBQUEsZ0JBQUEsT0FBQSxNQUFBLFdBQ0EsT0FDQSxLQUFBLG9DQUFBLEVBQUEsK0JBQ0EsTUFBQSxLQUNBLE1BQUEsT0FDQSxPQUFBLGNBQ0EsUUFBQSxLQUFBLG9CQUVBLEtBQUEsa0NBQUEsRUFBQSwrQkFDQSxNQUFBLEtBQ0EsTUFBQSxPQUNBLE9BQUEsY0FDQSxRQUFBLEtBQUEsb0JBRUEsS0FBQSx5Q0FBQSxFQUFBLGtDQUNBLE1BQUEsS0FDQSxNQUFBLEdBQ0EsT0FBQSxPQUNBLFFBQUEsS0FBQSxvQkFFQSxLQUFBLDBDQUFBLEVBQUEsbUNBQ0EsTUFBQSxLQUNBLE9BQUEsR0FDQSxPQUFBLE9BQ0EsUUFBQSxLQUFBLG9CQUVBLEtBQUEseUNBQUEsRUFBQSxzQ0FDQSxNQUFBLEtBQ0EsTUFBQSxJQUNBLE9BQUEsU0FDQSxRQUFBLEtBQUEsb0JBRUEsS0FBQSwwQ0FBQSxFQUFBLHVDQUNBLE1BQUEsS0FDQSxNQUFBLEdBQ0EsT0FBQSxTQUNBLFFBQUEsS0FBQSxvQkFFQSxLQUFBLG9DQUFBLEVBQUEsd0NBQ0EsTUFBQSxLQUNBLE1BQUEsS0FDQSxPQUFBLFFBQ0EsUUFBQSxLQUFBLG9CQUVBLFVBQ0EsS0FBQSxFQUFBLFVBQ0EsTUFBQSxLQUNBLFFBQUEsS0FBQSxRQUVBLEtBQUEsRUFBQSxpQ0FDQSxJQUFBLGlCQUNBLE1BQUEsS0FDQSxLQUFBLEVBQ0EsUUFBQSxLQUFBLFNBRUEsS0FBQSxFQUFBLHNDQUNBLElBQUEsaUJBQ0EsTUFBQSxLQUNBLEtBQUEsRUFDQSxRQUFBLEtBQUEsU0FFQSxXQUNBLE1BQ0EsR0FBQSxXQUNBLEdBQUEsa0JBQ0EsTUFBQSxXQUFBLEVBQUEsSUFBQSxLQUFBLEdBQUEsSUFBQSxPQUFBLGdCQUVBLElBQUEsT0FBQSxLQUFBLE9BQUEsc0NBQ0EsU0FDQSxNQUFBLFFBQUEsa0JBQUEsSUFDQSxNQUFBLEtBQUEsT0FFQSxlQUFBLFlBQUEsT0FHQSxlQUFBLEtBQUEsU0FBQSxHQUNBLEtBQUEsV0FDQSxRQUFBLEVBQUEsRUFDQSxPQUFBLEVBQUEsRUFDQSxZQUFBLEVBQUEsT0FDQSxXQUFBLEVBQUEsTUFDQSxZQUFBLEVBQUEsT0FBQSxLQUNBLFFBQ0EsS0FBQSxNQUVBLEtBQUEsV0FBQSxRQUFBLGlCQUVBLE1BQUEsU0FJQSxlQUFBLE9BQUEsUUFBQSxXQUFBLFlBQUEsS0FBQSxLQUFBLFFBQ0EsS0FBQSxPQUFBLFFBR0EsSUFBQSxPQUFBLGVBQUEsT0FBQSxRQUFBLElBQUEsUUFDQSxVQUFBLEdBQ0EsT0FBQSxTQUFBLEdBQ0EsR0FBQSxHQUFBLEtBQUEsT0FBQSxHQUFBLGVBQUEsUUFBQSxLQUFBLE9BQUEsS0FBQSxNQUVBLEVBQUEsR0FBQSxTQUNBLEdBQUEsT0FBQSxPQUFBLEtBQUEsT0FBQSxNQUNBLEVBQUEsT0FBQSxTQUFBLDBCQUNBLEVBQUEsT0FBQSxZQUFBLEtBQUEsV0FDQSxFQUFBLE9BQUEsT0FBQSxLQUFBLE9BQUEsS0FBQSxNQUNBLEVBQUEsT0FBQSxPQUFBLEVBQUEsTUFDQSxFQUFBLE9BQUEsV0FBQSxLQUFBLE9BQUEsR0FBQSxPQUFBLFNBRUEsSUFBQSxHQUFBLEdBQUEsZUFDQSxHQUFBLEtBQUEsT0FBQSxlQUFBLE9BQUEsY0FDQSxFQUFBLGlCQUFBLGFBQUEsUUFDQSxFQUFBLGlCQUFBLFVBQUEsSUFBQSxLQUFBLGVBQUEsU0FFQSxFQUFBLE9BQUEsV0FBQSxTQUFBLEdBQ0EsR0FBQSxFQUFBLGlCQUFBLENBQ0EsR0FBQSxHQUFBLEVBQUEsT0FBQSxFQUFBLE1BQUEsSUFBQSxDQUNBLEdBQUEsTUFBQSxhQUFBLFNBQUEsRUFBQSxPQUVBLEtBQUEsTUFFQSxFQUFBLE9BQUEsV0FDQSxHQUFBLE1BQUEsRUFBQSxPQUFBLENBQ0EsR0FBQSxHQUFBLEtBQUEsTUFBQSxFQUFBLGFBRUEsSUFBQSxFQUFBLFNBQ0EsRUFBQSxTQUNBLEtBQUEsT0FBQSxHQUFBLE9BQUEsT0FBQSxLQUFBLEVBQUEsT0FBQSxLQUFBLEtBQUEsRUFBQSxPQUFBLEtBQUEsS0FBQSxFQUFBLE9BQUEsS0FBQSxXQUVBLEtBQUEsT0FBQSxHQUFBLGFBQUEsRUFBQSxFQUFBLFdBR0EsS0FBQSxNQUVBLEVBQUEsS0FBQSxHQUVBLEtBQUEsU0FHQSxrQkFBQSxTQUFBLEdBQ0EsS0FBQSxXQUFBLFFBQUEsRUFBQSxPQUFBLEVBQUEsUUFHQSxNQUFBLFdBQ0EsS0FBQSxXQUFBLFFBQUEsV0FFQSxlQUFBLE9BQUEsUUFBQSxXQUFBLE1BQUEsS0FBQSxNQUNBLEtBQUEsT0FBQSxHQUFBLE9BQUEsV0FHQSxJQUFBLElBQUEsZ0NBQUEsZUFBQSxPQUFBIiwiZmlsZSI6ImFwcC5qcyIsInNvdXJjZXNDb250ZW50IjpbIkV4dC5ucygnTWFya2Rvd25FZGl0b3InKTtcbk1hcmtkb3duRWRpdG9yID0gZnVuY3Rpb24oY29uZmlnKSB7XG4gICAgY29uZmlnID0gY29uZmlnIHx8IHt9O1xuICAgIE1hcmtkb3duRWRpdG9yLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLGNvbmZpZyk7XG59O1xuRXh0LmV4dGVuZChNYXJrZG93bkVkaXRvcixFeHQuQ29tcG9uZW50LHtcbiAgICB3aW5kb3c6e30sY29uZmlnOiB7fVxufSk7XG5FeHQucmVnKCdtYXJrZG93bmVkaXRvcicsTWFya2Rvd25FZGl0b3IpO1xubWFya2Rvd25FZGl0b3IgPSBuZXcgTWFya2Rvd25FZGl0b3IoKTtcblxubWFya2Rvd25FZGl0b3IuRWRpdG9yID0gZnVuY3Rpb24oY29uZmlnKSB7XG4gICAgY29uZmlnID0gY29uZmlnIHx8IHt9O1xuICAgIGNvbmZpZy5yZXNvdXJjZSA9IE1PRHgucmVxdWVzdC5pZCB8fCAwO1xuICAgIG1hcmtkb3duRWRpdG9yLkVkaXRvci5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcyxjb25maWcpO1xuICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xufTtcbkV4dC5leHRlbmQobWFya2Rvd25FZGl0b3IuRWRpdG9yLEV4dC5Db21wb25lbnQse1xuICAgIHJlbWFya2FibGU6ICcnXG4gICAgLGZ1bGxTY3JlZW46IGZhbHNlXG4gICAgLGluaXRDb21wb25lbnQ6IGZ1bmN0aW9uKCkge1xuICAgICAgICBNYXJrZG93bkVkaXRvci5zdXBlcmNsYXNzLmluaXRDb21wb25lbnQuY2FsbCh0aGlzKTtcblxuICAgICAgICBFeHQub25SZWFkeSh0aGlzLnJlbmRlciwgdGhpcyk7XG4gICAgfVxuXG4gICAgLHJlbmRlcjogZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMudGV4dGFyZWEgPSBFeHQuZ2V0KCd0YScpO1xuXG4gICAgICAgIHRoaXMuYnVpbGRVSSgpO1xuICAgICAgICB0aGlzLnJlZ2lzdGVyQWNlKCk7XG4gICAgICAgIHRoaXMucmVnaXN0ZXJNYXJrZWQoKTtcblxuICAgICAgICB2YXIgcHJldmlld0J1dHRvbiA9IHRoaXMudG9vbEJveC5jaGlsZCgnLnByZXZpZXctYnV0dG9uJyk7XG4gICAgICAgIHZhciBmdWxsc2NyZWVuQnV0dG9uID0gdGhpcy50b29sQm94LmNoaWxkKCcuZnVsbHNjcmVlbi1idXR0b24nKTtcbiAgICAgICAgdmFyIGNvbnRlbnQgPSB0aGlzLmNvbnRlbnRNRDtcbiAgICAgICAgdmFyIHdyYXBwZXIgPSBjb250ZW50LnBhcmVudCgpO1xuXG4gICAgICAgIHZhciBkcm9wVGFyZ2V0ID0gTU9EeC5sb2FkKHtcbiAgICAgICAgICAgIHh0eXBlOiAnbW9keC10cmVlZHJvcCcsXG4gICAgICAgICAgICB0YXJnZXQ6IGNvbnRlbnQsXG4gICAgICAgICAgICB0YXJnZXRFbDogY29udGVudCxcbiAgICAgICAgICAgIG9uSW5zZXJ0OiAoZnVuY3Rpb24ocyl7XG4gICAgICAgICAgICAgICAgdGhpcy5pbnNlcnQocyk7XG4gICAgICAgICAgICAgICAgdGhpcy5mb2N1cygpO1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfSkuYmluZCh0aGlzLmVkaXRvciksXG4gICAgICAgICAgICBpZnJhbWU6IHRydWVcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMudGV4dGFyZWEub24oJ2Rlc3Ryb3knLCBmdW5jdGlvbigpIHtkcm9wVGFyZ2V0LmRlc3Ryb3koKTt9KTtcblxuICAgICAgICBwcmV2aWV3QnV0dG9uLmFkZExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnByZXZpZXcuaXNWaXNpYmxlKCkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnByZXZpZXcuc2V0RGlzcGxheWVkKCdub25lJyk7XG4gICAgICAgICAgICAgICAgY29udGVudC5zZXREaXNwbGF5ZWQoJ2Jsb2NrJyk7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0dXNCYXIuc2V0RGlzcGxheWVkKCdibG9jaycpO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5lZGl0b3IuZm9jdXMoKTtcblxuICAgICAgICAgICAgICAgIHByZXZpZXdCdXR0b24uY2hpbGQoJ2knKS5yZW1vdmVDbGFzcygnaWNvbi10b2dnbGUtb24nKTtcbiAgICAgICAgICAgICAgICBwcmV2aWV3QnV0dG9uLmNoaWxkKCdpJykuYWRkQ2xhc3MoJ2ljb24tdG9nZ2xlLW9mZicpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLnByZXZpZXcuc2V0RGlzcGxheWVkKCdibG9jaycpO1xuICAgICAgICAgICAgICAgIGNvbnRlbnQuc2V0RGlzcGxheWVkKCdub25lJyk7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0dXNCYXIuc2V0RGlzcGxheWVkKCdub25lJyk7XG5cbiAgICAgICAgICAgICAgICBwcmV2aWV3QnV0dG9uLmNoaWxkKCdpJykucmVtb3ZlQ2xhc3MoJ2ljb24tdG9nZ2xlLW9mZicpO1xuICAgICAgICAgICAgICAgIHByZXZpZXdCdXR0b24uY2hpbGQoJ2knKS5hZGRDbGFzcygnaWNvbi10b2dnbGUtb24nKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSwgdGhpcyk7XG5cbiAgICAgICAgZnVsbHNjcmVlbkJ1dHRvbi5hZGRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgaWNvbiA9IGZ1bGxzY3JlZW5CdXR0b24uY2hpbGQoJ2knKTtcblxuICAgICAgICAgICAgaWYgKHRoaXMuZnVsbFNjcmVlbiA9PSBmYWxzZSkge1xuICAgICAgICAgICAgICAgIHRoaXMuZnVsbFNjcmVlbiA9IHRydWU7XG4gICAgICAgICAgICAgICAgaWNvbi5yZW1vdmVDbGFzcygnaWNvbi1leHBhbmQnKTtcbiAgICAgICAgICAgICAgICBpY29uLmFkZENsYXNzKCdpY29uLWNvbXByZXNzJyk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLnByZXZpZXcuc2V0RGlzcGxheWVkKCdibG9jaycpO1xuICAgICAgICAgICAgICAgIGNvbnRlbnQuc2V0RGlzcGxheWVkKCdibG9jaycpO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5lZGl0b3IuZm9jdXMoKTtcblxuICAgICAgICAgICAgICAgIHByZXZpZXdCdXR0b24uaGlkZSgpO1xuXG4gICAgICAgICAgICAgICAgd3JhcHBlci5hZGRDbGFzcygnZnVsbHNjcmVlbicpO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5lZGl0b3Iuc2V0T3B0aW9uKCdtYXhMaW5lcycsIG51bGwpO1xuXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuZnVsbFNjcmVlbiA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIGljb24uYWRkQ2xhc3MoJ2ljb24tZXhwYW5kJyk7XG4gICAgICAgICAgICAgICAgaWNvbi5yZW1vdmVDbGFzcygnaWNvbi1jb21wcmVzcycpO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5wcmV2aWV3LnNldERpc3BsYXllZCgnbm9uZScpO1xuICAgICAgICAgICAgICAgIGNvbnRlbnQuc2V0RGlzcGxheWVkKCdibG9jaycpO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5lZGl0b3IuZm9jdXMoKTtcblxuICAgICAgICAgICAgICAgIHByZXZpZXdCdXR0b24uc2hvdygpO1xuXG4gICAgICAgICAgICAgICAgd3JhcHBlci5yZW1vdmVDbGFzcygnZnVsbHNjcmVlbicpO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5lZGl0b3Iuc2V0T3B0aW9uKCdtYXhMaW5lcycsIEluZmluaXR5KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5zdGF0dXNCYXIuc2V0RGlzcGxheWVkKCdibG9jaycpO1xuXG4gICAgICAgICAgICB0aGlzLmVkaXRvci5yZXNpemUodHJ1ZSk7XG4gICAgICAgIH0sIHRoaXMpO1xuXG4gICAgICAgIGlmIChtYXJrZG93bkVkaXRvci5jb250ZW50LmNvbnRlbnQpIHtcbiAgICAgICAgICAgIHRoaXMuZWRpdG9yLnNldFZhbHVlKG1hcmtkb3duRWRpdG9yLmNvbnRlbnQuY29udGVudCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5lZGl0b3Iuc2VsZWN0aW9uLmNsZWFyU2VsZWN0aW9uKCk7XG5cbiAgICAgICAgdGhpcy5wcmV2aWV3LnVwZGF0ZSh0aGlzLnBhcnNlKHRoaXMuZWRpdG9yLmdldFZhbHVlKCkpKTtcblxuICAgICAgICB0aGlzLmVkaXRvci5nZXRTZXNzaW9uKCkub24oJ2NoYW5nZScsIGZ1bmN0aW9uKGUpe1xuICAgICAgICAgICAgdGhpcy5wYXJzZSh0aGlzLmVkaXRvci5nZXRWYWx1ZSgpKTtcbiAgICAgICAgfS5iaW5kKHRoaXMpKTtcbiAgICB9XG5cbiAgICAsYnVpbGRVSTogZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMudGV4dGFyZWEuc2V0RGlzcGxheWVkKCdub25lJyk7XG4gICAgICAgIHRoaXMudGV4dGFyZWEuc2V0V2lkdGgoMCk7XG4gICAgICAgIHRoaXMudGV4dGFyZWEuc2V0SGVpZ2h0KDApO1xuXG4gICAgICAgIHRoaXMudGFNYXJrZG93biA9IEV4dC5nZXQoRXh0LkRvbUhlbHBlci5pbnNlcnRCZWZvcmUodGhpcy50ZXh0YXJlYSwge1xuICAgICAgICAgICAgdGFnOiAndGV4dGFyZWEnLFxuICAgICAgICAgICAgbmFtZTogJ3RhX21hcmtkb3duJyxcbiAgICAgICAgICAgIGNsYXNzOiAndGFfbWFya2Rvd24nXG4gICAgICAgIH0pKTtcblxuICAgICAgICB0aGlzLnRhTWFya2Rvd24uc2V0RGlzcGxheWVkKCdub25lJyk7XG4gICAgICAgIHRoaXMudGFNYXJrZG93bi5zZXRXaWR0aCgwKTtcbiAgICAgICAgdGhpcy50YU1hcmtkb3duLnNldEhlaWdodCgwKTtcblxuICAgICAgICB2YXIgd3JhcHBlciA9IEV4dC5Eb21IZWxwZXIuaW5zZXJ0QmVmb3JlKHRoaXMudGV4dGFyZWEsIHtcbiAgICAgICAgICAgIHRhZzogJ2RpdicsXG4gICAgICAgICAgICBjbGFzczogJ21hcmtkb3duLWNvbnRhaW5lcidcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5jb250ZW50TUQgPSBFeHQuZ2V0KEV4dC5Eb21IZWxwZXIuYXBwZW5kKHdyYXBwZXIse1xuICAgICAgICAgICAgdGFnOiAnZGl2JyxcbiAgICAgICAgICAgIGNsYXNzOiB0aGlzLnRleHRhcmVhLmRvbS5jbGFzc05hbWUgKyAnIGNvbnRlbnQtbWQnXG4gICAgICAgIH0pKTtcblxuICAgICAgICB0aGlzLnByZXZpZXcgPSBFeHQuZ2V0KEV4dC5Eb21IZWxwZXIuYXBwZW5kKHdyYXBwZXIse1xuICAgICAgICAgICAgdGFnOiAnZGl2JyxcbiAgICAgICAgICAgIGNsYXNzOiAnbWFya2Rvd24tYm9keSBwcmV2aWV3LW1kJ1xuICAgICAgICB9KSk7XG5cbiAgICAgICAgdGhpcy50b29sQm94ID0gRXh0LmdldChFeHQuRG9tSGVscGVyLmFwcGVuZCh3cmFwcGVyLHtcbiAgICAgICAgICAgIHRhZzogJ2RpdicsXG4gICAgICAgICAgICBjbGFzczogJ3Rvb2xib3gnLFxuICAgICAgICAgICAgY246IFt7XG4gICAgICAgICAgICAgICAgdGFnOiAnc3BhbicsXG4gICAgICAgICAgICAgICAgY2xhc3M6ICdwcmV2aWV3LWJ1dHRvbicsXG4gICAgICAgICAgICAgICAgaHRtbDogJzxpIGNsYXNzPVwiaWNvbiBpY29uLXRvZ2dsZS1vZmZcIj48L2k+ICcgKyBfKCdtYXJrZG93bmVkaXRvci50b29sYm94LnByZXZpZXcnKVxuICAgICAgICAgICAgfSx7XG4gICAgICAgICAgICAgICAgdGFnOiAnc3BhbicsXG4gICAgICAgICAgICAgICAgY2xhc3M6ICdmdWxsc2NyZWVuLWJ1dHRvbicsXG4gICAgICAgICAgICAgICAgaHRtbDogJzxpIGNsYXNzPVwiaWNvbiBpY29uLWV4cGFuZFwiPjwvaT4nXG4gICAgICAgICAgICB9XVxuICAgICAgICB9KSk7XG5cbiAgICAgICAgaWYgKE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci51cGxvYWQuZW5hYmxlX2ltYWdlX3VwbG9hZCddID09IDEgfHwgTU9EeC5jb25maWdbJ21hcmtkb3duZWRpdG9yLnVwbG9hZC5lbmFibGVfZmlsZV91cGxvYWQnXSA9PSAxKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXR1c0JhciA9IEV4dC5nZXQoRXh0LkRvbUhlbHBlci5hcHBlbmQod3JhcHBlcix7XG4gICAgICAgICAgICAgICAgdGFnOiAnZGl2JyxcbiAgICAgICAgICAgICAgICBjbGFzczogJ3N0YXR1cy1iYXInXG4gICAgICAgICAgICB9KSk7XG5cbiAgICAgICAgICAgIHRoaXMuc3RhdHVzQmFyLmRvbS5pbm5lckhUTUwgPSAnPGRpdiBjbGFzcz1cInVwbG9hZC1iYXJcIj4gPGlucHV0IGNsYXNzPVwiaGlkZGVuXCIgbmFtZT1cImZpbGVcIiBpZD1cIicgKyB0aGlzLnN0YXR1c0Jhci5pZCArICctZmlsZVwiIHR5cGU9XCJmaWxlXCIgbXVsdGlwbGU+JyArIF8oJ21hcmtkb3duZWRpdG9yLnN0YXR1c19iYXJfbWVzc2FnZScsIHtpZDogdGhpcy5zdGF0dXNCYXIuaWQgKyAnLWZpbGUnfSkgKyAnPC9kaXY+JztcblxuICAgICAgICAgICAgdGhpcy5zdGF0dXNCYXIuY2hpbGQoJ2lucHV0Jykub24oJ2NoYW5nZScsIGZ1bmN0aW9uKGUsIGlucHV0KSB7XG4gICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVGaWxlcyhpbnB1dC5maWxlcyk7XG4gICAgICAgICAgICAgICAgaW5wdXQudmFsdWUgPSBcIlwiO1xuICAgICAgICAgICAgfSwgdGhpcyk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnN0YXR1c0JhciA9IEV4dC5nZXQoRXh0LkRvbUhlbHBlci5hcHBlbmQod3JhcHBlcix7XG4gICAgICAgICAgICAgICAgdGFnOiAnZGl2JyxcbiAgICAgICAgICAgICAgICBjbGFzczogJ3N0YXR1cy1iYXInLFxuICAgICAgICAgICAgICAgIGh0bWw6IF8oJ21hcmtkb3duZWRpdG9yLnN0YXR1c19iYXJfZGlzYWJsZWQnKVxuICAgICAgICAgICAgfSkpO1xuICAgICAgICB9XG5cbiAgICAgICAgRXh0LkRvbUhlbHBlci5hcHBlbmQod3JhcHBlcix7XG4gICAgICAgICAgICB0YWc6ICdzcGFuJyxcbiAgICAgICAgICAgIHN0eWxlOiAnY2xlYXI6IGJvdGgnXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgICxyZWdpc3RlckFjZTogZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMuZWRpdG9yID0gYWNlLmVkaXQoRXh0LkRvbVF1ZXJ5LnNlbGVjdE5vZGUoJ2Rpdi5jb250ZW50LW1kJykpO1xuICAgICAgICB0aGlzLmVkaXRvci5zZXRPcHRpb25zKHtcbiAgICAgICAgICAgIG1heExpbmVzOiBJbmZpbml0eSxcbiAgICAgICAgICAgIG1pbkxpbmVzOiAyNSxcbiAgICAgICAgICAgIGVuYWJsZUJhc2ljQXV0b2NvbXBsZXRpb246IHRydWVcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuZWRpdG9yLnJlbmRlcmVyLnNldFNob3dHdXR0ZXIodHJ1ZSk7XG4gICAgICAgIHRoaXMuZWRpdG9yLnJlbmRlcmVyLnNldFNjcm9sbE1hcmdpbigxMCwgMTApO1xuICAgICAgICB0aGlzLmVkaXRvci5nZXRTZXNzaW9uKCkuc2V0VmFsdWUodGhpcy50ZXh0YXJlYS5nZXRWYWx1ZSgpKTtcbiAgICAgICAgdGhpcy5lZGl0b3IuZ2V0U2Vzc2lvbigpLnNldE1vZGUoXCJhY2UvbW9kZS9tYXJrZG93blwiKTtcbiAgICAgICAgdGhpcy5lZGl0b3Iuc2V0VGhlbWUoXCJhY2UvdGhlbWUvXCIgKyAoTU9EeC5jb25maWdbJ21hcmtkb3duZWRpdG9yLmdlbmVyYWwudGhlbWUnXSB8fCAnbW9ub2thaScpKTtcblxuICAgICAgICB2YXIgbGFuZ1Rvb2xzID0gYWNlLnJlcXVpcmUoXCJhY2UvZXh0L2xhbmd1YWdlX3Rvb2xzXCIpO1xuICAgICAgICB2YXIgcmVzb3VyY2VzQ29tcGxldGVyID0ge1xuICAgICAgICAgICAgZ2V0Q29tcGxldGlvbnM6IGZ1bmN0aW9uKGVkaXRvciwgc2Vzc2lvbiwgcG9zLCBwcmVmaXgsIGNhbGxiYWNrKSB7XG4gICAgICAgICAgICAgICAgaWYgKHByZWZpeC5sZW5ndGggPT09IDApIHsgY2FsbGJhY2sobnVsbCwgW10pOyByZXR1cm4gfVxuXG4gICAgICAgICAgICAgICAgTU9EeC5BamF4LnJlcXVlc3Qoe1xuICAgICAgICAgICAgICAgICAgICB1cmw6IG1hcmtkb3duRWRpdG9yLmNvbmZpZy5jb25uZWN0b3JVcmxcbiAgICAgICAgICAgICAgICAgICAgLHBhcmFtczoge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uOiAnbWdyL3Jlc291cmNlL2dldGxpc3QnXG4gICAgICAgICAgICAgICAgICAgICAgICAscHJlZml4OiBwcmVmaXhcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAnc3VjY2Vzcyc6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbjogZnVuY3Rpb24ocikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCByLnJlc3VsdHMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIGxhbmdUb29scy5hZGRDb21wbGV0ZXIocmVzb3VyY2VzQ29tcGxldGVyKTtcblxuXG4gICAgICAgIHRoaXMuZWRpdG9yLmNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKFwiZHJhZ2VudGVyXCIsIHRoaXMuY2F0Y2hBbmREb05vdGhpbmcsIGZhbHNlKTtcbiAgICAgICAgdGhpcy5lZGl0b3IuY29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoXCJkcmFnb3ZlclwiLCB0aGlzLmNhdGNoQW5kRG9Ob3RoaW5nLCBmYWxzZSk7XG4gICAgICAgIHRoaXMuZWRpdG9yLmNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKFwiZHJvcFwiLCB0aGlzLmRyb3AuYmluZCh0aGlzKSwgZmFsc2UpO1xuICAgIH1cblxuICAgICxyZWdpc3Rlck1hcmtlZDogZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMucmVtYXJrYWJsZSA9IG5ldyBSZW1hcmthYmxlKHtcbiAgICAgICAgICAgIGh0bWw6IHRydWUsXG4gICAgICAgICAgICBoaWdobGlnaHQ6IGZ1bmN0aW9uIChzdHIsIGxhbmcpIHtcbiAgICAgICAgICAgICAgICBpZiAobGFuZyAmJiBobGpzLmdldExhbmd1YWdlKGxhbmcpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGxqcy5oaWdobGlnaHQobGFuZywgc3RyKS52YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7fVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBobGpzLmhpZ2hsaWdodEF1dG8oc3RyKS52YWx1ZTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHt9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gJyc7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnJlbWFya2FibGUuaW5saW5lLnJ1bGVyLmRpc2FibGUoWyAnYmFja3RpY2tzJyBdKTtcbiAgICB9XG5cbiAgICAscGFyc2U6IGZ1bmN0aW9uKGlucHV0KSB7XG4gICAgICAgIHZhciBvdXRwdXQgPSB0aGlzLnJlbWFya2FibGUucmVuZGVyKGlucHV0KTtcblxuICAgICAgICBvdXRwdXQgPSBvdXRwdXQucmVwbGFjZSgvJTVCL2csICdbJyk7XG4gICAgICAgIG91dHB1dCA9IG91dHB1dC5yZXBsYWNlKC8lNUQvZywgJ10nKTtcblxuICAgICAgICB2YXIgY29kZUJsb2NrcyA9IG91dHB1dC5tYXRjaCgvPGNvZGUoLnxcXHMpKjxcXC9jb2RlPi9nKTtcbiAgICAgICAgRXh0LmVhY2goY29kZUJsb2NrcywgZnVuY3Rpb24oaXRlbSkge1xuICAgICAgICAgICAgdmFyIHJlcGxhY2VkSXRlbSA9IGl0ZW0ucmVwbGFjZSgvXFxbXFxbL2csICcmIzkxOyYjOTE7Jyk7XG4gICAgICAgICAgICByZXBsYWNlZEl0ZW0gPSByZXBsYWNlZEl0ZW0ucmVwbGFjZSgvXV0vZywgJyYjOTM7JiM5MzsnKTtcblxuICAgICAgICAgICAgb3V0cHV0ID0gb3V0cHV0LnJlcGxhY2UoaXRlbSwgcmVwbGFjZWRJdGVtKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci5scC5wYXJzZV9tb2R4X3RhZ3MnXSA9PSAxKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5wYXJzZVJlcXVlc3QpIHtcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5wYXJzZVJlcXVlc3QpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB2YXIgdGltZW91dCA9IHBhcnNlSW50KE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci5scC5wYXJzZV9tb2R4X3RhZ3NfdGltZW91dCddIHx8IDMwMCk7XG5cbiAgICAgICAgICAgIHRoaXMucGFyc2VSZXF1ZXN0ID0gc2V0VGltZW91dChmdW5jdGlvbigpe1xuICAgICAgICAgICAgICAgIE1PRHguQWpheC5yZXF1ZXN0KHtcbiAgICAgICAgICAgICAgICAgICAgdXJsOiBtYXJrZG93bkVkaXRvci5jb25maWcuY29ubmVjdG9yVXJsXG4gICAgICAgICAgICAgICAgICAgICxwYXJhbXM6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbjogJ21nci9lZGl0b3IvcHJvY2Vzc2NvbnRlbnQnXG4gICAgICAgICAgICAgICAgICAgICAgICAsY29udGVudDogb3V0cHV0XG4gICAgICAgICAgICAgICAgICAgICAgICAscmVzb3VyY2U6IE1PRHgucmVxdWVzdC5pZFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBpc1VwbG9hZCA6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyczoge1xuICAgICAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm46IGZ1bmN0aW9uKHIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wcmV2aWV3LnVwZGF0ZShyLmRhdGEpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmZ1bGxTY3JlZW4gPT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wcmV2aWV3LmRvbS5zY3JvbGxUb3AgPSB0aGlzLnByZXZpZXcuZG9tLnNjcm9sbEhlaWdodFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZTogdGhpc1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9LmJpbmQodGhpcyksIHRpbWVvdXQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5wcmV2aWV3LnVwZGF0ZShvdXRwdXQpO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5mdWxsU2NyZWVuID09IHRydWUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnByZXZpZXcuZG9tLnNjcm9sbFRvcCA9IHRoaXMucHJldmlldy5kb20uc2Nyb2xsSGVpZ2h0XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnRhTWFya2Rvd24uZG9tLnZhbHVlID0gdGhpcy5lZGl0b3IuZ2V0VmFsdWUoKTtcbiAgICAgICAgdGhpcy50ZXh0YXJlYS5kb20udmFsdWUgPSBvdXRwdXQ7XG5cbiAgICAgICAgcmV0dXJuIG91dHB1dDtcbiAgICB9XG5cbiAgICAsY2F0Y2hBbmREb05vdGhpbmc6IGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIH1cblxuICAgICxkcm9wOiBmdW5jdGlvbihlKSB7XG4gICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgICBpZiAoTU9EeC5jb25maWdbJ21hcmtkb3duZWRpdG9yLnVwbG9hZC5lbmFibGVfaW1hZ2VfdXBsb2FkJ10gPT0gMSB8fCBNT0R4LmNvbmZpZ1snbWFya2Rvd25lZGl0b3IudXBsb2FkLmVuYWJsZV9maWxlX3VwbG9hZCddID09IDEpIHtcbiAgICAgICAgICAgIHRoaXMuaGFuZGxlRmlsZXMoZS5kYXRhVHJhbnNmZXIuZmlsZXMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLGhhbmRsZUZpbGVzOiBmdW5jdGlvbihmaWxlcykge1xuICAgICAgICBFeHQuZWFjaChmaWxlcywgZnVuY3Rpb24oZmlsZSkge1xuICAgICAgICAgICAgdmFyIGlzSW1hZ2UgPSAvXmltYWdlXFwvLy50ZXN0KGZpbGUudHlwZSk7XG5cbiAgICAgICAgICAgIGlmIChpc0ltYWdlKSB7XG4gICAgICAgICAgICAgICAgaWYgKE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci51cGxvYWQuZW5hYmxlX2ltYWdlX3VwbG9hZCddID09IDApIHJldHVybiB0cnVlO1xuXG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmNoZWNrVHlwZShNT0R4LmNvbmZpZ1snbWFya2Rvd25lZGl0b3IudXBsb2FkLmltYWdlX3R5cGVzJ10sIGZpbGUpKXtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5mYWlsTWVzc2FnZShmaWxlLCAnaW1hZ2UnLCBfKCdtYXJrZG93bmVkaXRvci5lcnIudXBsb2FkLnVuc3VwcG9ydGVkX2ltYWdlJykpO1xuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChmaWxlLnNpemUgPiBwYXJzZUludChNT0R4LmNvbmZpZ1snbWFya2Rvd25lZGl0b3IudXBsb2FkLm1heF9zaXplJ10pKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmFpbE1lc3NhZ2UoZmlsZSwgJ2ltYWdlJywgXygnbWFya2Rvd25lZGl0b3IuZXJyLnVwbG9hZC50b29fYmlnJykpO1xuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmIChNT0R4LmNvbmZpZ1snbWFya2Rvd25lZGl0b3IuY3JvcHBlci5lbmFibGVfY3JvcHBlciddID09IDEpIHtcbiAgICAgICAgICAgICAgICAgICAgTU9EeC5sb2FkKHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHh0eXBlOiAnbWFya2Rvd25lZGl0b3Itd2luZG93LWNyb3BwZXInXG4gICAgICAgICAgICAgICAgICAgICAgICAsZmlsZTogZmlsZVxuICAgICAgICAgICAgICAgICAgICAgICAgLG1kOiB0aGlzXG4gICAgICAgICAgICAgICAgICAgIH0pLnNob3coKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnVwbG9hZEZpbGUoZmlsZSwgJ2ltYWdlJyk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZWRpdG9yLmZvY3VzKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoTU9EeC5jb25maWdbJ21hcmtkb3duZWRpdG9yLnVwbG9hZC5lbmFibGVfZmlsZV91cGxvYWQnXSA9PSAwKSByZXR1cm4gdHJ1ZTtcblxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5jaGVja1R5cGUoTU9EeC5jb25maWdbJ21hcmtkb3duZWRpdG9yLnVwbG9hZC5maWxlX3R5cGVzJ10sIGZpbGUpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmFpbE1lc3NhZ2UoZmlsZSwgJ2ZpbGUnLCBfKCdtYXJrZG93bmVkaXRvci5lcnIudXBsb2FkLnVuc3VwcG9ydGVkX2ZpbGUnKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGZpbGUuc2l6ZSA+IHBhcnNlSW50KE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci51cGxvYWQubWF4X3NpemUnXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5mYWlsTWVzc2FnZShmaWxlLCAnZmlsZScsIF8oJ21hcmtkb3duZWRpdG9yLmVyci51cGxvYWQudG9vX2JpZycpKTtcblxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB0aGlzLnVwbG9hZEZpbGUoZmlsZSwgJ2ZpbGUnKTtcbiAgICAgICAgICAgICAgICB0aGlzLmVkaXRvci5mb2N1cygpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0sIHRoaXMpO1xuICAgIH1cblxuICAgICxjaGVja1R5cGU6IGZ1bmN0aW9uKGFsbG93ZWRUeXBlcywgZmlsZSkge1xuICAgICAgICBhbGxvd2VkVHlwZXMgPSBhbGxvd2VkVHlwZXMuc3BsaXQoJywnKTtcblxuICAgICAgICByZXR1cm4gYWxsb3dlZFR5cGVzLmluZGV4T2YoZmlsZS5uYW1lLnNwbGl0KCcuJykucG9wKCkpICE9IC0xO1xuICAgIH1cblxuICAgICx1cGxvYWRGaWxlOiBmdW5jdGlvbihmaWxlLCB0eXBlKSB7XG4gICAgICAgIGlmICghdHlwZSkgdHlwZSA9ICdmaWxlJztcblxuICAgICAgICB2YXIgdXBsb2FkZXIgPSB0aGlzLmNyZWF0ZVVwbG9hZGVyKCk7XG5cbiAgICAgICAgdmFyIGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnZmlsZScsIGZpbGUpO1xuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ2FjdGlvbicsICdtZ3IvZWRpdG9yLycgKyB0eXBlICsgJ3VwbG9hZCcpO1xuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ25hbWUnLCBmaWxlLm5hbWUpO1xuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ3Jlc291cmNlJywgdGhpcy5jb25maWcucmVzb3VyY2UpO1xuXG4gICAgICAgIHZhciB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgICAgICAgeGhyLm9wZW4oJ1BPU1QnLCBtYXJrZG93bkVkaXRvci5jb25maWcuY29ubmVjdG9yVXJsKTtcbiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ1Bvd2VyZWQtQnknLCAnTU9EeCcpO1xuICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignbW9kQXV0aCcsIEV4dC5BamF4LmRlZmF1bHRIZWFkZXJzLm1vZEF1dGgpO1xuXG4gICAgICAgIHhoci51cGxvYWQub25wcm9ncmVzcyA9IGZ1bmN0aW9uIChldmVudCkge1xuICAgICAgICAgICAgaWYgKGV2ZW50Lmxlbmd0aENvbXB1dGFibGUpIHtcbiAgICAgICAgICAgICAgICB2YXIgY29tcGxldGUgPSAoZXZlbnQubG9hZGVkIC8gZXZlbnQudG90YWwgKiAxMDAgfCAwKTtcbiAgICAgICAgICAgICAgICB1cGxvYWRlci5jaGlsZCgnLnByb2dyZXNzJykuc2V0V2lkdGgoY29tcGxldGUgKyAnJScpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LmJpbmQodGhpcyk7XG5cbiAgICAgICAgeGhyLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmICh4aHIuc3RhdHVzID09PSAyMDApIHtcbiAgICAgICAgICAgICAgICB2YXIgcmVzID0gSlNPTi5wYXJzZSh4aHIucmVzcG9uc2VUZXh0KTtcbiAgICAgICAgICAgICAgICBpZiAocmVzLnN1Y2Nlc3MgPT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgICAgICB1cGxvYWRlci5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGltYWdlUHJlZml4ID0gKHR5cGUgPT0gJ2ltYWdlJykgPyAnIScgOiAnJztcbiAgICAgICAgICAgICAgICAgICAgdmFyIGVuZExpbmUgPSAodHlwZSA9PSAnaW1hZ2UnKSA/ICdcXG5cXG4nIDogJ1xcbic7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZWRpdG9yLmluc2VydChpbWFnZVByZWZpeCArICdbJyArIHJlcy5vYmplY3QubmFtZSArICddKCcgKyByZXMub2JqZWN0LnBhdGggKyAnIFwiJyArIHJlcy5vYmplY3QubmFtZSArICdcIiknICsgZW5kTGluZSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5mYWlsVXBsb2FkZXIodXBsb2FkZXIsIHJlcy5tZXNzYWdlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0uYmluZCh0aGlzKTtcblxuICAgICAgICB4aHIuc2VuZChmb3JtRGF0YSk7XG4gICAgfVxuXG4gICAgLGNyZWF0ZVVwbG9hZGVyOiBmdW5jdGlvbih0eXBlLCBmaWxlTmFtZSkge1xuICAgICAgICB2YXIgdXBsb2FkZXIgPSBFeHQuRG9tSGVscGVyLmluc2VydEZpcnN0KHRoaXMuc3RhdHVzQmFyLHtcbiAgICAgICAgICAgIHRhZzogJ2RpdicsXG4gICAgICAgICAgICBodG1sOiAnPGRpdiBjbGFzcz1cInByb2dyZXNzXCI+PGkgY2xhc3M9XCJpY29uIGljb24tc3Bpbm5lciBpY29uLXNwaW5cIj48L2k+IDxzcGFuPicgKyBfKCdtYXJrZG93bmVkaXRvci51cGxvYWRpbmdfJyArIHR5cGUpICsgZmlsZU5hbWUgKyAnPC9zcGFuPjwvZGl2PidcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIEV4dC5nZXQodXBsb2FkZXIpO1xuICAgIH1cblxuICAgICxmYWlsVXBsb2FkZXI6IGZ1bmN0aW9uKHVwbG9hZGVyLCBtZXNzYWdlKSB7XG4gICAgICAgIHVwbG9hZGVyLmNoaWxkKCcucHJvZ3Jlc3MnKS5hZGRDbGFzcygnZXJyb3InKTtcbiAgICAgICAgdXBsb2FkZXIuY2hpbGQoJy5wcm9ncmVzcycpLnNldFdpZHRoKCcxMDAlJyk7XG5cbiAgICAgICAgdXBsb2FkZXIuY2hpbGQoJ2knKS5hZGRDbGFzcygncmVtb3ZlLW1lc3NhZ2UnKTtcbiAgICAgICAgdXBsb2FkZXIuY2hpbGQoJ2knKS5yZXBsYWNlQ2xhc3MoJ2ljb24tc3Bpbm5lcicsICdpY29uLXJlbW92ZScpO1xuICAgICAgICB1cGxvYWRlci5jaGlsZCgnaScpLnJlbW92ZUNsYXNzKCdpY29uLXNwaW4nKTtcblxuICAgICAgICB1cGxvYWRlci5jaGlsZCgnc3BhbicpLmRvbS5pbm5lckhUTUwgKz0gJyBmYWlsZWQuICcgKyBtZXNzYWdlO1xuICAgICAgICB1cGxvYWRlci5jaGlsZCgnLnJlbW92ZS1tZXNzYWdlJykub24oJ2NsaWNrJywgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICB1cGxvYWRlci5yZW1vdmUoKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLGZhaWxNZXNzYWdlOiBmdW5jdGlvbihmaWxlLCB0eXBlLCBtZXNzYWdlKSB7XG4gICAgICAgIHZhciB1cGxvYWRlciA9IHRoaXMuY3JlYXRlVXBsb2FkZXIodHlwZSwgZmlsZS5uYW1lKTtcbiAgICAgICAgdGhpcy5mYWlsVXBsb2FkZXIodXBsb2FkZXIsIG1lc3NhZ2UpO1xuICAgIH1cbn0pO1xuXG5NT0R4LmxvYWRSVEUgPSBmdW5jdGlvbihpZCkge1xuICAgIG5ldyBtYXJrZG93bkVkaXRvci5FZGl0b3IoKTtcbn07XG4iLCJtYXJrZG93bkVkaXRvci53aW5kb3cuQ3JvcHBlciA9IGZ1bmN0aW9uKGNvbmZpZykge1xuICAgIGNvbmZpZyA9IGNvbmZpZyB8fCB7fTtcbiAgICBjb25maWcuY3JvcHBlclNlbGVjdG9yID0gY29uZmlnLmNyb3BwZXJTZWxlY3RvciB8fCAnLmltYWdlLXVwbG9hZC13cmFwcGVyID4gaW1nJztcblxuICAgIEV4dC5hcHBseUlmKGNvbmZpZyx7XG4gICAgICAgIG1vZGFsOiBmYWxzZVxuICAgICAgICAsbGF5b3V0OiAnYXV0bydcbiAgICAgICAgLGNsb3NlQWN0aW9uOiAnaGlkZSdcbiAgICAgICAgLHNoYWRvdzogdHJ1ZVxuICAgICAgICAscmVzaXphYmxlOiB0cnVlXG4gICAgICAgICxjb2xsYXBzaWJsZTogdHJ1ZVxuICAgICAgICAsbWF4aW1pemFibGU6IGZhbHNlXG4gICAgICAgICxhdXRvSGVpZ2h0OiBmYWxzZVxuICAgICAgICAsYXV0b1Njcm9sbDogdHJ1ZVxuICAgICAgICAsYWxsb3dEcm9wOiB0cnVlXG4gICAgICAgICx3aWR0aDogODAwXG4gICAgICAgICx0aXRsZTogXygnbWFya2Rvd25lZGl0b3IuY3JvcHBlci5jcm9wX2ltYWdlJylcbiAgICAgICAgLGNsczogJ21vZHgtd2luZG93J1xuICAgICAgICAsaHRtbDogJzxkaXYgY2xhc3M9XCJpbWFnZS11cGxvYWQtd3JhcHBlclwiPjxpbWcgc3JjPVwiJyArIFVSTC5jcmVhdGVPYmplY3RVUkwoY29uZmlnLmZpbGUpICsgJ1wiPjwvZGl2PidcbiAgICAgICAgLHRiYXI6IFt7XG4gICAgICAgICAgICB0ZXh0OiAnPGkgY2xhc3M9XCJpY29uIGljb24tYXJyb3dzXCI+PC9pPiAnICsgXygnbWFya2Rvd25lZGl0b3IuY3JvcHBlci5tb3ZlJylcbiAgICAgICAgICAgICxzY29wZTogdGhpc1xuICAgICAgICAgICAgLHBhcmFtOiAnbW92ZSdcbiAgICAgICAgICAgICxhY3Rpb246ICdzZXREcmFnTW9kZSdcbiAgICAgICAgICAgICxoYW5kbGVyOiB0aGlzLmNhbGxDcm9wcGVyQWN0aW9uXG4gICAgICAgIH0se1xuICAgICAgICAgICAgdGV4dDogJzxpIGNsYXNzPVwiaWNvbiBpY29uLWNyb3BcIj48L2k+ICcgKyBfKCdtYXJrZG93bmVkaXRvci5jcm9wcGVyLmNyb3AnKVxuICAgICAgICAgICAgLHNjb3BlOiB0aGlzXG4gICAgICAgICAgICAscGFyYW06ICdjcm9wJ1xuICAgICAgICAgICAgLGFjdGlvbjogJ3NldERyYWdNb2RlJ1xuICAgICAgICAgICAgLGhhbmRsZXI6IHRoaXMuY2FsbENyb3BwZXJBY3Rpb25cbiAgICAgICAgfSx7XG4gICAgICAgICAgICB0ZXh0OiAnPGkgY2xhc3M9XCJpY29uIGljb24tc2VhcmNoLXBsdXNcIj48L2k+ICcgKyBfKCdtYXJrZG93bmVkaXRvci5jcm9wcGVyLnpvb21faW4nKVxuICAgICAgICAgICAgLHNjb3BlOiB0aGlzXG4gICAgICAgICAgICAscGFyYW06IDAuMVxuICAgICAgICAgICAgLGFjdGlvbjogJ3pvb20nXG4gICAgICAgICAgICAsaGFuZGxlcjogdGhpcy5jYWxsQ3JvcHBlckFjdGlvblxuICAgICAgICB9LHtcbiAgICAgICAgICAgIHRleHQ6ICc8aSBjbGFzcz1cImljb24gaWNvbi1zZWFyY2gtbWludXNcIj48L2k+ICcgKyBfKCdtYXJrZG93bmVkaXRvci5jcm9wcGVyLnpvb21fb3V0JylcbiAgICAgICAgICAgICxzY29wZTogdGhpc1xuICAgICAgICAgICAgLHBhcmFtOiAtMC4xXG4gICAgICAgICAgICAsYWN0aW9uOiAnem9vbSdcbiAgICAgICAgICAgICxoYW5kbGVyOiB0aGlzLmNhbGxDcm9wcGVyQWN0aW9uXG4gICAgICAgIH0se1xuICAgICAgICAgICAgdGV4dDogJzxpIGNsYXNzPVwiaWNvbiBpY29uLXJvdGF0ZS1sZWZ0XCI+PC9pPiAnICsgXygnbWFya2Rvd25lZGl0b3IuY3JvcHBlci5yb3RhdGVfbGVmdCcpXG4gICAgICAgICAgICAsc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICxwYXJhbTogLTkwXG4gICAgICAgICAgICAsYWN0aW9uOiAncm90YXRlJ1xuICAgICAgICAgICAgLGhhbmRsZXI6IHRoaXMuY2FsbENyb3BwZXJBY3Rpb25cbiAgICAgICAgfSx7XG4gICAgICAgICAgICB0ZXh0OiAnPGkgY2xhc3M9XCJpY29uIGljb24tcm90YXRlLXJpZ2h0XCI+PC9pPiAnICsgXygnbWFya2Rvd25lZGl0b3IuY3JvcHBlci5yb3RhdGVfcmlnaHQnKVxuICAgICAgICAgICAgLHNjb3BlOiB0aGlzXG4gICAgICAgICAgICAscGFyYW06IDkwXG4gICAgICAgICAgICAsYWN0aW9uOiAncm90YXRlJ1xuICAgICAgICAgICAgLGhhbmRsZXI6IHRoaXMuY2FsbENyb3BwZXJBY3Rpb25cbiAgICAgICAgfSx7XG4gICAgICAgICAgICB0ZXh0OiAnPGkgY2xhc3M9XCJpY29uIGljb24tcmVtb3ZlXCI+PC9pPiAnICsgXygnbWFya2Rvd25lZGl0b3IuY3JvcHBlci5jbGVhcl9jcm9wcGVyJylcbiAgICAgICAgICAgICxzY29wZTogdGhpc1xuICAgICAgICAgICAgLHBhcmFtOiBudWxsXG4gICAgICAgICAgICAsYWN0aW9uOiAnY2xlYXInXG4gICAgICAgICAgICAsaGFuZGxlcjogdGhpcy5jYWxsQ3JvcHBlckFjdGlvblxuICAgICAgICB9XVxuICAgICAgICAsYnV0dG9uczogW3tcbiAgICAgICAgICAgIHRleHQ6IF8oJ2NhbmNlbCcpXG4gICAgICAgICAgICAsc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICxoYW5kbGVyOiB0aGlzLmNsb3NlXG4gICAgICAgIH0se1xuICAgICAgICAgICAgdGV4dDogXygnbWFya2Rvd25lZGl0b3IuY3JvcHBlci51cGxvYWQnKVxuICAgICAgICAgICAgLGNsczogJ3ByaW1hcnktYnV0dG9uJ1xuICAgICAgICAgICAgLHNjb3BlOiB0aGlzXG4gICAgICAgICAgICAsY3JvcDogMFxuICAgICAgICAgICAgLGhhbmRsZXI6IHRoaXMudXBsb2FkXG4gICAgICAgIH0se1xuICAgICAgICAgICAgdGV4dDogXygnbWFya2Rvd25lZGl0b3IuY3JvcHBlci5jcm9wX3VwbG9hZCcpXG4gICAgICAgICAgICAsY2xzOiAncHJpbWFyeS1idXR0b24nXG4gICAgICAgICAgICAsc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICxjcm9wOiAxXG4gICAgICAgICAgICAsaGFuZGxlcjogdGhpcy51cGxvYWRcbiAgICAgICAgfV1cbiAgICAgICAgLGxpc3RlbmVyczoge1xuICAgICAgICAgICAgJ3Nob3cnOiB7XG4gICAgICAgICAgICAgICAgZm46IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgY3JvcHBlck9wdGlvbnMgPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy4kY3JvcHBlckVsID0gJCgnIycgKyB0aGlzLmlkICsgJyAnICsgY29uZmlnLmNyb3BwZXJTZWxlY3Rvcik7XG5cbiAgICAgICAgICAgICAgICAgICAgdmFyIHJhdGlvID0gTU9EeC5jb25maWdbJ21hcmtkb3duZWRpdG9yLmNyb3BwZXIuYXNwZWN0X3JhdGlvJ107XG4gICAgICAgICAgICAgICAgICAgIGlmIChyYXRpbykge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmF0aW8ucmVwbGFjZSgvW14tOngoKVxcZC8qKy5dL2csICcnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhdGlvID0gZXZhbChyYXRpbyk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGNyb3BwZXJPcHRpb25zLmFzcGVjdFJhdGlvID0gcmF0aW87XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBjcm9wcGVyT3B0aW9ucy5jcm9wID0gZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaW1hZ2VEYXRhID0gW1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICd7XCJ4XCI6JyArIGRhdGEueCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnXCJ5XCI6JyArIGRhdGEueSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnXCJoZWlnaHRcIjonICsgZGF0YS5oZWlnaHQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ1wid2lkdGhcIjonICsgZGF0YS53aWR0aCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnXCJyb3RhdGVcIjonICsgZGF0YS5yb3RhdGUgKyAnfSdcbiAgICAgICAgICAgICAgICAgICAgICAgIF0uam9pbigpO1xuICAgICAgICAgICAgICAgICAgICB9LmJpbmQodGhpcyk7XG5cbiAgICAgICAgICAgICAgICAgICAgdGhpcy4kY3JvcHBlckVsLmNyb3BwZXIoY3JvcHBlck9wdGlvbnMpO1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgc2NvcGU6IHRoaXNcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0pO1xuICAgIG1hcmtkb3duRWRpdG9yLndpbmRvdy5Dcm9wcGVyLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLGNvbmZpZyk7XG4gICAgdGhpcy5jb25maWcgPSBjb25maWc7XG5cbn07XG5FeHQuZXh0ZW5kKG1hcmtkb3duRWRpdG9yLndpbmRvdy5Dcm9wcGVyLCBFeHQuV2luZG93LHtcbiAgICBpbWFnZURhdGE6ICcnXG4gICAgLHVwbG9hZDogZnVuY3Rpb24oYnV0dG9uKSB7XG4gICAgICAgIHZhciB1cGxvYWRlciA9IHRoaXMuY29uZmlnLm1kLmNyZWF0ZVVwbG9hZGVyKCdpbWFnZScsIHRoaXMuY29uZmlnLmZpbGUubmFtZSk7XG5cbiAgICAgICAgdmFyIGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnZmlsZScsIHRoaXMuY29uZmlnLmZpbGUpO1xuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ2FjdGlvbicsICdtZ3IvZWRpdG9yL2ltYWdldXBsb2FkJyk7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnaW1hZ2VEYXRhJywgdGhpcy5pbWFnZURhdGEpO1xuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ25hbWUnLCB0aGlzLmNvbmZpZy5maWxlLm5hbWUpO1xuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ2Nyb3AnLCBidXR0b24uY3JvcCk7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgncmVzb3VyY2UnLCB0aGlzLmNvbmZpZy5tZC5jb25maWcucmVzb3VyY2UpO1xuXG4gICAgICAgIHZhciB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgICAgICAgeGhyLm9wZW4oJ1BPU1QnLCBtYXJrZG93bkVkaXRvci5jb25maWcuY29ubmVjdG9yVXJsKTtcbiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ1Bvd2VyZWQtQnknLCAnTU9EeCcpO1xuICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignbW9kQXV0aCcsIEV4dC5BamF4LmRlZmF1bHRIZWFkZXJzLm1vZEF1dGgpO1xuXG4gICAgICAgIHhoci51cGxvYWQub25wcm9ncmVzcyA9IGZ1bmN0aW9uIChldmVudCkge1xuICAgICAgICAgICAgaWYgKGV2ZW50Lmxlbmd0aENvbXB1dGFibGUpIHtcbiAgICAgICAgICAgICAgICB2YXIgY29tcGxldGUgPSAoZXZlbnQubG9hZGVkIC8gZXZlbnQudG90YWwgKiAxMDAgfCAwKTtcbiAgICAgICAgICAgICAgICB1cGxvYWRlci5jaGlsZCgnLnByb2dyZXNzJykuc2V0V2lkdGgoY29tcGxldGUgKyAnJScpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LmJpbmQodGhpcyk7XG5cbiAgICAgICAgeGhyLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmICh4aHIuc3RhdHVzID09PSAyMDApIHtcbiAgICAgICAgICAgICAgICB2YXIgcmVzID0gSlNPTi5wYXJzZSh4aHIucmVzcG9uc2VUZXh0KTtcblxuICAgICAgICAgICAgICAgIGlmIChyZXMuc3VjY2VzcyA9PSB0cnVlKSB7XG4gICAgICAgICAgICAgICAgICAgIHVwbG9hZGVyLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZy5tZC5lZGl0b3IuaW5zZXJ0KCchWycgKyByZXMub2JqZWN0Lm5hbWUgKyAnXSgnICsgcmVzLm9iamVjdC5wYXRoICsgJyBcIicgKyByZXMub2JqZWN0Lm5hbWUgKyAnXCIpXFxuXFxuJyk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb25maWcubWQuZmFpbFVwbG9hZGVyKHVwbG9hZGVyLCByZXMubWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9LmJpbmQodGhpcyk7XG5cbiAgICAgICAgeGhyLnNlbmQoZm9ybURhdGEpO1xuXG4gICAgICAgIHRoaXMuY2xvc2UoKTtcbiAgICB9XG5cbiAgICAsY2FsbENyb3BwZXJBY3Rpb246IGZ1bmN0aW9uKGJ0bikge1xuICAgICAgICB0aGlzLiRjcm9wcGVyRWwuY3JvcHBlcihidG4uYWN0aW9uLCBidG4ucGFyYW0pO1xuICAgIH1cblxuICAgICxjbG9zZTogZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMuJGNyb3BwZXJFbC5jcm9wcGVyKFwiZGVzdHJveVwiKTtcblxuICAgICAgICBtYXJrZG93bkVkaXRvci53aW5kb3cuQ3JvcHBlci5zdXBlcmNsYXNzLmNsb3NlLmNhbGwodGhpcyk7XG4gICAgICAgIHRoaXMuY29uZmlnLm1kLmVkaXRvci5mb2N1cygpO1xuICAgIH1cbn0pO1xuRXh0LnJlZygnbWFya2Rvd25lZGl0b3Itd2luZG93LWNyb3BwZXInLG1hcmtkb3duRWRpdG9yLndpbmRvdy5Dcm9wcGVyKTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==