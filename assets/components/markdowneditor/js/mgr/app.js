Ext.ns("MarkdownEditor"),MarkdownEditor=function(e){e=e||{},MarkdownEditor.superclass.constructor.call(this,e)},Ext.extend(MarkdownEditor,Ext.Component,{window:{},config:{}}),Ext.reg("markdowneditor",MarkdownEditor),markdownEditor=new MarkdownEditor,markdownEditor.Editor=function(e){e=e||{},e.resource=MODx.request.id||0,markdownEditor.Editor.superclass.constructor.call(this,e),this.config=e},Ext.extend(markdownEditor.Editor,Ext.Component,{remarkable:"",initComponent:function(){MarkdownEditor.superclass.initComponent.call(this),Ext.onReady(this.render,this)},render:function(){this.textarea=Ext.get("ta"),this.buildUI(),this.registerAce(),this.registerMarked(),this.statusBar=Ext.get("status-bar"),this.preview=Ext.get("preview-md");var e=Ext.get("preview-button"),t=Ext.get("fullscreen-button"),o=Ext.get("content-md"),i=o.parent(),r=MODx.load({xtype:"modx-treedrop",target:o,targetEl:o,onInsert:function(e){return this.insert(e),this.focus(),!0}.bind(this.editor),iframe:!0});this.textarea.on("destroy",function(){r.destroy()}),e.addListener("click",function(){this.preview.isVisible()?(this.preview.setDisplayed("none"),o.setDisplayed("block"),this.statusBar.setDisplayed("block"),e.child("i").removeClass("icon-toggle-on"),e.child("i").addClass("icon-toggle-off")):(this.preview.setDisplayed("block"),o.setDisplayed("none"),this.statusBar.setDisplayed("none"),e.child("i").removeClass("icon-toggle-off"),e.child("i").addClass("icon-toggle-on"))},this),t.addListener("click",function(){var r=t.child("i");r.hasClass("icon-expand")?(r.removeClass("icon-expand"),r.addClass("icon-compress"),this.preview.setDisplayed("block"),o.setDisplayed("block"),e.hide(),i.addClass("fullscreen"),this.editor.setOption("maxLines",null)):(r.addClass("icon-expand"),r.removeClass("icon-compress"),this.preview.setDisplayed("none"),o.setDisplayed("block"),e.show(),i.removeClass("fullscreen"),this.editor.setOption("maxLines",1/0)),this.statusBar.setDisplayed("block"),this.editor.resize(!0)},this),markdownEditor.content.content&&this.editor.setValue(markdownEditor.content.content),this.editor.selection.clearSelection(),this.preview.update(this.parse(this.editor.getValue())),this.editor.getSession().on("change",function(){this.parse(this.editor.getValue())}.bind(this))},buildUI:function(){this.textarea.setDisplayed("none"),this.textarea.setWidth(0),this.textarea.setHeight(0),Ext.DomHelper.insertBefore(this.textarea,{tag:"textarea",name:"ta_markdown",id:"ta_markdown"}),this.taMarkdown=Ext.get("ta_markdown"),this.taMarkdown.setDisplayed("none"),this.taMarkdown.setWidth(0),this.taMarkdown.setHeight(0);var e=Ext.DomHelper.insertBefore(this.textarea,{tag:"div","class":"markdown-container"});Ext.DomHelper.append(e,{tag:"div",id:"content-md","class":this.textarea.dom.className}),Ext.DomHelper.append(e,{tag:"div",id:"preview-md","class":"markdown-body"}),Ext.DomHelper.append(e,{tag:"div",id:"toolbox",cn:[{tag:"span",id:"preview-button",html:'<i class="icon icon-toggle-off"></i> '+_("markdowneditor.toolbox.preview")},{tag:"span",id:"fullscreen-button",html:'<i class="icon icon-expand"></i>'}]}),1==MODx.config["markdowneditor.upload.enable_image_upload"]||1==MODx.config["markdowneditor.upload.enable_file_upload"]?(Ext.DomHelper.append(e,{tag:"div",id:"status-bar",html:'<input class="hidden" id="inputFile" name="file" type="file" multiple>'+_("markdowneditor.status_bar_message")}),Ext.get("inputFile").on("change",function(e,t){this.handleFiles(t.files),t.value=""},this)):Ext.DomHelper.append(e,{tag:"div",id:"status-bar",html:_("markdowneditor.status_bar_disabled")}),Ext.DomHelper.append(e,{tag:"span",style:"clear: both"})},registerAce:function(){this.editor=ace.edit(Ext.DomQuery.selectNode("div#content-md")),this.editor.setOptions({maxLines:1/0,minLines:25,enableBasicAutocompletion:!0}),this.editor.renderer.setShowGutter(!0),this.editor.renderer.setScrollMargin(10,10),this.editor.getSession().setValue(this.textarea.getValue()),this.editor.getSession().setMode("ace/mode/markdown"),this.editor.setTheme("ace/theme/"+(MODx.config["markdowneditor.general.theme"]||"monokai"));var e=ace.require("ace/ext/language_tools"),t={getCompletions:function(e,t,o,i,r){return 0===i.length?(r(null,[]),void 0):(MODx.Ajax.request({url:markdownEditor.config.connectorUrl,params:{action:"mgr/resource/getlist",prefix:i},listeners:{success:{fn:function(e){r(null,e.results)},scope:this}}}),void 0)}};e.addCompleter(t),this.editor.container.addEventListener("dragenter",this.catchAndDoNothing,!1),this.editor.container.addEventListener("dragover",this.catchAndDoNothing,!1),this.editor.container.addEventListener("drop",this.drop.bind(this),!1)},registerMarked:function(){this.remarkable=new Remarkable({html:!0,highlight:function(e,t){if(t&&hljs.getLanguage(t))try{return hljs.highlight(t,e).value}catch(o){}try{return hljs.highlightAuto(e).value}catch(o){}return""}}),this.remarkable.inline.ruler.disable(["backticks"])},parse:function(e){var t=this.remarkable.render(e);t=t.replace(/%5B/g,"["),t=t.replace(/%5D/g,"]");var o=t.match(/<code(.|\s)*<\/code>/g);if(Ext.each(o,function(e){var o=e.replace(/\[\[/g,"&#91;&#91;");o=o.replace(/]]/g,"&#93;&#93;"),t=t.replace(e,o)}),1==MODx.config["markdowneditor.lp.parse_modx_tags"]){this.parseRequest&&clearTimeout(this.parseRequest);var i=parseInt(MODx.config["markdowneditor.lp.parse_modx_tags_timeout"]||300);this.parseRequest=setTimeout(function(){MODx.Ajax.request({url:markdownEditor.config.connectorUrl,params:{action:"mgr/editor/processcontent",content:t,resource:MODx.request.id},isUpload:!0,listeners:{success:{fn:function(e){this.preview.update(e.data)},scope:this}}})}.bind(this),i)}else this.preview.update(t);return this.taMarkdown.dom.value=this.editor.getValue(),this.textarea.dom.value=t,t},catchAndDoNothing:function(e){e.stopPropagation(),e.preventDefault()},drop:function(e){e.stopPropagation(),e.preventDefault(),(1==MODx.config["markdowneditor.upload.enable_image_upload"]||1==MODx.config["markdowneditor.upload.enable_file_upload"])&&this.handleFiles(e.dataTransfer.files)},handleFiles:function(e){Ext.each(e,function(e){var t=/^image\//.test(e.type);if(t){if(0==MODx.config["markdowneditor.upload.enable_image_upload"])return!0;if(!this.checkType(MODx.config["markdowneditor.upload.image_types"],e))return this.failMessage(e,"image",_("markdowneditor.err.upload.unsupported_image")),!0;if(e.size>parseInt(MODx.config["markdowneditor.upload.max_size"]))return this.failMessage(e,"image",_("markdowneditor.err.upload.too_big")),!0;1==MODx.config["markdowneditor.cropper.enable_cropper"]?MODx.load({xtype:"markdowneditor-window-cropper",file:e,md:this}).show():this.uploadFile(e,"image")}else{if(0==MODx.config["markdowneditor.upload.enable_file_upload"])return!0;if(!this.checkType(MODx.config["markdowneditor.upload.file_types"],e))return this.failMessage(e,"file",_("markdowneditor.err.upload.unsupported_file")),!0;if(e.size>parseInt(MODx.config["markdowneditor.upload.max_size"]))return this.failMessage(e,"file",_("markdowneditor.err.upload.too_big")),!0;this.uploadFile(e,"file")}},this)},checkType:function(e,t){return e=e.split(","),-1!=e.indexOf(t.name.split(".").pop())},uploadFile:function(e,t){t||(t="file");var o=this.createUploader(),i=new FormData;i.append("file",e),i.append("action","mgr/editor/"+t+"upload"),i.append("name",e.name),i.append("resource",this.config.resource);var r=new XMLHttpRequest;r.open("POST",markdownEditor.config.connectorUrl),r.setRequestHeader("Powered-By","MODx"),r.setRequestHeader("modAuth",Ext.Ajax.defaultHeaders.modAuth),r.upload.onprogress=function(e){if(e.lengthComputable){var t=e.loaded/e.total*100|0;o.child(".progress").setWidth(t+"%")}}.bind(this),r.onload=function(){if(200===r.status){var e=JSON.parse(r.responseText);if(1==e.success){o.remove();var i="image"==t?"!":"";this.editor.insert(i+"["+e.object.name+"]("+e.object.path+' "'+e.object.name+'")\n')}else this.failUploader(o,e.message)}}.bind(this),r.send(i)},createUploader:function(e,t){var o=Ext.DomHelper.insertFirst(this.statusBar,{tag:"div",html:'<div class="progress"></div><i class="icon icon-spinner icon-spin"></i> <span>'+_("markdowneditor.uploading_"+e)+t+"</span>"});return Ext.get(o)},failUploader:function(e,t){e.child(".progress").addClass("error"),e.child(".progress").setWidth("100%"),e.child("i").addClass("remove-message"),e.child("i").replaceClass("icon-spinner","icon-remove"),e.child("i").removeClass("icon-spin"),e.child("span").dom.innerHTML+=" failed. "+t,e.child(".remove-message").on("click",function(){e.remove()})},failMessage:function(e,t,o){var i=this.createUploader(t,e.name);this.failUploader(i,o)}}),MODx.loadRTE=function(){new markdownEditor.Editor},markdownEditor.window.Cropper=function(config){config=config||{},config.cropperSelector=config.cropperSelector||".image-upload-wrapper > img",Ext.applyIf(config,{modal:!1,layout:"auto",closeAction:"hide",shadow:!0,resizable:!0,collapsible:!0,maximizable:!1,autoHeight:!1,autoScroll:!0,allowDrop:!0,width:800,title:_("markdowneditor.cropper.crop_image"),cls:"modx-window",html:'<div class="image-upload-wrapper"><img src="'+URL.createObjectURL(config.file)+'"></div>',tbar:[{text:'<i class="icon icon-arrows"></i> '+_("markdowneditor.cropper.move"),scope:this,param:"move",action:"setDragMode",handler:this.callCropperAction},{text:'<i class="icon icon-crop"></i> '+_("markdowneditor.cropper.crop"),scope:this,param:"crop",action:"setDragMode",handler:this.callCropperAction},{text:'<i class="icon icon-search-plus"></i> '+_("markdowneditor.cropper.zoom_in"),scope:this,param:.1,action:"zoom",handler:this.callCropperAction},{text:'<i class="icon icon-search-minus"></i> '+_("markdowneditor.cropper.zoom_out"),scope:this,param:-.1,action:"zoom",handler:this.callCropperAction},{text:'<i class="icon icon-rotate-left"></i> '+_("markdowneditor.cropper.rotate_left"),scope:this,param:-90,action:"rotate",handler:this.callCropperAction},{text:'<i class="icon icon-rotate-right"></i> '+_("markdowneditor.cropper.rotate_right"),scope:this,param:90,action:"rotate",handler:this.callCropperAction},{text:'<i class="icon icon-remove"></i> '+_("markdowneditor.cropper.clear_cropper"),scope:this,param:null,action:"clear",handler:this.callCropperAction}],buttons:[{text:_("cancel"),scope:this,handler:this.close},{text:_("markdowneditor.cropper.upload"),cls:"primary-button",scope:this,crop:0,handler:this.upload},{text:_("markdowneditor.cropper.crop_upload"),cls:"primary-button",scope:this,crop:1,handler:this.upload}],listeners:{show:{fn:function(){var cropperOptions={};this.$cropperEl=$("#"+this.id+" "+config.cropperSelector);var ratio=MODx.config["markdowneditor.cropper.aspect_ratio"];ratio&&(ratio.replace(/[^-:x()\d/*+.]/g,""),ratio=eval(ratio),cropperOptions.aspectRatio=ratio),cropperOptions.crop=function(e){this.imageData=['{"x":'+e.x,'"y":'+e.y,'"height":'+e.height,'"width":'+e.width,'"rotate":'+e.rotate+"}"].join()}.bind(this),this.$cropperEl.cropper(cropperOptions)},scope:this}}}),markdownEditor.window.Cropper.superclass.constructor.call(this,config),this.config=config},Ext.extend(markdownEditor.window.Cropper,Ext.Window,{imageData:"",upload:function(e){var t=this.config.md.createUploader("image",this.config.file.name),o=new FormData;o.append("file",this.config.file),o.append("action","mgr/editor/imageupload"),o.append("imageData",this.imageData),o.append("name",this.config.file.name),o.append("crop",e.crop),o.append("resource",this.config.md.config.resource);var i=new XMLHttpRequest;i.open("POST",markdownEditor.config.connectorUrl),i.setRequestHeader("Powered-By","MODx"),i.setRequestHeader("modAuth",Ext.Ajax.defaultHeaders.modAuth),i.upload.onprogress=function(e){if(e.lengthComputable){var o=e.loaded/e.total*100|0;t.child(".progress").setWidth(o+"%")}}.bind(this),i.onload=function(){if(200===i.status){var e=JSON.parse(i.responseText);1==e.success?(t.remove(),this.config.md.editor.insert("!["+e.object.name+"]("+e.object.path+' "'+e.object.name+'")\n')):this.config.md.failUploader(t,e.message)}}.bind(this),i.send(o),this.close()},callCropperAction:function(e){this.$cropperEl.cropper(e.action,e.param)},close:function(){this.$cropperEl.cropper("destroy"),markdownEditor.window.Cropper.superclass.close.call(this)}}),Ext.reg("markdowneditor-window-cropper",markdownEditor.window.Cropper);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsIm1hcmtkb3duZWRpdG9yLndpbmRvdy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxJQUFBLEdBQUEsa0JBQ0EsZUFBQSxTQUFBLEdBQ0EsRUFBQSxNQUNBLGVBQUEsV0FBQSxZQUFBLEtBQUEsS0FBQSxJQUVBLElBQUEsT0FBQSxlQUFBLElBQUEsV0FDQSxVQUFBLFlBRUEsSUFBQSxJQUFBLGlCQUFBLGdCQUNBLGVBQUEsR0FBQSxnQkFFQSxlQUFBLE9BQUEsU0FBQSxHQUNBLEVBQUEsTUFDQSxFQUFBLFNBQUEsS0FBQSxRQUFBLElBQUEsRUFDQSxlQUFBLE9BQUEsV0FBQSxZQUFBLEtBQUEsS0FBQSxHQUNBLEtBQUEsT0FBQSxHQUVBLElBQUEsT0FBQSxlQUFBLE9BQUEsSUFBQSxXQUNBLFdBQUEsR0FDQSxjQUFBLFdBQ0EsZUFBQSxXQUFBLGNBQUEsS0FBQSxNQUVBLElBQUEsUUFBQSxLQUFBLE9BQUEsT0FHQSxPQUFBLFdBQ0EsS0FBQSxTQUFBLElBQUEsSUFBQSxNQUVBLEtBQUEsVUFDQSxLQUFBLGNBQ0EsS0FBQSxpQkFFQSxLQUFBLFVBQUEsSUFBQSxJQUFBLGNBQ0EsS0FBQSxRQUFBLElBQUEsSUFBQSxhQUVBLElBQUEsR0FBQSxJQUFBLElBQUEsa0JBQ0EsRUFBQSxJQUFBLElBQUEscUJBQ0EsRUFBQSxJQUFBLElBQUEsY0FDQSxFQUFBLEVBQUEsU0FFQSxFQUFBLEtBQUEsTUFDQSxNQUFBLGdCQUNBLE9BQUEsRUFDQSxTQUFBLEVBQ0EsU0FBQSxTQUFBLEdBR0EsTUFGQSxNQUFBLE9BQUEsR0FDQSxLQUFBLFNBQ0EsR0FDQSxLQUFBLEtBQUEsUUFDQSxRQUFBLEdBRUEsTUFBQSxTQUFBLEdBQUEsVUFBQSxXQUFBLEVBQUEsWUFFQSxFQUFBLFlBQUEsUUFBQSxXQUNBLEtBQUEsUUFBQSxhQUNBLEtBQUEsUUFBQSxhQUFBLFFBQ0EsRUFBQSxhQUFBLFNBQ0EsS0FBQSxVQUFBLGFBQUEsU0FFQSxFQUFBLE1BQUEsS0FBQSxZQUFBLGtCQUNBLEVBQUEsTUFBQSxLQUFBLFNBQUEscUJBRUEsS0FBQSxRQUFBLGFBQUEsU0FDQSxFQUFBLGFBQUEsUUFDQSxLQUFBLFVBQUEsYUFBQSxRQUVBLEVBQUEsTUFBQSxLQUFBLFlBQUEsbUJBQ0EsRUFBQSxNQUFBLEtBQUEsU0FBQSxvQkFFQSxNQUVBLEVBQUEsWUFBQSxRQUFBLFdBQ0EsR0FBQSxHQUFBLEVBQUEsTUFBQSxJQUVBLEdBQUEsU0FBQSxnQkFDQSxFQUFBLFlBQUEsZUFDQSxFQUFBLFNBQUEsaUJBRUEsS0FBQSxRQUFBLGFBQUEsU0FDQSxFQUFBLGFBQUEsU0FFQSxFQUFBLE9BRUEsRUFBQSxTQUFBLGNBRUEsS0FBQSxPQUFBLFVBQUEsV0FBQSxRQUdBLEVBQUEsU0FBQSxlQUNBLEVBQUEsWUFBQSxpQkFFQSxLQUFBLFFBQUEsYUFBQSxRQUNBLEVBQUEsYUFBQSxTQUVBLEVBQUEsT0FFQSxFQUFBLFlBQUEsY0FFQSxLQUFBLE9BQUEsVUFBQSxXQUFBLE1BR0EsS0FBQSxVQUFBLGFBQUEsU0FFQSxLQUFBLE9BQUEsUUFBQSxJQUNBLE1BRUEsZUFBQSxRQUFBLFNBQ0EsS0FBQSxPQUFBLFNBQUEsZUFBQSxRQUFBLFNBRUEsS0FBQSxPQUFBLFVBQUEsaUJBRUEsS0FBQSxRQUFBLE9BQUEsS0FBQSxNQUFBLEtBQUEsT0FBQSxhQUVBLEtBQUEsT0FBQSxhQUFBLEdBQUEsU0FBQSxXQUNBLEtBQUEsTUFBQSxLQUFBLE9BQUEsYUFDQSxLQUFBLFFBR0EsUUFBQSxXQUNBLEtBQUEsU0FBQSxhQUFBLFFBQ0EsS0FBQSxTQUFBLFNBQUEsR0FDQSxLQUFBLFNBQUEsVUFBQSxHQUVBLElBQUEsVUFBQSxhQUFBLEtBQUEsVUFDQSxJQUFBLFdBQ0EsS0FBQSxjQUNBLEdBQUEsZ0JBR0EsS0FBQSxXQUFBLElBQUEsSUFBQSxlQUNBLEtBQUEsV0FBQSxhQUFBLFFBQ0EsS0FBQSxXQUFBLFNBQUEsR0FDQSxLQUFBLFdBQUEsVUFBQSxFQUVBLElBQUEsR0FBQSxJQUFBLFVBQUEsYUFBQSxLQUFBLFVBQ0EsSUFBQSxNQUNBLFFBQUEsc0JBR0EsS0FBQSxVQUFBLE9BQUEsR0FDQSxJQUFBLE1BQ0EsR0FBQSxhQUNBLFFBQUEsS0FBQSxTQUFBLElBQUEsWUFHQSxJQUFBLFVBQUEsT0FBQSxHQUNBLElBQUEsTUFDQSxHQUFBLGFBQ0EsUUFBQSxrQkFHQSxJQUFBLFVBQUEsT0FBQSxHQUNBLElBQUEsTUFDQSxHQUFBLFVBQ0EsS0FDQSxJQUFBLE9BQ0EsR0FBQSxpQkFDQSxLQUFBLHdDQUFBLEVBQUEsb0NBRUEsSUFBQSxPQUNBLEdBQUEsb0JBQ0EsS0FBQSx1Q0FJQSxHQUFBLEtBQUEsT0FBQSw4Q0FBQSxHQUFBLEtBQUEsT0FBQSw2Q0FDQSxJQUFBLFVBQUEsT0FBQSxHQUNBLElBQUEsTUFDQSxHQUFBLGFBQ0EsS0FBQSx5RUFBQSxFQUFBLHVDQUdBLElBQUEsSUFBQSxhQUFBLEdBQUEsU0FBQSxTQUFBLEVBQUEsR0FDQSxLQUFBLFlBQUEsRUFBQSxPQUNBLEVBQUEsTUFBQSxJQUNBLE9BRUEsSUFBQSxVQUFBLE9BQUEsR0FDQSxJQUFBLE1BQ0EsR0FBQSxhQUNBLEtBQUEsRUFBQSx3Q0FJQSxJQUFBLFVBQUEsT0FBQSxHQUNBLElBQUEsT0FDQSxNQUFBLGlCQUlBLFlBQUEsV0FDQSxLQUFBLE9BQUEsSUFBQSxLQUFBLElBQUEsU0FBQSxXQUFBLG1CQUNBLEtBQUEsT0FBQSxZQUNBLFNBQUEsSUFDQSxTQUFBLEdBQ0EsMkJBQUEsSUFFQSxLQUFBLE9BQUEsU0FBQSxlQUFBLEdBQ0EsS0FBQSxPQUFBLFNBQUEsZ0JBQUEsR0FBQSxJQUNBLEtBQUEsT0FBQSxhQUFBLFNBQUEsS0FBQSxTQUFBLFlBQ0EsS0FBQSxPQUFBLGFBQUEsUUFBQSxxQkFDQSxLQUFBLE9BQUEsU0FBQSxjQUFBLEtBQUEsT0FBQSxpQ0FBQSxXQUVBLElBQUEsR0FBQSxJQUFBLFFBQUEsMEJBQ0EsR0FDQSxlQUFBLFNBQUEsRUFBQSxFQUFBLEVBQUEsRUFBQSxHQUNBLE1BQUEsS0FBQSxFQUFBLFFBQUEsRUFBQSxTQUFBLFNBRUEsS0FBQSxLQUFBLFNBQ0EsSUFBQSxlQUFBLE9BQUEsYUFDQSxRQUNBLE9BQUEsdUJBQ0EsT0FBQSxHQUVBLFdBQ0EsU0FDQSxHQUFBLFNBQUEsR0FDQSxFQUFBLEtBQUEsRUFBQSxVQUVBLE1BQUEsU0FYQSxTQWtCQSxHQUFBLGFBQUEsR0FHQSxLQUFBLE9BQUEsVUFBQSxpQkFBQSxZQUFBLEtBQUEsbUJBQUEsR0FDQSxLQUFBLE9BQUEsVUFBQSxpQkFBQSxXQUFBLEtBQUEsbUJBQUEsR0FDQSxLQUFBLE9BQUEsVUFBQSxpQkFBQSxPQUFBLEtBQUEsS0FBQSxLQUFBLE9BQUEsSUFHQSxlQUFBLFdBQ0EsS0FBQSxXQUFBLEdBQUEsYUFDQSxNQUFBLEVBQ0EsVUFBQSxTQUFBLEVBQUEsR0FDQSxHQUFBLEdBQUEsS0FBQSxZQUFBLEdBQ0EsSUFDQSxNQUFBLE1BQUEsVUFBQSxFQUFBLEdBQUEsTUFDQSxNQUFBLElBR0EsSUFDQSxNQUFBLE1BQUEsY0FBQSxHQUFBLE1BQ0EsTUFBQSxJQUVBLE1BQUEsTUFHQSxLQUFBLFdBQUEsT0FBQSxNQUFBLFNBQUEsZUFHQSxNQUFBLFNBQUEsR0FDQSxHQUFBLEdBQUEsS0FBQSxXQUFBLE9BQUEsRUFFQSxHQUFBLEVBQUEsUUFBQSxPQUFBLEtBQ0EsRUFBQSxFQUFBLFFBQUEsT0FBQSxJQUVBLElBQUEsR0FBQSxFQUFBLE1BQUEsd0JBUUEsSUFQQSxJQUFBLEtBQUEsRUFBQSxTQUFBLEdBQ0EsR0FBQSxHQUFBLEVBQUEsUUFBQSxRQUFBLGFBQ0EsR0FBQSxFQUFBLFFBQUEsTUFBQSxjQUVBLEVBQUEsRUFBQSxRQUFBLEVBQUEsS0FHQSxHQUFBLEtBQUEsT0FBQSxxQ0FBQSxDQUNBLEtBQUEsY0FDQSxhQUFBLEtBQUEsYUFHQSxJQUFBLEdBQUEsU0FBQSxLQUFBLE9BQUEsOENBQUEsSUFFQSxNQUFBLGFBQUEsV0FBQSxXQUNBLEtBQUEsS0FBQSxTQUNBLElBQUEsZUFBQSxPQUFBLGFBQ0EsUUFDQSxPQUFBLDRCQUNBLFFBQUEsRUFDQSxTQUFBLEtBQUEsUUFBQSxJQUVBLFVBQUEsRUFDQSxXQUNBLFNBQ0EsR0FBQSxTQUFBLEdBQ0EsS0FBQSxRQUFBLE9BQUEsRUFBQSxPQUVBLE1BQUEsVUFJQSxLQUFBLE1BQUEsT0FFQSxNQUFBLFFBQUEsT0FBQSxFQU1BLE9BSEEsTUFBQSxXQUFBLElBQUEsTUFBQSxLQUFBLE9BQUEsV0FDQSxLQUFBLFNBQUEsSUFBQSxNQUFBLEVBRUEsR0FHQSxrQkFBQSxTQUFBLEdBQ0EsRUFBQSxrQkFDQSxFQUFBLGtCQUdBLEtBQUEsU0FBQSxHQUNBLEVBQUEsa0JBQ0EsRUFBQSxrQkFFQSxHQUFBLEtBQUEsT0FBQSw4Q0FBQSxHQUFBLEtBQUEsT0FBQSw4Q0FDQSxLQUFBLFlBQUEsRUFBQSxhQUFBLFFBSUEsWUFBQSxTQUFBLEdBQ0EsSUFBQSxLQUFBLEVBQUEsU0FBQSxHQUNBLEdBQUEsR0FBQSxXQUFBLEtBQUEsRUFBQSxLQUVBLElBQUEsRUFBQSxDQUNBLEdBQUEsR0FBQSxLQUFBLE9BQUEsNkNBQUEsT0FBQSxDQUVBLEtBQUEsS0FBQSxVQUFBLEtBQUEsT0FBQSxxQ0FBQSxHQUdBLE1BRkEsTUFBQSxZQUFBLEVBQUEsUUFBQSxFQUFBLGlEQUVBLENBR0EsSUFBQSxFQUFBLEtBQUEsU0FBQSxLQUFBLE9BQUEsbUNBR0EsTUFGQSxNQUFBLFlBQUEsRUFBQSxRQUFBLEVBQUEsdUNBRUEsQ0FHQSxJQUFBLEtBQUEsT0FBQSx5Q0FDQSxLQUFBLE1BQ0EsTUFBQSxnQ0FDQSxLQUFBLEVBQ0EsR0FBQSxPQUNBLE9BRUEsS0FBQSxXQUFBLEVBQUEsYUFFQSxDQUNBLEdBQUEsR0FBQSxLQUFBLE9BQUEsNENBQUEsT0FBQSxDQUVBLEtBQUEsS0FBQSxVQUFBLEtBQUEsT0FBQSxvQ0FBQSxHQUdBLE1BRkEsTUFBQSxZQUFBLEVBQUEsT0FBQSxFQUFBLGdEQUVBLENBR0EsSUFBQSxFQUFBLEtBQUEsU0FBQSxLQUFBLE9BQUEsbUNBR0EsTUFGQSxNQUFBLFlBQUEsRUFBQSxPQUFBLEVBQUEsdUNBRUEsQ0FHQSxNQUFBLFdBQUEsRUFBQSxVQUdBLE9BR0EsVUFBQSxTQUFBLEVBQUEsR0FHQSxNQUZBLEdBQUEsRUFBQSxNQUFBLEtBRUEsSUFBQSxFQUFBLFFBQUEsRUFBQSxLQUFBLE1BQUEsS0FBQSxRQUdBLFdBQUEsU0FBQSxFQUFBLEdBQ0EsSUFBQSxFQUFBLE9BRUEsSUFBQSxHQUFBLEtBQUEsaUJBRUEsRUFBQSxHQUFBLFNBQ0EsR0FBQSxPQUFBLE9BQUEsR0FDQSxFQUFBLE9BQUEsU0FBQSxjQUFBLEVBQUEsVUFDQSxFQUFBLE9BQUEsT0FBQSxFQUFBLE1BQ0EsRUFBQSxPQUFBLFdBQUEsS0FBQSxPQUFBLFNBRUEsSUFBQSxHQUFBLEdBQUEsZUFDQSxHQUFBLEtBQUEsT0FBQSxlQUFBLE9BQUEsY0FDQSxFQUFBLGlCQUFBLGFBQUEsUUFDQSxFQUFBLGlCQUFBLFVBQUEsSUFBQSxLQUFBLGVBQUEsU0FFQSxFQUFBLE9BQUEsV0FBQSxTQUFBLEdBQ0EsR0FBQSxFQUFBLGlCQUFBLENBQ0EsR0FBQSxHQUFBLEVBQUEsT0FBQSxFQUFBLE1BQUEsSUFBQSxDQUNBLEdBQUEsTUFBQSxhQUFBLFNBQUEsRUFBQSxPQUVBLEtBQUEsTUFFQSxFQUFBLE9BQUEsV0FDQSxHQUFBLE1BQUEsRUFBQSxPQUFBLENBQ0EsR0FBQSxHQUFBLEtBQUEsTUFBQSxFQUFBLGFBQ0EsSUFBQSxHQUFBLEVBQUEsUUFBQSxDQUNBLEVBQUEsUUFDQSxJQUFBLEdBQUEsU0FBQSxFQUFBLElBQUEsRUFDQSxNQUFBLE9BQUEsT0FBQSxFQUFBLElBQUEsRUFBQSxPQUFBLEtBQUEsS0FBQSxFQUFBLE9BQUEsS0FBQSxLQUFBLEVBQUEsT0FBQSxLQUFBLFlBRUEsTUFBQSxhQUFBLEVBQUEsRUFBQSxXQUdBLEtBQUEsTUFFQSxFQUFBLEtBQUEsSUFHQSxlQUFBLFNBQUEsRUFBQSxHQUNBLEdBQUEsR0FBQSxJQUFBLFVBQUEsWUFBQSxLQUFBLFdBQ0EsSUFBQSxNQUNBLEtBQUEsaUZBQUEsRUFBQSw0QkFBQSxHQUFBLEVBQUEsV0FHQSxPQUFBLEtBQUEsSUFBQSxJQUdBLGFBQUEsU0FBQSxFQUFBLEdBQ0EsRUFBQSxNQUFBLGFBQUEsU0FBQSxTQUNBLEVBQUEsTUFBQSxhQUFBLFNBQUEsUUFFQSxFQUFBLE1BQUEsS0FBQSxTQUFBLGtCQUNBLEVBQUEsTUFBQSxLQUFBLGFBQUEsZUFBQSxlQUNBLEVBQUEsTUFBQSxLQUFBLFlBQUEsYUFFQSxFQUFBLE1BQUEsUUFBQSxJQUFBLFdBQUEsWUFBQSxFQUNBLEVBQUEsTUFBQSxtQkFBQSxHQUFBLFFBQUEsV0FDQSxFQUFBLFlBSUEsWUFBQSxTQUFBLEVBQUEsRUFBQSxHQUNBLEdBQUEsR0FBQSxLQUFBLGVBQUEsRUFBQSxFQUFBLEtBQ0EsTUFBQSxhQUFBLEVBQUEsTUFJQSxLQUFBLFFBQUEsV0FDQSxHQUFBLGdCQUFBLFFDMWJBLGVBQUEsT0FBQSxRQUFBLFNBQUEsUUFDQSxPQUFBLFdBQ0EsT0FBQSxnQkFBQSxPQUFBLGlCQUFBLDhCQUVBLElBQUEsUUFBQSxRQUNBLE9BQUEsRUFDQSxPQUFBLE9BQ0EsWUFBQSxPQUNBLFFBQUEsRUFDQSxXQUFBLEVBQ0EsYUFBQSxFQUNBLGFBQUEsRUFDQSxZQUFBLEVBQ0EsWUFBQSxFQUNBLFdBQUEsRUFDQSxNQUFBLElBQ0EsTUFBQSxFQUFBLHFDQUNBLElBQUEsY0FDQSxLQUFBLCtDQUFBLElBQUEsZ0JBQUEsT0FBQSxNQUFBLFdBQ0EsT0FDQSxLQUFBLG9DQUFBLEVBQUEsK0JBQ0EsTUFBQSxLQUNBLE1BQUEsT0FDQSxPQUFBLGNBQ0EsUUFBQSxLQUFBLG9CQUVBLEtBQUEsa0NBQUEsRUFBQSwrQkFDQSxNQUFBLEtBQ0EsTUFBQSxPQUNBLE9BQUEsY0FDQSxRQUFBLEtBQUEsb0JBRUEsS0FBQSx5Q0FBQSxFQUFBLGtDQUNBLE1BQUEsS0FDQSxNQUFBLEdBQ0EsT0FBQSxPQUNBLFFBQUEsS0FBQSxvQkFFQSxLQUFBLDBDQUFBLEVBQUEsbUNBQ0EsTUFBQSxLQUNBLE9BQUEsR0FDQSxPQUFBLE9BQ0EsUUFBQSxLQUFBLG9CQUVBLEtBQUEseUNBQUEsRUFBQSxzQ0FDQSxNQUFBLEtBQ0EsTUFBQSxJQUNBLE9BQUEsU0FDQSxRQUFBLEtBQUEsb0JBRUEsS0FBQSwwQ0FBQSxFQUFBLHVDQUNBLE1BQUEsS0FDQSxNQUFBLEdBQ0EsT0FBQSxTQUNBLFFBQUEsS0FBQSxvQkFFQSxLQUFBLG9DQUFBLEVBQUEsd0NBQ0EsTUFBQSxLQUNBLE1BQUEsS0FDQSxPQUFBLFFBQ0EsUUFBQSxLQUFBLG9CQUVBLFVBQ0EsS0FBQSxFQUFBLFVBQ0EsTUFBQSxLQUNBLFFBQUEsS0FBQSxRQUVBLEtBQUEsRUFBQSxpQ0FDQSxJQUFBLGlCQUNBLE1BQUEsS0FDQSxLQUFBLEVBQ0EsUUFBQSxLQUFBLFNBRUEsS0FBQSxFQUFBLHNDQUNBLElBQUEsaUJBQ0EsTUFBQSxLQUNBLEtBQUEsRUFDQSxRQUFBLEtBQUEsU0FFQSxXQUNBLE1BQ0EsR0FBQSxXQUNBLEdBQUEsa0JBQ0EsTUFBQSxXQUFBLEVBQUEsSUFBQSxLQUFBLEdBQUEsSUFBQSxPQUFBLGdCQUVBLElBQUEsT0FBQSxLQUFBLE9BQUEsc0NBQ0EsU0FDQSxNQUFBLFFBQUEsa0JBQUEsSUFDQSxNQUFBLEtBQUEsT0FFQSxlQUFBLFlBQUEsT0FHQSxlQUFBLEtBQUEsU0FBQSxHQUNBLEtBQUEsV0FDQSxRQUFBLEVBQUEsRUFDQSxPQUFBLEVBQUEsRUFDQSxZQUFBLEVBQUEsT0FDQSxXQUFBLEVBQUEsTUFDQSxZQUFBLEVBQUEsT0FBQSxLQUNBLFFBQ0EsS0FBQSxNQUVBLEtBQUEsV0FBQSxRQUFBLGlCQUVBLE1BQUEsU0FJQSxlQUFBLE9BQUEsUUFBQSxXQUFBLFlBQUEsS0FBQSxLQUFBLFFBQ0EsS0FBQSxPQUFBLFFBR0EsSUFBQSxPQUFBLGVBQUEsT0FBQSxRQUFBLElBQUEsUUFDQSxVQUFBLEdBQ0EsT0FBQSxTQUFBLEdBQ0EsR0FBQSxHQUFBLEtBQUEsT0FBQSxHQUFBLGVBQUEsUUFBQSxLQUFBLE9BQUEsS0FBQSxNQUVBLEVBQUEsR0FBQSxTQUNBLEdBQUEsT0FBQSxPQUFBLEtBQUEsT0FBQSxNQUNBLEVBQUEsT0FBQSxTQUFBLDBCQUNBLEVBQUEsT0FBQSxZQUFBLEtBQUEsV0FDQSxFQUFBLE9BQUEsT0FBQSxLQUFBLE9BQUEsS0FBQSxNQUNBLEVBQUEsT0FBQSxPQUFBLEVBQUEsTUFDQSxFQUFBLE9BQUEsV0FBQSxLQUFBLE9BQUEsR0FBQSxPQUFBLFNBRUEsSUFBQSxHQUFBLEdBQUEsZUFDQSxHQUFBLEtBQUEsT0FBQSxlQUFBLE9BQUEsY0FDQSxFQUFBLGlCQUFBLGFBQUEsUUFDQSxFQUFBLGlCQUFBLFVBQUEsSUFBQSxLQUFBLGVBQUEsU0FFQSxFQUFBLE9BQUEsV0FBQSxTQUFBLEdBQ0EsR0FBQSxFQUFBLGlCQUFBLENBQ0EsR0FBQSxHQUFBLEVBQUEsT0FBQSxFQUFBLE1BQUEsSUFBQSxDQUNBLEdBQUEsTUFBQSxhQUFBLFNBQUEsRUFBQSxPQUVBLEtBQUEsTUFFQSxFQUFBLE9BQUEsV0FDQSxHQUFBLE1BQUEsRUFBQSxPQUFBLENBQ0EsR0FBQSxHQUFBLEtBQUEsTUFBQSxFQUFBLGFBRUEsSUFBQSxFQUFBLFNBQ0EsRUFBQSxTQUNBLEtBQUEsT0FBQSxHQUFBLE9BQUEsT0FBQSxLQUFBLEVBQUEsT0FBQSxLQUFBLEtBQUEsRUFBQSxPQUFBLEtBQUEsS0FBQSxFQUFBLE9BQUEsS0FBQSxTQUVBLEtBQUEsT0FBQSxHQUFBLGFBQUEsRUFBQSxFQUFBLFdBR0EsS0FBQSxNQUVBLEVBQUEsS0FBQSxHQUVBLEtBQUEsU0FHQSxrQkFBQSxTQUFBLEdBQ0EsS0FBQSxXQUFBLFFBQUEsRUFBQSxPQUFBLEVBQUEsUUFHQSxNQUFBLFdBQ0EsS0FBQSxXQUFBLFFBQUEsV0FFQSxlQUFBLE9BQUEsUUFBQSxXQUFBLE1BQUEsS0FBQSxTQUdBLElBQUEsSUFBQSxnQ0FBQSxlQUFBLE9BQUEiLCJmaWxlIjoiYXBwLmpzIiwic291cmNlc0NvbnRlbnQiOlsiRXh0Lm5zKCdNYXJrZG93bkVkaXRvcicpO1xuTWFya2Rvd25FZGl0b3IgPSBmdW5jdGlvbihjb25maWcpIHtcbiAgICBjb25maWcgPSBjb25maWcgfHwge307XG4gICAgTWFya2Rvd25FZGl0b3Iuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsY29uZmlnKTtcbn07XG5FeHQuZXh0ZW5kKE1hcmtkb3duRWRpdG9yLEV4dC5Db21wb25lbnQse1xuICAgIHdpbmRvdzp7fSxjb25maWc6IHt9XG59KTtcbkV4dC5yZWcoJ21hcmtkb3duZWRpdG9yJyxNYXJrZG93bkVkaXRvcik7XG5tYXJrZG93bkVkaXRvciA9IG5ldyBNYXJrZG93bkVkaXRvcigpO1xuXG5tYXJrZG93bkVkaXRvci5FZGl0b3IgPSBmdW5jdGlvbihjb25maWcpIHtcbiAgICBjb25maWcgPSBjb25maWcgfHwge307XG4gICAgY29uZmlnLnJlc291cmNlID0gTU9EeC5yZXF1ZXN0LmlkIHx8IDA7XG4gICAgbWFya2Rvd25FZGl0b3IuRWRpdG9yLnN1cGVyY2xhc3MuY29uc3RydWN0b3IuY2FsbCh0aGlzLGNvbmZpZyk7XG4gICAgdGhpcy5jb25maWcgPSBjb25maWc7XG59O1xuRXh0LmV4dGVuZChtYXJrZG93bkVkaXRvci5FZGl0b3IsRXh0LkNvbXBvbmVudCx7XG4gICAgcmVtYXJrYWJsZTogJydcbiAgICAsaW5pdENvbXBvbmVudDogZnVuY3Rpb24oKSB7XG4gICAgICAgIE1hcmtkb3duRWRpdG9yLnN1cGVyY2xhc3MuaW5pdENvbXBvbmVudC5jYWxsKHRoaXMpO1xuXG4gICAgICAgIEV4dC5vblJlYWR5KHRoaXMucmVuZGVyLCB0aGlzKTtcbiAgICB9XG5cbiAgICAscmVuZGVyOiBmdW5jdGlvbigpIHtcbiAgICAgICAgdGhpcy50ZXh0YXJlYSA9IEV4dC5nZXQoJ3RhJyk7XG5cbiAgICAgICAgdGhpcy5idWlsZFVJKCk7XG4gICAgICAgIHRoaXMucmVnaXN0ZXJBY2UoKTtcbiAgICAgICAgdGhpcy5yZWdpc3Rlck1hcmtlZCgpO1xuXG4gICAgICAgIHRoaXMuc3RhdHVzQmFyID0gRXh0LmdldCgnc3RhdHVzLWJhcicpO1xuICAgICAgICB0aGlzLnByZXZpZXcgPSBFeHQuZ2V0KCdwcmV2aWV3LW1kJyk7XG5cbiAgICAgICAgdmFyIHByZXZpZXdCdXR0b24gPSBFeHQuZ2V0KCdwcmV2aWV3LWJ1dHRvbicpO1xuICAgICAgICB2YXIgZnVsbHNjcmVlbkJ1dHRvbiA9IEV4dC5nZXQoJ2Z1bGxzY3JlZW4tYnV0dG9uJyk7XG4gICAgICAgIHZhciBjb250ZW50ID0gRXh0LmdldCgnY29udGVudC1tZCcpO1xuICAgICAgICB2YXIgd3JhcHBlciA9IGNvbnRlbnQucGFyZW50KCk7XG5cbiAgICAgICAgdmFyIGRyb3BUYXJnZXQgPSBNT0R4LmxvYWQoe1xuICAgICAgICAgICAgeHR5cGU6ICdtb2R4LXRyZWVkcm9wJyxcbiAgICAgICAgICAgIHRhcmdldDogY29udGVudCxcbiAgICAgICAgICAgIHRhcmdldEVsOiBjb250ZW50LFxuICAgICAgICAgICAgb25JbnNlcnQ6IChmdW5jdGlvbihzKXtcbiAgICAgICAgICAgICAgICB0aGlzLmluc2VydChzKTtcbiAgICAgICAgICAgICAgICB0aGlzLmZvY3VzKCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9KS5iaW5kKHRoaXMuZWRpdG9yKSxcbiAgICAgICAgICAgIGlmcmFtZTogdHJ1ZVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy50ZXh0YXJlYS5vbignZGVzdHJveScsIGZ1bmN0aW9uKCkge2Ryb3BUYXJnZXQuZGVzdHJveSgpO30pO1xuXG4gICAgICAgIHByZXZpZXdCdXR0b24uYWRkTGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKHRoaXMucHJldmlldy5pc1Zpc2libGUoKSkge1xuICAgICAgICAgICAgICAgIHRoaXMucHJldmlldy5zZXREaXNwbGF5ZWQoJ25vbmUnKTtcbiAgICAgICAgICAgICAgICBjb250ZW50LnNldERpc3BsYXllZCgnYmxvY2snKTtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1c0Jhci5zZXREaXNwbGF5ZWQoJ2Jsb2NrJyk7XG5cbiAgICAgICAgICAgICAgICBwcmV2aWV3QnV0dG9uLmNoaWxkKCdpJykucmVtb3ZlQ2xhc3MoJ2ljb24tdG9nZ2xlLW9uJyk7XG4gICAgICAgICAgICAgICAgcHJldmlld0J1dHRvbi5jaGlsZCgnaScpLmFkZENsYXNzKCdpY29uLXRvZ2dsZS1vZmYnKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5wcmV2aWV3LnNldERpc3BsYXllZCgnYmxvY2snKTtcbiAgICAgICAgICAgICAgICBjb250ZW50LnNldERpc3BsYXllZCgnbm9uZScpO1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzQmFyLnNldERpc3BsYXllZCgnbm9uZScpO1xuXG4gICAgICAgICAgICAgICAgcHJldmlld0J1dHRvbi5jaGlsZCgnaScpLnJlbW92ZUNsYXNzKCdpY29uLXRvZ2dsZS1vZmYnKTtcbiAgICAgICAgICAgICAgICBwcmV2aWV3QnV0dG9uLmNoaWxkKCdpJykuYWRkQ2xhc3MoJ2ljb24tdG9nZ2xlLW9uJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sIHRoaXMpO1xuXG4gICAgICAgIGZ1bGxzY3JlZW5CdXR0b24uYWRkTGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdmFyIGljb24gPSBmdWxsc2NyZWVuQnV0dG9uLmNoaWxkKCdpJyk7XG5cbiAgICAgICAgICAgIGlmIChpY29uLmhhc0NsYXNzKCdpY29uLWV4cGFuZCcpKSB7XG4gICAgICAgICAgICAgICAgaWNvbi5yZW1vdmVDbGFzcygnaWNvbi1leHBhbmQnKTtcbiAgICAgICAgICAgICAgICBpY29uLmFkZENsYXNzKCdpY29uLWNvbXByZXNzJyk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLnByZXZpZXcuc2V0RGlzcGxheWVkKCdibG9jaycpO1xuICAgICAgICAgICAgICAgIGNvbnRlbnQuc2V0RGlzcGxheWVkKCdibG9jaycpO1xuXG4gICAgICAgICAgICAgICAgcHJldmlld0J1dHRvbi5oaWRlKCk7XG5cbiAgICAgICAgICAgICAgICB3cmFwcGVyLmFkZENsYXNzKCdmdWxsc2NyZWVuJyk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmVkaXRvci5zZXRPcHRpb24oJ21heExpbmVzJywgbnVsbCk7XG5cbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWNvbi5hZGRDbGFzcygnaWNvbi1leHBhbmQnKTtcbiAgICAgICAgICAgICAgICBpY29uLnJlbW92ZUNsYXNzKCdpY29uLWNvbXByZXNzJyk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLnByZXZpZXcuc2V0RGlzcGxheWVkKCdub25lJyk7XG4gICAgICAgICAgICAgICAgY29udGVudC5zZXREaXNwbGF5ZWQoJ2Jsb2NrJyk7XG5cbiAgICAgICAgICAgICAgICBwcmV2aWV3QnV0dG9uLnNob3coKTtcblxuICAgICAgICAgICAgICAgIHdyYXBwZXIucmVtb3ZlQ2xhc3MoJ2Z1bGxzY3JlZW4nKTtcblxuICAgICAgICAgICAgICAgIHRoaXMuZWRpdG9yLnNldE9wdGlvbignbWF4TGluZXMnLCBJbmZpbml0eSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuc3RhdHVzQmFyLnNldERpc3BsYXllZCgnYmxvY2snKTtcblxuICAgICAgICAgICAgdGhpcy5lZGl0b3IucmVzaXplKHRydWUpO1xuICAgICAgICB9LCB0aGlzKTtcblxuICAgICAgICBpZiAobWFya2Rvd25FZGl0b3IuY29udGVudC5jb250ZW50KSB7XG4gICAgICAgICAgICB0aGlzLmVkaXRvci5zZXRWYWx1ZShtYXJrZG93bkVkaXRvci5jb250ZW50LmNvbnRlbnQpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZWRpdG9yLnNlbGVjdGlvbi5jbGVhclNlbGVjdGlvbigpO1xuXG4gICAgICAgIHRoaXMucHJldmlldy51cGRhdGUodGhpcy5wYXJzZSh0aGlzLmVkaXRvci5nZXRWYWx1ZSgpKSk7XG5cbiAgICAgICAgdGhpcy5lZGl0b3IuZ2V0U2Vzc2lvbigpLm9uKCdjaGFuZ2UnLCBmdW5jdGlvbihlKXtcbiAgICAgICAgICAgIHRoaXMucGFyc2UodGhpcy5lZGl0b3IuZ2V0VmFsdWUoKSk7XG4gICAgICAgIH0uYmluZCh0aGlzKSk7XG4gICAgfVxuXG4gICAgLGJ1aWxkVUk6IGZ1bmN0aW9uKCkge1xuICAgICAgICB0aGlzLnRleHRhcmVhLnNldERpc3BsYXllZCgnbm9uZScpO1xuICAgICAgICB0aGlzLnRleHRhcmVhLnNldFdpZHRoKDApO1xuICAgICAgICB0aGlzLnRleHRhcmVhLnNldEhlaWdodCgwKTtcblxuICAgICAgICBFeHQuRG9tSGVscGVyLmluc2VydEJlZm9yZSh0aGlzLnRleHRhcmVhLCB7XG4gICAgICAgICAgICB0YWc6ICd0ZXh0YXJlYScsXG4gICAgICAgICAgICBuYW1lOiAndGFfbWFya2Rvd24nLFxuICAgICAgICAgICAgaWQ6ICd0YV9tYXJrZG93bidcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy50YU1hcmtkb3duID0gRXh0LmdldCgndGFfbWFya2Rvd24nKTtcbiAgICAgICAgdGhpcy50YU1hcmtkb3duLnNldERpc3BsYXllZCgnbm9uZScpO1xuICAgICAgICB0aGlzLnRhTWFya2Rvd24uc2V0V2lkdGgoMCk7XG4gICAgICAgIHRoaXMudGFNYXJrZG93bi5zZXRIZWlnaHQoMCk7XG5cbiAgICAgICAgdmFyIHdyYXBwZXIgPSBFeHQuRG9tSGVscGVyLmluc2VydEJlZm9yZSh0aGlzLnRleHRhcmVhLCB7XG4gICAgICAgICAgICB0YWc6ICdkaXYnLFxuICAgICAgICAgICAgY2xhc3M6ICdtYXJrZG93bi1jb250YWluZXInXG4gICAgICAgIH0pO1xuXG4gICAgICAgIEV4dC5Eb21IZWxwZXIuYXBwZW5kKHdyYXBwZXIse1xuICAgICAgICAgICAgdGFnOiAnZGl2JyxcbiAgICAgICAgICAgIGlkOiAnY29udGVudC1tZCcsXG4gICAgICAgICAgICBjbGFzczogdGhpcy50ZXh0YXJlYS5kb20uY2xhc3NOYW1lXG4gICAgICAgIH0pO1xuXG4gICAgICAgIEV4dC5Eb21IZWxwZXIuYXBwZW5kKHdyYXBwZXIse1xuICAgICAgICAgICAgdGFnOiAnZGl2JyxcbiAgICAgICAgICAgIGlkOiAncHJldmlldy1tZCcsXG4gICAgICAgICAgICBjbGFzczogJ21hcmtkb3duLWJvZHknXG4gICAgICAgIH0pO1xuXG4gICAgICAgIEV4dC5Eb21IZWxwZXIuYXBwZW5kKHdyYXBwZXIse1xuICAgICAgICAgICAgdGFnOiAnZGl2JyxcbiAgICAgICAgICAgIGlkOiAndG9vbGJveCcsXG4gICAgICAgICAgICBjbjogW3tcbiAgICAgICAgICAgICAgICB0YWc6ICdzcGFuJyxcbiAgICAgICAgICAgICAgICBpZDogJ3ByZXZpZXctYnV0dG9uJyxcbiAgICAgICAgICAgICAgICBodG1sOiAnPGkgY2xhc3M9XCJpY29uIGljb24tdG9nZ2xlLW9mZlwiPjwvaT4gJyArIF8oJ21hcmtkb3duZWRpdG9yLnRvb2xib3gucHJldmlldycpXG4gICAgICAgICAgICB9LHtcbiAgICAgICAgICAgICAgICB0YWc6ICdzcGFuJyxcbiAgICAgICAgICAgICAgICBpZDogJ2Z1bGxzY3JlZW4tYnV0dG9uJyxcbiAgICAgICAgICAgICAgICBodG1sOiAnPGkgY2xhc3M9XCJpY29uIGljb24tZXhwYW5kXCI+PC9pPidcbiAgICAgICAgICAgIH1dXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChNT0R4LmNvbmZpZ1snbWFya2Rvd25lZGl0b3IudXBsb2FkLmVuYWJsZV9pbWFnZV91cGxvYWQnXSA9PSAxIHx8IE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci51cGxvYWQuZW5hYmxlX2ZpbGVfdXBsb2FkJ10gPT0gMSkge1xuICAgICAgICAgICAgRXh0LkRvbUhlbHBlci5hcHBlbmQod3JhcHBlcix7XG4gICAgICAgICAgICAgICAgdGFnOiAnZGl2JyxcbiAgICAgICAgICAgICAgICBpZDogJ3N0YXR1cy1iYXInLFxuICAgICAgICAgICAgICAgIGh0bWw6ICc8aW5wdXQgY2xhc3M9XCJoaWRkZW5cIiBpZD1cImlucHV0RmlsZVwiIG5hbWU9XCJmaWxlXCIgdHlwZT1cImZpbGVcIiBtdWx0aXBsZT4nICsgXygnbWFya2Rvd25lZGl0b3Iuc3RhdHVzX2Jhcl9tZXNzYWdlJylcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBFeHQuZ2V0KCdpbnB1dEZpbGUnKS5vbignY2hhbmdlJywgZnVuY3Rpb24oZSwgaW5wdXQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUZpbGVzKGlucHV0LmZpbGVzKTtcbiAgICAgICAgICAgICAgICBpbnB1dC52YWx1ZSA9IFwiXCI7XG4gICAgICAgICAgICB9LCB0aGlzKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIEV4dC5Eb21IZWxwZXIuYXBwZW5kKHdyYXBwZXIse1xuICAgICAgICAgICAgICAgIHRhZzogJ2RpdicsXG4gICAgICAgICAgICAgICAgaWQ6ICdzdGF0dXMtYmFyJyxcbiAgICAgICAgICAgICAgICBodG1sOiBfKCdtYXJrZG93bmVkaXRvci5zdGF0dXNfYmFyX2Rpc2FibGVkJylcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgRXh0LkRvbUhlbHBlci5hcHBlbmQod3JhcHBlcix7XG4gICAgICAgICAgICB0YWc6ICdzcGFuJyxcbiAgICAgICAgICAgIHN0eWxlOiAnY2xlYXI6IGJvdGgnXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgICxyZWdpc3RlckFjZTogZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMuZWRpdG9yID0gYWNlLmVkaXQoRXh0LkRvbVF1ZXJ5LnNlbGVjdE5vZGUoJ2RpdiNjb250ZW50LW1kJykpO1xuICAgICAgICB0aGlzLmVkaXRvci5zZXRPcHRpb25zKHtcbiAgICAgICAgICAgIG1heExpbmVzOiBJbmZpbml0eSxcbiAgICAgICAgICAgIG1pbkxpbmVzOiAyNSxcbiAgICAgICAgICAgIGVuYWJsZUJhc2ljQXV0b2NvbXBsZXRpb246IHRydWVcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuZWRpdG9yLnJlbmRlcmVyLnNldFNob3dHdXR0ZXIodHJ1ZSk7XG4gICAgICAgIHRoaXMuZWRpdG9yLnJlbmRlcmVyLnNldFNjcm9sbE1hcmdpbigxMCwgMTApO1xuICAgICAgICB0aGlzLmVkaXRvci5nZXRTZXNzaW9uKCkuc2V0VmFsdWUodGhpcy50ZXh0YXJlYS5nZXRWYWx1ZSgpKTtcbiAgICAgICAgdGhpcy5lZGl0b3IuZ2V0U2Vzc2lvbigpLnNldE1vZGUoXCJhY2UvbW9kZS9tYXJrZG93blwiKTtcbiAgICAgICAgdGhpcy5lZGl0b3Iuc2V0VGhlbWUoXCJhY2UvdGhlbWUvXCIgKyAoTU9EeC5jb25maWdbJ21hcmtkb3duZWRpdG9yLmdlbmVyYWwudGhlbWUnXSB8fCAnbW9ub2thaScpKTtcblxuICAgICAgICB2YXIgbGFuZ1Rvb2xzID0gYWNlLnJlcXVpcmUoXCJhY2UvZXh0L2xhbmd1YWdlX3Rvb2xzXCIpO1xuICAgICAgICB2YXIgcmVzb3VyY2VzQ29tcGxldGVyID0ge1xuICAgICAgICAgICAgZ2V0Q29tcGxldGlvbnM6IGZ1bmN0aW9uKGVkaXRvciwgc2Vzc2lvbiwgcG9zLCBwcmVmaXgsIGNhbGxiYWNrKSB7XG4gICAgICAgICAgICAgICAgaWYgKHByZWZpeC5sZW5ndGggPT09IDApIHsgY2FsbGJhY2sobnVsbCwgW10pOyByZXR1cm4gfVxuXG4gICAgICAgICAgICAgICAgTU9EeC5BamF4LnJlcXVlc3Qoe1xuICAgICAgICAgICAgICAgICAgICB1cmw6IG1hcmtkb3duRWRpdG9yLmNvbmZpZy5jb25uZWN0b3JVcmxcbiAgICAgICAgICAgICAgICAgICAgLHBhcmFtczoge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uOiAnbWdyL3Jlc291cmNlL2dldGxpc3QnXG4gICAgICAgICAgICAgICAgICAgICAgICAscHJlZml4OiBwcmVmaXhcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAnc3VjY2Vzcyc6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbjogZnVuY3Rpb24ocikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCByLnJlc3VsdHMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIGxhbmdUb29scy5hZGRDb21wbGV0ZXIocmVzb3VyY2VzQ29tcGxldGVyKTtcblxuXG4gICAgICAgIHRoaXMuZWRpdG9yLmNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKFwiZHJhZ2VudGVyXCIsIHRoaXMuY2F0Y2hBbmREb05vdGhpbmcsIGZhbHNlKTtcbiAgICAgICAgdGhpcy5lZGl0b3IuY29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoXCJkcmFnb3ZlclwiLCB0aGlzLmNhdGNoQW5kRG9Ob3RoaW5nLCBmYWxzZSk7XG4gICAgICAgIHRoaXMuZWRpdG9yLmNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKFwiZHJvcFwiLCB0aGlzLmRyb3AuYmluZCh0aGlzKSwgZmFsc2UpO1xuICAgIH1cblxuICAgICxyZWdpc3Rlck1hcmtlZDogZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMucmVtYXJrYWJsZSA9IG5ldyBSZW1hcmthYmxlKHtcbiAgICAgICAgICAgIGh0bWw6IHRydWUsXG4gICAgICAgICAgICBoaWdobGlnaHQ6IGZ1bmN0aW9uIChzdHIsIGxhbmcpIHtcbiAgICAgICAgICAgICAgICBpZiAobGFuZyAmJiBobGpzLmdldExhbmd1YWdlKGxhbmcpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGxqcy5oaWdobGlnaHQobGFuZywgc3RyKS52YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7fVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBobGpzLmhpZ2hsaWdodEF1dG8oc3RyKS52YWx1ZTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHt9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gJyc7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnJlbWFya2FibGUuaW5saW5lLnJ1bGVyLmRpc2FibGUoWyAnYmFja3RpY2tzJyBdKTtcbiAgICB9XG5cbiAgICAscGFyc2U6IGZ1bmN0aW9uKGlucHV0KSB7XG4gICAgICAgIHZhciBvdXRwdXQgPSB0aGlzLnJlbWFya2FibGUucmVuZGVyKGlucHV0KTtcblxuICAgICAgICBvdXRwdXQgPSBvdXRwdXQucmVwbGFjZSgvJTVCL2csICdbJyk7XG4gICAgICAgIG91dHB1dCA9IG91dHB1dC5yZXBsYWNlKC8lNUQvZywgJ10nKTtcblxuICAgICAgICB2YXIgY29kZUJsb2NrcyA9IG91dHB1dC5tYXRjaCgvPGNvZGUoLnxcXHMpKjxcXC9jb2RlPi9nKTtcbiAgICAgICAgRXh0LmVhY2goY29kZUJsb2NrcywgZnVuY3Rpb24oaXRlbSkge1xuICAgICAgICAgICAgdmFyIHJlcGxhY2VkSXRlbSA9IGl0ZW0ucmVwbGFjZSgvXFxbXFxbL2csICcmIzkxOyYjOTE7Jyk7XG4gICAgICAgICAgICByZXBsYWNlZEl0ZW0gPSByZXBsYWNlZEl0ZW0ucmVwbGFjZSgvXV0vZywgJyYjOTM7JiM5MzsnKTtcblxuICAgICAgICAgICAgb3V0cHV0ID0gb3V0cHV0LnJlcGxhY2UoaXRlbSwgcmVwbGFjZWRJdGVtKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci5scC5wYXJzZV9tb2R4X3RhZ3MnXSA9PSAxKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5wYXJzZVJlcXVlc3QpIHtcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5wYXJzZVJlcXVlc3QpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB2YXIgdGltZW91dCA9IHBhcnNlSW50KE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci5scC5wYXJzZV9tb2R4X3RhZ3NfdGltZW91dCddIHx8IDMwMCk7XG5cbiAgICAgICAgICAgIHRoaXMucGFyc2VSZXF1ZXN0ID0gc2V0VGltZW91dChmdW5jdGlvbigpe1xuICAgICAgICAgICAgICAgIE1PRHguQWpheC5yZXF1ZXN0KHtcbiAgICAgICAgICAgICAgICAgICAgdXJsOiBtYXJrZG93bkVkaXRvci5jb25maWcuY29ubmVjdG9yVXJsXG4gICAgICAgICAgICAgICAgICAgICxwYXJhbXM6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbjogJ21nci9lZGl0b3IvcHJvY2Vzc2NvbnRlbnQnXG4gICAgICAgICAgICAgICAgICAgICAgICAsY29udGVudDogb3V0cHV0XG4gICAgICAgICAgICAgICAgICAgICAgICAscmVzb3VyY2U6IE1PRHgucmVxdWVzdC5pZFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBpc1VwbG9hZCA6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyczoge1xuICAgICAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm46IGZ1bmN0aW9uKHIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wcmV2aWV3LnVwZGF0ZShyLmRhdGEpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfS5iaW5kKHRoaXMpLCB0aW1lb3V0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucHJldmlldy51cGRhdGUob3V0cHV0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMudGFNYXJrZG93bi5kb20udmFsdWUgPSB0aGlzLmVkaXRvci5nZXRWYWx1ZSgpO1xuICAgICAgICB0aGlzLnRleHRhcmVhLmRvbS52YWx1ZSA9IG91dHB1dDtcblxuICAgICAgICByZXR1cm4gb3V0cHV0O1xuICAgIH1cblxuICAgICxjYXRjaEFuZERvTm90aGluZzogZnVuY3Rpb24oZSkge1xuICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgfVxuXG4gICAgLGRyb3A6IGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAgIGlmIChNT0R4LmNvbmZpZ1snbWFya2Rvd25lZGl0b3IudXBsb2FkLmVuYWJsZV9pbWFnZV91cGxvYWQnXSA9PSAxIHx8IE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci51cGxvYWQuZW5hYmxlX2ZpbGVfdXBsb2FkJ10gPT0gMSkge1xuICAgICAgICAgICAgdGhpcy5oYW5kbGVGaWxlcyhlLmRhdGFUcmFuc2Zlci5maWxlcyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAsaGFuZGxlRmlsZXM6IGZ1bmN0aW9uKGZpbGVzKSB7XG4gICAgICAgIEV4dC5lYWNoKGZpbGVzLCBmdW5jdGlvbihmaWxlKSB7XG4gICAgICAgICAgICB2YXIgaXNJbWFnZSA9IC9eaW1hZ2VcXC8vLnRlc3QoZmlsZS50eXBlKTtcblxuICAgICAgICAgICAgaWYgKGlzSW1hZ2UpIHtcbiAgICAgICAgICAgICAgICBpZiAoTU9EeC5jb25maWdbJ21hcmtkb3duZWRpdG9yLnVwbG9hZC5lbmFibGVfaW1hZ2VfdXBsb2FkJ10gPT0gMCkgcmV0dXJuIHRydWU7XG5cbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuY2hlY2tUeXBlKE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci51cGxvYWQuaW1hZ2VfdHlwZXMnXSwgZmlsZSkpe1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmZhaWxNZXNzYWdlKGZpbGUsICdpbWFnZScsIF8oJ21hcmtkb3duZWRpdG9yLmVyci51cGxvYWQudW5zdXBwb3J0ZWRfaW1hZ2UnKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGZpbGUuc2l6ZSA+IHBhcnNlSW50KE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci51cGxvYWQubWF4X3NpemUnXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5mYWlsTWVzc2FnZShmaWxlLCAnaW1hZ2UnLCBfKCdtYXJrZG93bmVkaXRvci5lcnIudXBsb2FkLnRvb19iaWcnKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci5jcm9wcGVyLmVuYWJsZV9jcm9wcGVyJ10gPT0gMSkge1xuICAgICAgICAgICAgICAgICAgICBNT0R4LmxvYWQoe1xuICAgICAgICAgICAgICAgICAgICAgICAgeHR5cGU6ICdtYXJrZG93bmVkaXRvci13aW5kb3ctY3JvcHBlcidcbiAgICAgICAgICAgICAgICAgICAgICAgICxmaWxlOiBmaWxlXG4gICAgICAgICAgICAgICAgICAgICAgICAsbWQ6IHRoaXNcbiAgICAgICAgICAgICAgICAgICAgfSkuc2hvdygpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXBsb2FkRmlsZShmaWxlLCAnaW1hZ2UnKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChNT0R4LmNvbmZpZ1snbWFya2Rvd25lZGl0b3IudXBsb2FkLmVuYWJsZV9maWxlX3VwbG9hZCddID09IDApIHJldHVybiB0cnVlO1xuXG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmNoZWNrVHlwZShNT0R4LmNvbmZpZ1snbWFya2Rvd25lZGl0b3IudXBsb2FkLmZpbGVfdHlwZXMnXSwgZmlsZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5mYWlsTWVzc2FnZShmaWxlLCAnZmlsZScsIF8oJ21hcmtkb3duZWRpdG9yLmVyci51cGxvYWQudW5zdXBwb3J0ZWRfZmlsZScpKTtcblxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoZmlsZS5zaXplID4gcGFyc2VJbnQoTU9EeC5jb25maWdbJ21hcmtkb3duZWRpdG9yLnVwbG9hZC5tYXhfc2l6ZSddKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmZhaWxNZXNzYWdlKGZpbGUsICdmaWxlJywgXygnbWFya2Rvd25lZGl0b3IuZXJyLnVwbG9hZC50b29fYmlnJykpO1xuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHRoaXMudXBsb2FkRmlsZShmaWxlLCAnZmlsZScpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgIH0sIHRoaXMpO1xuICAgIH1cblxuICAgICxjaGVja1R5cGU6IGZ1bmN0aW9uKGFsbG93ZWRUeXBlcywgZmlsZSkge1xuICAgICAgICBhbGxvd2VkVHlwZXMgPSBhbGxvd2VkVHlwZXMuc3BsaXQoJywnKTtcblxuICAgICAgICByZXR1cm4gYWxsb3dlZFR5cGVzLmluZGV4T2YoZmlsZS5uYW1lLnNwbGl0KCcuJykucG9wKCkpICE9IC0xO1xuICAgIH1cblxuICAgICx1cGxvYWRGaWxlOiBmdW5jdGlvbihmaWxlLCB0eXBlKSB7XG4gICAgICAgIGlmICghdHlwZSkgdHlwZSA9ICdmaWxlJztcblxuICAgICAgICB2YXIgdXBsb2FkZXIgPSB0aGlzLmNyZWF0ZVVwbG9hZGVyKCk7XG5cbiAgICAgICAgdmFyIGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnZmlsZScsIGZpbGUpO1xuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ2FjdGlvbicsICdtZ3IvZWRpdG9yLycgKyB0eXBlICsgJ3VwbG9hZCcpO1xuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ25hbWUnLCBmaWxlLm5hbWUpO1xuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ3Jlc291cmNlJywgdGhpcy5jb25maWcucmVzb3VyY2UpO1xuXG4gICAgICAgIHZhciB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgICAgICAgeGhyLm9wZW4oJ1BPU1QnLCBtYXJrZG93bkVkaXRvci5jb25maWcuY29ubmVjdG9yVXJsKTtcbiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ1Bvd2VyZWQtQnknLCAnTU9EeCcpO1xuICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignbW9kQXV0aCcsIEV4dC5BamF4LmRlZmF1bHRIZWFkZXJzLm1vZEF1dGgpO1xuXG4gICAgICAgIHhoci51cGxvYWQub25wcm9ncmVzcyA9IGZ1bmN0aW9uIChldmVudCkge1xuICAgICAgICAgICAgaWYgKGV2ZW50Lmxlbmd0aENvbXB1dGFibGUpIHtcbiAgICAgICAgICAgICAgICB2YXIgY29tcGxldGUgPSAoZXZlbnQubG9hZGVkIC8gZXZlbnQudG90YWwgKiAxMDAgfCAwKTtcbiAgICAgICAgICAgICAgICB1cGxvYWRlci5jaGlsZCgnLnByb2dyZXNzJykuc2V0V2lkdGgoY29tcGxldGUgKyAnJScpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LmJpbmQodGhpcyk7XG5cbiAgICAgICAgeGhyLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmICh4aHIuc3RhdHVzID09PSAyMDApIHtcbiAgICAgICAgICAgICAgICB2YXIgcmVzID0gSlNPTi5wYXJzZSh4aHIucmVzcG9uc2VUZXh0KTtcbiAgICAgICAgICAgICAgICBpZiAocmVzLnN1Y2Nlc3MgPT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgICAgICB1cGxvYWRlci5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGltYWdlUHJlZml4ID0gKHR5cGUgPT0gJ2ltYWdlJykgPyAnIScgOiAnJztcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lZGl0b3IuaW5zZXJ0KGltYWdlUHJlZml4ICsgJ1snICsgcmVzLm9iamVjdC5uYW1lICsgJ10oJyArIHJlcy5vYmplY3QucGF0aCArICcgXCInICsgcmVzLm9iamVjdC5uYW1lICsgJ1wiKVxcbicpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmFpbFVwbG9hZGVyKHVwbG9hZGVyLCByZXMubWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9LmJpbmQodGhpcyk7XG5cbiAgICAgICAgeGhyLnNlbmQoZm9ybURhdGEpO1xuICAgIH1cblxuICAgICxjcmVhdGVVcGxvYWRlcjogZnVuY3Rpb24odHlwZSwgZmlsZU5hbWUpIHtcbiAgICAgICAgdmFyIHVwbG9hZGVyID0gRXh0LkRvbUhlbHBlci5pbnNlcnRGaXJzdCh0aGlzLnN0YXR1c0Jhcix7XG4gICAgICAgICAgICB0YWc6ICdkaXYnLFxuICAgICAgICAgICAgaHRtbDogJzxkaXYgY2xhc3M9XCJwcm9ncmVzc1wiPjwvZGl2PjxpIGNsYXNzPVwiaWNvbiBpY29uLXNwaW5uZXIgaWNvbi1zcGluXCI+PC9pPiA8c3Bhbj4nICsgXygnbWFya2Rvd25lZGl0b3IudXBsb2FkaW5nXycgKyB0eXBlKSArIGZpbGVOYW1lICsgJzwvc3Bhbj4nXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBFeHQuZ2V0KHVwbG9hZGVyKTtcbiAgICB9XG5cbiAgICAsZmFpbFVwbG9hZGVyOiBmdW5jdGlvbih1cGxvYWRlciwgbWVzc2FnZSkge1xuICAgICAgICB1cGxvYWRlci5jaGlsZCgnLnByb2dyZXNzJykuYWRkQ2xhc3MoJ2Vycm9yJyk7XG4gICAgICAgIHVwbG9hZGVyLmNoaWxkKCcucHJvZ3Jlc3MnKS5zZXRXaWR0aCgnMTAwJScpO1xuXG4gICAgICAgIHVwbG9hZGVyLmNoaWxkKCdpJykuYWRkQ2xhc3MoJ3JlbW92ZS1tZXNzYWdlJyk7XG4gICAgICAgIHVwbG9hZGVyLmNoaWxkKCdpJykucmVwbGFjZUNsYXNzKCdpY29uLXNwaW5uZXInLCAnaWNvbi1yZW1vdmUnKTtcbiAgICAgICAgdXBsb2FkZXIuY2hpbGQoJ2knKS5yZW1vdmVDbGFzcygnaWNvbi1zcGluJyk7XG5cbiAgICAgICAgdXBsb2FkZXIuY2hpbGQoJ3NwYW4nKS5kb20uaW5uZXJIVE1MICs9ICcgZmFpbGVkLiAnICsgbWVzc2FnZTtcbiAgICAgICAgdXBsb2FkZXIuY2hpbGQoJy5yZW1vdmUtbWVzc2FnZScpLm9uKCdjbGljaycsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgdXBsb2FkZXIucmVtb3ZlKCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgICxmYWlsTWVzc2FnZTogZnVuY3Rpb24oZmlsZSwgdHlwZSwgbWVzc2FnZSkge1xuICAgICAgICB2YXIgdXBsb2FkZXIgPSB0aGlzLmNyZWF0ZVVwbG9hZGVyKHR5cGUsIGZpbGUubmFtZSk7XG4gICAgICAgIHRoaXMuZmFpbFVwbG9hZGVyKHVwbG9hZGVyLCBtZXNzYWdlKTtcbiAgICB9XG59KTtcblxuTU9EeC5sb2FkUlRFID0gZnVuY3Rpb24oaWQpIHtcbiAgICBuZXcgbWFya2Rvd25FZGl0b3IuRWRpdG9yKCk7XG59O1xuIiwibWFya2Rvd25FZGl0b3Iud2luZG93LkNyb3BwZXIgPSBmdW5jdGlvbihjb25maWcpIHtcbiAgICBjb25maWcgPSBjb25maWcgfHwge307XG4gICAgY29uZmlnLmNyb3BwZXJTZWxlY3RvciA9IGNvbmZpZy5jcm9wcGVyU2VsZWN0b3IgfHwgJy5pbWFnZS11cGxvYWQtd3JhcHBlciA+IGltZyc7XG5cbiAgICBFeHQuYXBwbHlJZihjb25maWcse1xuICAgICAgICBtb2RhbDogZmFsc2VcbiAgICAgICAgLGxheW91dDogJ2F1dG8nXG4gICAgICAgICxjbG9zZUFjdGlvbjogJ2hpZGUnXG4gICAgICAgICxzaGFkb3c6IHRydWVcbiAgICAgICAgLHJlc2l6YWJsZTogdHJ1ZVxuICAgICAgICAsY29sbGFwc2libGU6IHRydWVcbiAgICAgICAgLG1heGltaXphYmxlOiBmYWxzZVxuICAgICAgICAsYXV0b0hlaWdodDogZmFsc2VcbiAgICAgICAgLGF1dG9TY3JvbGw6IHRydWVcbiAgICAgICAgLGFsbG93RHJvcDogdHJ1ZVxuICAgICAgICAsd2lkdGg6IDgwMFxuICAgICAgICAsdGl0bGU6IF8oJ21hcmtkb3duZWRpdG9yLmNyb3BwZXIuY3JvcF9pbWFnZScpXG4gICAgICAgICxjbHM6ICdtb2R4LXdpbmRvdydcbiAgICAgICAgLGh0bWw6ICc8ZGl2IGNsYXNzPVwiaW1hZ2UtdXBsb2FkLXdyYXBwZXJcIj48aW1nIHNyYz1cIicgKyBVUkwuY3JlYXRlT2JqZWN0VVJMKGNvbmZpZy5maWxlKSArICdcIj48L2Rpdj4nXG4gICAgICAgICx0YmFyOiBbe1xuICAgICAgICAgICAgdGV4dDogJzxpIGNsYXNzPVwiaWNvbiBpY29uLWFycm93c1wiPjwvaT4gJyArIF8oJ21hcmtkb3duZWRpdG9yLmNyb3BwZXIubW92ZScpXG4gICAgICAgICAgICAsc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICxwYXJhbTogJ21vdmUnXG4gICAgICAgICAgICAsYWN0aW9uOiAnc2V0RHJhZ01vZGUnXG4gICAgICAgICAgICAsaGFuZGxlcjogdGhpcy5jYWxsQ3JvcHBlckFjdGlvblxuICAgICAgICB9LHtcbiAgICAgICAgICAgIHRleHQ6ICc8aSBjbGFzcz1cImljb24gaWNvbi1jcm9wXCI+PC9pPiAnICsgXygnbWFya2Rvd25lZGl0b3IuY3JvcHBlci5jcm9wJylcbiAgICAgICAgICAgICxzY29wZTogdGhpc1xuICAgICAgICAgICAgLHBhcmFtOiAnY3JvcCdcbiAgICAgICAgICAgICxhY3Rpb246ICdzZXREcmFnTW9kZSdcbiAgICAgICAgICAgICxoYW5kbGVyOiB0aGlzLmNhbGxDcm9wcGVyQWN0aW9uXG4gICAgICAgIH0se1xuICAgICAgICAgICAgdGV4dDogJzxpIGNsYXNzPVwiaWNvbiBpY29uLXNlYXJjaC1wbHVzXCI+PC9pPiAnICsgXygnbWFya2Rvd25lZGl0b3IuY3JvcHBlci56b29tX2luJylcbiAgICAgICAgICAgICxzY29wZTogdGhpc1xuICAgICAgICAgICAgLHBhcmFtOiAwLjFcbiAgICAgICAgICAgICxhY3Rpb246ICd6b29tJ1xuICAgICAgICAgICAgLGhhbmRsZXI6IHRoaXMuY2FsbENyb3BwZXJBY3Rpb25cbiAgICAgICAgfSx7XG4gICAgICAgICAgICB0ZXh0OiAnPGkgY2xhc3M9XCJpY29uIGljb24tc2VhcmNoLW1pbnVzXCI+PC9pPiAnICsgXygnbWFya2Rvd25lZGl0b3IuY3JvcHBlci56b29tX291dCcpXG4gICAgICAgICAgICAsc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICxwYXJhbTogLTAuMVxuICAgICAgICAgICAgLGFjdGlvbjogJ3pvb20nXG4gICAgICAgICAgICAsaGFuZGxlcjogdGhpcy5jYWxsQ3JvcHBlckFjdGlvblxuICAgICAgICB9LHtcbiAgICAgICAgICAgIHRleHQ6ICc8aSBjbGFzcz1cImljb24gaWNvbi1yb3RhdGUtbGVmdFwiPjwvaT4gJyArIF8oJ21hcmtkb3duZWRpdG9yLmNyb3BwZXIucm90YXRlX2xlZnQnKVxuICAgICAgICAgICAgLHNjb3BlOiB0aGlzXG4gICAgICAgICAgICAscGFyYW06IC05MFxuICAgICAgICAgICAgLGFjdGlvbjogJ3JvdGF0ZSdcbiAgICAgICAgICAgICxoYW5kbGVyOiB0aGlzLmNhbGxDcm9wcGVyQWN0aW9uXG4gICAgICAgIH0se1xuICAgICAgICAgICAgdGV4dDogJzxpIGNsYXNzPVwiaWNvbiBpY29uLXJvdGF0ZS1yaWdodFwiPjwvaT4gJyArIF8oJ21hcmtkb3duZWRpdG9yLmNyb3BwZXIucm90YXRlX3JpZ2h0JylcbiAgICAgICAgICAgICxzY29wZTogdGhpc1xuICAgICAgICAgICAgLHBhcmFtOiA5MFxuICAgICAgICAgICAgLGFjdGlvbjogJ3JvdGF0ZSdcbiAgICAgICAgICAgICxoYW5kbGVyOiB0aGlzLmNhbGxDcm9wcGVyQWN0aW9uXG4gICAgICAgIH0se1xuICAgICAgICAgICAgdGV4dDogJzxpIGNsYXNzPVwiaWNvbiBpY29uLXJlbW92ZVwiPjwvaT4gJyArIF8oJ21hcmtkb3duZWRpdG9yLmNyb3BwZXIuY2xlYXJfY3JvcHBlcicpXG4gICAgICAgICAgICAsc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICxwYXJhbTogbnVsbFxuICAgICAgICAgICAgLGFjdGlvbjogJ2NsZWFyJ1xuICAgICAgICAgICAgLGhhbmRsZXI6IHRoaXMuY2FsbENyb3BwZXJBY3Rpb25cbiAgICAgICAgfV1cbiAgICAgICAgLGJ1dHRvbnM6IFt7XG4gICAgICAgICAgICB0ZXh0OiBfKCdjYW5jZWwnKVxuICAgICAgICAgICAgLHNjb3BlOiB0aGlzXG4gICAgICAgICAgICAsaGFuZGxlcjogdGhpcy5jbG9zZVxuICAgICAgICB9LHtcbiAgICAgICAgICAgIHRleHQ6IF8oJ21hcmtkb3duZWRpdG9yLmNyb3BwZXIudXBsb2FkJylcbiAgICAgICAgICAgICxjbHM6ICdwcmltYXJ5LWJ1dHRvbidcbiAgICAgICAgICAgICxzY29wZTogdGhpc1xuICAgICAgICAgICAgLGNyb3A6IDBcbiAgICAgICAgICAgICxoYW5kbGVyOiB0aGlzLnVwbG9hZFxuICAgICAgICB9LHtcbiAgICAgICAgICAgIHRleHQ6IF8oJ21hcmtkb3duZWRpdG9yLmNyb3BwZXIuY3JvcF91cGxvYWQnKVxuICAgICAgICAgICAgLGNsczogJ3ByaW1hcnktYnV0dG9uJ1xuICAgICAgICAgICAgLHNjb3BlOiB0aGlzXG4gICAgICAgICAgICAsY3JvcDogMVxuICAgICAgICAgICAgLGhhbmRsZXI6IHRoaXMudXBsb2FkXG4gICAgICAgIH1dXG4gICAgICAgICxsaXN0ZW5lcnM6IHtcbiAgICAgICAgICAgICdzaG93Jzoge1xuICAgICAgICAgICAgICAgIGZuOiBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNyb3BwZXJPcHRpb25zID0ge307XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuJGNyb3BwZXJFbCA9ICQoJyMnICsgdGhpcy5pZCArICcgJyArIGNvbmZpZy5jcm9wcGVyU2VsZWN0b3IpO1xuXG4gICAgICAgICAgICAgICAgICAgIHZhciByYXRpbyA9IE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci5jcm9wcGVyLmFzcGVjdF9yYXRpbyddO1xuICAgICAgICAgICAgICAgICAgICBpZiAocmF0aW8pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhdGlvLnJlcGxhY2UoL1teLTp4KClcXGQvKisuXS9nLCAnJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICByYXRpbyA9IGV2YWwocmF0aW8pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICBjcm9wcGVyT3B0aW9ucy5hc3BlY3RSYXRpbyA9IHJhdGlvO1xuICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgY3JvcHBlck9wdGlvbnMuY3JvcCA9IGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmltYWdlRGF0YSA9IFtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAne1wieFwiOicgKyBkYXRhLngsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ1wieVwiOicgKyBkYXRhLnksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ1wiaGVpZ2h0XCI6JyArIGRhdGEuaGVpZ2h0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdcIndpZHRoXCI6JyArIGRhdGEud2lkdGgsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ1wicm90YXRlXCI6JyArIGRhdGEucm90YXRlICsgJ30nXG4gICAgICAgICAgICAgICAgICAgICAgICBdLmpvaW4oKTtcbiAgICAgICAgICAgICAgICAgICAgfS5iaW5kKHRoaXMpO1xuXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuJGNyb3BwZXJFbC5jcm9wcGVyKGNyb3BwZXJPcHRpb25zKTtcbiAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICBtYXJrZG93bkVkaXRvci53aW5kb3cuQ3JvcHBlci5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcyxjb25maWcpO1xuICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuXG59O1xuRXh0LmV4dGVuZChtYXJrZG93bkVkaXRvci53aW5kb3cuQ3JvcHBlciwgRXh0LldpbmRvdyx7XG4gICAgaW1hZ2VEYXRhOiAnJ1xuICAgICx1cGxvYWQ6IGZ1bmN0aW9uKGJ1dHRvbikge1xuICAgICAgICB2YXIgdXBsb2FkZXIgPSB0aGlzLmNvbmZpZy5tZC5jcmVhdGVVcGxvYWRlcignaW1hZ2UnLCB0aGlzLmNvbmZpZy5maWxlLm5hbWUpO1xuXG4gICAgICAgIHZhciBmb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSgpO1xuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ2ZpbGUnLCB0aGlzLmNvbmZpZy5maWxlKTtcbiAgICAgICAgZm9ybURhdGEuYXBwZW5kKCdhY3Rpb24nLCAnbWdyL2VkaXRvci9pbWFnZXVwbG9hZCcpO1xuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ2ltYWdlRGF0YScsIHRoaXMuaW1hZ2VEYXRhKTtcbiAgICAgICAgZm9ybURhdGEuYXBwZW5kKCduYW1lJywgdGhpcy5jb25maWcuZmlsZS5uYW1lKTtcbiAgICAgICAgZm9ybURhdGEuYXBwZW5kKCdjcm9wJywgYnV0dG9uLmNyb3ApO1xuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ3Jlc291cmNlJywgdGhpcy5jb25maWcubWQuY29uZmlnLnJlc291cmNlKTtcblxuICAgICAgICB2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG4gICAgICAgIHhoci5vcGVuKCdQT1NUJywgbWFya2Rvd25FZGl0b3IuY29uZmlnLmNvbm5lY3RvclVybCk7XG4gICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdQb3dlcmVkLUJ5JywgJ01PRHgnKTtcbiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ21vZEF1dGgnLCBFeHQuQWpheC5kZWZhdWx0SGVhZGVycy5tb2RBdXRoKTtcblxuICAgICAgICB4aHIudXBsb2FkLm9ucHJvZ3Jlc3MgPSBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgICAgICAgIGlmIChldmVudC5sZW5ndGhDb21wdXRhYmxlKSB7XG4gICAgICAgICAgICAgICAgdmFyIGNvbXBsZXRlID0gKGV2ZW50LmxvYWRlZCAvIGV2ZW50LnRvdGFsICogMTAwIHwgMCk7XG4gICAgICAgICAgICAgICAgdXBsb2FkZXIuY2hpbGQoJy5wcm9ncmVzcycpLnNldFdpZHRoKGNvbXBsZXRlICsgJyUnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfS5iaW5kKHRoaXMpO1xuXG4gICAgICAgIHhoci5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZiAoeGhyLnN0YXR1cyA9PT0gMjAwKSB7XG4gICAgICAgICAgICAgICAgdmFyIHJlcyA9IEpTT04ucGFyc2UoeGhyLnJlc3BvbnNlVGV4dCk7XG5cbiAgICAgICAgICAgICAgICBpZiAocmVzLnN1Y2Nlc3MgPT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgICAgICB1cGxvYWRlci5yZW1vdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb25maWcubWQuZWRpdG9yLmluc2VydCgnIVsnICsgcmVzLm9iamVjdC5uYW1lICsgJ10oJyArIHJlcy5vYmplY3QucGF0aCArICcgXCInICsgcmVzLm9iamVjdC5uYW1lICsgJ1wiKVxcbicpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29uZmlnLm1kLmZhaWxVcGxvYWRlcih1cGxvYWRlciwgcmVzLm1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfS5iaW5kKHRoaXMpO1xuXG4gICAgICAgIHhoci5zZW5kKGZvcm1EYXRhKTtcblxuICAgICAgICB0aGlzLmNsb3NlKCk7XG4gICAgfVxuXG4gICAgLGNhbGxDcm9wcGVyQWN0aW9uOiBmdW5jdGlvbihidG4pIHtcbiAgICAgICAgdGhpcy4kY3JvcHBlckVsLmNyb3BwZXIoYnRuLmFjdGlvbiwgYnRuLnBhcmFtKTtcbiAgICB9XG5cbiAgICAsY2xvc2U6IGZ1bmN0aW9uKCkge1xuICAgICAgICB0aGlzLiRjcm9wcGVyRWwuY3JvcHBlcihcImRlc3Ryb3lcIik7XG5cbiAgICAgICAgbWFya2Rvd25FZGl0b3Iud2luZG93LkNyb3BwZXIuc3VwZXJjbGFzcy5jbG9zZS5jYWxsKHRoaXMpO1xuICAgIH1cbn0pO1xuRXh0LnJlZygnbWFya2Rvd25lZGl0b3Itd2luZG93LWNyb3BwZXInLG1hcmtkb3duRWRpdG9yLndpbmRvdy5Dcm9wcGVyKTtcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==