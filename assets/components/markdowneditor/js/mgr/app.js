Ext.ns("MarkdownEditor"),MarkdownEditor=function(e){e=e||{},MarkdownEditor.superclass.constructor.call(this,e)},Ext.extend(MarkdownEditor,Ext.Component,{window:{},config:{}}),Ext.reg("markdowneditor",MarkdownEditor),markdownEditor=new MarkdownEditor,markdownEditor.Editor=function(e){e=e||{},e.resource=MODx.request.id||0,markdownEditor.Editor.superclass.constructor.call(this,e),this.config=e},Ext.extend(markdownEditor.Editor,Ext.Component,{remarkable:"",fullScreen:!1,initComponent:function(){MarkdownEditor.superclass.initComponent.call(this),Ext.onReady(this.render,this)},render:function(){this.textarea=Ext.get("ta"),this.buildUI(),this.registerAce(),this.registerMarked();var e=this.toolBox.child(".preview-button"),t=this.toolBox.child(".fullscreen-button"),i=this.contentMD,o=i.parent(),r=MODx.load({xtype:"modx-treedrop",target:i,targetEl:i,onInsert:function(e){return this.insert(e),this.focus(),!0}.bind(this.editor),iframe:!0});this.textarea.on("destroy",function(){r.destroy()}),e.addListener("click",function(){this.preview.isVisible()?(this.preview.setDisplayed("none"),i.setDisplayed("block"),this.statusBar.setDisplayed("block"),this.editor.focus(),e.child("i").removeClass("icon-toggle-on"),e.child("i").addClass("icon-toggle-off")):(this.preview.setDisplayed("block"),i.setDisplayed("none"),this.statusBar.setDisplayed("none"),e.child("i").removeClass("icon-toggle-off"),e.child("i").addClass("icon-toggle-on"))},this),t.addListener("click",function(){var r=t.child("i");0==this.fullScreen?(this.fullScreen=!0,r.removeClass("icon-expand"),r.addClass("icon-compress"),this.preview.setDisplayed("block"),i.setDisplayed("block"),this.editor.focus(),e.hide(),o.addClass("fullscreen"),this.editor.setOption("maxLines",null)):(this.fullScreen=!1,r.addClass("icon-expand"),r.removeClass("icon-compress"),this.preview.setDisplayed("none"),i.setDisplayed("block"),this.editor.focus(),e.show(),o.removeClass("fullscreen"),this.editor.setOption("maxLines",1/0)),this.statusBar.setDisplayed("block"),this.editor.resize(!0)},this),markdownEditor.content.content&&this.editor.setValue(markdownEditor.content.content),this.editor.selection.clearSelection(),this.preview.update(this.parse(this.editor.getValue())),this.editor.getSession().on("change",function(){this.parse(this.editor.getValue())}.bind(this))},buildUI:function(){this.textarea.setDisplayed("none"),this.textarea.setWidth(0),this.textarea.setHeight(0),this.taMarkdown=Ext.get(Ext.DomHelper.insertBefore(this.textarea,{tag:"textarea",name:"ta_markdown","class":"ta_markdown"})),this.taMarkdown.setDisplayed("none"),this.taMarkdown.setWidth(0),this.taMarkdown.setHeight(0);var e=Ext.DomHelper.insertBefore(this.textarea,{tag:"div","class":"markdown-container"});this.contentMD=Ext.get(Ext.DomHelper.append(e,{tag:"div","class":this.textarea.dom.className+" content-md"})),this.preview=Ext.get(Ext.DomHelper.append(e,{tag:"div","class":"markdown-body preview-md"})),this.toolBox=Ext.get(Ext.DomHelper.append(e,{tag:"div","class":"toolbox",cn:[{tag:"span","class":"preview-button",html:'<i class="icon icon-toggle-off"></i> '+_("markdowneditor.toolbox.preview")},{tag:"span","class":"fullscreen-button",html:'<i class="icon icon-expand"></i>'}]})),1==MODx.config["markdowneditor.upload.enable_image_upload"]||1==MODx.config["markdowneditor.upload.enable_file_upload"]?(this.statusBar=Ext.get(Ext.DomHelper.append(e,{tag:"div","class":"status-bar"})),this.statusBar.dom.innerHTML='<div class="upload-bar"> <input class="hidden" name="file" id="'+this.statusBar.id+'-file" type="file" multiple>'+_("markdowneditor.status_bar_message",{id:this.statusBar.id+"-file"})+"</div>",this.statusBar.child("input").on("change",function(e,t){this.handleFiles(t.files),t.value=""},this)):this.statusBar=Ext.get(Ext.DomHelper.append(e,{tag:"div","class":"status-bar",html:_("markdowneditor.status_bar_disabled")})),Ext.DomHelper.append(e,{tag:"span",style:"clear: both"})},registerAce:function(){this.editor=ace.edit(Ext.DomQuery.selectNode("div.content-md")),this.editor.setOptions({maxLines:1/0,minLines:25,enableBasicAutocompletion:!0}),this.editor.renderer.setShowGutter(!0),this.editor.renderer.setScrollMargin(10,10),this.editor.getSession().setValue(this.textarea.getValue()),this.editor.getSession().setMode("ace/mode/markdown"),this.editor.setTheme("ace/theme/"+(MODx.config["markdowneditor.general.theme"]||"monokai"));var e=ace.require("ace/ext/language_tools"),t={getCompletions:function(e,t,i,o,r){return 0===o.length?(r(null,[]),void 0):(MODx.Ajax.request({url:markdownEditor.config.connectorUrl,params:{action:"mgr/resource/getlist",prefix:o},listeners:{success:{fn:function(e){r(null,e.results)},scope:this}}}),void 0)}};e.addCompleter(t),this.editor.container.addEventListener("dragenter",this.catchAndDoNothing,!1),this.editor.container.addEventListener("dragover",this.catchAndDoNothing,!1),this.editor.container.addEventListener("drop",this.drop.bind(this),!1)},registerMarked:function(){this.remarkable=new Remarkable({html:!0,highlight:function(e,t){if(t&&hljs.getLanguage(t))try{return hljs.highlight(t,e).value}catch(i){}try{return hljs.highlightAuto(e).value}catch(i){}return""}}),this.remarkable.inline.ruler.disable(["backticks"])},parse:function(e){var t=this.remarkable.render(e);t=t.replace(/%5B/g,"["),t=t.replace(/%5D/g,"]");var i=t.match(/<code(.|\s)*<\/code>/g);if(Ext.each(i,function(e){var i=e.replace(/\[\[/g,"&#91;&#91;");i=i.replace(/]]/g,"&#93;&#93;"),t=t.replace(e,i)}),1==MODx.config["markdowneditor.lp.parse_modx_tags"]){this.parseRequest&&clearTimeout(this.parseRequest);var o=parseInt(MODx.config["markdowneditor.lp.parse_modx_tags_timeout"]||300);this.parseRequest=setTimeout(function(){MODx.Ajax.request({url:markdownEditor.config.connectorUrl,params:{action:"mgr/editor/processcontent",content:t,resource:MODx.request.id},isUpload:!0,listeners:{success:{fn:function(e){this.preview.update(e.data),1==this.fullScreen&&this.editor.getCursorPosition().row+2>=this.editor.getSession().getScreenLength()&&(this.preview.dom.scrollTop=this.preview.dom.scrollHeight)},scope:this}}})}.bind(this),o)}else this.preview.update(t),1==this.fullScreen&&this.editor.getCursorPosition().row+2>=this.editor.getSession().getScreenLength()&&(this.preview.dom.scrollTop=this.preview.dom.scrollHeight);return this.taMarkdown.dom.value=this.editor.getValue(),this.textarea.dom.value=t,t},catchAndDoNothing:function(e){e.stopPropagation(),e.preventDefault()},drop:function(e){e.stopPropagation(),e.preventDefault(),(1==MODx.config["markdowneditor.upload.enable_image_upload"]||1==MODx.config["markdowneditor.upload.enable_file_upload"])&&this.handleFiles(e.dataTransfer.files)},handleFiles:function(e){Ext.each(e,function(e){var t=/^image\//.test(e.type);if(t){if(0==MODx.config["markdowneditor.upload.enable_image_upload"])return!0;if(!this.checkType(MODx.config["markdowneditor.upload.image_types"],e))return this.failMessage(e,"image",_("markdowneditor.err.upload.unsupported_image")),!0;if(e.size>parseInt(MODx.config["markdowneditor.upload.max_size"]))return this.failMessage(e,"image",_("markdowneditor.err.upload.too_big")),!0;1==MODx.config["markdowneditor.cropper.enable_cropper"]?MODx.load({xtype:"markdowneditor-window-cropper",file:e,md:this}).show():(this.uploadFile(e,"image"),this.editor.focus())}else{if(0==MODx.config["markdowneditor.upload.enable_file_upload"])return!0;if(!this.checkType(MODx.config["markdowneditor.upload.file_types"],e))return this.failMessage(e,"file",_("markdowneditor.err.upload.unsupported_file")),!0;if(e.size>parseInt(MODx.config["markdowneditor.upload.max_size"]))return this.failMessage(e,"file",_("markdowneditor.err.upload.too_big")),!0;this.uploadFile(e,"file"),this.editor.focus()}},this)},checkType:function(e,t){return e=e.split(","),-1!=e.indexOf(t.name.split(".").pop())},uploadFile:function(e,t){t||(t="file");var i=this.createUploader(),o=new FormData;o.append("file",e),o.append("action","mgr/editor/"+t+"upload"),o.append("name",e.name),o.append("resource",this.config.resource);var r=new XMLHttpRequest;r.open("POST",markdownEditor.config.connectorUrl),r.setRequestHeader("Powered-By","MODx"),r.setRequestHeader("modAuth",Ext.Ajax.defaultHeaders.modAuth),r.upload.onprogress=function(e){if(e.lengthComputable){var t=e.loaded/e.total*100|0;i.child(".progress").setWidth(t+"%")}}.bind(this),r.onload=function(){if(200===r.status){var e=JSON.parse(r.responseText);if(1==e.success){i.remove();var o="image"==t?"!":"",a="image"==t?"\n\n":"\n";this.editor.insert(o+"["+e.object.name+"]("+e.object.path+' "'+e.object.name+'")'+a)}else this.failUploader(i,e.message)}}.bind(this),r.send(o)},createUploader:function(e,t){var i=Ext.DomHelper.insertFirst(this.statusBar,{tag:"div",html:'<div class="progress"><i class="icon icon-spinner icon-spin"></i> <span>'+_("markdowneditor.uploading_"+e)+t+"</span></div>"});return Ext.get(i)},failUploader:function(e,t){e.child(".progress").addClass("error"),e.child(".progress").setWidth("100%"),e.child("i").addClass("remove-message"),e.child("i").replaceClass("icon-spinner","icon-remove"),e.child("i").removeClass("icon-spin"),e.child("span").dom.innerHTML+=" failed. "+t,e.child(".remove-message").on("click",function(){e.remove()})},failMessage:function(e,t,i){var o=this.createUploader(t,e.name);this.failUploader(o,i)}}),MODx.loadRTE=function(){new markdownEditor.Editor},markdownEditor.window.Cropper=function(config){config=config||{},config.cropperSelector=config.cropperSelector||".image-upload-wrapper > img",Ext.applyIf(config,{modal:!1,layout:"auto",closeAction:"hide",shadow:!0,resizable:!0,collapsible:!0,maximizable:!1,autoHeight:!1,autoScroll:!0,allowDrop:!0,width:800,title:_("markdowneditor.cropper.crop_image"),cls:"modx-window",html:'<div class="image-upload-wrapper"><img src="'+URL.createObjectURL(config.file)+'"></div>',tbar:[{text:'<i class="icon icon-arrows"></i> '+_("markdowneditor.cropper.move"),scope:this,param:"move",action:"setDragMode",handler:this.callCropperAction},{text:'<i class="icon icon-crop"></i> '+_("markdowneditor.cropper.crop"),scope:this,param:"crop",action:"setDragMode",handler:this.callCropperAction},{text:'<i class="icon icon-search-plus"></i> '+_("markdowneditor.cropper.zoom_in"),scope:this,param:.1,action:"zoom",handler:this.callCropperAction},{text:'<i class="icon icon-search-minus"></i> '+_("markdowneditor.cropper.zoom_out"),scope:this,param:-.1,action:"zoom",handler:this.callCropperAction},{text:'<i class="icon icon-rotate-left"></i> '+_("markdowneditor.cropper.rotate_left"),scope:this,param:-90,action:"rotate",handler:this.callCropperAction},{text:'<i class="icon icon-rotate-right"></i> '+_("markdowneditor.cropper.rotate_right"),scope:this,param:90,action:"rotate",handler:this.callCropperAction},{text:'<i class="icon icon-remove"></i> '+_("markdowneditor.cropper.clear_cropper"),scope:this,param:null,action:"clear",handler:this.callCropperAction}],buttons:[{text:_("cancel"),scope:this,handler:this.close},{text:_("markdowneditor.cropper.upload"),cls:"primary-button",scope:this,crop:0,handler:this.upload},{text:_("markdowneditor.cropper.crop_upload"),cls:"primary-button",scope:this,crop:1,handler:this.upload}],listeners:{show:{fn:function(){var cropperOptions={};this.$cropperEl=$("#"+this.id+" "+config.cropperSelector);var ratio=MODx.config["markdowneditor.cropper.aspect_ratio"];ratio&&(ratio.replace(/[^-:x()\d/*+.]/g,""),ratio=eval(ratio),cropperOptions.aspectRatio=ratio),cropperOptions.crop=function(e){this.imageData=['{"x":'+e.x,'"y":'+e.y,'"height":'+e.height,'"width":'+e.width,'"rotate":'+e.rotate+"}"].join()}.bind(this),this.$cropperEl.cropper(cropperOptions)},scope:this}}}),markdownEditor.window.Cropper.superclass.constructor.call(this,config),this.config=config},Ext.extend(markdownEditor.window.Cropper,Ext.Window,{imageData:"",upload:function(e){var t=this.config.md.createUploader("image",this.config.file.name),i=new FormData;i.append("file",this.config.file),i.append("action","mgr/editor/imageupload"),i.append("imageData",this.imageData),i.append("name",this.config.file.name),i.append("crop",e.crop),i.append("resource",this.config.md.config.resource);var o=new XMLHttpRequest;o.open("POST",markdownEditor.config.connectorUrl),o.setRequestHeader("Powered-By","MODx"),o.setRequestHeader("modAuth",Ext.Ajax.defaultHeaders.modAuth),o.upload.onprogress=function(e){if(e.lengthComputable){var i=e.loaded/e.total*100|0;t.child(".progress").setWidth(i+"%")}}.bind(this),o.onload=function(){if(200===o.status){var e=JSON.parse(o.responseText);1==e.success?(t.remove(),this.config.md.editor.insert("!["+e.object.name+"]("+e.object.path+' "'+e.object.name+'")\n\n')):this.config.md.failUploader(t,e.message)}}.bind(this),o.send(i),this.close()},callCropperAction:function(e){this.$cropperEl.cropper(e.action,e.param)},close:function(){this.$cropperEl.cropper("destroy"),markdownEditor.window.Cropper.superclass.close.call(this),this.config.md.editor.focus()}}),Ext.reg("markdowneditor-window-cropper",markdownEditor.window.Cropper);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsIm1hcmtkb3duZWRpdG9yLndpbmRvdy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxJQUFBLEdBQUEsa0JBQ0EsZUFBQSxTQUFBLEdBQ0EsRUFBQSxNQUNBLGVBQUEsV0FBQSxZQUFBLEtBQUEsS0FBQSxJQUVBLElBQUEsT0FBQSxlQUFBLElBQUEsV0FDQSxVQUFBLFlBRUEsSUFBQSxJQUFBLGlCQUFBLGdCQUNBLGVBQUEsR0FBQSxnQkFFQSxlQUFBLE9BQUEsU0FBQSxHQUNBLEVBQUEsTUFDQSxFQUFBLFNBQUEsS0FBQSxRQUFBLElBQUEsRUFDQSxlQUFBLE9BQUEsV0FBQSxZQUFBLEtBQUEsS0FBQSxHQUNBLEtBQUEsT0FBQSxHQUVBLElBQUEsT0FBQSxlQUFBLE9BQUEsSUFBQSxXQUNBLFdBQUEsR0FDQSxZQUFBLEVBQ0EsY0FBQSxXQUNBLGVBQUEsV0FBQSxjQUFBLEtBQUEsTUFFQSxJQUFBLFFBQUEsS0FBQSxPQUFBLE9BR0EsT0FBQSxXQUNBLEtBQUEsU0FBQSxJQUFBLElBQUEsTUFFQSxLQUFBLFVBQ0EsS0FBQSxjQUNBLEtBQUEsZ0JBRUEsSUFBQSxHQUFBLEtBQUEsUUFBQSxNQUFBLG1CQUNBLEVBQUEsS0FBQSxRQUFBLE1BQUEsc0JBQ0EsRUFBQSxLQUFBLFVBQ0EsRUFBQSxFQUFBLFNBRUEsRUFBQSxLQUFBLE1BQ0EsTUFBQSxnQkFDQSxPQUFBLEVBQ0EsU0FBQSxFQUNBLFNBQUEsU0FBQSxHQUdBLE1BRkEsTUFBQSxPQUFBLEdBQ0EsS0FBQSxTQUNBLEdBQ0EsS0FBQSxLQUFBLFFBQ0EsUUFBQSxHQUVBLE1BQUEsU0FBQSxHQUFBLFVBQUEsV0FBQSxFQUFBLFlBRUEsRUFBQSxZQUFBLFFBQUEsV0FDQSxLQUFBLFFBQUEsYUFDQSxLQUFBLFFBQUEsYUFBQSxRQUNBLEVBQUEsYUFBQSxTQUNBLEtBQUEsVUFBQSxhQUFBLFNBRUEsS0FBQSxPQUFBLFFBRUEsRUFBQSxNQUFBLEtBQUEsWUFBQSxrQkFDQSxFQUFBLE1BQUEsS0FBQSxTQUFBLHFCQUVBLEtBQUEsUUFBQSxhQUFBLFNBQ0EsRUFBQSxhQUFBLFFBQ0EsS0FBQSxVQUFBLGFBQUEsUUFFQSxFQUFBLE1BQUEsS0FBQSxZQUFBLG1CQUNBLEVBQUEsTUFBQSxLQUFBLFNBQUEsb0JBRUEsTUFFQSxFQUFBLFlBQUEsUUFBQSxXQUNBLEdBQUEsR0FBQSxFQUFBLE1BQUEsSUFFQSxJQUFBLEtBQUEsWUFDQSxLQUFBLFlBQUEsRUFDQSxFQUFBLFlBQUEsZUFDQSxFQUFBLFNBQUEsaUJBRUEsS0FBQSxRQUFBLGFBQUEsU0FDQSxFQUFBLGFBQUEsU0FFQSxLQUFBLE9BQUEsUUFFQSxFQUFBLE9BRUEsRUFBQSxTQUFBLGNBRUEsS0FBQSxPQUFBLFVBQUEsV0FBQSxRQUdBLEtBQUEsWUFBQSxFQUNBLEVBQUEsU0FBQSxlQUNBLEVBQUEsWUFBQSxpQkFFQSxLQUFBLFFBQUEsYUFBQSxRQUNBLEVBQUEsYUFBQSxTQUVBLEtBQUEsT0FBQSxRQUVBLEVBQUEsT0FFQSxFQUFBLFlBQUEsY0FFQSxLQUFBLE9BQUEsVUFBQSxXQUFBLE1BR0EsS0FBQSxVQUFBLGFBQUEsU0FFQSxLQUFBLE9BQUEsUUFBQSxJQUNBLE1BRUEsZUFBQSxRQUFBLFNBQ0EsS0FBQSxPQUFBLFNBQUEsZUFBQSxRQUFBLFNBRUEsS0FBQSxPQUFBLFVBQUEsaUJBRUEsS0FBQSxRQUFBLE9BQUEsS0FBQSxNQUFBLEtBQUEsT0FBQSxhQUVBLEtBQUEsT0FBQSxhQUFBLEdBQUEsU0FBQSxXQUNBLEtBQUEsTUFBQSxLQUFBLE9BQUEsYUFDQSxLQUFBLFFBR0EsUUFBQSxXQUNBLEtBQUEsU0FBQSxhQUFBLFFBQ0EsS0FBQSxTQUFBLFNBQUEsR0FDQSxLQUFBLFNBQUEsVUFBQSxHQUVBLEtBQUEsV0FBQSxJQUFBLElBQUEsSUFBQSxVQUFBLGFBQUEsS0FBQSxVQUNBLElBQUEsV0FDQSxLQUFBLGNBQ0EsUUFBQSxpQkFHQSxLQUFBLFdBQUEsYUFBQSxRQUNBLEtBQUEsV0FBQSxTQUFBLEdBQ0EsS0FBQSxXQUFBLFVBQUEsRUFFQSxJQUFBLEdBQUEsSUFBQSxVQUFBLGFBQUEsS0FBQSxVQUNBLElBQUEsTUFDQSxRQUFBLHNCQUdBLE1BQUEsVUFBQSxJQUFBLElBQUEsSUFBQSxVQUFBLE9BQUEsR0FDQSxJQUFBLE1BQ0EsUUFBQSxLQUFBLFNBQUEsSUFBQSxVQUFBLGlCQUdBLEtBQUEsUUFBQSxJQUFBLElBQUEsSUFBQSxVQUFBLE9BQUEsR0FDQSxJQUFBLE1BQ0EsUUFBQSw4QkFHQSxLQUFBLFFBQUEsSUFBQSxJQUFBLElBQUEsVUFBQSxPQUFBLEdBQ0EsSUFBQSxNQUNBLFFBQUEsVUFDQSxLQUNBLElBQUEsT0FDQSxRQUFBLGlCQUNBLEtBQUEsd0NBQUEsRUFBQSxvQ0FFQSxJQUFBLE9BQ0EsUUFBQSxvQkFDQSxLQUFBLHdDQUlBLEdBQUEsS0FBQSxPQUFBLDhDQUFBLEdBQUEsS0FBQSxPQUFBLDZDQUNBLEtBQUEsVUFBQSxJQUFBLElBQUEsSUFBQSxVQUFBLE9BQUEsR0FDQSxJQUFBLE1BQ0EsUUFBQSxnQkFHQSxLQUFBLFVBQUEsSUFBQSxVQUFBLGtFQUFBLEtBQUEsVUFBQSxHQUFBLCtCQUFBLEVBQUEscUNBQUEsR0FBQSxLQUFBLFVBQUEsR0FBQSxVQUFBLFNBRUEsS0FBQSxVQUFBLE1BQUEsU0FBQSxHQUFBLFNBQUEsU0FBQSxFQUFBLEdBQ0EsS0FBQSxZQUFBLEVBQUEsT0FDQSxFQUFBLE1BQUEsSUFDQSxPQUVBLEtBQUEsVUFBQSxJQUFBLElBQUEsSUFBQSxVQUFBLE9BQUEsR0FDQSxJQUFBLE1BQ0EsUUFBQSxhQUNBLEtBQUEsRUFBQSx5Q0FJQSxJQUFBLFVBQUEsT0FBQSxHQUNBLElBQUEsT0FDQSxNQUFBLGlCQUlBLFlBQUEsV0FDQSxLQUFBLE9BQUEsSUFBQSxLQUFBLElBQUEsU0FBQSxXQUFBLG1CQUNBLEtBQUEsT0FBQSxZQUNBLFNBQUEsSUFDQSxTQUFBLEdBQ0EsMkJBQUEsSUFFQSxLQUFBLE9BQUEsU0FBQSxlQUFBLEdBQ0EsS0FBQSxPQUFBLFNBQUEsZ0JBQUEsR0FBQSxJQUNBLEtBQUEsT0FBQSxhQUFBLFNBQUEsS0FBQSxTQUFBLFlBQ0EsS0FBQSxPQUFBLGFBQUEsUUFBQSxxQkFDQSxLQUFBLE9BQUEsU0FBQSxjQUFBLEtBQUEsT0FBQSxpQ0FBQSxXQUVBLElBQUEsR0FBQSxJQUFBLFFBQUEsMEJBQ0EsR0FDQSxlQUFBLFNBQUEsRUFBQSxFQUFBLEVBQUEsRUFBQSxHQUNBLE1BQUEsS0FBQSxFQUFBLFFBQUEsRUFBQSxTQUFBLFNBRUEsS0FBQSxLQUFBLFNBQ0EsSUFBQSxlQUFBLE9BQUEsYUFDQSxRQUNBLE9BQUEsdUJBQ0EsT0FBQSxHQUVBLFdBQ0EsU0FDQSxHQUFBLFNBQUEsR0FDQSxFQUFBLEtBQUEsRUFBQSxVQUVBLE1BQUEsU0FYQSxTQWtCQSxHQUFBLGFBQUEsR0FHQSxLQUFBLE9BQUEsVUFBQSxpQkFBQSxZQUFBLEtBQUEsbUJBQUEsR0FDQSxLQUFBLE9BQUEsVUFBQSxpQkFBQSxXQUFBLEtBQUEsbUJBQUEsR0FDQSxLQUFBLE9BQUEsVUFBQSxpQkFBQSxPQUFBLEtBQUEsS0FBQSxLQUFBLE9BQUEsSUFHQSxlQUFBLFdBQ0EsS0FBQSxXQUFBLEdBQUEsYUFDQSxNQUFBLEVBQ0EsVUFBQSxTQUFBLEVBQUEsR0FDQSxHQUFBLEdBQUEsS0FBQSxZQUFBLEdBQ0EsSUFDQSxNQUFBLE1BQUEsVUFBQSxFQUFBLEdBQUEsTUFDQSxNQUFBLElBR0EsSUFDQSxNQUFBLE1BQUEsY0FBQSxHQUFBLE1BQ0EsTUFBQSxJQUVBLE1BQUEsTUFHQSxLQUFBLFdBQUEsT0FBQSxNQUFBLFNBQUEsZUFHQSxNQUFBLFNBQUEsR0FDQSxHQUFBLEdBQUEsS0FBQSxXQUFBLE9BQUEsRUFFQSxHQUFBLEVBQUEsUUFBQSxPQUFBLEtBQ0EsRUFBQSxFQUFBLFFBQUEsT0FBQSxJQUVBLElBQUEsR0FBQSxFQUFBLE1BQUEsd0JBUUEsSUFQQSxJQUFBLEtBQUEsRUFBQSxTQUFBLEdBQ0EsR0FBQSxHQUFBLEVBQUEsUUFBQSxRQUFBLGFBQ0EsR0FBQSxFQUFBLFFBQUEsTUFBQSxjQUVBLEVBQUEsRUFBQSxRQUFBLEVBQUEsS0FHQSxHQUFBLEtBQUEsT0FBQSxxQ0FBQSxDQUNBLEtBQUEsY0FDQSxhQUFBLEtBQUEsYUFHQSxJQUFBLEdBQUEsU0FBQSxLQUFBLE9BQUEsOENBQUEsSUFFQSxNQUFBLGFBQUEsV0FBQSxXQUNBLEtBQUEsS0FBQSxTQUNBLElBQUEsZUFBQSxPQUFBLGFBQ0EsUUFDQSxPQUFBLDRCQUNBLFFBQUEsRUFDQSxTQUFBLEtBQUEsUUFBQSxJQUVBLFVBQUEsRUFDQSxXQUNBLFNBQ0EsR0FBQSxTQUFBLEdBQ0EsS0FBQSxRQUFBLE9BQUEsRUFBQSxNQUVBLEdBQUEsS0FBQSxZQUNBLEtBQUEsT0FBQSxvQkFBQSxJQUFBLEdBQUEsS0FBQSxPQUFBLGFBQUEsb0JBQ0EsS0FBQSxRQUFBLElBQUEsVUFBQSxLQUFBLFFBQUEsSUFBQSxlQUlBLE1BQUEsVUFJQSxLQUFBLE1BQUEsT0FFQSxNQUFBLFFBQUEsT0FBQSxHQUVBLEdBQUEsS0FBQSxZQUNBLEtBQUEsT0FBQSxvQkFBQSxJQUFBLEdBQUEsS0FBQSxPQUFBLGFBQUEsb0JBQ0EsS0FBQSxRQUFBLElBQUEsVUFBQSxLQUFBLFFBQUEsSUFBQSxhQVFBLE9BSEEsTUFBQSxXQUFBLElBQUEsTUFBQSxLQUFBLE9BQUEsV0FDQSxLQUFBLFNBQUEsSUFBQSxNQUFBLEVBRUEsR0FHQSxrQkFBQSxTQUFBLEdBQ0EsRUFBQSxrQkFDQSxFQUFBLGtCQUdBLEtBQUEsU0FBQSxHQUNBLEVBQUEsa0JBQ0EsRUFBQSxrQkFFQSxHQUFBLEtBQUEsT0FBQSw4Q0FBQSxHQUFBLEtBQUEsT0FBQSw4Q0FDQSxLQUFBLFlBQUEsRUFBQSxhQUFBLFFBSUEsWUFBQSxTQUFBLEdBQ0EsSUFBQSxLQUFBLEVBQUEsU0FBQSxHQUNBLEdBQUEsR0FBQSxXQUFBLEtBQUEsRUFBQSxLQUVBLElBQUEsRUFBQSxDQUNBLEdBQUEsR0FBQSxLQUFBLE9BQUEsNkNBQUEsT0FBQSxDQUVBLEtBQUEsS0FBQSxVQUFBLEtBQUEsT0FBQSxxQ0FBQSxHQUdBLE1BRkEsTUFBQSxZQUFBLEVBQUEsUUFBQSxFQUFBLGlEQUVBLENBR0EsSUFBQSxFQUFBLEtBQUEsU0FBQSxLQUFBLE9BQUEsbUNBR0EsTUFGQSxNQUFBLFlBQUEsRUFBQSxRQUFBLEVBQUEsdUNBRUEsQ0FHQSxJQUFBLEtBQUEsT0FBQSx5Q0FDQSxLQUFBLE1BQ0EsTUFBQSxnQ0FDQSxLQUFBLEVBQ0EsR0FBQSxPQUNBLFFBRUEsS0FBQSxXQUFBLEVBQUEsU0FDQSxLQUFBLE9BQUEsYUFFQSxDQUNBLEdBQUEsR0FBQSxLQUFBLE9BQUEsNENBQUEsT0FBQSxDQUVBLEtBQUEsS0FBQSxVQUFBLEtBQUEsT0FBQSxvQ0FBQSxHQUdBLE1BRkEsTUFBQSxZQUFBLEVBQUEsT0FBQSxFQUFBLGdEQUVBLENBR0EsSUFBQSxFQUFBLEtBQUEsU0FBQSxLQUFBLE9BQUEsbUNBR0EsTUFGQSxNQUFBLFlBQUEsRUFBQSxPQUFBLEVBQUEsdUNBRUEsQ0FHQSxNQUFBLFdBQUEsRUFBQSxRQUNBLEtBQUEsT0FBQSxVQUdBLE9BR0EsVUFBQSxTQUFBLEVBQUEsR0FHQSxNQUZBLEdBQUEsRUFBQSxNQUFBLEtBRUEsSUFBQSxFQUFBLFFBQUEsRUFBQSxLQUFBLE1BQUEsS0FBQSxRQUdBLFdBQUEsU0FBQSxFQUFBLEdBQ0EsSUFBQSxFQUFBLE9BRUEsSUFBQSxHQUFBLEtBQUEsaUJBRUEsRUFBQSxHQUFBLFNBQ0EsR0FBQSxPQUFBLE9BQUEsR0FDQSxFQUFBLE9BQUEsU0FBQSxjQUFBLEVBQUEsVUFDQSxFQUFBLE9BQUEsT0FBQSxFQUFBLE1BQ0EsRUFBQSxPQUFBLFdBQUEsS0FBQSxPQUFBLFNBRUEsSUFBQSxHQUFBLEdBQUEsZUFDQSxHQUFBLEtBQUEsT0FBQSxlQUFBLE9BQUEsY0FDQSxFQUFBLGlCQUFBLGFBQUEsUUFDQSxFQUFBLGlCQUFBLFVBQUEsSUFBQSxLQUFBLGVBQUEsU0FFQSxFQUFBLE9BQUEsV0FBQSxTQUFBLEdBQ0EsR0FBQSxFQUFBLGlCQUFBLENBQ0EsR0FBQSxHQUFBLEVBQUEsT0FBQSxFQUFBLE1BQUEsSUFBQSxDQUNBLEdBQUEsTUFBQSxhQUFBLFNBQUEs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LGtCQUFBLElBQ0EsTUFBQSxLQUFBLE9BRUEsZUFBQSxZQUFBLE9BR0EsZUFBQSxLQUFBLFNBQUEsR0FDQSxLQUFBLFdBQ0EsUUFBQSxFQUFBLEVBQ0EsT0FBQSxFQUFBLEVBQ0EsWUFBQSxFQUFBLE9BQ0EsV0FBQSxFQUFBLE1BQ0EsWUFBQSxFQUFBLE9BQUEsS0FDQSxRQUNBLEtBQUEsTUFFQSxLQUFBLFdBQUEsUUFBQSxpQkFFQSxNQUFBLFNBSUEsZUFBQSxPQUFBLFFBQUEsV0FBQSxZQUFBLEtBQUEsS0FBQSxRQUNBLEtBQUEsT0FBQSxRQUdBLElBQUEsT0FBQSxlQUFBLE9BQUEsUUFBQSxJQUFBLFFBQ0EsVUFBQSxHQUNBLE9BQUEsU0FBQSxHQUNBLEdBQUEsR0FBQSxLQUFBLE9BQUEsR0FBQSxlQUFBLFFBQUEsS0FBQSxPQUFBLEtBQUEsTUFFQSxFQUFBLEdBQUEsU0FDQSxHQUFBLE9BQUEsT0FBQSxLQUFBLE9BQUEsTUFDQSxFQUFBLE9BQUEsU0FBQSwwQkFDQSxFQUFBLE9BQUEsWUFBQSxLQUFBLFdBQ0EsRUFBQSxPQUFBLE9BQUEsS0FBQSxPQUFBLEtBQUEsTUFDQSxFQUFBLE9BQUEsT0FBQSxFQUFBLE1BQ0EsRUFBQSxPQUFBLFdBQUEsS0FBQSxPQUFBLEdBQUEsT0FBQSxTQUVBLElBQUEsR0FBQSxHQUFBLGVBQ0EsR0FBQSxLQUFBLE9BQUEsZUFBQSxPQUFBLGNBQ0EsRUFBQSxpQkFBQSxhQUFBLFFBQ0EsRUFBQSxpQkFBQSxVQUFBLElBQUEsS0FBQSxlQUFBLFNBRUEsRUFBQSxPQUFBLFdBQUEsU0FBQSxHQUNBLEdBQUEsRUFBQSxpQkFBQSxDQUNBLEdBQUEsR0FBQSxFQUFBLE9BQUEsRUFBQSxNQUFBLElBQUEsQ0FDQSxHQUFBLE1BQUEsYUFBQSxTQUFBLEVBQUEsT0FFQSxLQUFBLE1BRUEsRUFBQSxPQUFBLFdBQ0EsR0FBQSxNQUFBLEVBQUEsT0FBQSxDQUNBLEdBQUEsR0FBQSxLQUFBLE1BQUEsRUFBQSxhQUVBLElBQUEsRUFBQSxTQUNBLEVBQUEsU0FDQSxLQUFBLE9BQUEsR0FBQSxPQUFBLE9BQUEsS0FBQSxFQUFBLE9BQUEsS0FBQSxLQUFBLEVBQUEsT0FBQSxLQUFBLEtBQUEsRUFBQSxPQUFBLEtBQUEsV0FFQSxLQUFBLE9BQUEsR0FBQSxhQUFBLEVBQUEsRUFBQSxXQUdBLEtBQUEsTUFFQSxFQUFBLEtBQUEsR0FFQSxLQUFBLFNBR0Esa0JBQUEsU0FBQSxHQUNBLEtBQUEsV0FBQSxRQUFBLEVBQUEsT0FBQSxFQUFBLFFBR0EsTUFBQSxXQUNBLEtBQUEsV0FBQSxRQUFBLFdBRUEsZUFBQSxPQUFBLFFBQUEsV0FBQSxNQUFBLEtBQUEsTUFDQSxLQUFBLE9BQUEsR0FBQSxPQUFBLFdBR0EsSUFBQSxJQUFBLGdDQUFBLGVBQUEsT0FBQSIsImZpbGUiOiJhcHAuanMiLCJzb3VyY2VzQ29udGVudCI6WyJFeHQubnMoJ01hcmtkb3duRWRpdG9yJyk7XG5NYXJrZG93bkVkaXRvciA9IGZ1bmN0aW9uKGNvbmZpZykge1xuICAgIGNvbmZpZyA9IGNvbmZpZyB8fCB7fTtcbiAgICBNYXJrZG93bkVkaXRvci5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcyxjb25maWcpO1xufTtcbkV4dC5leHRlbmQoTWFya2Rvd25FZGl0b3IsRXh0LkNvbXBvbmVudCx7XG4gICAgd2luZG93Ont9LGNvbmZpZzoge31cbn0pO1xuRXh0LnJlZygnbWFya2Rvd25lZGl0b3InLE1hcmtkb3duRWRpdG9yKTtcbm1hcmtkb3duRWRpdG9yID0gbmV3IE1hcmtkb3duRWRpdG9yKCk7XG5cbm1hcmtkb3duRWRpdG9yLkVkaXRvciA9IGZ1bmN0aW9uKGNvbmZpZykge1xuICAgIGNvbmZpZyA9IGNvbmZpZyB8fCB7fTtcbiAgICBjb25maWcucmVzb3VyY2UgPSBNT0R4LnJlcXVlc3QuaWQgfHwgMDtcbiAgICBtYXJrZG93bkVkaXRvci5FZGl0b3Iuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsY29uZmlnKTtcbiAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbn07XG5FeHQuZXh0ZW5kKG1hcmtkb3duRWRpdG9yLkVkaXRvcixFeHQuQ29tcG9uZW50LHtcbiAgICByZW1hcmthYmxlOiAnJ1xuICAgICxmdWxsU2NyZWVuOiBmYWxzZVxuICAgICxpbml0Q29tcG9uZW50OiBmdW5jdGlvbigpIHtcbiAgICAgICAgTWFya2Rvd25FZGl0b3Iuc3VwZXJjbGFzcy5pbml0Q29tcG9uZW50LmNhbGwodGhpcyk7XG5cbiAgICAgICAgRXh0Lm9uUmVhZHkodGhpcy5yZW5kZXIsIHRoaXMpO1xuICAgIH1cblxuICAgICxyZW5kZXI6IGZ1bmN0aW9uKCkge1xuICAgICAgICB0aGlzLnRleHRhcmVhID0gRXh0LmdldCgndGEnKTtcblxuICAgICAgICB0aGlzLmJ1aWxkVUkoKTtcbiAgICAgICAgdGhpcy5yZWdpc3RlckFjZSgpO1xuICAgICAgICB0aGlzLnJlZ2lzdGVyTWFya2VkKCk7XG5cbiAgICAgICAgdmFyIHByZXZpZXdCdXR0b24gPSB0aGlzLnRvb2xCb3guY2hpbGQoJy5wcmV2aWV3LWJ1dHRvbicpO1xuICAgICAgICB2YXIgZnVsbHNjcmVlbkJ1dHRvbiA9IHRoaXMudG9vbEJveC5jaGlsZCgnLmZ1bGxzY3JlZW4tYnV0dG9uJyk7XG4gICAgICAgIHZhciBjb250ZW50ID0gdGhpcy5jb250ZW50TUQ7XG4gICAgICAgIHZhciB3cmFwcGVyID0gY29udGVudC5wYXJlbnQoKTtcblxuICAgICAgICB2YXIgZHJvcFRhcmdldCA9IE1PRHgubG9hZCh7XG4gICAgICAgICAgICB4dHlwZTogJ21vZHgtdHJlZWRyb3AnLFxuICAgICAgICAgICAgdGFyZ2V0OiBjb250ZW50LFxuICAgICAgICAgICAgdGFyZ2V0RWw6IGNvbnRlbnQsXG4gICAgICAgICAgICBvbkluc2VydDogKGZ1bmN0aW9uKHMpe1xuICAgICAgICAgICAgICAgIHRoaXMuaW5zZXJ0KHMpO1xuICAgICAgICAgICAgICAgIHRoaXMuZm9jdXMoKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH0pLmJpbmQodGhpcy5lZGl0b3IpLFxuICAgICAgICAgICAgaWZyYW1lOiB0cnVlXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnRleHRhcmVhLm9uKCdkZXN0cm95JywgZnVuY3Rpb24oKSB7ZHJvcFRhcmdldC5kZXN0cm95KCk7fSk7XG5cbiAgICAgICAgcHJldmlld0J1dHRvbi5hZGRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5wcmV2aWV3LmlzVmlzaWJsZSgpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5wcmV2aWV3LnNldERpc3BsYXllZCgnbm9uZScpO1xuICAgICAgICAgICAgICAgIGNvbnRlbnQuc2V0RGlzcGxheWVkKCdibG9jaycpO1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzQmFyLnNldERpc3BsYXllZCgnYmxvY2snKTtcblxuICAgICAgICAgICAgICAgIHRoaXMuZWRpdG9yLmZvY3VzKCk7XG5cbiAgICAgICAgICAgICAgICBwcmV2aWV3QnV0dG9uLmNoaWxkKCdpJykucmVtb3ZlQ2xhc3MoJ2ljb24tdG9nZ2xlLW9uJyk7XG4gICAgICAgICAgICAgICAgcHJldmlld0J1dHRvbi5jaGlsZCgnaScpLmFkZENsYXNzKCdpY29uLXRvZ2dsZS1vZmYnKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5wcmV2aWV3LnNldERpc3BsYXllZCgnYmxvY2snKTtcbiAgICAgICAgICAgICAgICBjb250ZW50LnNldERpc3BsYXllZCgnbm9uZScpO1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzQmFyLnNldERpc3BsYXllZCgnbm9uZScpO1xuXG4gICAgICAgICAgICAgICAgcHJldmlld0J1dHRvbi5jaGlsZCgnaScpLnJlbW92ZUNsYXNzKCdpY29uLXRvZ2dsZS1vZmYnKTtcbiAgICAgICAgICAgICAgICBwcmV2aWV3QnV0dG9uLmNoaWxkKCdpJykuYWRkQ2xhc3MoJ2ljb24tdG9nZ2xlLW9uJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sIHRoaXMpO1xuXG4gICAgICAgIGZ1bGxzY3JlZW5CdXR0b24uYWRkTGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdmFyIGljb24gPSBmdWxsc2NyZWVuQnV0dG9uLmNoaWxkKCdpJyk7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLmZ1bGxTY3JlZW4gPT0gZmFsc2UpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZ1bGxTY3JlZW4gPSB0cnVlO1xuICAgICAgICAgICAgICAgIGljb24ucmVtb3ZlQ2xhc3MoJ2ljb24tZXhwYW5kJyk7XG4gICAgICAgICAgICAgICAgaWNvbi5hZGRDbGFzcygnaWNvbi1jb21wcmVzcycpO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5wcmV2aWV3LnNldERpc3BsYXllZCgnYmxvY2snKTtcbiAgICAgICAgICAgICAgICBjb250ZW50LnNldERpc3BsYXllZCgnYmxvY2snKTtcblxuICAgICAgICAgICAgICAgIHRoaXMuZWRpdG9yLmZvY3VzKCk7XG5cbiAgICAgICAgICAgICAgICBwcmV2aWV3QnV0dG9uLmhpZGUoKTtcblxuICAgICAgICAgICAgICAgIHdyYXBwZXIuYWRkQ2xhc3MoJ2Z1bGxzY3JlZW4nKTtcblxuICAgICAgICAgICAgICAgIHRoaXMuZWRpdG9yLnNldE9wdGlvbignbWF4TGluZXMnLCBudWxsKTtcblxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmZ1bGxTY3JlZW4gPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpY29uLmFkZENsYXNzKCdpY29uLWV4cGFuZCcpO1xuICAgICAgICAgICAgICAgIGljb24ucmVtb3ZlQ2xhc3MoJ2ljb24tY29tcHJlc3MnKTtcblxuICAgICAgICAgICAgICAgIHRoaXMucHJldmlldy5zZXREaXNwbGF5ZWQoJ25vbmUnKTtcbiAgICAgICAgICAgICAgICBjb250ZW50LnNldERpc3BsYXllZCgnYmxvY2snKTtcblxuICAgICAgICAgICAgICAgIHRoaXMuZWRpdG9yLmZvY3VzKCk7XG5cbiAgICAgICAgICAgICAgICBwcmV2aWV3QnV0dG9uLnNob3coKTtcblxuICAgICAgICAgICAgICAgIHdyYXBwZXIucmVtb3ZlQ2xhc3MoJ2Z1bGxzY3JlZW4nKTtcblxuICAgICAgICAgICAgICAgIHRoaXMuZWRpdG9yLnNldE9wdGlvbignbWF4TGluZXMnLCBJbmZpbml0eSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuc3RhdHVzQmFyLnNldERpc3BsYXllZCgnYmxvY2snKTtcblxuICAgICAgICAgICAgdGhpcy5lZGl0b3IucmVzaXplKHRydWUpO1xuICAgICAgICB9LCB0aGlzKTtcblxuICAgICAgICBpZiAobWFya2Rvd25FZGl0b3IuY29udGVudC5jb250ZW50KSB7XG4gICAgICAgICAgICB0aGlzLmVkaXRvci5zZXRWYWx1ZShtYXJrZG93bkVkaXRvci5jb250ZW50LmNvbnRlbnQpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZWRpdG9yLnNlbGVjdGlvbi5jbGVhclNlbGVjdGlvbigpO1xuXG4gICAgICAgIHRoaXMucHJldmlldy51cGRhdGUodGhpcy5wYXJzZSh0aGlzLmVkaXRvci5nZXRWYWx1ZSgpKSk7XG5cbiAgICAgICAgdGhpcy5lZGl0b3IuZ2V0U2Vzc2lvbigpLm9uKCdjaGFuZ2UnLCBmdW5jdGlvbihlKXtcbiAgICAgICAgICAgIHRoaXMucGFyc2UodGhpcy5lZGl0b3IuZ2V0VmFsdWUoKSk7XG4gICAgICAgIH0uYmluZCh0aGlzKSk7XG4gICAgfVxuXG4gICAgLGJ1aWxkVUk6IGZ1bmN0aW9uKCkge1xuICAgICAgICB0aGlzLnRleHRhcmVhLnNldERpc3BsYXllZCgnbm9uZScpO1xuICAgICAgICB0aGlzLnRleHRhcmVhLnNldFdpZHRoKDApO1xuICAgICAgICB0aGlzLnRleHRhcmVhLnNldEhlaWdodCgwKTtcblxuICAgICAgICB0aGlzLnRhTWFya2Rvd24gPSBFeHQuZ2V0KEV4dC5Eb21IZWxwZXIuaW5zZXJ0QmVmb3JlKHRoaXMudGV4dGFyZWEsIHtcbiAgICAgICAgICAgIHRhZzogJ3RleHRhcmVhJyxcbiAgICAgICAgICAgIG5hbWU6ICd0YV9tYXJrZG93bicsXG4gICAgICAgICAgICBjbGFzczogJ3RhX21hcmtkb3duJ1xuICAgICAgICB9KSk7XG5cbiAgICAgICAgdGhpcy50YU1hcmtkb3duLnNldERpc3BsYXllZCgnbm9uZScpO1xuICAgICAgICB0aGlzLnRhTWFya2Rvd24uc2V0V2lkdGgoMCk7XG4gICAgICAgIHRoaXMudGFNYXJrZG93bi5zZXRIZWlnaHQoMCk7XG5cbiAgICAgICAgdmFyIHdyYXBwZXIgPSBFeHQuRG9tSGVscGVyLmluc2VydEJlZm9yZSh0aGlzLnRleHRhcmVhLCB7XG4gICAgICAgICAgICB0YWc6ICdkaXYnLFxuICAgICAgICAgICAgY2xhc3M6ICdtYXJrZG93bi1jb250YWluZXInXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuY29udGVudE1EID0gRXh0LmdldChFeHQuRG9tSGVscGVyLmFwcGVuZCh3cmFwcGVyLHtcbiAgICAgICAgICAgIHRhZzogJ2RpdicsXG4gICAgICAgICAgICBjbGFzczogdGhpcy50ZXh0YXJlYS5kb20uY2xhc3NOYW1lICsgJyBjb250ZW50LW1kJ1xuICAgICAgICB9KSk7XG5cbiAgICAgICAgdGhpcy5wcmV2aWV3ID0gRXh0LmdldChFeHQuRG9tSGVscGVyLmFwcGVuZCh3cmFwcGVyLHtcbiAgICAgICAgICAgIHRhZzogJ2RpdicsXG4gICAgICAgICAgICBjbGFzczogJ21hcmtkb3duLWJvZHkgcHJldmlldy1tZCdcbiAgICAgICAgfSkpO1xuXG4gICAgICAgIHRoaXMudG9vbEJveCA9IEV4dC5nZXQoRXh0LkRvbUhlbHBlci5hcHBlbmQod3JhcHBlcix7XG4gICAgICAgICAgICB0YWc6ICdkaXYnLFxuICAgICAgICAgICAgY2xhc3M6ICd0b29sYm94JyxcbiAgICAgICAgICAgIGNuOiBbe1xuICAgICAgICAgICAgICAgIHRhZzogJ3NwYW4nLFxuICAgICAgICAgICAgICAgIGNsYXNzOiAncHJldmlldy1idXR0b24nLFxuICAgICAgICAgICAgICAgIGh0bWw6ICc8aSBjbGFzcz1cImljb24gaWNvbi10b2dnbGUtb2ZmXCI+PC9pPiAnICsgXygnbWFya2Rvd25lZGl0b3IudG9vbGJveC5wcmV2aWV3JylcbiAgICAgICAgICAgIH0se1xuICAgICAgICAgICAgICAgIHRhZzogJ3NwYW4nLFxuICAgICAgICAgICAgICAgIGNsYXNzOiAnZnVsbHNjcmVlbi1idXR0b24nLFxuICAgICAgICAgICAgICAgIGh0bWw6ICc8aSBjbGFzcz1cImljb24gaWNvbi1leHBhbmRcIj48L2k+J1xuICAgICAgICAgICAgfV1cbiAgICAgICAgfSkpO1xuXG4gICAgICAgIGlmIChNT0R4LmNvbmZpZ1snbWFya2Rvd25lZGl0b3IudXBsb2FkLmVuYWJsZV9pbWFnZV91cGxvYWQnXSA9PSAxIHx8IE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci51cGxvYWQuZW5hYmxlX2ZpbGVfdXBsb2FkJ10gPT0gMSkge1xuICAgICAgICAgICAgdGhpcy5zdGF0dXNCYXIgPSBFeHQuZ2V0KEV4dC5Eb21IZWxwZXIuYXBwZW5kKHdyYXBwZXIse1xuICAgICAgICAgICAgICAgIHRhZzogJ2RpdicsXG4gICAgICAgICAgICAgICAgY2xhc3M6ICdzdGF0dXMtYmFyJ1xuICAgICAgICAgICAgfSkpO1xuXG4gICAgICAgICAgICB0aGlzLnN0YXR1c0Jhci5kb20uaW5uZXJIVE1MID0gJzxkaXYgY2xhc3M9XCJ1cGxvYWQtYmFyXCI+IDxpbnB1dCBjbGFzcz1cImhpZGRlblwiIG5hbWU9XCJmaWxlXCIgaWQ9XCInICsgdGhpcy5zdGF0dXNCYXIuaWQgKyAnLWZpbGVcIiB0eXBlPVwiZmlsZVwiIG11bHRpcGxlPicgKyBfKCdtYXJrZG93bmVkaXRvci5zdGF0dXNfYmFyX21lc3NhZ2UnLCB7aWQ6IHRoaXMuc3RhdHVzQmFyLmlkICsgJy1maWxlJ30pICsgJzwvZGl2Pic7XG5cbiAgICAgICAgICAgIHRoaXMuc3RhdHVzQmFyLmNoaWxkKCdpbnB1dCcpLm9uKCdjaGFuZ2UnLCBmdW5jdGlvbihlLCBpbnB1dCkge1xuICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlRmlsZXMoaW5wdXQuZmlsZXMpO1xuICAgICAgICAgICAgICAgIGlucHV0LnZhbHVlID0gXCJcIjtcbiAgICAgICAgICAgIH0sIHRoaXMpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5zdGF0dXNCYXIgPSBFeHQuZ2V0KEV4dC5Eb21IZWxwZXIuYXBwZW5kKHdyYXBwZXIse1xuICAgICAgICAgICAgICAgIHRhZzogJ2RpdicsXG4gICAgICAgICAgICAgICAgY2xhc3M6ICdzdGF0dXMtYmFyJyxcbiAgICAgICAgICAgICAgICBodG1sOiBfKCdtYXJrZG93bmVkaXRvci5zdGF0dXNfYmFyX2Rpc2FibGVkJylcbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgfVxuXG4gICAgICAgIEV4dC5Eb21IZWxwZXIuYXBwZW5kKHdyYXBwZXIse1xuICAgICAgICAgICAgdGFnOiAnc3BhbicsXG4gICAgICAgICAgICBzdHlsZTogJ2NsZWFyOiBib3RoJ1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAscmVnaXN0ZXJBY2U6IGZ1bmN0aW9uKCkge1xuICAgICAgICB0aGlzLmVkaXRvciA9IGFjZS5lZGl0KEV4dC5Eb21RdWVyeS5zZWxlY3ROb2RlKCdkaXYuY29udGVudC1tZCcpKTtcbiAgICAgICAgdGhpcy5lZGl0b3Iuc2V0T3B0aW9ucyh7XG4gICAgICAgICAgICBtYXhMaW5lczogSW5maW5pdHksXG4gICAgICAgICAgICBtaW5MaW5lczogMjUsXG4gICAgICAgICAgICBlbmFibGVCYXNpY0F1dG9jb21wbGV0aW9uOiB0cnVlXG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmVkaXRvci5yZW5kZXJlci5zZXRTaG93R3V0dGVyKHRydWUpO1xuICAgICAgICB0aGlzLmVkaXRvci5yZW5kZXJlci5zZXRTY3JvbGxNYXJnaW4oMTAsIDEwKTtcbiAgICAgICAgdGhpcy5lZGl0b3IuZ2V0U2Vzc2lvbigpLnNldFZhbHVlKHRoaXMudGV4dGFyZWEuZ2V0VmFsdWUoKSk7XG4gICAgICAgIHRoaXMuZWRpdG9yLmdldFNlc3Npb24oKS5zZXRNb2RlKFwiYWNlL21vZGUvbWFya2Rvd25cIik7XG4gICAgICAgIHRoaXMuZWRpdG9yLnNldFRoZW1lKFwiYWNlL3RoZW1lL1wiICsgKE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci5nZW5lcmFsLnRoZW1lJ10gfHwgJ21vbm9rYWknKSk7XG5cbiAgICAgICAgdmFyIGxhbmdUb29scyA9IGFjZS5yZXF1aXJlKFwiYWNlL2V4dC9sYW5ndWFnZV90b29sc1wiKTtcbiAgICAgICAgdmFyIHJlc291cmNlc0NvbXBsZXRlciA9IHtcbiAgICAgICAgICAgIGdldENvbXBsZXRpb25zOiBmdW5jdGlvbihlZGl0b3IsIHNlc3Npb24sIHBvcywgcHJlZml4LCBjYWxsYmFjaykge1xuICAgICAgICAgICAgICAgIGlmIChwcmVmaXgubGVuZ3RoID09PSAwKSB7IGNhbGxiYWNrKG51bGwsIFtdKTsgcmV0dXJuIH1cblxuICAgICAgICAgICAgICAgIE1PRHguQWpheC5yZXF1ZXN0KHtcbiAgICAgICAgICAgICAgICAgICAgdXJsOiBtYXJrZG93bkVkaXRvci5jb25maWcuY29ubmVjdG9yVXJsXG4gICAgICAgICAgICAgICAgICAgICxwYXJhbXM6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbjogJ21nci9yZXNvdXJjZS9nZXRsaXN0J1xuICAgICAgICAgICAgICAgICAgICAgICAgLHByZWZpeDogcHJlZml4XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyczoge1xuICAgICAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm46IGZ1bmN0aW9uKHIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgci5yZXN1bHRzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBsYW5nVG9vbHMuYWRkQ29tcGxldGVyKHJlc291cmNlc0NvbXBsZXRlcik7XG5cblxuICAgICAgICB0aGlzLmVkaXRvci5jb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcihcImRyYWdlbnRlclwiLCB0aGlzLmNhdGNoQW5kRG9Ob3RoaW5nLCBmYWxzZSk7XG4gICAgICAgIHRoaXMuZWRpdG9yLmNvbnRhaW5lci5hZGRFdmVudExpc3RlbmVyKFwiZHJhZ292ZXJcIiwgdGhpcy5jYXRjaEFuZERvTm90aGluZywgZmFsc2UpO1xuICAgICAgICB0aGlzLmVkaXRvci5jb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcihcImRyb3BcIiwgdGhpcy5kcm9wLmJpbmQodGhpcyksIGZhbHNlKTtcbiAgICB9XG5cbiAgICAscmVnaXN0ZXJNYXJrZWQ6IGZ1bmN0aW9uKCkge1xuICAgICAgICB0aGlzLnJlbWFya2FibGUgPSBuZXcgUmVtYXJrYWJsZSh7XG4gICAgICAgICAgICBodG1sOiB0cnVlLFxuICAgICAgICAgICAgaGlnaGxpZ2h0OiBmdW5jdGlvbiAoc3RyLCBsYW5nKSB7XG4gICAgICAgICAgICAgICAgaWYgKGxhbmcgJiYgaGxqcy5nZXRMYW5ndWFnZShsYW5nKSkge1xuICAgICAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhsanMuaGlnaGxpZ2h0KGxhbmcsIHN0cikudmFsdWU7XG4gICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge31cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGxqcy5oaWdobGlnaHRBdXRvKHN0cikudmFsdWU7XG4gICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7fVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5yZW1hcmthYmxlLmlubGluZS5ydWxlci5kaXNhYmxlKFsgJ2JhY2t0aWNrcycgXSk7XG4gICAgfVxuXG4gICAgLHBhcnNlOiBmdW5jdGlvbihpbnB1dCkge1xuICAgICAgICB2YXIgb3V0cHV0ID0gdGhpcy5yZW1hcmthYmxlLnJlbmRlcihpbnB1dCk7XG5cbiAgICAgICAgb3V0cHV0ID0gb3V0cHV0LnJlcGxhY2UoLyU1Qi9nLCAnWycpO1xuICAgICAgICBvdXRwdXQgPSBvdXRwdXQucmVwbGFjZSgvJTVEL2csICddJyk7XG5cbiAgICAgICAgdmFyIGNvZGVCbG9ja3MgPSBvdXRwdXQubWF0Y2goLzxjb2RlKC58XFxzKSo8XFwvY29kZT4vZyk7XG4gICAgICAgIEV4dC5lYWNoKGNvZGVCbG9ja3MsIGZ1bmN0aW9uKGl0ZW0pIHtcbiAgICAgICAgICAgIHZhciByZXBsYWNlZEl0ZW0gPSBpdGVtLnJlcGxhY2UoL1xcW1xcWy9nLCAnJiM5MTsmIzkxOycpO1xuICAgICAgICAgICAgcmVwbGFjZWRJdGVtID0gcmVwbGFjZWRJdGVtLnJlcGxhY2UoL11dL2csICcmIzkzOyYjOTM7Jyk7XG5cbiAgICAgICAgICAgIG91dHB1dCA9IG91dHB1dC5yZXBsYWNlKGl0ZW0sIHJlcGxhY2VkSXRlbSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChNT0R4LmNvbmZpZ1snbWFya2Rvd25lZGl0b3IubHAucGFyc2VfbW9keF90YWdzJ10gPT0gMSkge1xuICAgICAgICAgICAgaWYgKHRoaXMucGFyc2VSZXF1ZXN0KSB7XG4gICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMucGFyc2VSZXF1ZXN0KTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdmFyIHRpbWVvdXQgPSBwYXJzZUludChNT0R4LmNvbmZpZ1snbWFya2Rvd25lZGl0b3IubHAucGFyc2VfbW9keF90YWdzX3RpbWVvdXQnXSB8fCAzMDApO1xuXG4gICAgICAgICAgICB0aGlzLnBhcnNlUmVxdWVzdCA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKXtcbiAgICAgICAgICAgICAgICBNT0R4LkFqYXgucmVxdWVzdCh7XG4gICAgICAgICAgICAgICAgICAgIHVybDogbWFya2Rvd25FZGl0b3IuY29uZmlnLmNvbm5lY3RvclVybFxuICAgICAgICAgICAgICAgICAgICAscGFyYW1zOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb246ICdtZ3IvZWRpdG9yL3Byb2Nlc3Njb250ZW50J1xuICAgICAgICAgICAgICAgICAgICAgICAgLGNvbnRlbnQ6IG91dHB1dFxuICAgICAgICAgICAgICAgICAgICAgICAgLHJlc291cmNlOiBNT0R4LnJlcXVlc3QuaWRcbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgaXNVcGxvYWQgOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnM6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuOiBmdW5jdGlvbihyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHJldmlldy51cGRhdGUoci5kYXRhKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5mdWxsU2NyZWVuID09IHRydWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgodGhpcy5lZGl0b3IuZ2V0Q3Vyc29yUG9zaXRpb24oKS5yb3cgKyAyKSA+PSB0aGlzLmVkaXRvci5nZXRTZXNzaW9uKCkuZ2V0U2NyZWVuTGVuZ3RoKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnByZXZpZXcuZG9tLnNjcm9sbFRvcCA9IHRoaXMucHJldmlldy5kb20uc2Nyb2xsSGVpZ2h0XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0uYmluZCh0aGlzKSwgdGltZW91dCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnByZXZpZXcudXBkYXRlKG91dHB1dCk7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLmZ1bGxTY3JlZW4gPT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgIGlmICgodGhpcy5lZGl0b3IuZ2V0Q3Vyc29yUG9zaXRpb24oKS5yb3cgKyAyKSA+PSB0aGlzLmVkaXRvci5nZXRTZXNzaW9uKCkuZ2V0U2NyZWVuTGVuZ3RoKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5wcmV2aWV3LmRvbS5zY3JvbGxUb3AgPSB0aGlzLnByZXZpZXcuZG9tLnNjcm9sbEhlaWdodFxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMudGFNYXJrZG93bi5kb20udmFsdWUgPSB0aGlzLmVkaXRvci5nZXRWYWx1ZSgpO1xuICAgICAgICB0aGlzLnRleHRhcmVhLmRvbS52YWx1ZSA9IG91dHB1dDtcblxuICAgICAgICByZXR1cm4gb3V0cHV0O1xuICAgIH1cblxuICAgICxjYXRjaEFuZERvTm90aGluZzogZnVuY3Rpb24oZSkge1xuICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgfVxuXG4gICAgLGRyb3A6IGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAgIGlmIChNT0R4LmNvbmZpZ1snbWFya2Rvd25lZGl0b3IudXBsb2FkLmVuYWJsZV9pbWFnZV91cGxvYWQnXSA9PSAxIHx8IE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci51cGxvYWQuZW5hYmxlX2ZpbGVfdXBsb2FkJ10gPT0gMSkge1xuICAgICAgICAgICAgdGhpcy5oYW5kbGVGaWxlcyhlLmRhdGFUcmFuc2Zlci5maWxlcyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAsaGFuZGxlRmlsZXM6IGZ1bmN0aW9uKGZpbGVzKSB7XG4gICAgICAgIEV4dC5lYWNoKGZpbGVzLCBmdW5jdGlvbihmaWxlKSB7XG4gICAgICAgICAgICB2YXIgaXNJbWFnZSA9IC9eaW1hZ2VcXC8vLnRlc3QoZmlsZS50eXBlKTtcblxuICAgICAgICAgICAgaWYgKGlzSW1hZ2UpIHtcbiAgICAgICAgICAgICAgICBpZiAoTU9EeC5jb25maWdbJ21hcmtkb3duZWRpdG9yLnVwbG9hZC5lbmFibGVfaW1hZ2VfdXBsb2FkJ10gPT0gMCkgcmV0dXJuIHRydWU7XG5cbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuY2hlY2tUeXBlKE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci51cGxvYWQuaW1hZ2VfdHlwZXMnXSwgZmlsZSkpe1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmZhaWxNZXNzYWdlKGZpbGUsICdpbWFnZScsIF8oJ21hcmtkb3duZWRpdG9yLmVyci51cGxvYWQudW5zdXBwb3J0ZWRfaW1hZ2UnKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKGZpbGUuc2l6ZSA+IHBhcnNlSW50KE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci51cGxvYWQubWF4X3NpemUnXSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5mYWlsTWVzc2FnZShmaWxlLCAnaW1hZ2UnLCBfKCdtYXJrZG93bmVkaXRvci5lcnIudXBsb2FkLnRvb19iaWcnKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci5jcm9wcGVyLmVuYWJsZV9jcm9wcGVyJ10gPT0gMSkge1xuICAgICAgICAgICAgICAgICAgICBNT0R4LmxvYWQoe1xuICAgICAgICAgICAgICAgICAgICAgICAgeHR5cGU6ICdtYXJrZG93bmVkaXRvci13aW5kb3ctY3JvcHBlcidcbiAgICAgICAgICAgICAgICAgICAgICAgICxmaWxlOiBmaWxlXG4gICAgICAgICAgICAgICAgICAgICAgICAsbWQ6IHRoaXNcbiAgICAgICAgICAgICAgICAgICAgfSkuc2hvdygpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXBsb2FkRmlsZShmaWxlLCAnaW1hZ2UnKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lZGl0b3IuZm9jdXMoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmIChNT0R4LmNvbmZpZ1snbWFya2Rvd25lZGl0b3IudXBsb2FkLmVuYWJsZV9maWxlX3VwbG9hZCddID09IDApIHJldHVybiB0cnVlO1xuXG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmNoZWNrVHlwZShNT0R4LmNvbmZpZ1snbWFya2Rvd25lZGl0b3IudXBsb2FkLmZpbGVfdHlwZXMnXSwgZmlsZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5mYWlsTWVzc2FnZShmaWxlLCAnZmlsZScsIF8oJ21hcmtkb3duZWRpdG9yLmVyci51cGxvYWQudW5zdXBwb3J0ZWRfZmlsZScpKTtcblxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoZmlsZS5zaXplID4gcGFyc2VJbnQoTU9EeC5jb25maWdbJ21hcmtkb3duZWRpdG9yLnVwbG9hZC5tYXhfc2l6ZSddKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmZhaWxNZXNzYWdlKGZpbGUsICdmaWxlJywgXygnbWFya2Rvd25lZGl0b3IuZXJyLnVwbG9hZC50b29fYmlnJykpO1xuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHRoaXMudXBsb2FkRmlsZShmaWxlLCAnZmlsZScpO1xuICAgICAgICAgICAgICAgIHRoaXMuZWRpdG9yLmZvY3VzKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSwgdGhpcyk7XG4gICAgfVxuXG4gICAgLGNoZWNrVHlwZTogZnVuY3Rpb24oYWxsb3dlZFR5cGVzLCBmaWxlKSB7XG4gICAgICAgIGFsbG93ZWRUeXBlcyA9IGFsbG93ZWRUeXBlcy5zcGxpdCgnLCcpO1xuXG4gICAgICAgIHJldHVybiBhbGxvd2VkVHlwZXMuaW5kZXhPZihmaWxlLm5hbWUuc3BsaXQoJy4nKS5wb3AoKSkgIT0gLTE7XG4gICAgfVxuXG4gICAgLHVwbG9hZEZpbGU6IGZ1bmN0aW9uKGZpbGUsIHR5cGUpIHtcbiAgICAgICAgaWYgKCF0eXBlKSB0eXBlID0gJ2ZpbGUnO1xuXG4gICAgICAgIHZhciB1cGxvYWRlciA9IHRoaXMuY3JlYXRlVXBsb2FkZXIoKTtcblxuICAgICAgICB2YXIgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcbiAgICAgICAgZm9ybURhdGEuYXBwZW5kKCdmaWxlJywgZmlsZSk7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnYWN0aW9uJywgJ21nci9lZGl0b3IvJyArIHR5cGUgKyAndXBsb2FkJyk7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnbmFtZScsIGZpbGUubmFtZSk7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgncmVzb3VyY2UnLCB0aGlzLmNvbmZpZy5yZXNvdXJjZSk7XG5cbiAgICAgICAgdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgICAgICB4aHIub3BlbignUE9TVCcsIG1hcmtkb3duRWRpdG9yLmNvbmZpZy5jb25uZWN0b3JVcmwpO1xuICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignUG93ZXJlZC1CeScsICdNT0R4Jyk7XG4gICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdtb2RBdXRoJywgRXh0LkFqYXguZGVmYXVsdEhlYWRlcnMubW9kQXV0aCk7XG5cbiAgICAgICAgeGhyLnVwbG9hZC5vbnByb2dyZXNzID0gZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgICAgICBpZiAoZXZlbnQubGVuZ3RoQ29tcHV0YWJsZSkge1xuICAgICAgICAgICAgICAgIHZhciBjb21wbGV0ZSA9IChldmVudC5sb2FkZWQgLyBldmVudC50b3RhbCAqIDEwMCB8IDApO1xuICAgICAgICAgICAgICAgIHVwbG9hZGVyLmNoaWxkKCcucHJvZ3Jlc3MnKS5zZXRXaWR0aChjb21wbGV0ZSArICclJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0uYmluZCh0aGlzKTtcblxuICAgICAgICB4aHIub25sb2FkID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKHhoci5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgICAgICAgICAgIHZhciByZXMgPSBKU09OLnBhcnNlKHhoci5yZXNwb25zZVRleHQpO1xuICAgICAgICAgICAgICAgIGlmIChyZXMuc3VjY2VzcyA9PSB0cnVlKSB7XG4gICAgICAgICAgICAgICAgICAgIHVwbG9hZGVyLnJlbW92ZSgpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgaW1hZ2VQcmVmaXggPSAodHlwZSA9PSAnaW1hZ2UnKSA/ICchJyA6ICcnO1xuICAgICAgICAgICAgICAgICAgICB2YXIgZW5kTGluZSA9ICh0eXBlID09ICdpbWFnZScpID8gJ1xcblxcbicgOiAnXFxuJztcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lZGl0b3IuaW5zZXJ0KGltYWdlUHJlZml4ICsgJ1snICsgcmVzLm9iamVjdC5uYW1lICsgJ10oJyArIHJlcy5vYmplY3QucGF0aCArICcgXCInICsgcmVzLm9iamVjdC5uYW1lICsgJ1wiKScgKyBlbmRMaW5lKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmZhaWxVcGxvYWRlcih1cGxvYWRlciwgcmVzLm1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfS5iaW5kKHRoaXMpO1xuXG4gICAgICAgIHhoci5zZW5kKGZvcm1EYXRhKTtcbiAgICB9XG5cbiAgICAsY3JlYXRlVXBsb2FkZXI6IGZ1bmN0aW9uKHR5cGUsIGZpbGVOYW1lKSB7XG4gICAgICAgIHZhciB1cGxvYWRlciA9IEV4dC5Eb21IZWxwZXIuaW5zZXJ0Rmlyc3QodGhpcy5zdGF0dXNCYXIse1xuICAgICAgICAgICAgdGFnOiAnZGl2JyxcbiAgICAgICAgICAgIGh0bWw6ICc8ZGl2IGNsYXNzPVwicHJvZ3Jlc3NcIj48aSBjbGFzcz1cImljb24gaWNvbi1zcGlubmVyIGljb24tc3BpblwiPjwvaT4gPHNwYW4+JyArIF8oJ21hcmtkb3duZWRpdG9yLnVwbG9hZGluZ18nICsgdHlwZSkgKyBmaWxlTmFtZSArICc8L3NwYW4+PC9kaXY+J1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gRXh0LmdldCh1cGxvYWRlcik7XG4gICAgfVxuXG4gICAgLGZhaWxVcGxvYWRlcjogZnVuY3Rpb24odXBsb2FkZXIsIG1lc3NhZ2UpIHtcbiAgICAgICAgdXBsb2FkZXIuY2hpbGQoJy5wcm9ncmVzcycpLmFkZENsYXNzKCdlcnJvcicpO1xuICAgICAgICB1cGxvYWRlci5jaGlsZCgnLnByb2dyZXNzJykuc2V0V2lkdGgoJzEwMCUnKTtcblxuICAgICAgICB1cGxvYWRlci5jaGlsZCgnaScpLmFkZENsYXNzKCdyZW1vdmUtbWVzc2FnZScpO1xuICAgICAgICB1cGxvYWRlci5jaGlsZCgnaScpLnJlcGxhY2VDbGFzcygnaWNvbi1zcGlubmVyJywgJ2ljb24tcmVtb3ZlJyk7XG4gICAgICAgIHVwbG9hZGVyLmNoaWxkKCdpJykucmVtb3ZlQ2xhc3MoJ2ljb24tc3BpbicpO1xuXG4gICAgICAgIHVwbG9hZGVyLmNoaWxkKCdzcGFuJykuZG9tLmlubmVySFRNTCArPSAnIGZhaWxlZC4gJyArIG1lc3NhZ2U7XG4gICAgICAgIHVwbG9hZGVyLmNoaWxkKCcucmVtb3ZlLW1lc3NhZ2UnKS5vbignY2xpY2snLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHVwbG9hZGVyLnJlbW92ZSgpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAsZmFpbE1lc3NhZ2U6IGZ1bmN0aW9uKGZpbGUsIHR5cGUsIG1lc3NhZ2UpIHtcbiAgICAgICAgdmFyIHVwbG9hZGVyID0gdGhpcy5jcmVhdGVVcGxvYWRlcih0eXBlLCBmaWxlLm5hbWUpO1xuICAgICAgICB0aGlzLmZhaWxVcGxvYWRlcih1cGxvYWRlciwgbWVzc2FnZSk7XG4gICAgfVxufSk7XG5cbk1PRHgubG9hZFJURSA9IGZ1bmN0aW9uKGlkKSB7XG4gICAgbmV3IG1hcmtkb3duRWRpdG9yLkVkaXRvcigpO1xufTtcbiIsIm1hcmtkb3duRWRpdG9yLndpbmRvdy5Dcm9wcGVyID0gZnVuY3Rpb24oY29uZmlnKSB7XG4gICAgY29uZmlnID0gY29uZmlnIHx8IHt9O1xuICAgIGNvbmZpZy5jcm9wcGVyU2VsZWN0b3IgPSBjb25maWcuY3JvcHBlclNlbGVjdG9yIHx8ICcuaW1hZ2UtdXBsb2FkLXdyYXBwZXIgPiBpbWcnO1xuXG4gICAgRXh0LmFwcGx5SWYoY29uZmlnLHtcbiAgICAgICAgbW9kYWw6IGZhbHNlXG4gICAgICAgICxsYXlvdXQ6ICdhdXRvJ1xuICAgICAgICAsY2xvc2VBY3Rpb246ICdoaWRlJ1xuICAgICAgICAsc2hhZG93OiB0cnVlXG4gICAgICAgICxyZXNpemFibGU6IHRydWVcbiAgICAgICAgLGNvbGxhcHNpYmxlOiB0cnVlXG4gICAgICAgICxtYXhpbWl6YWJsZTogZmFsc2VcbiAgICAgICAgLGF1dG9IZWlnaHQ6IGZhbHNlXG4gICAgICAgICxhdXRvU2Nyb2xsOiB0cnVlXG4gICAgICAgICxhbGxvd0Ryb3A6IHRydWVcbiAgICAgICAgLHdpZHRoOiA4MDBcbiAgICAgICAgLHRpdGxlOiBfKCdtYXJrZG93bmVkaXRvci5jcm9wcGVyLmNyb3BfaW1hZ2UnKVxuICAgICAgICAsY2xzOiAnbW9keC13aW5kb3cnXG4gICAgICAgICxodG1sOiAnPGRpdiBjbGFzcz1cImltYWdlLXVwbG9hZC13cmFwcGVyXCI+PGltZyBzcmM9XCInICsgVVJMLmNyZWF0ZU9iamVjdFVSTChjb25maWcuZmlsZSkgKyAnXCI+PC9kaXY+J1xuICAgICAgICAsdGJhcjogW3tcbiAgICAgICAgICAgIHRleHQ6ICc8aSBjbGFzcz1cImljb24gaWNvbi1hcnJvd3NcIj48L2k+ICcgKyBfKCdtYXJrZG93bmVkaXRvci5jcm9wcGVyLm1vdmUnKVxuICAgICAgICAgICAgLHNjb3BlOiB0aGlzXG4gICAgICAgICAgICAscGFyYW06ICdtb3ZlJ1xuICAgICAgICAgICAgLGFjdGlvbjogJ3NldERyYWdNb2RlJ1xuICAgICAgICAgICAgLGhhbmRsZXI6IHRoaXMuY2FsbENyb3BwZXJBY3Rpb25cbiAgICAgICAgfSx7XG4gICAgICAgICAgICB0ZXh0OiAnPGkgY2xhc3M9XCJpY29uIGljb24tY3JvcFwiPjwvaT4gJyArIF8oJ21hcmtkb3duZWRpdG9yLmNyb3BwZXIuY3JvcCcpXG4gICAgICAgICAgICAsc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICxwYXJhbTogJ2Nyb3AnXG4gICAgICAgICAgICAsYWN0aW9uOiAnc2V0RHJhZ01vZGUnXG4gICAgICAgICAgICAsaGFuZGxlcjogdGhpcy5jYWxsQ3JvcHBlckFjdGlvblxuICAgICAgICB9LHtcbiAgICAgICAgICAgIHRleHQ6ICc8aSBjbGFzcz1cImljb24gaWNvbi1zZWFyY2gtcGx1c1wiPjwvaT4gJyArIF8oJ21hcmtkb3duZWRpdG9yLmNyb3BwZXIuem9vbV9pbicpXG4gICAgICAgICAgICAsc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICxwYXJhbTogMC4xXG4gICAgICAgICAgICAsYWN0aW9uOiAnem9vbSdcbiAgICAgICAgICAgICxoYW5kbGVyOiB0aGlzLmNhbGxDcm9wcGVyQWN0aW9uXG4gICAgICAgIH0se1xuICAgICAgICAgICAgdGV4dDogJzxpIGNsYXNzPVwiaWNvbiBpY29uLXNlYXJjaC1taW51c1wiPjwvaT4gJyArIF8oJ21hcmtkb3duZWRpdG9yLmNyb3BwZXIuem9vbV9vdXQnKVxuICAgICAgICAgICAgLHNjb3BlOiB0aGlzXG4gICAgICAgICAgICAscGFyYW06IC0wLjFcbiAgICAgICAgICAgICxhY3Rpb246ICd6b29tJ1xuICAgICAgICAgICAgLGhhbmRsZXI6IHRoaXMuY2FsbENyb3BwZXJBY3Rpb25cbiAgICAgICAgfSx7XG4gICAgICAgICAgICB0ZXh0OiAnPGkgY2xhc3M9XCJpY29uIGljb24tcm90YXRlLWxlZnRcIj48L2k+ICcgKyBfKCdtYXJrZG93bmVkaXRvci5jcm9wcGVyLnJvdGF0ZV9sZWZ0JylcbiAgICAgICAgICAgICxzY29wZTogdGhpc1xuICAgICAgICAgICAgLHBhcmFtOiAtOTBcbiAgICAgICAgICAgICxhY3Rpb246ICdyb3RhdGUnXG4gICAgICAgICAgICAsaGFuZGxlcjogdGhpcy5jYWxsQ3JvcHBlckFjdGlvblxuICAgICAgICB9LHtcbiAgICAgICAgICAgIHRleHQ6ICc8aSBjbGFzcz1cImljb24gaWNvbi1yb3RhdGUtcmlnaHRcIj48L2k+ICcgKyBfKCdtYXJrZG93bmVkaXRvci5jcm9wcGVyLnJvdGF0ZV9yaWdodCcpXG4gICAgICAgICAgICAsc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICxwYXJhbTogOTBcbiAgICAgICAgICAgICxhY3Rpb246ICdyb3RhdGUnXG4gICAgICAgICAgICAsaGFuZGxlcjogdGhpcy5jYWxsQ3JvcHBlckFjdGlvblxuICAgICAgICB9LHtcbiAgICAgICAgICAgIHRleHQ6ICc8aSBjbGFzcz1cImljb24gaWNvbi1yZW1vdmVcIj48L2k+ICcgKyBfKCdtYXJrZG93bmVkaXRvci5jcm9wcGVyLmNsZWFyX2Nyb3BwZXInKVxuICAgICAgICAgICAgLHNjb3BlOiB0aGlzXG4gICAgICAgICAgICAscGFyYW06IG51bGxcbiAgICAgICAgICAgICxhY3Rpb246ICdjbGVhcidcbiAgICAgICAgICAgICxoYW5kbGVyOiB0aGlzLmNhbGxDcm9wcGVyQWN0aW9uXG4gICAgICAgIH1dXG4gICAgICAgICxidXR0b25zOiBbe1xuICAgICAgICAgICAgdGV4dDogXygnY2FuY2VsJylcbiAgICAgICAgICAgICxzY29wZTogdGhpc1xuICAgICAgICAgICAgLGhhbmRsZXI6IHRoaXMuY2xvc2VcbiAgICAgICAgfSx7XG4gICAgICAgICAgICB0ZXh0OiBfKCdtYXJrZG93bmVkaXRvci5jcm9wcGVyLnVwbG9hZCcpXG4gICAgICAgICAgICAsY2xzOiAncHJpbWFyeS1idXR0b24nXG4gICAgICAgICAgICAsc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICxjcm9wOiAwXG4gICAgICAgICAgICAsaGFuZGxlcjogdGhpcy51cGxvYWRcbiAgICAgICAgfSx7XG4gICAgICAgICAgICB0ZXh0OiBfKCdtYXJrZG93bmVkaXRvci5jcm9wcGVyLmNyb3BfdXBsb2FkJylcbiAgICAgICAgICAgICxjbHM6ICdwcmltYXJ5LWJ1dHRvbidcbiAgICAgICAgICAgICxzY29wZTogdGhpc1xuICAgICAgICAgICAgLGNyb3A6IDFcbiAgICAgICAgICAgICxoYW5kbGVyOiB0aGlzLnVwbG9hZFxuICAgICAgICB9XVxuICAgICAgICAsbGlzdGVuZXJzOiB7XG4gICAgICAgICAgICAnc2hvdyc6IHtcbiAgICAgICAgICAgICAgICBmbjogZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjcm9wcGVyT3B0aW9ucyA9IHt9O1xuICAgICAgICAgICAgICAgICAgICB0aGlzLiRjcm9wcGVyRWwgPSAkKCcjJyArIHRoaXMuaWQgKyAnICcgKyBjb25maWcuY3JvcHBlclNlbGVjdG9yKTtcblxuICAgICAgICAgICAgICAgICAgICB2YXIgcmF0aW8gPSBNT0R4LmNvbmZpZ1snbWFya2Rvd25lZGl0b3IuY3JvcHBlci5hc3BlY3RfcmF0aW8nXTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHJhdGlvKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByYXRpby5yZXBsYWNlKC9bXi06eCgpXFxkLyorLl0vZywgJycpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmF0aW8gPSBldmFsKHJhdGlvKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgY3JvcHBlck9wdGlvbnMuYXNwZWN0UmF0aW8gPSByYXRpbztcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIGNyb3BwZXJPcHRpb25zLmNyb3AgPSBmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbWFnZURhdGEgPSBbXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3tcInhcIjonICsgZGF0YS54LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdcInlcIjonICsgZGF0YS55LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdcImhlaWdodFwiOicgKyBkYXRhLmhlaWdodCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnXCJ3aWR0aFwiOicgKyBkYXRhLndpZHRoLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdcInJvdGF0ZVwiOicgKyBkYXRhLnJvdGF0ZSArICd9J1xuICAgICAgICAgICAgICAgICAgICAgICAgXS5qb2luKCk7XG4gICAgICAgICAgICAgICAgICAgIH0uYmluZCh0aGlzKTtcblxuICAgICAgICAgICAgICAgICAgICB0aGlzLiRjcm9wcGVyRWwuY3JvcHBlcihjcm9wcGVyT3B0aW9ucyk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBzY29wZTogdGhpc1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSk7XG4gICAgbWFya2Rvd25FZGl0b3Iud2luZG93LkNyb3BwZXIuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsY29uZmlnKTtcbiAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcblxufTtcbkV4dC5leHRlbmQobWFya2Rvd25FZGl0b3Iud2luZG93LkNyb3BwZXIsIEV4dC5XaW5kb3cse1xuICAgIGltYWdlRGF0YTogJydcbiAgICAsdXBsb2FkOiBmdW5jdGlvbihidXR0b24pIHtcbiAgICAgICAgdmFyIHVwbG9hZGVyID0gdGhpcy5jb25maWcubWQuY3JlYXRlVXBsb2FkZXIoJ2ltYWdlJywgdGhpcy5jb25maWcuZmlsZS5uYW1lKTtcblxuICAgICAgICB2YXIgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcbiAgICAgICAgZm9ybURhdGEuYXBwZW5kKCdmaWxlJywgdGhpcy5jb25maWcuZmlsZSk7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnYWN0aW9uJywgJ21nci9lZGl0b3IvaW1hZ2V1cGxvYWQnKTtcbiAgICAgICAgZm9ybURhdGEuYXBwZW5kKCdpbWFnZURhdGEnLCB0aGlzLmltYWdlRGF0YSk7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnbmFtZScsIHRoaXMuY29uZmlnLmZpbGUubmFtZSk7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnY3JvcCcsIGJ1dHRvbi5jcm9wKTtcbiAgICAgICAgZm9ybURhdGEuYXBwZW5kKCdyZXNvdXJjZScsIHRoaXMuY29uZmlnLm1kLmNvbmZpZy5yZXNvdXJjZSk7XG5cbiAgICAgICAgdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgICAgICB4aHIub3BlbignUE9TVCcsIG1hcmtkb3duRWRpdG9yLmNvbmZpZy5jb25uZWN0b3JVcmwpO1xuICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignUG93ZXJlZC1CeScsICdNT0R4Jyk7XG4gICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdtb2RBdXRoJywgRXh0LkFqYXguZGVmYXVsdEhlYWRlcnMubW9kQXV0aCk7XG5cbiAgICAgICAgeGhyLnVwbG9hZC5vbnByb2dyZXNzID0gZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgICAgICBpZiAoZXZlbnQubGVuZ3RoQ29tcHV0YWJsZSkge1xuICAgICAgICAgICAgICAgIHZhciBjb21wbGV0ZSA9IChldmVudC5sb2FkZWQgLyBldmVudC50b3RhbCAqIDEwMCB8IDApO1xuICAgICAgICAgICAgICAgIHVwbG9hZGVyLmNoaWxkKCcucHJvZ3Jlc3MnKS5zZXRXaWR0aChjb21wbGV0ZSArICclJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0uYmluZCh0aGlzKTtcblxuICAgICAgICB4aHIub25sb2FkID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKHhoci5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgICAgICAgICAgIHZhciByZXMgPSBKU09OLnBhcnNlKHhoci5yZXNwb25zZVRleHQpO1xuXG4gICAgICAgICAgICAgICAgaWYgKHJlcy5zdWNjZXNzID09IHRydWUpIHtcbiAgICAgICAgICAgICAgICAgICAgdXBsb2FkZXIucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29uZmlnLm1kLmVkaXRvci5pbnNlcnQoJyFbJyArIHJlcy5vYmplY3QubmFtZSArICddKCcgKyByZXMub2JqZWN0LnBhdGggKyAnIFwiJyArIHJlcy5vYmplY3QubmFtZSArICdcIilcXG5cXG4nKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZy5tZC5mYWlsVXBsb2FkZXIodXBsb2FkZXIsIHJlcy5tZXNzYWdlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0uYmluZCh0aGlzKTtcblxuICAgICAgICB4aHIuc2VuZChmb3JtRGF0YSk7XG5cbiAgICAgICAgdGhpcy5jbG9zZSgpO1xuICAgIH1cblxuICAgICxjYWxsQ3JvcHBlckFjdGlvbjogZnVuY3Rpb24oYnRuKSB7XG4gICAgICAgIHRoaXMuJGNyb3BwZXJFbC5jcm9wcGVyKGJ0bi5hY3Rpb24sIGJ0bi5wYXJhbSk7XG4gICAgfVxuXG4gICAgLGNsb3NlOiBmdW5jdGlvbigpIHtcbiAgICAgICAgdGhpcy4kY3JvcHBlckVsLmNyb3BwZXIoXCJkZXN0cm95XCIpO1xuXG4gICAgICAgIG1hcmtkb3duRWRpdG9yLndpbmRvdy5Dcm9wcGVyLnN1cGVyY2xhc3MuY2xvc2UuY2FsbCh0aGlzKTtcbiAgICAgICAgdGhpcy5jb25maWcubWQuZWRpdG9yLmZvY3VzKCk7XG4gICAgfVxufSk7XG5FeHQucmVnKCdtYXJrZG93bmVkaXRvci13aW5kb3ctY3JvcHBlcicsbWFya2Rvd25FZGl0b3Iud2luZG93LkNyb3BwZXIpO1xuIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9