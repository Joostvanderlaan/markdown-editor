var MarkdownEditor=function(e){e=e||{},MarkdownEditor.superclass.constructor.call(this,e)};Ext.override(MODx.panel.Resource,{}),Ext.extend(MarkdownEditor,Ext.Component,{window:{},remarkable:"",initComponent:function(){MarkdownEditor.superclass.initComponent.call(this),Ext.onReady(this.render,this)},parseRequest:"",parse:function(e){var t=this.remarkable.render(e);return t=t.replace(/%5B/g,"["),t=t.replace(/%5D/g,"]"),this.parseRequest&&clearTimeout(this.parseRequest),this.parseRequest=setTimeout(function(){MODx.Ajax.request({url:MarkdownEditor_config.connectorUrl,params:{action:"mgr/editor/processcontent",content:t,resource:MODx.request.id},isUpload:!0,listeners:{success:{fn:function(e){Ext.get("preview-md").update(e.data)},scope:this}}})},150),this.taMarkdown.dom.value=this.editor.getValue(),this.textarea.dom.value=t,t},buildUI:function(){this.textarea.setDisplayed("none"),this.textarea.setWidth(0),this.textarea.setHeight(0),Ext.DomHelper.insertBefore(this.textarea,{tag:"textarea",name:"ta_markdown",id:"ta_markdown"}),this.taMarkdown=Ext.get("ta_markdown"),this.taMarkdown.setDisplayed("none"),this.taMarkdown.setWidth(0),this.taMarkdown.setHeight(0);var e=Ext.DomHelper.insertBefore(this.textarea,{tag:"div","class":"markdown-container"});Ext.DomHelper.append(e,{tag:"div",id:"content-md","class":this.textarea.dom.className}),Ext.DomHelper.append(e,{tag:"div",id:"preview-md","class":"markdown-body"}),Ext.DomHelper.append(e,{tag:"div",id:"toolbox",cn:[{tag:"span",id:"preview-button",html:'<i class="icon icon-toggle-off"></i> Preview'},{tag:"span",id:"fullscreen-button",html:'<i class="icon icon-expand"></i>'}]}),Ext.DomHelper.append(e,{tag:"div",id:"status-bar",html:"Attach images by dragging & dropping,  selecting them, or pasting from the clipboard."}),Ext.DomHelper.append(e,{tag:"span",style:"clear: both"})},registerAce:function(){this.editor=ace.edit(Ext.DomQuery.selectNode("div#content-md")),this.editor.setOptions({maxLines:1/0,minLines:25,enableBasicAutocompletion:!0}),this.editor.renderer.setShowGutter(!0),this.editor.renderer.setScrollMargin(10,10),this.editor.getSession().setValue(this.textarea.getValue()),this.editor.getSession().setMode("ace/mode/markdown"),this.editor.setTheme("ace/theme/monokai");var e=ace.require("ace/ext/language_tools"),t={getCompletions:function(e,t,i,o,r){return 0===o.length?(r(null,[]),void 0):(MODx.Ajax.request({url:MarkdownEditor_config.connectorUrl,params:{action:"mgr/resource/getlist",prefix:o},listeners:{success:{fn:function(e){r(null,e.results)},scope:this}}}),void 0)}};e.addCompleter(t),this.editor.container.addEventListener("dragenter",this.catchAndDoNothing,!1),this.editor.container.addEventListener("dragover",this.catchAndDoNothing,!1),this.editor.container.addEventListener("drop",this.drop.bind(this),!1)},catchAndDoNothing:function(e){e.stopPropagation(),e.preventDefault()},drop:function(e){e.stopPropagation(),e.preventDefault(),Ext.each(e.dataTransfer.files,function(e){"image/jpeg"==e.type?(MODx.load({xtype:"markdowneditor-window-cropper",file:e,md:this}).show(),$(".image-upload-wrapper > img").cropper({aspectRatio:1})):console.log("not image")},this)},registerMarked:function(){this.remarkable=new Remarkable({html:!0,highlight:function(e,t){if(t&&hljs.getLanguage(t))try{return hljs.highlight(t,e).value}catch(i){}try{return hljs.highlightAuto(e).value}catch(i){}return""}}),this.remarkable.inline.ruler.disable(["backticks"])},render:function(){var e=this;this.textarea=Ext.get("ta"),this.buildUI(),this.registerAce(),this.registerMarked();var t=Ext.get("preview-button"),i=Ext.get("fullscreen-button"),o=Ext.get("preview-md"),r=Ext.get("content-md"),s=r.parent(),a=MODx.load({xtype:"modx-treedrop",target:r,targetEl:r,onInsert:function(e){return this.insert(e),this.focus(),!0}.bind(this.editor),iframe:!0});this.textarea.on("destroy",function(){a.destroy()}),t.addListener("click",function(){o.isVisible()?(o.setDisplayed("none"),r.setDisplayed("block"),t.child("i").removeClass("icon-toggle-on"),t.child("i").addClass("icon-toggle-off")):(o.setDisplayed("block"),r.setDisplayed("none"),t.child("i").removeClass("icon-toggle-off"),t.child("i").addClass("icon-toggle-on"))}),i.addListener("click",function(){var e=i.child("i");e.hasClass("icon-expand")?(e.removeClass("icon-expand"),e.addClass("icon-compress"),o.setDisplayed("block"),r.setDisplayed("block"),t.hide(),s.addClass("fullscreen"),this.editor.setOption("maxLines",null)):(e.addClass("icon-expand"),e.removeClass("icon-compress"),o.setDisplayed("none"),r.setDisplayed("block"),t.show(),s.removeClass("fullscreen"),this.editor.setOption("maxLines",1/0)),this.editor.resize(!0)},this),this.editor.setValue(MarkdownEditor_content.content),this.editor.selection.clearSelection(),o.update(this.parse(this.editor.getValue())),this.editor.getSession().on("change",function(){e.parse(e.editor.getValue())})}}),MarkdownEditor=new MarkdownEditor;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxHQUFBLGdCQUFBLFNBQUEsR0FDQSxFQUFBLE1BQ0EsZUFBQSxXQUFBLFlBQUEsS0FBQSxLQUFBLEdBRUEsS0FBQSxTQUFBLEtBQUEsTUFBQSxhQUVBLElBQUEsT0FBQSxlQUFBLElBQUEsV0FDQSxVQUNBLFdBQUEsR0FDQSxjQUFBLFdBQ0EsZUFBQSxXQUFBLGNBQUEsS0FBQSxNQUVBLElBQUEsUUFBQSxLQUFBLE9BQUEsT0FHQSxhQUFBLEdBQ0EsTUFBQSxTQUFBLEdBQ0EsR0FBQSxHQUFBLEtBQUEsV0FBQSxPQUFBLEVBZ0NBLE9BOUJBLEdBQUEsRUFBQSxRQUFBLE9BQUEsS0FDQSxFQUFBLEVBQUEsUUFBQSxPQUFBLEtBRUEsS0FBQSxjQUNBLGFBQUEsS0FBQSxjQUdBLEtBQUEsYUFBQSxXQUFBLFdBQ0EsS0FBQSxLQUFBLFNBQ0EsSUFBQSxzQkFBQSxhQUNBLFFBQ0EsT0FBQSw0QkFDQSxRQUFBLEVBQ0EsU0FBQSxLQUFBLFFBQUEsSUFFQSxVQUFBLEVBQ0EsV0FDQSxTQUNBLEdBQUEsU0FBQSxHQUNBLElBQUEsSUFBQSxjQUFBLE9BQUEsRUFBQSxPQUVBLE1BQUEsVUFJQSxLQUVBLEtBQUEsV0FBQSxJQUFBLE1BQUEsS0FBQSxPQUFBLFdBQ0EsS0FBQSxTQUFBLElBQUEsTUFBQSxFQUVBLEdBR0EsUUFBQSxXQUNBLEtBQUEsU0FBQSxhQUFBLFFBQ0EsS0FBQSxTQUFBLFNBQUEsR0FDQSxLQUFBLFNBQUEsVUFBQSxHQUVBLElBQUEsVUFBQSxhQUFBLEtBQUEsVUFDQSxJQUFBLFdBQ0EsS0FBQSxjQUNBLEdBQUEsZ0JBR0EsS0FBQSxXQUFBLElBQUEsSUFBQSxlQUNBLEtBQUEsV0FBQSxhQUFBLFFBQ0EsS0FBQSxXQUFBLFNBQUEsR0FDQSxLQUFBLFdBQUEsVUFBQSxFQUVBLElBQUEsR0FBQSxJQUFBLFVBQUEsYUFBQSxLQUFBLFVBQ0EsSUFBQSxNQUNBLFFBQUEsc0JBR0EsS0FBQSxVQUFBLE9BQUEsR0FDQSxJQUFBLE1BQ0EsR0FBQSxhQUNBLFFBQUEsS0FBQSxTQUFBLElBQUEsWUFHQSxJQUFBLFVBQUEsT0FBQSxHQUNBLElBQUEsTUFDQSxHQUFBLGFBQ0EsUUFBQSxrQkFHQSxJQUFBLFVBQUEsT0FBQSxHQUNBLElBQUEsTUFDQSxHQUFBLFVBQ0EsS0FDQSxJQUFBLE9BQ0EsR0FBQSxpQkFDQSxLQUFBLGlEQUVBLElBQUEsT0FDQSxHQUFBLG9CQUNBLEtBQUEsdUNBSUEsSUFBQSxVQUFBLE9BQUEsR0FDQSxJQUFBLE1BQ0EsR0FBQSxhQUNBLEtBQUEsMEZBR0EsSUFBQSxVQUFBLE9BQUEsR0FDQSxJQUFBLE9BQ0EsTUFBQSxpQkFJQSxZQUFBLFdBRUEsS0FBQSxPQUFBLElBQUEsS0FBQSxJQUFBLFNBQUEsV0FBQSxtQkFDQSxLQUFBLE9BQUEsWUFDQSxTQUFBLElBQ0EsU0FBQSxHQUNBLDJCQUFBLElBRUEsS0FBQSxPQUFBLFNBQUEsZUFBQSxHQUNBLEtBQUEsT0FBQSxTQUFBLGdCQUFBLEdBQUEsSUFDQSxLQUFBLE9BQUEsYUFBQSxTQUFBLEtBQUEsU0FBQSxZQUNBLEtBQUEsT0FBQSxhQUFBLFFBQUEscUJBQ0EsS0FBQSxPQUFBLFNBQUEsb0JBRUEsSUFBQSxHQUFBLElBQUEsUUFBQSwwQkFDQSxHQUNBLGVBQUEsU0FBQSxFQUFBLEVBQUEsRUFBQSxFQUFBLEdBQ0EsTUFBQSxLQUFBLEVBQUEsUUFBQSxFQUFBLFNBQUEsU0FDQSxLQUFBLEtBQUEsU0FDQSxJQUFBLHNCQUFBLGFBQ0EsUUFDQSxPQUFBLHVCQUNBLE9BQUEsR0FFQSxXQUNBLFNBQ0EsR0FBQSxTQUFBLEdBQ0EsRUFBQSxLQUFBLEVBQUEsVUFFQSxNQUFBLFNBWEEsU0FrQkEsR0FBQSxhQUFBLEdBRUEsS0FBQSxPQUFBLFVBQUEsaUJBQUEsWUFBQSxLQUFBLG1CQUFBLEdBQ0EsS0FBQSxPQUFBLFVBQUEsaUJBQUEsV0FBQSxLQUFBLG1CQUFBLEdBQ0EsS0FBQSxPQUFBLFVBQUEsaUJBQUEsT0FBQSxLQUFBLEtBQUEsS0FBQSxPQUFBLElBR0Esa0JBQUEsU0FBQSxHQUNBLEVBQUEsa0JBQ0EsRUFBQSxrQkFHQSxLQUFBLFNBQUEsR0FDQSxFQUFBLGtCQUNBLEVBQUEsaUJBRUEsSUFBQSxLQUFBLEVBQUEsYUFBQSxNQUFBLFNBQUEsR0FFQSxjQUFBLEVBQUEsTUFDQSxLQUFBLE1BQ0EsTUFBQSxnQ0FDQSxLQUFBLEVBQ0EsR0FBQSxPQUNBLE9BRUEsRUFBQSwrQkFBQSxTQUNBLFlBQUEsS0FHQSxRQUFBLElBQUEsY0FtQ0EsT0FJQSxlQUFBLFdBRUEsS0FBQSxXQUFBLEdBQUEsYUFDQSxNQUFBLEVBQ0EsVUFBQSxTQUFBLEVBQUEsR0FDQSxHQUFBLEdBQUEsS0FBQSxZQUFBLEdBQ0EsSUFDQSxNQUFBLE1BQUEsVUFBQSxFQUFBLEdBQUEsTUFDQSxNQUFBLElBR0EsSUFDQSxNQUFBLE1BQUEsY0FBQSxHQUFBLE1BQ0EsTUFBQSxJQUVBLE1BQUEsTUFHQSxLQUFBLFdBQUEsT0FBQSxNQUFBLFNBQUEsZUFHQSxPQUFBLFdBQ0EsR0FBQSxHQUFBLElBQ0EsTUFBQSxTQUFBLElBQUEsSUFBQSxNQUVBLEtBQUEsVUFDQSxLQUFBLGNBQ0EsS0FBQSxnQkFVQSxJQUFBLEdBQUEsSUFBQSxJQUFBLGtCQUNBLEVBQUEsSUFBQSxJQUFBLHFCQUNBLEVBQUEsSUFBQSxJQUFBLGNBQ0EsRUFBQSxJQUFBLElBQUEsY0FDQSxFQUFBLEVBQUEsU0FFQSxFQUFBLEtBQUEsTUFDQSxNQUFBLGdCQUNBLE9BQUEsRUFDQSxTQUFBLEVBQ0EsU0FBQSxTQUFBLEdBR0EsTUFGQSxNQUFBLE9BQUEsR0FDQSxLQUFBLFNBQ0EsR0FDQSxLQUFBLEtBQUEsUUFDQSxRQUFBLEdBRUEsTUFBQSxTQUFBLEdBQUEsVUFBQSxXQUFBLEVBQUEsWUFFQSxFQUFBLFlBQUEsUUFBQSxXQUNBLEVBQUEsYUFDQSxFQUFBLGFBQUEsUUFDQSxFQUFBLGFBQUEsU0FFQSxFQUFBLE1BQUEsS0FBQSxZQUFBLGtCQUNBLEVBQUEsTUFBQSxLQUFBLFNBQUEscUJBRUEsRUFBQSxhQUFBLFNBQ0EsRUFBQSxhQUFBLFFBRUEsRUFBQSxNQUFBLEtBQUEsWUFBQSxtQkFDQSxFQUFBLE1BQUEsS0FBQSxTQUFBLHFCQUlBLEVBQUEsWUFBQSxRQUFBLFdBQ0EsR0FBQSxHQUFBLEVBQUEsTUFBQSxJQUVBLEdBQUEsU0FBQSxnQkFDQSxFQUFBLFlBQUEsZUFDQSxFQUFBLFNBQUEsaUJBRUEsRUFBQSxhQUFBLFNBQ0EsRUFBQSxhQUFBLFNBRUEsRUFBQSxPQUVBLEVBQUEsU0FBQSxjQUVBLEtBQUEsT0FBQSxVQUFBLFdBQUEsUUFJQSxFQUFBLFNBQUEsZUFDQSxFQUFBLFlBQUEsaUJBRUEsRUFBQSxhQUFBLFFBQ0EsRUFBQSxhQUFBLFNBRUEsRUFBQSxPQUVBLEVBQUEsWUFBQSxjQUVBLEtBQUEsT0FBQSxVQUFBLFdBQUEsTUFLQSxLQUFBLE9BQUEsUUFBQSxJQUNBLE1BRUEsS0FBQSxPQUFBLFNBQUEsdUJBQUEsU0FDQSxLQUFBLE9BQUEsVUFBQSxpQkFFQSxFQUFBLE9BQUEsS0FBQSxNQUFBLEtBQUEsT0FBQSxhQUVBLEtBQUEsT0FBQSxhQUFBLEdBQUEsU0FBQSxXQUNBLEVBQUEsTUFBQSxFQUFBLE9BQUEsaUJBU0EsZUFBQSxHQUFBIiwiZmlsZSI6ImFwcC5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBNYXJrZG93bkVkaXRvciA9IGZ1bmN0aW9uKGNvbmZpZykge1xuICAgIGNvbmZpZyA9IGNvbmZpZyB8fCB7fTtcbiAgICBNYXJrZG93bkVkaXRvci5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcyxjb25maWcpO1xufTtcbkV4dC5vdmVycmlkZShNT0R4LnBhbmVsLlJlc291cmNlLCB7fSk7XG5cbkV4dC5leHRlbmQoTWFya2Rvd25FZGl0b3IsRXh0LkNvbXBvbmVudCx7XG4gICAgd2luZG93OiB7fVxuICAgICxyZW1hcmthYmxlOiAnJ1xuICAgICxpbml0Q29tcG9uZW50OiBmdW5jdGlvbigpIHtcbiAgICAgICAgTWFya2Rvd25FZGl0b3Iuc3VwZXJjbGFzcy5pbml0Q29tcG9uZW50LmNhbGwodGhpcyk7XG5cbiAgICAgICAgRXh0Lm9uUmVhZHkodGhpcy5yZW5kZXIsIHRoaXMpO1xuICAgIH1cblxuICAgICxwYXJzZVJlcXVlc3Q6ICcnXG4gICAgLHBhcnNlOiBmdW5jdGlvbihpbnB1dCkge1xuICAgICAgICB2YXIgb3V0cHV0ID0gdGhpcy5yZW1hcmthYmxlLnJlbmRlcihpbnB1dCk7XG5cbiAgICAgICAgb3V0cHV0ID0gb3V0cHV0LnJlcGxhY2UoLyU1Qi9nLCAnWycpO1xuICAgICAgICBvdXRwdXQgPSBvdXRwdXQucmVwbGFjZSgvJTVEL2csICddJyk7XG5cbiAgICAgICAgaWYgKHRoaXMucGFyc2VSZXF1ZXN0KSB7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5wYXJzZVJlcXVlc3QpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5wYXJzZVJlcXVlc3QgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICBNT0R4LkFqYXgucmVxdWVzdCh7XG4gICAgICAgICAgICAgICAgdXJsOiBNYXJrZG93bkVkaXRvcl9jb25maWcuY29ubmVjdG9yVXJsXG4gICAgICAgICAgICAgICAgLHBhcmFtczoge1xuICAgICAgICAgICAgICAgICAgICBhY3Rpb246ICdtZ3IvZWRpdG9yL3Byb2Nlc3Njb250ZW50J1xuICAgICAgICAgICAgICAgICAgICAsY29udGVudDogb3V0cHV0XG4gICAgICAgICAgICAgICAgICAgICxyZXNvdXJjZTogTU9EeC5yZXF1ZXN0LmlkXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBpc1VwbG9hZCA6IHRydWUsXG4gICAgICAgICAgICAgICAgbGlzdGVuZXJzOiB7XG4gICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm46IGZ1bmN0aW9uKHIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBFeHQuZ2V0KCdwcmV2aWV3LW1kJykudXBkYXRlKHIuZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9LCAxNTApO1xuXG4gICAgICAgIHRoaXMudGFNYXJrZG93bi5kb20udmFsdWUgPSB0aGlzLmVkaXRvci5nZXRWYWx1ZSgpO1xuICAgICAgICB0aGlzLnRleHRhcmVhLmRvbS52YWx1ZSA9IG91dHB1dDtcblxuICAgICAgICByZXR1cm4gb3V0cHV0O1xuICAgIH1cblxuICAgICxidWlsZFVJOiBmdW5jdGlvbigpIHtcbiAgICAgICAgdGhpcy50ZXh0YXJlYS5zZXREaXNwbGF5ZWQoJ25vbmUnKTtcbiAgICAgICAgdGhpcy50ZXh0YXJlYS5zZXRXaWR0aCgwKTtcbiAgICAgICAgdGhpcy50ZXh0YXJlYS5zZXRIZWlnaHQoMCk7XG5cbiAgICAgICAgRXh0LkRvbUhlbHBlci5pbnNlcnRCZWZvcmUodGhpcy50ZXh0YXJlYSwge1xuICAgICAgICAgICAgdGFnOiAndGV4dGFyZWEnLFxuICAgICAgICAgICAgbmFtZTogJ3RhX21hcmtkb3duJyxcbiAgICAgICAgICAgIGlkOiAndGFfbWFya2Rvd24nXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMudGFNYXJrZG93biA9IEV4dC5nZXQoJ3RhX21hcmtkb3duJyk7XG4gICAgICAgIHRoaXMudGFNYXJrZG93bi5zZXREaXNwbGF5ZWQoJ25vbmUnKTtcbiAgICAgICAgdGhpcy50YU1hcmtkb3duLnNldFdpZHRoKDApO1xuICAgICAgICB0aGlzLnRhTWFya2Rvd24uc2V0SGVpZ2h0KDApO1xuXG4gICAgICAgIHZhciB3cmFwcGVyID0gRXh0LkRvbUhlbHBlci5pbnNlcnRCZWZvcmUodGhpcy50ZXh0YXJlYSwge1xuICAgICAgICAgICAgdGFnOiAnZGl2JyxcbiAgICAgICAgICAgIGNsYXNzOiAnbWFya2Rvd24tY29udGFpbmVyJ1xuICAgICAgICB9KTtcblxuICAgICAgICBFeHQuRG9tSGVscGVyLmFwcGVuZCh3cmFwcGVyLHtcbiAgICAgICAgICAgIHRhZzogJ2RpdicsXG4gICAgICAgICAgICBpZDogJ2NvbnRlbnQtbWQnLFxuICAgICAgICAgICAgY2xhc3M6IHRoaXMudGV4dGFyZWEuZG9tLmNsYXNzTmFtZVxuICAgICAgICB9KTtcblxuICAgICAgICBFeHQuRG9tSGVscGVyLmFwcGVuZCh3cmFwcGVyLHtcbiAgICAgICAgICAgIHRhZzogJ2RpdicsXG4gICAgICAgICAgICBpZDogJ3ByZXZpZXctbWQnLFxuICAgICAgICAgICAgY2xhc3M6ICdtYXJrZG93bi1ib2R5J1xuICAgICAgICB9KTtcblxuICAgICAgICBFeHQuRG9tSGVscGVyLmFwcGVuZCh3cmFwcGVyLHtcbiAgICAgICAgICAgIHRhZzogJ2RpdicsXG4gICAgICAgICAgICBpZDogJ3Rvb2xib3gnLFxuICAgICAgICAgICAgY246IFt7XG4gICAgICAgICAgICAgICAgdGFnOiAnc3BhbicsXG4gICAgICAgICAgICAgICAgaWQ6ICdwcmV2aWV3LWJ1dHRvbicsXG4gICAgICAgICAgICAgICAgaHRtbDogJzxpIGNsYXNzPVwiaWNvbiBpY29uLXRvZ2dsZS1vZmZcIj48L2k+IFByZXZpZXcnXG4gICAgICAgICAgICB9LHtcbiAgICAgICAgICAgICAgICB0YWc6ICdzcGFuJyxcbiAgICAgICAgICAgICAgICBpZDogJ2Z1bGxzY3JlZW4tYnV0dG9uJyxcbiAgICAgICAgICAgICAgICBodG1sOiAnPGkgY2xhc3M9XCJpY29uIGljb24tZXhwYW5kXCI+PC9pPidcbiAgICAgICAgICAgIH1dXG4gICAgICAgIH0pO1xuXG4gICAgICAgIEV4dC5Eb21IZWxwZXIuYXBwZW5kKHdyYXBwZXIse1xuICAgICAgICAgICAgdGFnOiAnZGl2JyxcbiAgICAgICAgICAgIGlkOiAnc3RhdHVzLWJhcicsXG4gICAgICAgICAgICBodG1sOiAnQXR0YWNoIGltYWdlcyBieSBkcmFnZ2luZyAmIGRyb3BwaW5nLCAgc2VsZWN0aW5nIHRoZW0sIG9yIHBhc3RpbmcgZnJvbSB0aGUgY2xpcGJvYXJkLidcbiAgICAgICAgfSk7XG5cbiAgICAgICAgRXh0LkRvbUhlbHBlci5hcHBlbmQod3JhcHBlcix7XG4gICAgICAgICAgICB0YWc6ICdzcGFuJyxcbiAgICAgICAgICAgIHN0eWxlOiAnY2xlYXI6IGJvdGgnLFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAscmVnaXN0ZXJBY2U6IGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgbWRlID0gdGhpcztcbiAgICAgICAgdGhpcy5lZGl0b3IgPSBhY2UuZWRpdChFeHQuRG9tUXVlcnkuc2VsZWN0Tm9kZSgnZGl2I2NvbnRlbnQtbWQnKSk7XG4gICAgICAgIHRoaXMuZWRpdG9yLnNldE9wdGlvbnMoe1xuICAgICAgICAgICAgbWF4TGluZXM6IEluZmluaXR5LFxuICAgICAgICAgICAgbWluTGluZXM6IDI1LFxuICAgICAgICAgICAgZW5hYmxlQmFzaWNBdXRvY29tcGxldGlvbjogdHJ1ZVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5lZGl0b3IucmVuZGVyZXIuc2V0U2hvd0d1dHRlcih0cnVlKTtcbiAgICAgICAgdGhpcy5lZGl0b3IucmVuZGVyZXIuc2V0U2Nyb2xsTWFyZ2luKDEwLCAxMCk7XG4gICAgICAgIHRoaXMuZWRpdG9yLmdldFNlc3Npb24oKS5zZXRWYWx1ZSh0aGlzLnRleHRhcmVhLmdldFZhbHVlKCkpO1xuICAgICAgICB0aGlzLmVkaXRvci5nZXRTZXNzaW9uKCkuc2V0TW9kZShcImFjZS9tb2RlL21hcmtkb3duXCIpO1xuICAgICAgICB0aGlzLmVkaXRvci5zZXRUaGVtZShcImFjZS90aGVtZS9tb25va2FpXCIpO1xuXG4gICAgICAgIHZhciBsYW5nVG9vbHMgPSBhY2UucmVxdWlyZShcImFjZS9leHQvbGFuZ3VhZ2VfdG9vbHNcIik7XG4gICAgICAgIHZhciByaHltZUNvbXBsZXRlciA9IHtcbiAgICAgICAgICAgIGdldENvbXBsZXRpb25zOiBmdW5jdGlvbihlZGl0b3IsIHNlc3Npb24sIHBvcywgcHJlZml4LCBjYWxsYmFjaykge1xuICAgICAgICAgICAgICAgIGlmIChwcmVmaXgubGVuZ3RoID09PSAwKSB7IGNhbGxiYWNrKG51bGwsIFtdKTsgcmV0dXJuIH1cbiAgICAgICAgICAgICAgICBNT0R4LkFqYXgucmVxdWVzdCh7XG4gICAgICAgICAgICAgICAgICAgIHVybDogTWFya2Rvd25FZGl0b3JfY29uZmlnLmNvbm5lY3RvclVybFxuICAgICAgICAgICAgICAgICAgICAscGFyYW1zOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb246ICdtZ3IvcmVzb3VyY2UvZ2V0bGlzdCdcbiAgICAgICAgICAgICAgICAgICAgICAgICxwcmVmaXg6IHByZWZpeFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnM6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuOiBmdW5jdGlvbihyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHIucmVzdWx0cyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY29wZTogdGhpc1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgbGFuZ1Rvb2xzLmFkZENvbXBsZXRlcihyaHltZUNvbXBsZXRlcik7XG5cbiAgICAgICAgdGhpcy5lZGl0b3IuY29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoXCJkcmFnZW50ZXJcIiwgdGhpcy5jYXRjaEFuZERvTm90aGluZywgZmFsc2UpO1xuICAgICAgICB0aGlzLmVkaXRvci5jb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcihcImRyYWdvdmVyXCIsIHRoaXMuY2F0Y2hBbmREb05vdGhpbmcsIGZhbHNlKTtcbiAgICAgICAgdGhpcy5lZGl0b3IuY29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoXCJkcm9wXCIsIHRoaXMuZHJvcC5iaW5kKHRoaXMpLCBmYWxzZSk7XG4gICAgfVxuXG4gICAgLGNhdGNoQW5kRG9Ob3RoaW5nOiBmdW5jdGlvbihlKSB7XG4gICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICB9XG5cbiAgICAsZHJvcDogZnVuY3Rpb24oZSkge1xuICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG5cbiAgICAgICAgRXh0LmVhY2goZS5kYXRhVHJhbnNmZXIuZmlsZXMsIGZ1bmN0aW9uKGZpbGUpIHtcblxuICAgICAgICAgICAgaWYgKGZpbGUudHlwZSA9PSAnaW1hZ2UvanBlZycpIHtcbiAgICAgICAgICAgICAgICBNT0R4LmxvYWQoe1xuICAgICAgICAgICAgICAgICAgICB4dHlwZTogJ21hcmtkb3duZWRpdG9yLXdpbmRvdy1jcm9wcGVyJ1xuICAgICAgICAgICAgICAgICAgICAsZmlsZTogZmlsZVxuICAgICAgICAgICAgICAgICAgICAsbWQ6IHRoaXNcbiAgICAgICAgICAgICAgICB9KS5zaG93KCk7XG5cbiAgICAgICAgICAgICAgICAkKCcuaW1hZ2UtdXBsb2FkLXdyYXBwZXIgPiBpbWcnKS5jcm9wcGVyKHtcbiAgICAgICAgICAgICAgICAgICAgYXNwZWN0UmF0aW86IDFcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ25vdCBpbWFnZScpO1xuICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgICAgIC8vdmFyIGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgICAgICAgICAvL2Zvcm1EYXRhLmFwcGVuZCgnZmlsZScsIGZpbGUpO1xuICAgICAgICAgICAgLy9mb3JtRGF0YS5hcHBlbmQoJ2FjdGlvbicsICdtZ3IvZWRpdG9yL3VwbG9hZCcpO1xuICAgICAgICAgICAgLy9cbiAgICAgICAgICAgIC8vdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgICAgICAgICAgLy94aHIub3BlbignUE9TVCcsIE1hcmtkb3duRWRpdG9yX2NvbmZpZy5jb25uZWN0b3JVcmwpO1xuICAgICAgICAgICAgLy94aHIuc2V0UmVxdWVzdEhlYWRlcignUG93ZXJlZC1CeScsICdNT0R4Jyk7XG4gICAgICAgICAgICAvL3hoci5zZXRSZXF1ZXN0SGVhZGVyKCdtb2RBdXRoJywgRXh0LkFqYXguZGVmYXVsdEhlYWRlcnMubW9kQXV0aCk7XG5cbiAgICAgICAgICAgIC8veGhyLnVwbG9hZC5vbnByb2dyZXNzID0gZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgICAgICAvLyAgICBpZiAoZXZlbnQubGVuZ3RoQ29tcHV0YWJsZSkge1xuICAgICAgICAgICAgLy8gICAgICAgIHZhciBjb21wbGV0ZSA9IChldmVudC5sb2FkZWQgLyBldmVudC50b3RhbCAqIDEwMCB8IDApO1xuICAgICAgICAgICAgLy8gICAgICAgIHByb2dyZXNzLnZhbHVlID0gcHJvZ3Jlc3MuaW5uZXJIVE1MID0gY29tcGxldGU7XG4gICAgICAgICAgICAvLyAgICB9XG4gICAgICAgICAgICAvL307XG5cbiAgICAgICAgICAgIC8veGhyLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIC8vICAgIGlmICh4aHIuc3RhdHVzID09PSAyMDApIHtcbiAgICAgICAgICAgIC8vICAgICAgICB2YXIgcmVzID0gSlNPTi5wYXJzZSh4aHIucmVzcG9uc2VUZXh0KTtcbiAgICAgICAgICAgIC8vICAgICAgICBpZiAocmVzLnN1Y2Nlc3MgPT0gdHJ1ZSkge1xuICAgICAgICAgICAgLy8gICAgICAgICAgICBjb25zb2xlLmxvZyhyZXMpO1xuICAgICAgICAgICAgLy8gICAgICAgICAgICB0aGlzLmVkaXRvci5pbnNlcnQoJyFbJyArIHJlcy5uYW1lICsgJ10oJyArIHJlcy5wYXRoICsgJyknKTtcbiAgICAgICAgICAgIC8vICAgICAgICB9XG4gICAgICAgICAgICAvLyAgICAgICAgY29uc29sZS5sb2coJ2FsbCBkb25lOiAnICsgeGhyLnN0YXR1cyk7XG4gICAgICAgICAgICAvLyAgICB9IGVsc2Uge1xuICAgICAgICAgICAgLy8gICAgICAgIGNvbnNvbGUubG9nKCdTb21ldGhpbmcgd2VudCB0ZXJyaWJseSB3cm9uZy4uLicpO1xuICAgICAgICAgICAgLy8gICAgfVxuICAgICAgICAgICAgLy99LmJpbmQodGhpcyk7XG4gICAgICAgICAgICAvL1xuICAgICAgICAgICAgLy94aHIuc2VuZChmb3JtRGF0YSk7XG5cbiAgICAgICAgfSwgdGhpcyk7XG5cbiAgICB9XG5cbiAgICAscmVnaXN0ZXJNYXJrZWQ6IGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgbWRlID0gdGhpcztcbiAgICAgICAgdGhpcy5yZW1hcmthYmxlID0gbmV3IFJlbWFya2FibGUoe1xuICAgICAgICAgICAgaHRtbDogdHJ1ZSxcbiAgICAgICAgICAgIGhpZ2hsaWdodDogZnVuY3Rpb24gKHN0ciwgbGFuZykge1xuICAgICAgICAgICAgICAgIGlmIChsYW5nICYmIGhsanMuZ2V0TGFuZ3VhZ2UobGFuZykpIHtcbiAgICAgICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBobGpzLmhpZ2hsaWdodChsYW5nLCBzdHIpLnZhbHVlO1xuICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHt9XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhsanMuaGlnaGxpZ2h0QXV0byhzdHIpLnZhbHVlO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge31cblxuICAgICAgICAgICAgICAgIHJldHVybiAnJzsgLy8gdXNlIGV4dGVybmFsIGRlZmF1bHQgZXNjYXBpbmdcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMucmVtYXJrYWJsZS5pbmxpbmUucnVsZXIuZGlzYWJsZShbICdiYWNrdGlja3MnIF0pO1xuICAgIH1cblxuICAgICxyZW5kZXI6IGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgbWRlID0gdGhpcztcbiAgICAgICAgdGhpcy50ZXh0YXJlYSA9IEV4dC5nZXQoJ3RhJyk7XG5cbiAgICAgICAgdGhpcy5idWlsZFVJKCk7XG4gICAgICAgIHRoaXMucmVnaXN0ZXJBY2UoKTtcbiAgICAgICAgdGhpcy5yZWdpc3Rlck1hcmtlZCgpO1xuXG5cbiAgICAgICAgLy8gY29weSBiYWNrIHRvIHRleHRhcmVhIG9uIGZvcm0gc3VibWl0Li4uXG4gICAgICAgIC8vdGV4dGFyZWEuY2xvc2VzdCgnZm9ybScpLnN1Ym1pdChmdW5jdGlvbiAoKSB7XG4gICAgICAgIC8vICAgIHRleHRhcmVhLnZhbChlZGl0b3IuZ2V0U2Vzc2lvbigpLmdldFZhbHVlKCkpO1xuICAgICAgICAvL30pO1xuXG5cblxuICAgICAgICB2YXIgcHJldmlld0J1dHRvbiA9IEV4dC5nZXQoJ3ByZXZpZXctYnV0dG9uJyk7XG4gICAgICAgIHZhciBmdWxsc2NyZWVuQnV0dG9uID0gRXh0LmdldCgnZnVsbHNjcmVlbi1idXR0b24nKTtcbiAgICAgICAgdmFyIHByZXZpZXcgPSBFeHQuZ2V0KCdwcmV2aWV3LW1kJyk7XG4gICAgICAgIHZhciBjb250ZW50ID0gRXh0LmdldCgnY29udGVudC1tZCcpO1xuICAgICAgICB2YXIgd3JhcHBlciA9IGNvbnRlbnQucGFyZW50KCk7XG5cbiAgICAgICAgdmFyIGRyb3BUYXJnZXQgPSBNT0R4LmxvYWQoe1xuICAgICAgICAgICAgeHR5cGU6ICdtb2R4LXRyZWVkcm9wJyxcbiAgICAgICAgICAgIHRhcmdldDogY29udGVudCxcbiAgICAgICAgICAgIHRhcmdldEVsOiBjb250ZW50LFxuICAgICAgICAgICAgb25JbnNlcnQ6IChmdW5jdGlvbihzKXtcbiAgICAgICAgICAgICAgICB0aGlzLmluc2VydChzKTtcbiAgICAgICAgICAgICAgICB0aGlzLmZvY3VzKCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9KS5iaW5kKHRoaXMuZWRpdG9yKSxcbiAgICAgICAgICAgIGlmcmFtZTogdHJ1ZVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy50ZXh0YXJlYS5vbignZGVzdHJveScsIGZ1bmN0aW9uKCkge2Ryb3BUYXJnZXQuZGVzdHJveSgpO30pO1xuXG4gICAgICAgIHByZXZpZXdCdXR0b24uYWRkTGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKHByZXZpZXcuaXNWaXNpYmxlKCkpIHtcbiAgICAgICAgICAgICAgICBwcmV2aWV3LnNldERpc3BsYXllZCgnbm9uZScpO1xuICAgICAgICAgICAgICAgIGNvbnRlbnQuc2V0RGlzcGxheWVkKCdibG9jaycpO1xuXG4gICAgICAgICAgICAgICAgcHJldmlld0J1dHRvbi5jaGlsZCgnaScpLnJlbW92ZUNsYXNzKCdpY29uLXRvZ2dsZS1vbicpO1xuICAgICAgICAgICAgICAgIHByZXZpZXdCdXR0b24uY2hpbGQoJ2knKS5hZGRDbGFzcygnaWNvbi10b2dnbGUtb2ZmJyk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHByZXZpZXcuc2V0RGlzcGxheWVkKCdibG9jaycpO1xuICAgICAgICAgICAgICAgIGNvbnRlbnQuc2V0RGlzcGxheWVkKCdub25lJyk7XG5cbiAgICAgICAgICAgICAgICBwcmV2aWV3QnV0dG9uLmNoaWxkKCdpJykucmVtb3ZlQ2xhc3MoJ2ljb24tdG9nZ2xlLW9mZicpO1xuICAgICAgICAgICAgICAgIHByZXZpZXdCdXR0b24uY2hpbGQoJ2knKS5hZGRDbGFzcygnaWNvbi10b2dnbGUtb24nKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgZnVsbHNjcmVlbkJ1dHRvbi5hZGRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgaWNvbiA9IGZ1bGxzY3JlZW5CdXR0b24uY2hpbGQoJ2knKTtcblxuICAgICAgICAgICAgaWYgKGljb24uaGFzQ2xhc3MoJ2ljb24tZXhwYW5kJykpIHtcbiAgICAgICAgICAgICAgICBpY29uLnJlbW92ZUNsYXNzKCdpY29uLWV4cGFuZCcpO1xuICAgICAgICAgICAgICAgIGljb24uYWRkQ2xhc3MoJ2ljb24tY29tcHJlc3MnKTtcblxuICAgICAgICAgICAgICAgIHByZXZpZXcuc2V0RGlzcGxheWVkKCdibG9jaycpO1xuICAgICAgICAgICAgICAgIGNvbnRlbnQuc2V0RGlzcGxheWVkKCdibG9jaycpO1xuXG4gICAgICAgICAgICAgICAgcHJldmlld0J1dHRvbi5oaWRlKCk7XG5cbiAgICAgICAgICAgICAgICB3cmFwcGVyLmFkZENsYXNzKCdmdWxsc2NyZWVuJyk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmVkaXRvci5zZXRPcHRpb24oJ21heExpbmVzJywgbnVsbCk7XG4gICAgICAgICAgICAgICAgLy90aGlzLmVkaXRvci5zZXRBdXRvU2Nyb2xsRWRpdG9ySW50b1ZpZXcoZmFsc2UpO1xuXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGljb24uYWRkQ2xhc3MoJ2ljb24tZXhwYW5kJyk7XG4gICAgICAgICAgICAgICAgaWNvbi5yZW1vdmVDbGFzcygnaWNvbi1jb21wcmVzcycpO1xuXG4gICAgICAgICAgICAgICAgcHJldmlldy5zZXREaXNwbGF5ZWQoJ25vbmUnKTtcbiAgICAgICAgICAgICAgICBjb250ZW50LnNldERpc3BsYXllZCgnYmxvY2snKTtcblxuICAgICAgICAgICAgICAgIHByZXZpZXdCdXR0b24uc2hvdygpO1xuXG4gICAgICAgICAgICAgICAgd3JhcHBlci5yZW1vdmVDbGFzcygnZnVsbHNjcmVlbicpO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5lZGl0b3Iuc2V0T3B0aW9uKCdtYXhMaW5lcycsIEluZmluaXR5KTtcbiAgICAgICAgICAgICAgICAvL3RoaXMuZWRpdG9yLnNldEF1dG9TY3JvbGxFZGl0b3JJbnRvVmlldyh0cnVlKTtcblxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLmVkaXRvci5yZXNpemUodHJ1ZSk7XG4gICAgICAgIH0sIHRoaXMpO1xuXG4gICAgICAgIHRoaXMuZWRpdG9yLnNldFZhbHVlKE1hcmtkb3duRWRpdG9yX2NvbnRlbnQuY29udGVudCk7XG4gICAgICAgIHRoaXMuZWRpdG9yLnNlbGVjdGlvbi5jbGVhclNlbGVjdGlvbigpO1xuXG4gICAgICAgIHByZXZpZXcudXBkYXRlKHRoaXMucGFyc2UodGhpcy5lZGl0b3IuZ2V0VmFsdWUoKSkpO1xuXG4gICAgICAgIHRoaXMuZWRpdG9yLmdldFNlc3Npb24oKS5vbignY2hhbmdlJywgZnVuY3Rpb24oZSl7XG4gICAgICAgICAgICB2YXIgcGFyc2VkID0gbWRlLnBhcnNlKG1kZS5lZGl0b3IuZ2V0VmFsdWUoKSk7XG5cblxuICAgICAgICAgICAgLy9tZGUudGV4dGFyZWEuZG9tLnZhbHVlID0gcGFyc2VkO1xuICAgICAgICAgICAgLy9tZGUudGFNYXJrZG93bi5kb20udmFsdWUgPSBtZGUuZWRpdG9yLmdldFZhbHVlKCk7XG4gICAgICAgICAgICAvL3ByZXZpZXcudXBkYXRlKHBhcnNlZCk7XG4gICAgICAgIH0pO1xuICAgIH1cbn0pO1xuTWFya2Rvd25FZGl0b3IgPSBuZXcgTWFya2Rvd25FZGl0b3IoKTsiXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=