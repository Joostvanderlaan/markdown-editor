Ext.ns("MarkdownEditor"),MarkdownEditor=function(e){e=e||{},MarkdownEditor.superclass.constructor.call(this,e)},Ext.extend(MarkdownEditor,Ext.Component,{window:{},combo:{},config:{}}),Ext.reg("markdowneditor",MarkdownEditor),markdownEditor=new MarkdownEditor,markdownEditor.loadedElements={},markdownEditor.Editor=function(e){e=e||{},e.resource=MODx.request.id||0,markdownEditor.Editor.superclass.constructor.call(this,e),this.config=e},Ext.extend(markdownEditor.Editor,Ext.Component,{remarkable:"",fullScreen:!1,diffDOM:null,localCache:{oEmbed:{}},initComponent:function(){MarkdownEditor.superclass.initComponent.call(this),this.diffDOM=new diffDOM,this.mdElementId&&Ext.onReady(this.render,this)},destroy:function(){this.editor.destroy(),this.mdContainer.remove(),this.taMarkdown.remove(),this.textarea.dom.style.display=null,this.textarea.dom.style.width=null,this.textarea.dom.style.height=null,MarkdownEditor.superclass.destroy.call(this)},render:function(){if(this.textarea=Ext.get(this.mdElementId),this.mdElementName=this.textarea.dom.name,this.textarea){this.buildUI(),this.registerAce(),this.registerRemarkable(),this.buildToolbox();var e=this.toolBox.child(".preview-button"),t=this.toolBox.child(".fullscreen-button"),i=this.toolBox.child(".splitscreen-button"),o=this.contentMD,r=Ext.get(Ext.DomHelper.append(o.parent(),{tag:"div","class":"preview-button-off",html:'<i class="icon icon-eye-slash icon-large"></i>',hidden:!0})),n=MODx.load({xtype:"modx-treedrop",target:o,targetEl:o,onInsert:function(e){return this.insert(e),this.focus(),!0}.bind(this.editor),iframe:!0});this.textarea.on("destroy",function(){n.destroy()});var a=parseInt(MODx.config["markdowneditor.general.split"]||0);1==a&&i.turnOn(),e.addListener("click",function(){this.showPreview(),this.hideContent(),this.statusBar.setDisplayed("none"),this.contentMD.parent().parent().addClass("preview"),r.show()},this),r.addListener("click",function(){this.hidePreview(),this.showContent(),this.statusBar.setDisplayed("block"),this.contentMD.parent().parent().removeClass("preview"),this.editor.focus(),r.hide()},this),i.addListener("click",function(){i.child("i").hasClass("icon-pause")?i.turnOn():i.turnOff()},this),t.addListener("click",function(){0==this.fullScreen?t.turnOn():t.turnOff(),this.statusBar.setDisplayed("block"),this.editor.resize(!0)},this),markdownEditor.content[this.mdElementName]&&this.editor.setValue(markdownEditor.content[this.mdElementName]),this.editor.selection.clearSelection(),this.preview.update(this.parse(this.editor.getValue())),this.preview.fixHeight(),this.editor.getSession().on("change",function(e){if("insertText"==e.data.action&&this.editor.getSession().getDocument().isNewLine(e.data.text)){var t=this.editor.getSession(),i=t.getDocument();null!=/^\s*(?:[*+-]|\d+\.)\s*$/.exec(i.getLine(e.data.range.start.row))&&i.removeLines(e.data.range.start.row,e.data.range.start.row)}this.parse(this.editor.getValue())}.bind(this))}},showContent:function(){this.contentMD.setDisplayed("block")},hideContent:function(){this.contentMD.setDisplayed("none")},showPreview:function(){this.preview.parent().setDisplayed("block")},hidePreview:function(){this.preview.parent().setDisplayed("none")},buildUI:function(){this.textarea.setDisplayed("none"),this.textarea.setWidth(0),this.textarea.setHeight(0),this.taMarkdown=Ext.get(Ext.DomHelper.insertBefore(this.textarea,{tag:"textarea",name:this.mdElementName+"_markdown","class":this.mdElementName+"_markdown"})),this.taMarkdown.setDisplayed("none"),this.taMarkdown.setWidth(0),this.taMarkdown.setHeight(0),this.mdContainer=Ext.get(Ext.DomHelper.insertBefore(this.textarea,{tag:"div","class":"markdown-container ace-"+(MODx.config["markdowneditor.general.theme"]||"monokai").toLowerCase().replace(/_/g,"-")}));var e=Ext.get(Ext.DomHelper.append(this.mdContainer.dom,{tag:"div","class":"fullscreen-header ace_gutter",html:'<input type="text" />'})),t=Ext.getCmp("modx-resource-pagetitle");if(t){var i=e.child("input");i.dom.value=t.getValue(),i.on("change",function(){t.setValue(this.dom.value)}),t.on("change",function(e,t){i.dom.value=t})}var o=Ext.get(Ext.DomHelper.append(this.mdContainer.dom,{tag:"div","class":"markdown-wrapper"}));this.contentMD=Ext.get(Ext.DomHelper.append(o,{tag:"div","class":this.textarea.dom.className+" content-md "+this.mdElementName+"_markdown"})),this.preview=Ext.get(Ext.DomHelper.append(o,{tag:"div","class":"markdown-body preview-md"})),this.preview=Ext.get(Ext.DomHelper.append(this.preview.dom,{tag:"div"}));var r=this;this.preview.fixHeight=function(){r.editor.resize();var e=r.editor.getSession().getScreenLength()*r.editor.renderer.lineHeight+r.editor.renderer.scrollBar.getWidth()+25;this.parent().setHeight(e)},1==MODx.config["markdowneditor.upload.enable_image_upload"]||1==MODx.config["markdowneditor.upload.enable_file_upload"]?(this.statusBar=Ext.get(Ext.DomHelper.append(this.mdContainer.dom,{tag:"div","class":"status-bar ace_gutter"})),this.isMobileDevice()?(this.statusBar.dom.innerHTML='<div class="upload-bar"> <input class="hidden" name="md_file_'+this.statusBar.id+'" id="'+this.statusBar.id+'-file" type="file" multiple /><input class="hidden" name="md_file_'+this.statusBar.id+'-mobile" id="'+this.statusBar.id+'-file-mobile" type="file" accept="image/*" capture="camera" />'+_("markdowneditor.status_bar_message_mobile",{id:this.statusBar.id+"-file",id_mobile:this.statusBar.id+"-file-mobile"})+"</div>",this.statusBar.child("#"+this.statusBar.id+"-file-mobile").on("change",function(e,t){this.handleFiles(t.files,1),t.value=""},this)):(this.statusBar.dom.innerHTML='<div class="upload-bar"> <input class="hidden" name="md_file_'+this.statusBar.id+'" id="'+this.statusBar.id+'-file" type="file" multiple>'+_("markdowneditor.status_bar_message",{id:this.statusBar.id+"-file"})+"</div>",this.statusBar.child("#"+this.statusBar.id+"-file").on("change",function(e,t){this.handleFiles(t.files),t.value=""},this))):this.statusBar=Ext.get(Ext.DomHelper.append(this.mdContainer.dom,{tag:"div","class":"status-bar",html:_("markdowneditor.status_bar_disabled")})),Ext.DomHelper.append(this.mdContainer.dom,{tag:"span",style:"clear: both"})},buildToolbox:function(){this.toolBox=Ext.get(Ext.DomHelper.append(this.statusBar,{tag:"div","class":"toolbox",cn:[{tag:"div","class":"preview-button",html:'<i class="icon icon-eye icon-large"></i>'},{tag:"div","class":"splitscreen-button",html:'<i class="icon icon-pause icon-large"></i>'},{tag:"div","class":"fullscreen-button",html:'<i class="icon icon-expand icon-large"></i>'}]}));var e=this;this.toolBox.child(".splitscreen-button").turnOn=function(){this.child("i").removeClass("icon-pause"),this.child("i").addClass("icon-stop"),e.contentMD.parent().parent().addClass("split"),e.editor.resize(),e.preview.fixHeight()},this.toolBox.child(".splitscreen-button").turnOff=function(){this.child("i").addClass("icon-pause"),this.child("i").removeClass("icon-stop"),e.contentMD.parent().parent().removeClass("split"),e.editor.resize()},this.toolBox.child(".fullscreen-button").turnOn=function(){this.child("i").removeClass("icon-expand"),this.child("i").addClass("icon-compress");var t=Ext.get("modx-action-buttons");t&&t.addClass("markdowneditor-fullscreen"),e.fullScreen=!0,1==parseInt(MODx.config["markdowneditor.general.split_fullscreen"]||1)?e.toolBox.child(".splitscreen-button").turnOn():e.toolBox.child(".splitscreen-button").turnOff(),e.showPreview(),e.showContent(),e.editor.focus(),e.contentMD.parent().parent().addClass("fullscreen"),e.editor.setOption("maxLines",null),e.editor.resize()},this.toolBox.child(".fullscreen-button").turnOff=function(){this.child("i").addClass("icon-expand"),this.child("i").removeClass("icon-compress");var t=Ext.get("modx-action-buttons");t&&t.removeClass("markdowneditor-fullscreen"),e.fullScreen=!1,1==parseInt(MODx.config["markdowneditor.general.split"]||0)?e.toolBox.child(".splitscreen-button").turnOn():e.toolBox.child(".splitscreen-button").turnOff(),e.hidePreview(),e.showContent(),e.editor.focus(),e.contentMD.parent().parent().removeClass("fullscreen"),e.editor.setOption("maxLines",1/0),e.preview.fixHeight()}},registerAce:function(){this.editor=ace.edit(Ext.DomQuery.selectNode("div."+this.mdElementName+"_markdown")),ace.require("ace/layer/gutter_toolbar"),this.editor.setOptions({maxLines:1/0,minLines:25,enableBasicAutocompletion:!0,printMargin:!1,showGutter:!0,useSoftTabs:!0,showFoldWidgets:!1,showLineNumbers:!1,fontSize:parseInt(MODx.config["markdowneditor.general.font_size"])||12,fontFamily:MODx.config["markdowneditor.general.font_family"]||""}),this.editor.$blockScrolling=1/0,this.editor.session.setUseWrapMode(!0),this.editor.session.setWrapLimitRange(),this.editor.renderer.setScrollMargin(10,10),this.editor.session.setValue(this.textarea.getValue()),this.editor.session.setMode("ace/mode/markdowneditor"),this.editor.setTheme("ace/theme/"+(MODx.config["markdowneditor.general.theme"]||"monokai")),this.contentMD.hasClass("ace_dark")?this.mdContainer.addClass("theme-dark"):this.mdContainer.addClass("theme-light"),this.editor.selection.on("changeCursor",function(e,t){this.gutterToolbar&&this.gutterToolbar.update("");var i=t.getRange();i.start.row==i.end.row&&this.editor.session.addGutterDecoration(i.start.row,"")}.bind(this)),this.editor.session.gutterRenderer={getWidth:function(e,t,i){return i.characterWidth},getText:function(e,t,i){return i.element&&this.editor.getCursorPosition().row==t&&""==e.doc.$lines[t]?this.addGutterToolbar(i.element):i.element.innerHTML="",""}.bind(this)},this.editor.commands.addCommand({name:"Indent list",bindKey:{win:"Tab",mac:"Tab"},exec:function(e){var t=e.session.getLine(e.getCursorPosition().row),i=/^(\s*)(?:([-+*])|(\d+)\.)(\s+)/.exec(t);i?e.session.indentRows(e.getCursorPosition().row,e.getCursorPosition().row,"	"):e.indent()}}),this.editor.commands.addCommand({name:"Exit fullscreen",bindKey:{win:"Esc",mac:"Esc"},exec:function(){this.fullScreen&&this.toolBox.child(".fullscreen-button").turnOff()}.bind(this)});var e=ace.require("ace/ext/language_tools"),t={getCompletions:function(e,t,i,o,r){return 0===o.length?(r(null,[]),void 0):(MODx.Ajax.request({url:markdownEditor.config.connectorUrl,params:{action:"mgr/resource/getlist",prefix:o},listeners:{success:{fn:function(e){r(null,e.results)},scope:this}}}),void 0)}};e.addCompleter(t),this.editor.container.addEventListener("dragenter",this.catchAndDoNothing,!1),this.editor.container.addEventListener("dragover",this.catchAndDoNothing,!1),this.editor.container.addEventListener("drop",this.drop.bind(this),!1)},addGutterToolbar:function(e){this.gutterToolbar=Ext.get(e),this.isMobileDevice()?this.gutterToolbar.update('<i class="icon icon-plus icon-fixed-width"></i><div class="inline-toolbar"><i class="icon icon-archive icon-fixed-width"></i><label for="'+this.statusBar.id+'-file"><i class="icon icon-upload icon-fixed-width"></i></label><label for="'+this.statusBar.id+'-file-mobile"><i class="icon icon-camera icon-fixed-width"></i></label><i class="icon icon-code icon-fixed-width"></i></div>'):this.gutterToolbar.update('<i class="icon icon-plus icon-fixed-width"></i><div class="inline-toolbar"><i class="icon icon-archive icon-fixed-width"></i><label for="'+this.statusBar.id+'-file"><i class="icon icon-upload icon-fixed-width"></i></label><i class="icon icon-code icon-fixed-width"></i></div>');var t=this.gutterToolbar.child("i.icon-plus"),i=this.gutterToolbar.child(".inline-toolbar");t.turnOn=function(){t.addClass("md-icon-rotate-45"),i.show()},t.turnOff=function(){t.removeClass("md-icon-rotate-45"),i.hide()},t.on("click",function(){t.hasClass("md-icon-rotate-45")?t.turnOff():t.turnOn()}.bind(this)),this.gutterToolbar.child("i.icon-code").on("click",function(){MODx.load({xtype:"markdowneditor-window-oembed",success:function(e){this.editor.insert("[embed "+e.url+"]"),this.editor.focus()},scope:this}).show()}.bind(this)),this.gutterToolbar.child("i.icon-archive").on("click",function(){MODx.load({xtype:"modx-browser-window",source:parseInt(MODx.config["markdowneditor.general.source"]),hideSourceCombo:1!=parseInt(MODx.config["markdowneditor.general.source_select"]||0),onSelect:function(e){var t="";e.preview&&(t="!"),t=t+"["+e.name+"]("+e.fullRelativeUrl+' "'+e.name+'")',this.editor.insert(t),this.editor.focus()},scope:this}).show()}.bind(this))},registerRemarkable:function(){hljs.registerLanguage("modx",function(){return{cI:!0,c:[{cN:"comment",b:"\\[\\[\\s*-",e:"\\]\\]",c:[]},{cN:"variable",rE:!0,b:"&",e:"=",c:[]},{cN:"class",b:"\\[\\[",e:"[\\?]",rB:!0,c:[{b:"\\[\\[",e:"[:@\\?]",rE:!0,c:[{cN:"title",b:"[a-zA-Z0-9]+"},{cN:"string",b:"[\\$\\+!%]"}]},{cN:"variable",b:"@[a-zA-Z0-9]+"},{cN:"variable",b:":[a-zA-Z0-9]+",e:"=",eE:!0}]}]}}),this.remarkable=new Remarkable({html:!0,highlight:function(e,t){var i="";if(t&&hljs.getLanguage(t))try{return i=hljs.highlight(t,e).value,i=i.replace(/\[\[/g,"&#91;&#91;"),i=i.replace(/]]/g,"&#93;&#93;")}catch(o){}try{return i=hljs.highlightAuto(e).value,i=i.replace(/\[\[/g,"&#91;&#91;"),i=i.replace(/]]/g,"&#93;&#93;")}catch(o){}return""}}),this.remarkable.inline.ruler.disable(["backticks"]);var e=function(e,t){if(this.localCache.oEmbed[e[t].url])return this.localCache.oEmbed[e[t].url];var i=Ext.id();return MODx.Ajax.request({url:markdownEditor.config.connectorUrl,params:{action:"mgr/editor/oembed",url:e[t].url},listeners:{success:{fn:function(o){var r=Ext.get(i);if(r){r.update(o.data),r.dom.removeAttribute("id"),this.localCache.oEmbed[e[t].url]=r.dom.outerHTML;var n=Ext.get(Ext.DomHelper.createDom({tag:"div",html:this.textarea.dom.value}));n.child("#"+i).update(o.data).dom.removeAttribute("id"),this.textarea.dom.value=n.dom.innerHTML}},scope:this}}}),'<div id="'+i+'" class="markdowneditor-oembed-content">[embed '+e[t].url+"]</div>"}.bind(this),t=this.remarkable;t.renderer.rules.code=function(){var e=t.renderer.rules.code;return function(){var t=e.apply(this,arguments);return t=t.replace(/\[\[/g,"&#91;&#91;"),t=t.replace(/]]/g,"&#93;&#93;")}}();var i=function(t){t.inline.ruler.push("oEmbed",this.oEmbedParser),t.renderer.rules.oEmbed=e}.bind(this),o=function(e){e.inline.ruler.push("modxCode",this.modxCodeParser)}.bind(this);this.remarkable.use(i),this.remarkable.use(o)},parse:function(e){var t=this.remarkable.render(e);if(t=t.replace(/%5B/g,"["),t=t.replace(/%5D/g,"]"),1==MODx.config["markdowneditor.lp.parse_modx_tags"]){this.parseRequest&&clearTimeout(this.parseRequest);var i=parseInt(MODx.config["markdowneditor.lp.parse_modx_tags_timeout"]||300);this.parseRequest=setTimeout(function(){MODx.Ajax.request({url:markdownEditor.config.connectorUrl,params:{action:"mgr/editor/processcontent",content:t,resource:MODx.request.id},isUpload:!0,listeners:{success:{fn:function(e){var t=document.createElement("div");t.innerHTML=e.data,this.diffDOM.apply(this.preview.dom,this.diffDOM.diff(this.preview.dom,t)),this.preview.fixHeight(),this.editor.getCursorPosition().row+2>=this.editor.getSession().getDocument().getLength()&&(this.preview.parent().dom.scrollTop=this.preview.parent().dom.scrollHeight)},scope:this}}})}.bind(this),i)}else{var o=document.createElement("div");o.innerHTML=t,this.diffDOM.apply(this.preview.dom,this.diffDOM.diff(this.preview.dom,o)),this.preview.fixHeight(),this.editor.getCursorPosition().row+2>=this.editor.getSession().getDocument().getLength()&&(this.preview.parent().dom.scrollTop=this.preview.parent().dom.scrollHeight)}return this.taMarkdown.dom.value=this.editor.getValue(),this.textarea.dom.value=t,t},oEmbedParser:function(e){var t=e.pos,i=e.src.charCodeAt(e.pos);if(91!==i)return!1;if(t++,i=e.src.charCodeAt(t),101!==i)return!1;if(t++,i=e.src.charCodeAt(t),109!==i)return!1;if(t++,i=e.src.charCodeAt(t),98!==i)return!1;if(t++,i=e.src.charCodeAt(t),101!==i)return!1;if(t++,i=e.src.charCodeAt(t),100!==i)return!1;if(t++,i=e.src.charCodeAt(t),32!==i)return!1;t++;for(var o=t,r=e.posMax,n=!1;r>t;){if(93===e.src.charCodeAt(t)){n=!0;break}if(32===e.src.charCodeAt(t))return!1;t++}if(!n)return!1;e.pos=t+1,e.pos>e.posMax&&(e.pos=e.posMax);var a=e.src.slice(o,t),s={type:"oEmbed",level:e.level,content:i,url:a};return e.push(s),!0},modxCodeParser:function(e,t){var i,o,r,n,a=e.pos;if(96!==e.src.charCodeAt(a))return!1;if(a++,96!==e.src.charCodeAt(a))return!1;if(a++,96!==e.src.charCodeAt(a))return!1;for(a++,i=e.posMax,o="```",r=n=a;-1!==(r=e.src.indexOf("`",n));){for(n=r+1;i>n&&96===e.src.charCodeAt(n);)n++;if(n-r===o.length)return t||e.push({type:"code",content:e.src.slice(a,r).replace(/[ \n]+/g," ").trim(),block:!1,level:e.level}),e.pos=n,!0}return t||(e.pending+=o),e.pos+=o.length,!0},catchAndDoNothing:function(e){e.stopPropagation(),e.preventDefault()},drop:function(e){e.stopPropagation(),e.preventDefault(),(1==MODx.config["markdowneditor.upload.enable_image_upload"]||1==MODx.config["markdowneditor.upload.enable_file_upload"])&&this.handleFiles(e.dataTransfer.files)},handleFiles:function(e,t){t=t||0,Ext.each(e,function(e){var i=/^image\//.test(e.type);if(i){if(0==MODx.config["markdowneditor.upload.enable_image_upload"])return!0;if(!this.checkType(MODx.config["markdowneditor.upload.image_types"],e))return this.failMessage(e,"image",_("markdowneditor.err.upload.unsupported_image")),!0;if(!this.checkSize(e.size))return this.failMessage(e,"image",_("markdowneditor.err.upload.too_big")),!0;1==MODx.config["markdowneditor.cropper.enable_cropper"]?MODx.load({xtype:"markdowneditor-window-cropper",file:e,md:this,mobile:t}).show():(this.uploadFile(e,"image",t),this.editor.focus())}else{if(0==MODx.config["markdowneditor.upload.enable_file_upload"])return!0;if(!this.checkType(MODx.config["markdowneditor.upload.file_types"],e))return this.failMessage(e,"file",_("markdowneditor.err.upload.unsupported_file")),!0;if(!this.checkSize(e.size))return this.failMessage(e,"file",_("markdowneditor.err.upload.too_big")),!0;this.uploadFile(e,"file"),this.editor.focus()}},this)},checkSize:function(e){var t=MODx.config["markdowneditor.upload.max_size"];return t&&""!=t||(t=MODx.config.upload_maxsize||"2097152"),t=parseInt(t),0==t?!0:t>=e},checkType:function(e,t){e=e.split(",");var i=t.name.split(".").pop();return-1!=e.indexOf(i.toLowerCase())},uploadFile:function(e,t,i){t=t||"file",i=i||0;var o=this.createUploader(t,e.name),r=new FormData;r.append("file",e),r.append("action","mgr/editor/"+t+"upload"),r.append("name",e.name),r.append("resource",this.config.resource),r.append("mobile",i);var n=new XMLHttpRequest;n.open("POST",markdownEditor.config.connectorUrl),n.setRequestHeader("Powered-By","MODx"),n.setRequestHeader("modAuth",Ext.Ajax.defaultHeaders.modAuth),n.upload.onprogress=function(e){if(e.lengthComputable){var t=e.loaded/e.total*100|0;o.child(".progress").setWidth(t+"%")}}.bind(this),n.onload=function(){if(200===n.status){var e=JSON.parse(n.responseText);if(1==e.success){o.remove();var i="image"==t?"!":"",r="image"==t?"\n\n":"\n";this.editor.insert(i+"["+e.object.name+"]("+e.object.path+' "'+e.object.name+'")'+r)}else this.failUploader(o,e.message)}}.bind(this),n.send(r)},createUploader:function(e,t){var i=Ext.DomHelper.insertFirst(this.statusBar,{tag:"div",html:'<div class="progress"><i class="icon icon-spinner icon-spin"></i> <span>'+_("markdowneditor.uploading_"+e)+t+"</span></div>"});return Ext.get(i)},failUploader:function(e,t){e.child(".progress").addClass("error"),e.child(".progress").setWidth("100%"),e.child("i").addClass("remove-message"),e.child("i").replaceClass("icon-spinner","icon-remove"),e.child("i").removeClass("icon-spin"),e.child("span").dom.innerHTML+=" failed. "+t,e.child(".remove-message").on("click",function(){e.remove()})},failMessage:function(e,t,i){var o=this.createUploader(t,e.name);this.failUploader(o,i)},isMobileDevice:function(){return"undefined"!=typeof window.orientation||-1!==navigator.userAgent.indexOf("IEMobile")}}),MODx.loadRTE=function(e){new markdownEditor.Editor({mdElementId:e})},MODx.afterTVLoad=function(){var e=Ext.query("textarea.modx-richtext");Ext.each(e,function(e){return(e=Ext.get(e))?markdownEditor.loadedElements[e.id]?!0:(markdownEditor.loadedElements[e.id]=new markdownEditor.Editor({mdElementId:e.id}),void 0):!0})},MODx.unloadTVRTE=function(){var e=Ext.query(".modx-richtext");Ext.each(e,function(e){return(e=Ext.get(e))?markdownEditor.loadedElements[e.id]?(markdownEditor.loadedElements[e.id].destroy(),void 0):!0:!0})},markdownEditor.combo.CropperProfile=function(e){var t=JSON.parse(MODx.config["markdowneditor.cropper.profiles"]||"[]");e=e||{},Ext.applyIf(e,{store:new Ext.data.JsonStore({data:t,fields:["name","width","height","ratio"]}),displayField:"name",mode:"local",valueField:"name",editable:!1,value:t[0]?t[0].name:""});var i=parseInt(MODx.config["markdowneditor.cropper.show_description"]||0);i&&(e.tpl=new Ext.XTemplate('<tpl for="."><div class="x-combo-list-item"><span style="font-weight: bold">{name}</span>','<br /><tpl if="width">W:{width} </tpl><tpl if="height">H:{height} </tpl><tpl if="ratio">R:{ratio}</tpl></div></tpl>')),markdownEditor.combo.CropperProfile.superclass.constructor.call(this,e)},Ext.extend(markdownEditor.combo.CropperProfile,MODx.combo.ComboBox),Ext.reg("markdowneditor-combo-cropper-profile",markdownEditor.combo.CropperProfile),markdownEditor.window.Cropper=function(e){e=e||{},e.cropperSelector=e.cropperSelector||".image-upload-wrapper > img";var t=Ext.id();Ext.applyIf(e,{modal:!1,layout:"auto",closeAction:"hide",shadow:!0,resizable:!0,collapsible:!0,maximizable:!1,autoHeight:!1,autoScroll:!0,allowDrop:!0,width:800,mobile:0,title:_("markdowneditor.cropper.crop_image"),cls:"modx-window markdowneditor-cropper-window",items:[{layout:"column",border:!1,defaults:{layout:"form",labelAlign:"top",labelSeparator:"",anchor:"100%",border:!1},items:[{columnWidth:.1,defaults:{msgTarget:"under",anchor:"100%"},cls:"markdowneditor-toolbar",items:[{xtype:"button",text:'<i class="icon icon-arrows icon-large"></i>',tooltip:_("markdowneditor.cropper.move"),scope:this,param:"move",action:"setDragMode",handler:this.callCropperAction},{xtype:"button",text:'<i class="icon icon-crop icon-large"></i>',tooltip:_("markdowneditor.cropper.crop"),scope:this,param:"crop",action:"setDragMode",handler:this.callCropperAction},{xtype:"button",text:'<i class="icon icon-search-plus icon-large"></i>',tooltip:_("markdowneditor.cropper.zoom_in"),scope:this,param:.1,action:"zoom",handler:this.callCropperAction},{xtype:"button",text:'<i class="icon icon-search-minus icon-large"></i>',tooltip:_("markdowneditor.cropper.zoom_out"),scope:this,param:-.1,action:"zoom",handler:this.callCropperAction},{xtype:"button",text:'<i class="icon icon-rotate-left icon-large"></i>',tooltip:_("markdowneditor.cropper.rotate_left"),scope:this,param:-90,action:"rotate",handler:this.callCropperAction},{xtype:"button",text:'<i class="icon icon-rotate-right icon-large"></i>',tooltip:_("markdowneditor.cropper.rotate_right"),scope:this,param:90,action:"rotate",handler:this.callCropperAction},{xtype:"button",text:'<i class="icon icon-remove icon-large"></i>',tooltip:_("markdowneditor.cropper.clear_cropper"),scope:this,param:null,action:"clear",handler:this.callCropperAction}]},{columnWidth:.9,defaults:{msgTarget:"under",anchor:"100%"},cls:"markdowneditor-cropper",items:[{html:'<div class="image-upload-wrapper"><img src="'+URL.createObjectURL(e.file)+'"></div>'}]}]}],bbar:[{xtype:"markdowneditor-combo-cropper-profile",id:t+"-cropper-profile",listeners:{select:{fn:function(e,t){this.changeCropperProfile(t.data)},scope:this}}},"->",{text:_("cancel"),scope:this,handler:this.close},{text:_("markdowneditor.cropper.upload"),cls:"primary-button",scope:this,crop:0,handler:this.upload},{text:_("markdowneditor.cropper.crop_upload"),cls:"primary-button",scope:this,crop:1,handler:this.upload}],listeners:{show:{fn:function(){var i={};this.$cropperEl=$("#"+this.id+" "+e.cropperSelector),i.crop=function(e){this.imageData=['{"x":'+e.x,'"y":'+e.y,'"height":'+e.height,'"width":'+e.width,'"rotate":'+e.rotate+"}"].join()}.bind(this),this.$cropperEl.cropper(i);var o=Ext.getCmp(t+"-cropper-profile").store.getAt(0);this.changeCropperProfile(o.data)},scope:this}}}),markdownEditor.window.Cropper.superclass.constructor.call(this,e),this.config=e},Ext.extend(markdownEditor.window.Cropper,Ext.Window,{imageData:"",cropperProfile:{name:""},changeCropperProfile:function(profile){var ratio;if(""!=profile.ratio)ratio=profile.ratio,ratio.replace(/[^-:x()\d/*+.]/g,""),ratio=eval(ratio)||0/0;else if(profile.width&&profile.height){var width=parseInt(profile.width),height=parseInt(profile.height);ratio=width>0&&height>0?width/height:0/0}else ratio=0/0;this.cropperProfile=profile,this.callCropperAction({action:"setAspectRatio",param:ratio})},upload:function(e){var t=this.config.md.createUploader("image",this.config.file.name),i=new FormData;i.append("file",this.config.file),i.append("action","mgr/editor/imageupload"),i.append("imageData",this.imageData),i.append("name",this.config.file.name),i.append("crop",e.crop),i.append("resource",this.config.md.config.resource),i.append("mobile",this.config.mobile),i.append("profile",this.cropperProfile.name);var o=new XMLHttpRequest;o.open("POST",markdownEditor.config.connectorUrl),o.setRequestHeader("Powered-By","MODx"),o.setRequestHeader("modAuth",Ext.Ajax.defaultHeaders.modAuth),o.upload.onprogress=function(e){if(e.lengthComputable){var i=e.loaded/e.total*100|0;t.child(".progress").setWidth(i+"%")}}.bind(this),o.onload=function(){if(200===o.status){var e=JSON.parse(o.responseText);1==e.success?(t.remove(),this.config.md.editor.insert("!["+e.object.name+"]("+e.object.path+' "'+e.object.name+'")\n\n')):this.config.md.failUploader(t,e.message)}}.bind(this),o.send(i),this.close()},callCropperAction:function(e){this.$cropperEl.cropper(e.action,e.param)},close:function(){this.$cropperEl.cropper("destroy"),markdownEditor.window.Cropper.superclass.close.call(this),this.config.md.editor.focus()}}),Ext.reg("markdowneditor-window-cropper",markdownEditor.window.Cropper),markdownEditor.window.OEmbed=function(e){e=e||{},Ext.applyIf(e,{title:_("markdowneditor.oembed.embed_url"),closeAction:"close",resizable:!1,collapsible:!1,maximizable:!1,height:185,modal:!0,fields:this.getFields(e)}),markdownEditor.window.OEmbed.superclass.constructor.call(this,e)},Ext.extend(markdownEditor.window.OEmbed,MODx.Window,{getFields:function(){return[{xtype:"textfield",name:"url",fieldLabel:_("markdowneditor.oembed.url"),allowBlank:!1,anchor:"100%",vtype:"url"}]},submit:function(){var e=this.fp.getForm();e.isValid()&&(this.config.success&&Ext.callback(this.config.success,this.config.scope||this,[e.getValues()]),this.close())}}),Ext.reg("markdowneditor-window-oembed",markdownEditor.window.OEmbed);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsImNvbWJvLmpzIiwibWFya2Rvd25lZGl0b3Iud2luZG93LmpzIiwib2VtYmVkLndpbmRvdy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxJQUFBLEdBQUEsa0JBQ0EsZUFBQSxTQUFBLEdBQ0EsRUFBQSxNQUNBLGVBQUEsV0FBQSxZQUFBLEtBQUEsS0FBQSxJQUVBLElBQUEsT0FBQSxlQUFBLElBQUEsV0FDQSxVQUFBLFNBQUEsWUFFQSxJQUFBLElBQUEsaUJBQUEsZ0JBQ0EsZUFBQSxHQUFBLGdCQUVBLGVBQUEsa0JBRUEsZUFBQSxPQUFBLFNBQUEsR0FDQSxFQUFBLE1BQ0EsRUFBQSxTQUFBLEtBQUEsUUFBQSxJQUFBLEVBQ0EsZUFBQSxPQUFBLFdBQUEsWUFBQSxLQUFBLEtBQUEsR0FDQSxLQUFBLE9BQUEsR0FFQSxJQUFBLE9BQUEsZUFBQSxPQUFBLElBQUEsV0FDQSxXQUFBLEdBQ0EsWUFBQSxFQUNBLFFBQUEsS0FDQSxZQUNBLFdBRUEsY0FBQSxXQUNBLGVBQUEsV0FBQSxjQUFBLEtBQUEsTUFFQSxLQUFBLFFBQUEsR0FBQSxTQUVBLEtBQUEsYUFDQSxJQUFBLFFBQUEsS0FBQSxPQUFBLE9BSUEsUUFBQSxXQUNBLEtBQUEsT0FBQSxVQUVBLEtBQUEsWUFBQSxTQUNBLEtBQUEsV0FBQSxTQUVBLEtBQUEsU0FBQSxJQUFBLE1BQUEsUUFBQSxLQUNBLEtBQUEsU0FBQSxJQUFBLE1BQUEsTUFBQSxLQUNBLEtBQUEsU0FBQSxJQUFBLE1BQUEsT0FBQSxLQUVBLGVBQUEsV0FBQSxRQUFBLEtBQUEsT0FHQSxPQUFBLFdBSUEsR0FIQSxLQUFBLFNBQUEsSUFBQSxJQUFBLEtBQUEsYUFDQSxLQUFBLGNBQUEsS0FBQSxTQUFBLElBQUEsS0FFQSxLQUFBLFNBQUEsQ0FFQSxLQUFBLFVBQ0EsS0FBQSxjQUNBLEtBQUEscUJBQ0EsS0FBQSxjQUVBLElBQUEsR0FBQSxLQUFBLFFBQUEsTUFBQSxtQkFDQSxFQUFBLEtBQUEsUUFBQSxNQUFBLHNCQUNBLEVBQUEsS0FBQSxRQUFBLE1BQUEsdUJBRUEsRUFBQSxLQUFBLFVBRUEsRUFBQSxJQUFBLElBQUEsSUFBQSxVQUFBLE9BQUEsRUFBQSxVQUNBLElBQUEsTUFDQSxRQUFBLHFCQUNBLEtBQUEsaURBQ0EsUUFBQSxLQUdBLEVBQUEsS0FBQSxNQUNBLE1BQUEsZ0JBQ0EsT0FBQSxFQUNBLFNBQUEsRUFDQSxTQUFBLFNBQUEsR0FHQSxNQUZBLE1BQUEsT0FBQSxHQUNBLEtBQUEsU0FDQSxHQUNBLEtBQUEsS0FBQSxRQUNBLFFBQUEsR0FFQSxNQUFBLFNBQUEsR0FBQSxVQUFBLFdBQUEsRUFBQSxXQUVBLElBQUEsR0FBQSxTQUFBLEtBQUEsT0FBQSxpQ0FBQSxFQUNBLElBQUEsR0FDQSxFQUFBLFNBRUEsRUFBQSxZQUFBLFFBQUEsV0FDQSxLQUFBLGNBQ0EsS0FBQSxjQUNBLEtBQUEsVUFBQSxhQUFBLFFBRUEsS0FBQSxVQUFBLFNBQUEsU0FBQSxTQUFBLFdBRUEsRUFBQSxRQUNBLE1BRUEsRUFBQSxZQUFBLFFBQUEsV0FDQSxLQUFBLGNBQ0EsS0FBQSxjQUNBLEtBQUEsVUFBQSxhQUFBLFNBRUEsS0FBQSxVQUFBLFNBQUEsU0FBQSxZQUFBLFdBRUEsS0FBQSxPQUFBLFFBRUEsRUFBQSxRQUNBLE1BRUEsRUFBQSxZQUFBLFFBQUEsV0FDQSxFQUFBLE1BQUEsS0FBQSxTQUFBLGNBQ0EsRUFBQSxTQUVBLEVBQUEsV0FFQSxNQUVBLEVBQUEsWUFBQSxRQUFBLFdBQ0EsR0FBQSxLQUFBLFdBQ0EsRUFBQSxTQUVBLEVBQUEsVUFHQSxLQUFBLFVBQUEsYUFBQSxTQUNBLEtBQUEsT0FBQSxRQUFBLElBRUEsTUFFQSxlQUFBLFFBQUEsS0FBQSxnQkFDQSxLQUFBLE9BQUEsU0FBQSxlQUFBLFFBQUEsS0FBQSxnQkFFQSxLQUFBLE9BQUEsVUFBQSxpQkFFQSxLQUFBLFFBQUEsT0FBQSxLQUFBLE1BQUEsS0FBQSxPQUFBLGFBRUEsS0FBQSxRQUFBLFlBRUEsS0FBQSxPQUFBLGFBQUEsR0FBQSxTQUFBLFNBQUEsR0FDQSxHQUFBLGNBQUEsRUFBQSxLQUFBLFFBQUEsS0FBQSxPQUFBLGFBQUEsY0FBQSxVQUFBLEVBQUEsS0FBQSxNQUFBLENBQ0EsR0FBQSxHQUFBLEtBQUEsT0FBQSxhQUNBLEVBQUEsRUFBQSxhQUVBLE9BQUEsMEJBQUEsS0FBQSxFQUFBLFFBQUEsRUFBQSxLQUFBLE1BQUEsTUFBQSxPQUNBLEVBQUEsWUFBQSxFQUFBLEtBQUEsTUFBQSxNQUFBLElBQUEsRUFBQSxLQUFBLE1BQUEsTUFBQSxLQUlBLEtBQUEsTUFBQSxLQUFBLE9BQUEsYUFDQSxLQUFBLFNBR0EsWUFBQSxXQUNBLEtBQUEsVUFBQSxhQUFBLFVBR0EsWUFBQSxXQUNBLEtBQUEsVUFBQSxhQUFBLFNBR0EsWUFBQSxXQUNBLEtBQUEsUUFBQSxTQUFBLGFBQUEsVUFHQSxZQUFBLFdBQ0EsS0FBQSxRQUFBLFNBQUEsYUFBQSxTQUdBLFFBQUEsV0FDQSxLQUFBLFNBQUEsYUFBQSxRQUNBLEtBQUEsU0FBQSxTQUFBLEdBQ0EsS0FBQSxTQUFBLFVBQUEsR0FFQSxLQUFBLFdBQUEsSUFBQSxJQUFBLElBQUEsVUFBQSxhQUFBLEtBQUEsVUFDQSxJQUFBLFdBQ0EsS0FBQSxLQUFBLGNBQUEsWUFDQSxRQUFBLEtBQUEsY0FBQSxlQUdBLEtBQUEsV0FBQSxhQUFBLFFBQ0EsS0FBQSxXQUFBLFNBQUEsR0FDQSxLQUFBLFdBQUEsVUFBQSxHQUVBLEtBQUEsWUFBQSxJQUFBLElBQUEsSUFBQSxVQUFBLGFBQUEsS0FBQSxVQUNBLElBQUEsTUFDQSxRQUFBLDJCQUFBLEtBQUEsT0FBQSxpQ0FBQSxXQUFBLGNBQUEsUUFBQSxLQUFBLE9BR0EsSUFBQSxHQUFBLElBQUEsSUFBQSxJQUFBLFVBQUEsT0FBQSxLQUFBLFlBQUEsS0FDQSxJQUFBLE1BQ0EsUUFBQSwrQkFDQSxLQUFBLDJCQUdBLEVBQUEsSUFBQSxPQUFBLDBCQUNBLElBQUEsRUFBQSxDQUNBLEdBQUEsR0FBQSxFQUFBLE1BQUEsUUFDQSxHQUFBLElBQUEsTUFBQSxFQUFBLFdBRUEsRUFBQSxHQUFBLFNBQUEsV0FDQSxFQUFBLFNBQUEsS0FBQSxJQUFBLFNBR0EsRUFBQSxHQUFBLFNBQUEsU0FBQSxFQUFBLEdBQ0EsRUFBQSxJQUFBLE1BQUEsSUFJQSxHQUFBLEdBQUEsSUFBQSxJQUFBLElBQUEsVUFBQSxPQUFBLEtBQUEsWUFBQSxLQUNBLElBQUEsTUFDQSxRQUFBLHFCQUdBLE1BQUEsVUFBQSxJQUFBLElBQUEsSUFBQSxVQUFBLE9BQUEsR0FDQSxJQUFBLE1BQ0EsUUFBQSxLQUFBLFNBQUEsSUFBQSxVQUFBLGVBQUEsS0FBQSxjQUFBLGVBR0EsS0FBQSxRQUFBLElBQUEsSUFBQSxJQUFBLFVBQUEsT0FBQSxHQUNBLElBQUEsTUFDQSxRQUFBLDhCQUdBLEtBQUEsUUFBQSxJQUFBLElBQUEsSUFBQSxVQUFBLE9BQUEsS0FBQSxRQUFBLEtBQ0EsSUFBQSxRQUdBLElBQUEsR0FBQSxJQUNBLE1BQUEsUUFBQSxVQUFBLFdBQ0EsRUFBQSxPQUFBLFFBQ0EsSUFBQSxHQUFBLEVBQUEsT0FBQSxhQUFBLGtCQUFBLEVBQUEsT0FBQSxTQUFBLFdBQUEsRUFBQSxPQUFBLFNBQUEsVUFBQSxXQUFBLEVBRUEsTUFBQSxTQUFBLFVBQUEsSUFHQSxHQUFBLEtBQUEsT0FBQSw4Q0FBQSxHQUFBLEtBQUEsT0FBQSw2Q0FDQSxLQUFBLFVBQUEsSUFBQSxJQUFBLElBQUEsVUFBQSxPQUFBLEtBQUEsWUFBQSxLQUNBLElBQUEsTUFDQSxRQUFBLDJCQUdBLEtBQUEsa0JBQ0EsS0FBQSxVQUFBLElBQUEsVUFBQSxnRUFBQSxLQUFBLFVBQUEsR0FBQSxTQUFBLEtBQUEsVUFBQSxHQUFBLHFFQUFBLEtBQUEsVUFBQSxHQUFBLGdCQUFBLEtBQUEsVUFBQSxHQUFBLGlFQUFBLEVBQUEsNENBQUEsR0FBQSxLQUFBLFVBQUEsR0FBQSxRQUFBLFVBQUEsS0FBQSxVQUFBLEdBQUEsaUJBQUEsU0FFQSxLQUFBLFVBQUEsTUFBQSxJQUFBLEtBQUEsVUFBQSxHQUFBLGdCQUFBLEdBQUEsU0FBQSxTQUFBLEVBQUEsR0FDQSxLQUFBLFlBQUEsRUFBQSxNQUFBLEdBQ0EsRUFBQSxNQUFBLElBQ0EsUUFFQSxLQUFBLFVBQUEsSUFBQSxVQUFBLGdFQUFBLEtBQUEsVUFBQSxHQUFBLFNBQUEsS0FBQSxVQUFBLEdBQUEsK0JBQUEsRUFBQSxxQ0FBQSxHQUFBLEtBQUEsVUFBQSxHQUFBLFVBQUEsU0FFQSxLQUFBLFVBQUEsTUFBQSxJQUFBLEtBQUEsVUFBQSxHQUFBLFNBQUEsR0FBQSxTQUFBLFNBQUEsRUFBQSxHQUNBLEtBQUEsWUFBQSxFQUFBLE9BQ0EsRUFBQSxNQUFBLElBQ0EsUUFJQSxLQUFBLFVBQUEsSUFBQSxJQUFBLElBQUEsVUFBQSxPQUFBLEtBQUEsWUFBQSxLQUNBLElBQUEsTUFDQSxRQUFBLGFBQ0EsS0FBQSxFQUFBLHlDQUlBLElBQUEsVUFBQSxPQUFBLEtBQUEsWUFBQSxLQUNBLElBQUEsT0FDQSxNQUFBLGlCQUlBLGFBQUEsV0FDQSxLQUFBLFFBQUEsSUFBQSxJQUFBLElBQUEsVUFBQSxPQUFBLEtBQUEsV0FDQSxJQUFBLE1BQ0EsUUFBQSxVQUNBLEtBQ0EsSUFBQSxNQUNBLFFBQUEsaUJBQ0EsS0FBQSw2Q0FFQSxJQUFBLE1BQ0EsUUFBQSxxQkFDQSxLQUFBLCtDQUVBLElBQUEsTUFDQSxRQUFBLG9CQUNBLEtBQUEsa0RBSUEsSUFBQSxHQUFBLElBRUEsTUFBQSxRQUFBLE1BQUEsdUJBQUEsT0FBQSxXQUNBLEtBQUEsTUFBQSxLQUFBLFlBQUEsY0FDQSxLQUFBLE1BQUEsS0FBQSxTQUFBLGFBRUEsRUFBQSxVQUFBLFNBQUEsU0FBQSxTQUFBLFNBQ0EsRUFBQSxPQUFBLFNBQ0EsRUFBQSxRQUFBLGFBR0EsS0FBQSxRQUFBLE1BQUEsdUJBQUEsUUFBQSxXQUNBLEtBQUEsTUFBQSxLQUFBLFNBQUEsY0FDQSxLQUFBLE1BQUEsS0FBQSxZQUFBLGFBRUEsRUFBQSxVQUFBLFNBQUEsU0FBQSxZQUFBLFNBQ0EsRUFBQSxPQUFBLFVBR0EsS0FBQSxRQUFBLE1BQUEsc0JBQUEsT0FBQSxXQUNBLEtBQUEsTUFBQSxLQUFBLFlBQUEsZUFDQSxLQUFBLE1BQUEsS0FBQSxTQUFBLGdCQUVBLElBQUEsR0FBQSxJQUFBLElBQUEsc0JBQ0EsSUFDQSxFQUFBLFNBQUEsNkJBR0EsRUFBQSxZQUFBLEVBRUEsR0FBQSxTQUFBLEtBQUEsT0FBQSw0Q0FBQSxHQUNBLEVBQUEsUUFBQSxNQUFBLHVCQUFBLFNBRUEsRUFBQSxRQUFBLE1BQUEsdUJBQUEsVUFHQSxFQUFBLGNBQ0EsRUFBQSxjQUVBLEVBQUEsT0FBQSxRQUVBLEVBQUEsVUFBQSxTQUFBLFNBQUEsU0FBQSxjQUVBLEVBQUEsT0FBQSxVQUFBLFdBQUEsTUFDQSxFQUFBLE9BQUEsVUFHQSxLQUFBLFFBQUEsTUFBQSxzQkFBQSxRQUFBLFdBQ0EsS0FBQSxNQUFBLEtBQUEsU0FBQSxlQUNBLEtBQUEsTUFBQSxLQUFBLFlBQUEsZ0JBRUEsSUFBQSxHQUFBLElBQUEsSUFBQSxzQkFDQSxJQUNBLEVBQUEsWUFBQSw2QkFHQSxFQUFBLFlBQUEsRUFFQSxHQUFBLFNBQUEsS0FBQSxPQUFBLGlDQUFBLEdBQ0EsRUFBQSxRQUFBLE1BQUEsdUJBQUEsU0FFQSxFQUFBLFFBQUEsTUFBQSx1QkFBQSxVQUdBLEVBQUEsY0FDQSxFQUFBLGNBRUEsRUFBQSxPQUFBLFFBRUEsRUFBQSxVQUFBLFNBQUEsU0FBQSxZQUFBLGNBRUEsRUFBQSxPQUFBLFVBQUEsV0FBQSxLQUVBLEVBQUEsUUFBQSxjQUlBLFlBQUEsV0FDQSxLQUFBLE9BQUEsSUFBQSxLQUFBLElBQUEsU0FBQSxXQUFBLE9BQUEsS0FBQSxjQUFBLGNBQ0EsSUFBQSxRQUFBLDRCQUVBLEtBQUEsT0FBQSxZQUNBLFNBQUEsSUFDQSxTQUFBLEdBQ0EsMkJBQUEsRUFDQSxhQUFBLEVBQ0EsWUFBQSxFQUNBLGFBQUEsRUFDQSxpQkFBQSxFQUNBLGlCQUFBLEVBQ0EsU0FBQSxTQUFBLEtBQUEsT0FBQSxzQ0FBQSxHQUNBLFdBQUEsS0FBQSxPQUFBLHVDQUFBLEtBRUEsS0FBQSxPQUFBLGdCQUFBLElBQ0EsS0FBQSxPQUFBLFFBQUEsZ0JBQUEsR0FDQSxLQUFBLE9BQUEsUUFBQSxvQkFDQSxLQUFBLE9BQUEsU0FBQSxnQkFBQSxHQUFBLElBQ0EsS0FBQSxPQUFBLFFBQUEsU0FBQSxLQUFBLFNBQUEsWUFDQSxLQUFBLE9BQUEsUUFBQSxRQUFBLDJCQUNBLEtBQUEsT0FBQSxTQUFBLGNBQUEsS0FBQSxPQUFBLGlDQUFBLFlBRUEsS0FBQSxVQUFBLFNBQUEsWUFDQSxLQUFBLFlBQUEsU0FBQSxjQUVBLEtBQUEsWUFBQSxTQUFBLGVBSUEsS0FBQSxPQUFBLFVBQUEsR0FBQSxlQUFBLFNBQUEsRUFBQSxHQUNBLEtBQUEsZUFDQSxLQUFBLGNBQUEsT0FBQSxHQUdBLElBQUEsR0FBQSxFQUFBLFVBQ0EsR0FBQSxNQUFBLEtBQUEsRUFBQSxJQUFBLEtBRUEsS0FBQSxPQUFBLFFBQUEsb0JBQUEsRUFBQSxNQUFBLElBQUEsS0FDQSxLQUFBLE9BRUEsS0FBQSxPQUFBLFFBQUEsZ0JBQ0EsU0FBQSxTQUFBLEVBQUEsRUFBQSxHQUNBLE1BQUEsR0FBQSxnQkFFQSxRQUFBLFNBQUEsRUFBQSxFQUFBLEdBT0EsTUFOQSxHQUFBLFNBQUEsS0FBQSxPQUFBLG9CQUFBLEtBQUEsR0FBQSxJQUFBLEVBQUEsSUFBQSxPQUFBLEdBQ0EsS0FBQSxpQkFBQSxFQUFBLFNBRUEsRUFBQSxRQUFBLFVBQUEsR0FHQSxJQUNBLEtBQUEsT0FHQSxLQUFBLE9BQUEsU0FBQSxZQUNBLEtBQUEsY0FDQSxTQUFBLElBQUEsTUFBQSxJQUFBLE9BQ0EsS0FBQSxTQUFBLEdBQ0EsR0FBQSxHQUFBLEVBQUEsUUFBQSxRQUFBLEVBQUEsb0JBQUEsS0FDQSxFQUFBLGlDQUFBLEtBQUEsRUFDQSxHQUNBLEVBQUEsUUFBQSxXQUFBLEVBQUEsb0JBQUEsSUFBQSxFQUFBLG9CQUFBLElBQUEsS0FFQSxFQUFBLFlBS0EsS0FBQSxPQUFBLFNBQUEsWUFDQSxLQUFBLGtCQUNBLFNBQUEsSUFBQSxNQUFBLElBQUEsT0FDQSxLQUFBLFdBQ0EsS0FBQSxZQUNBLEtBQUEsUUFBQSxNQUFBLHNCQUFBLFdBRUEsS0FBQSxPQUdBLElBQUEsR0FBQSxJQUFBLFFBQUEsMEJBQ0EsR0FDQSxlQUFBLFNBQUEsRUFBQSxFQUFBLEVBQUEsRUFBQSxHQUNBLE1BQUEsS0FBQSxFQUFBLFFBQUEsRUFBQSxTQUFBLFNBRUEsS0FBQSxLQUFBLFNBQ0EsSUFBQSxlQUFBLE9BQUEsYUFDQSxRQUNBLE9BQUEsdUJBQ0EsT0FBQSxHQUVBLFdBQ0EsU0FDQSxHQUFBLFNBQUEsR0FDQSxFQUFBLEtBQUEsRUFBQSxVQUVBLE1BQUEsU0FYQSxTQWtCQSxHQUFBLGFBQUEsR0FFQSxLQUFBLE9BQUEsVUFBQSxpQkFBQSxZQUFBLEtBQUEsbUJBQUEsR0FDQSxLQUFBLE9BQUEsVUFBQSxpQkFBQSxXQUFBLEtBQUEsbUJBQUEsR0FDQSxLQUFBLE9BQUEsVUFBQSxpQkFBQSxPQUFBLEtBQUEsS0FBQSxLQUFBLE9BQUEsSUFHQSxpQkFBQSxTQUFBLEdBQ0EsS0FBQSxjQUFBLElBQUEsSUFBQSxHQUVBLEtBQUEsaUJBQ0EsS0FBQSxjQUFBLE9BQUEsNElBR0EsS0FBQSxVQUFBLEdBQUEsK0VBQ0EsS0FBQSxVQUFBLEdBQUEsZ0lBSUEsS0FBQSxjQUFBLE9BQUEsNElBR0EsS0FBQSxVQUFBLEdBQUEsd0hBS0EsSUFBQSxHQUFBLEtBQUEsY0FBQSxNQUFBLGVBQ0EsRUFBQSxLQUFBLGNBQUEsTUFBQSxrQkFFQSxHQUFBLE9BQUEsV0FDQSxFQUFBLFNBQUEscUJBQ0EsRUFBQSxRQUdBLEVBQUEsUUFBQSxXQUNBLEVBQUEsWUFBQSxxQkFDQSxFQUFBLFFBR0EsRUFBQSxHQUFBLFFBQUEsV0FDQSxFQUFBLFNBQUEscUJBR0EsRUFBQSxVQUZBLEVBQUEsVUFJQSxLQUFBLE9BRUEsS0FBQSxjQUFBLE1BQUEsZUFBQSxHQUFBLFFBQUEsV0FDQSxLQUFBLE1BQ0EsTUFBQSwrQkFDQSxRQUFBLFNBQUEsR0FDQSxLQUFBLE9BQUEsT0FBQSxVQUFBLEVBQUEsSUFBQSxLQUNBLEtBQUEsT0FBQSxTQUVBLE1BQUEsT0FDQSxRQUNBLEtBQUEsT0FFQSxLQUFBLGNBQUEsTUFBQSxrQkFBQSxHQUFBLFFBQUEsV0FDQSxLQUFBLE1BQ0EsTUFBQSxzQkFDQSxPQUFBLFNBQUEsS0FBQSxPQUFBLGtDQUNBLGdCQUFBLEdBQUEsU0FBQSxLQUFBLE9BQUEseUNBQUEsR0FDQSxTQUFBLFNBQUEsR0FDQSxHQUFBLEdBQUEsRUFDQSxHQUFBLFVBQUEsRUFBQSxLQUNBLEVBQUEsRUFBQSxJQUFBLEVBQUEsS0FBQSxLQUFBLEVBQUEsZ0JBQUEsS0FBQSxFQUFBLEtBQUEsS0FFQSxLQUFBLE9BQUEsT0FBQSxHQUNBLEtBQUEsT0FBQSxTQUVBLE1BQUEsT0FDQSxRQUNBLEtBQUEsUUFHQSxtQkFBQSxXQUNBLEtBQUEsaUJBQUEsT0FBQSxXQUNBLE9BQ0EsSUFBQSxFQUNBLElBQ0EsR0FBQSxVQUNBLEVBQUEsY0FDQSxFQUFBLFNBQ0EsT0FFQSxHQUFBLFdBQ0EsSUFBQSxFQUNBLEVBQUEsSUFDQSxFQUFBLElBQ0EsT0FFQSxHQUFBLFFBQ0EsRUFBQSxTQUNBLEVBQUEsUUFDQSxJQUFBLEVBQ0EsSUFDQSxFQUFBLFNBQ0EsRUFBQSxVQUNBLElBQUEsRUFDQSxJQUNBLEdBQUEsUUFDQSxFQUFBLGlCQUVBLEdBQUEsU0FDQSxFQUFBLGlCQUdBLEdBQUEsV0FDQSxFQUFBLGtCQUVBLEdBQUEsV0FDQSxFQUFBLGdCQUNBLEVBQUEsSUFDQSxJQUFBLFNBTUEsS0FBQSxXQUFBLEdBQUEsYUFDQSxNQUFBLEVBQ0EsVUFBQSxTQUFBLEVBQUEsR0FDQSxHQUFBLEdBQUEsRUFDQSxJQUFBLEdBQUEsS0FBQSxZQUFBLEdBQ0EsSUFNQSxNQUxBLEdBQUEsS0FBQSxVQUFBLEVBQUEsR0FBQSxNQUVBLEVBQUEsRUFBQSxRQUFBLFFBQUEsY0FDQSxFQUFBLEVBQUEsUUFBQSxNQUFBLGNBR0EsTUFBQSxJQUdBLElBTUEsTUFMQSxHQUFBLEtBQUEsY0FBQSxHQUFBLE1BRUEsRUFBQSxFQUFBLFFBQUEsUUFBQSxjQUNBLEVBQUEsRUFBQSxRQUFBLE1BQUEsY0FHQSxNQUFBLElBRUEsTUFBQSxNQUdBLEtBQUEsV0FBQSxPQUFBLE1BQUEsU0FBQSxhQUVBLElBQUEsR0FBQSxTQUFBLEVBQUEsR0FDQSxHQUFBLEtBQUEsV0FBQSxPQUFBLEVBQUEsR0FBQSxLQUNBLE1BQUEsTUFBQSxXQUFBLE9BQUEsRUFBQSxHQUFBLElBRUEsSUFBQSxHQUFBLElBQUEsSUE2QkEsT0EzQkEsTUFBQSxLQUFBLFNBQ0EsSUFBQSxlQUFBLE9BQUEsYUFDQSxRQUNBLE9BQUEsb0JBQ0EsSUFBQSxFQUFBLEdBQUEsS0FFQSxXQUNBLFNBQ0EsR0FBQSxTQUFBLEdBQ0EsR0FBQSxHQUFBLElBQUEsSUFBQSxFQUNBLElBQUEsRUFBQSxDQUNBLEVBQUEsT0FBQSxFQUFBLE1BQ0EsRUFBQSxJQUFBLGdCQUFBLE1BRUEsS0FBQSxXQUFBLE9BQUEsRUFBQSxHQUFBLEtBQUEsRUFBQSxJQUFBLFNBRUEsSUFBQSxHQUFBLElBQUEsSUFBQSxJQUFBLFVBQUEsV0FBQSxJQUFBLE1BQUEsS0FBQSxLQUFBLFNBQUEsSUFBQSxRQUNBLEdBQUEsTUFBQSxJQUFBLEdBQUEsT0FBQSxFQUFBLE1BQUEsSUFBQSxnQkFBQSxNQUVBLEtBQUEsU0FBQSxJQUFBLE1BQUEsRUFBQSxJQUFBLFlBR0EsTUFBQSxTQUtBLFlBQUEsRUFBQSxrREFBQSxFQUFBLEdBQUEsSUFBQSxXQUVBLEtBQUEsTUFFQSxFQUFBLEtBQUEsVUFDQSxHQUFBLFNBQUEsTUFBQSxLQUFBLFdBQ0EsR0FBQSxHQUFBLEVBQUEsU0FBQSxNQUFBLElBQ0EsT0FBQSxZQUNBLEdBQUEsR0FBQSxFQUFBLE1BQUEsS0FBQSxVQUlBLE9BSEEsR0FBQSxFQUFBLFFBQUEsUUFBQSxjQUNBLEVBQUEsRUFBQSxRQUFBLE1BQUEsaUJBTUEsSUFBQSxHQUFBLFNBQUEsR0FDQSxFQUFBLE9BQUEsTUFBQSxLQUFBLFNBQUEsS0FBQSxjQUNBLEVBQUEsU0FBQSxNQUFBLE9BQUEsR0FDQSxLQUFBLE1BRUEsRUFBQSxTQUFBLEdBQ0EsRUFBQSxPQUFBLE1BQUEsS0FBQSxXQUFBLEtBQUEsaUJBQ0EsS0FBQSxLQUVBLE1BQUEsV0FBQSxJQUFBLEdBQ0EsS0FBQSxXQUFBLElBQUEsSUFHQSxNQUFBLFNBQUEsR0FDQSxHQUFBLEdBQUEsS0FBQSxXQUFBLE9BQUEsRUFLQSxJQUhBLEVBQUEsRUFBQSxRQUFBLE9BQUEsS0FDQSxFQUFBLEVBQUEsUUFBQSxPQUFBLEtBRUEsR0FBQSxLQUFBLE9BQUEscUNBQUEsQ0FDQSxLQUFBLGNBQ0EsYUFBQSxLQUFBLGFBR0EsSUFBQSxHQUFBLFNBQUEsS0FBQSxPQUFBLDhDQUFBLElBRUEsTUFBQSxhQUFBLFdBQUEsV0FDQSxLQUFBLEtBQUEsU0FDQSxJQUFBLGVBQUEsT0FBQSxhQUNBLFFBQ0EsT0FBQSw0QkFDQSxRQUFBLEVBQ0EsU0FBQSxLQUFBLFFBQUEsSUFFQSxVQUFBLEVBQ0EsV0FDQSxTQUNBLEdBQUEsU0FBQSxHQUNBLEdBQUEsR0FBQSxTQUFBLGNBQUEsTUFDQSxHQUFBLFVBQUEsRUFBQSxLQUVBLEtBQUEsUUFBQSxNQUFBLEtBQUEsUUFBQSxJQUFBLEtBQUEsUUFBQSxLQUFBLEtBQUEsUUFBQSxJQUFBLElBRUEsS0FBQSxRQUFBLFlBRUEsS0FBQSxPQUFBLG9CQUFBLElBQUEsR0FBQSxLQUFBLE9BQUEsYUFBQSxjQUFBLGNBQ0EsS0FBQSxRQUFBLFNBQUEsSUFBQSxVQUFBLEtBQUEsUUFBQSxTQUFBLElBQUEsZUFJQSxNQUFBLFVBSUEsS0FBQSxNQUFBLE9BQ0EsQ0FDQSxHQUFBLEdBQUEsU0FBQSxjQUFBLE1BQ0EsR0FBQSxVQUFBLEVBRUEsS0FBQSxRQUFBLE1BQUEsS0FBQSxRQUFBLElBQUEsS0FBQSxRQUFBLEtBQUEsS0FBQSxRQUFBLElBQUEsSUFFQSxLQUFBLFFBQUEsWUFFQSxLQUFBLE9BQUEsb0JBQUEsSUFBQSxHQUFBLEtBQUEsT0FBQSxhQUFBLGNBQUEsY0FDQSxLQUFBLFFBQUEsU0FBQSxJQUFBLFVBQUEsS0FBQSxRQUFBLFNBQUEsSUFBQSxjQU9BLE1BSEEsTUFBQSxXQUFBLElBQUEsTUFBQSxLQUFBLE9BQUEsV0FDQSxLQUFBLFNBQUEsSUFBQSxNQUFBLEVBRUEsR0FHQSxhQUFBLFNBQUEsR0FHQSxHQUFBLEdBQUEsRUFBQSxJQUNBLEVBQUEsRUFBQSxJQUFBLFdBQUEsRUFBQSxJQUNBLElBQUEsS0FBQSxFQUNBLE9BQUEsQ0FPQSxJQUZBLElBQ0EsRUFBQSxFQUFBLElBQUEsV0FBQSxHQUNBLE1BQUEsRUFDQSxPQUFBLENBT0EsSUFGQSxJQUNBLEVBQUEsRUFBQSxJQUFBLFdBQUEsR0FDQSxNQUFBLEVBQ0EsT0FBQSxDQU9BLElBRkEsSUFDQSxFQUFBLEVBQUEsSUFBQSxXQUFBLEdBQ0EsS0FBQSxFQUNBLE9BQUEsQ0FPQSxJQUZBLElBQ0EsRUFBQSxFQUFBLElBQUEsV0FBQSxHQUNBLE1BQUEsRUFDQSxPQUFBLENBT0EsSUFGQSxJQUNBLEVBQUEsRUFBQSxJQUFBLFdBQUEsR0FDQSxNQUFBLEVBQ0EsT0FBQSxDQU9BLElBRkEsSUFDQSxFQUFBLEVBQUEsSUFBQSxXQUFBLEdBQ0EsS0FBQSxFQUNBLE9BQUEsQ0FHQSxJQUtBLEtBSEEsR0FBQSxHQUFBLEVBQ0EsRUFBQSxFQUFBLE9BQ0EsR0FBQSxFQUNBLEVBQUEsR0FBQSxDQUNBLEdBQUEsS0FBQSxFQUFBLElBQUEsV0FBQSxHQUFBLENBQ0EsR0FBQSxDQUNBLE9BR0EsR0FBQSxLQUFBLEVBQUEsSUFBQSxXQUFBLEdBQ0EsT0FBQSxDQUdBLEtBR0EsSUFBQSxFQUFBLE9BQUEsQ0FFQSxHQUFBLElBQUEsRUFBQSxFQUVBLEVBQUEsSUFBQSxFQUFBLFNBQ0EsRUFBQSxJQUFBLEVBQUEsT0FHQSxJQUFBLEdBQUEsRUFBQSxJQUFBLE1BQUEsRUFBQSxHQUdBLEdBQ0EsS0FBQSxTQUNBLE1BQUEsRUFBQSxNQUNBLFFBQUEsRUFDQSxJQUFBLEVBS0EsT0FGQSxHQUFBLEtBQUEsSUFFQSxHQUdBLGVBQUEsU0FBQSxFQUFBLEdBQ0EsR0FBQSxHQUFBLEVBQUEsRUFBQSxFQUNBLEVBQUEsRUFBQSxHQUVBLElBQUEsS0FBQSxFQUFBLElBQUEsV0FBQSxHQUFBLE9BQUEsQ0FFQSxJQURBLElBQ0EsS0FBQSxFQUFBLElBQUEsV0FBQSxHQUFBLE9BQUEsQ0FFQSxJQURBLElBQ0EsS0FBQSxFQUFBLElBQUEsV0FBQSxHQUFBLE9BQUEsQ0FTQSxLQVBBLElBQ0EsRUFBQSxFQUFBLE9BRUEsRUFBQSxNQUVBLEVBQUEsRUFBQSxFQUVBLE1BQUEsRUFBQSxFQUFBLElBQUEsUUFBQSxJQUFBLEtBQUEsQ0FHQSxJQUZBLEVBQUEsRUFBQSxFQUVBLEVBQUEsR0FBQSxLQUFBLEVBQUEsSUFBQSxXQUFBLElBQUEsR0FFQSxJQUFBLEVBQUEsSUFBQSxFQUFBLE9BWUEsTUFYQSxJQUNBLEVBQUEsTUFDQSxLQUFBLE9BQ0EsUUFBQSxFQUFBLElBQUEsTUFBQSxFQUFBLEdBQ0EsUUFBQSxVQUFBLEtBQ0EsT0FDQSxPQUFBLEVBQ0EsTUFBQSxFQUFBLFFBR0EsRUFBQSxJQUFBLEdBQ0EsRUFNQSxNQUZBLEtBQUEsRUFBQSxTQUFBLEdBQ0EsRUFBQSxLQUFBLEVBQUEsUUFDQSxHQUdBLGtCQUFBLFNBQUEsR0FDQSxFQUFBLGtCQUNBLEVBQUEsa0JBR0EsS0FBQSxTQUFBLEdBQ0EsRUFBQSxrQkFDQSxFQUFBLGtCQUVBLEdBQUEsS0FBQSxPQUFBLDhDQUFBLEdBQUEsS0FBQSxPQUFBLDhDQUNBLEtBQUEsWUFBQSxFQUFBLGFBQUEsUUFJQSxZQUFBLFNBQUEsRUFBQSxHQUNBLEVBQUEsR0FBQSxFQUVBLElBQUEsS0FBQSxFQUFBLFNBQUEsR0FDQSxHQUFBLEdBQUEsV0FBQSxLQUFBLEVBQUEsS0FFQSxJQUFBLEVBQUEsQ0FDQSxHQUFBLEdBQUEsS0FBQSxPQUFBLDZDQUFBLE9BQUEsQ0FFQSxLQUFBLEtBQUEsVUFBQSxLQUFBLE9BQUEscUNBQUEsR0FHQSxNQUZBLE1BQUEsWUFBQSxFQUFBLFFBQUEsRUFBQSxpREFFQSxDQUlBLEtBQUEsS0FBQSxVQUFBLEVBQUEsTUFHQSxNQUZBLE1BQUEsWUFBQSxFQUFBLFFBQUEsRUFBQSx1Q0FFQSxDQUdBLElBQUEsS0FBQSxPQUFBLHlDQUNBLEtBQUEsTUFDQSxNQUFBLGdDQUNBLEtBQUEsRUFDQSxHQUFBLEtBQ0EsT0FBQSxJQUNBLFFBRUEsS0FBQSxXQUFBLEVBQUEsUUFBQSxHQUNBLEtBQUEsT0FBQSxhQUVBLENBQ0EsR0FBQSxHQUFBLEtBQUEsT0FBQSw0Q0FBQSxPQUFBLENBRUEsS0FBQSxLQUFBLFVBQUEsS0FBQSxPQUFBLG9DQUFBLEdBR0EsTUFGQSxNQUFBLFlBQUEsRUFBQSxPQUFBLEVBQUEsZ0RBRUEsQ0FHQSxLQUFBLEtBQUEsVUFBQSxFQUFBLE1BR0EsTUFGQSxNQUFBLFlBQUEsRUFBQSxPQUFBLEVBQUEsdUNBRUEsQ0FHQSxNQUFBLFdBQUEsRUFBQSxRQUNBLEtBQUEsT0FBQSxVQUdBLE9BR0EsVUFBQSxTQUFBLEdBQ0EsR0FBQSxHQUFBLEtBQUEsT0FBQSxpQ0FLQSxPQUpBLElBQUEsSUFBQSxJQUFBLEVBQUEsS0FBQSxPQUFBLGdCQUFBLFdBRUEsRUFBQSxTQUFBLEdBRUEsR0FBQSxHQUFBLEVBRUEsR0FBQSxHQUdBLFVBQUEsU0FBQSxFQUFBLEdBQ0EsRUFBQSxFQUFBLE1BQUEsSUFDQSxJQUFBLEdBQUEsRUFBQSxLQUFBLE1BQUEsS0FBQSxLQUNBLE9BQUEsSUFBQSxFQUFBLFFBQUEsRUFBQSxnQkFHQSxXQUFBLFNBQUEsRUFBQSxFQUFBLEdBQ0EsRUFBQSxHQUFBLE9BQ0EsRUFBQSxHQUFBLENBRUEsSUFBQSxHQUFBLEtBQUEsZUFBQSxFQUFBLEVBQUEsTUFFQSxFQUFBLEdBQUEsU0FDQSxHQUFBLE9BQUEsT0FBQSxHQUNBLEVBQUEsT0FBQSxTQUFBLGNBQUEsRUFBQSxVQUNBLEVBQUEsT0FBQSxPQUFBLEVBQUEsTUFDQSxFQUFBLE9BQUEsV0FBQSxLQUFBLE9BQUEsVUFDQSxFQUFBLE9BQUEsU0FBQSxFQUVBLElBQUEsR0FBQSxHQUFBLGVBQ0EsR0FBQSxLQUFBLE9BQUEsZUFBQSxPQUFBLGNBQ0EsRUFBQSxpQkFBQSxhQUFBLFFBQ0EsRUFBQSxpQkFBQSxVQUFBLElBQUEsS0FBQSxlQUFBLFNBRUEsRUFBQSxPQUFBLFdBQUEsU0FBQSxHQUNBLEdBQUEsRUFBQSxpQkFBQSxDQUNBLEdBQUEsR0FBQSxFQUFBLE9BQUEsRUFBQSxNQUFBLElBQUEsQ0FDQSxHQUFBLE1BQUEsYUFBQSxTQUFBLEVBQUEsT0FFQSxLQUFBLE1BRUEsRUFBQSxPQUFBLFdBQ0EsR0FBQSxNQUFBLEVBQUEsT0FBQSxDQUNBLEdBQUEsR0FBQSxLQUFBLE1BQUEsRUFBQSxhQUNBLElBQUEsR0FBQSxFQUFBLFFBQUEsQ0FDQSxFQUFBLFFBQ0EsSUFBQSxHQUFBLFNBQUEsRUFBQSxJQUFBLEdBQ0EsRUFBQSxTQUFBLEVBQUEsT0FBQSxJQUNBLE1BQUEsT0FBQSxPQUFBLEVBQUEsSUFBQSxFQUFBLE9BQUEsS0FBQSxLQUFBLEVBQUEsT0FBQSxLQUFBLEtBQUEsRUFBQSxPQUFBLEtBQUEsS0FBQSxPQUVBLE1BQUEsYUFBQSxFQUFBLEVBQUEsV0FHQSxLQUFBLE1BRUEsRUFBQSxLQUFBLElBR0EsZUFBQSxTQUFBLEVBQUEsR0FDQSxHQUFBLEdBQUEsSUFBQSxVQUFBLFlBQUEsS0FBQSxXQUNBLElBQUEsTUFDQSxLQUFBLDJFQUFBLEVBQUEsNEJBQUEsR0FBQSxFQUFBLGlCQUdBLE9BQUEsS0FBQSxJQUFBLElBR0EsYUFBQSxTQUFBLEVBQUEsR0FDQSxFQUFBLE1BQUEsYUFBQSxTQUFBLFNBQ0EsRUFBQSxNQUFBLGFBQUEsU0FBQSxRQUVBLEVBQUEsTUFBQSxLQUFBLFNBQUEsa0JBQ0EsRUFBQSxNQUFBLEtBQUEsYUFBQSxlQUFBLGVBQ0EsRUFBQSxNQUFBLEtBQUEsWUFBQSxhQUVBLEVBQUEsTUFBQSxRQUFBLElBQUEsV0FBQSxZQUFBLEVBQ0EsRUFBQSxNQUFBLG1CQUFBLEdBQUEsUUFBQSxXQUNBLEVBQUEsWUFJQSxZQUFBLFNBQUEsRUFBQSxFQUFBLEdBQ0EsR0FBQSxHQUFBLEtBQUEsZUFBQSxFQUFBLEVBQUEsS0FDQSxNQUFBLGFBQUEsRUFBQSxJQUdBLGVBQUEsV0FDQSxNQUFBLG1CQUFBLFFBQUEsYUFBQSxLQUFBLFVBQUEsVUFBQSxRQUFBLGVBSUEsS0FBQSxRQUFBLFNBQUEsR0FDQSxHQUFBLGdCQUFBLFFBQ0EsWUFBQSxLQUlBLEtBQUEsWUFBQSxXQUNBLEdBQUEsR0FBQSxJQUFBLE1BQUEseUJBRUEsS0FBQSxLQUFBLEVBQUEsU0FBQSxHQUVBLE9BREEsRUFBQSxJQUFBLElBQUEsSUFHQSxlQUFBLGVBQUEsRUFBQSxLQUFBLEdBRUEsZUFBQSxlQUFBLEVBQUEsSUFBQSxHQUFBLGdCQUFBLFFBQ0EsWUFBQSxFQUFBLEtBREEsU0FKQSxLQVlBLEtBQUEsWUFBQSxXQUNBLEdBQUEsR0FBQSxJQUFBLE1BQUEsaUJBRUEsS0FBQSxLQUFBLEVBQUEsU0FBQSxHQUVBLE9BREEsRUFBQSxJQUFBLElBQUEsSUFHQSxlQUFBLGVBQUEsRUFBQSxLQUVBLGVBQUEsZUFBQSxFQUFBLElBQUEsVUFBQSxTQUZBLEdBRkEsS0NyakNBLGVBQUEsTUFBQSxlQUFBLFNBQUEsR0FDQSxHQUFBLEdBQUEsS0FBQSxNQUFBLEtBQUEsT0FBQSxvQ0FBQSxLQUVBLEdBQUEsTUFDQSxJQUFBLFFBQUEsR0FDQSxNQUFBLEdBQUEsS0FBQSxLQUFBLFdBQ0EsS0FBQSxFQUNBLFFBQUEsT0FBQSxRQUFBLFNBQUEsV0FFQSxhQUFBLE9BQ0EsS0FBQSxRQUNBLFdBQUEsT0FDQSxVQUFBLEVBQ0EsTUFBQSxFQUFBLEdBQUEsRUFBQSxHQUFBLEtBQUEsSUFHQSxJQUFBLEdBQUEsU0FBQSxLQUFBLE9BQUEsNENBQUEsRUFDQSxLQUNBLEVBQUEsSUFBQSxHQUFBLEtBQUEsVUFBQSw0RkFDQSx3SEFHQSxlQUFBLE1BQUEsZUFBQSxXQUFBLFlBQUEsS0FBQSxLQUFBLElBRUEsSUFBQSxPQUFBLGVBQUEsTUFBQSxlQUFBLEtBQUEsTUFBQSxVQUNBLElBQUEsSUFBQSx1Q0FBQSxlQUFBLE1BQUEsZ0JDekJBLGVBQUEsT0FBQSxRQUFBLFNBQUEsR0FDQSxFQUFBLE1BQ0EsRUFBQSxnQkFBQSxFQUFBLGlCQUFBLDZCQUVBLElBQUEsR0FBQSxJQUFBLElBRUEsS0FBQSxRQUFBLEdBQ0EsT0FBQSxFQUNBLE9BQUEsT0FDQSxZQUFBLE9BQ0EsUUFBQSxFQUNBLFdBQUEsRUFDQSxhQUFBLEVBQ0EsYUFBQSxFQUNBLFlBQUEsRUFDQSxZQUFBLEVBQ0EsV0FBQSxFQUNBLE1BQUEsSUFDQSxPQUFBLEVBQ0EsTUFBQSxFQUFBLHFDQUNBLElBQUEsNENBQ0EsUUFDQSxPQUFBLFNBQ0EsUUFBQSxFQUNBLFVBQ0EsT0FBQSxPQUNBLFdBQUEsTUFDQSxlQUFBLEdBQ0EsT0FBQSxPQUNBLFFBQUEsR0FFQSxRQUNBLFlBQUEsR0FDQSxVQUNBLFVBQUEsUUFDQSxPQUFBLFFBRUEsSUFBQSx5QkFDQSxRQUNBLE1BQUEsU0FDQSxLQUFBLDhDQUNBLFFBQUEsRUFBQSwrQkFDQSxNQUFBLEtBQ0EsTUFBQSxPQUNBLE9BQUEsY0FDQSxRQUFBLEtBQUEsb0JBRUEsTUFBQSxTQUNBLEtBQUEsNENBQ0EsUUFBQSxFQUFBLCtCQUNBLE1BQUEsS0FDQSxNQUFBLE9BQ0EsT0FBQSxjQUNBLFFBQUEsS0FBQSxvQkFFQSxNQUFBLFNBQ0EsS0FBQSxtREFDQSxRQUFBLEVBQUEsa0NBQ0EsTUFBQSxLQUNBLE1BQUEsR0FDQSxPQUFBLE9BQ0EsUUFBQSxLQUFBLG9CQUVBLE1BQUEsU0FDQSxLQUFBLG9EQUNBLFFBQUEsRUFBQSxtQ0FDQSxNQUFBLEtBQ0EsT0FBQSxHQUNBLE9BQUEsT0FDQSxRQUFBLEtBQUEsb0JBRUEsTUFBQSxTQUNBLEtBQUEsbURBQ0EsUUFBQSxFQUFBLHNDQUNBLE1BQUEsS0FDQSxNQUFBLElBQ0EsT0FBQSxTQUNBLFFBQUEsS0FBQSxvQkFFQSxNQUFBLFNBQ0EsS0FBQSxvREFDQSxRQUFBLEVBQUEsdUNBQ0EsTUFBQSxLQUNBLE1BQUEsR0FDQSxPQUFBLFNBQ0EsUUFBQSxLQUFBLG9CQUVBLE1BQUEsU0FDQSxLQUFBLDhDQUNBLFFBQUEsRUFBQSx3Q0FDQSxNQUFBLEtBQ0EsTUFBQSxLQUNBLE9BQUEsUUFDQSxRQUFBLEtBQUEsc0JBR0EsWUFBQSxHQUNBLFVBQ0EsVUFBQSxRQUNBLE9BQUEsUUFFQSxJQUFBLHlCQUNBLFFBQ0EsS0FBQSwrQ0FBQSxJQUFBLGdCQUFBLEVBQUEsTUFBQSxpQkFJQSxPQUNBLE1BQUEsdUNBQ0EsR0FBQSxFQUFBLG1CQUNBLFdBQ0EsUUFDQSxHQUFBLFNBQUEsRUFBQSxHQUNBLEtBQUEscUJBQUEsRUFBQSxPQUVBLE1BQUEsUUFHQSxNQUNBLEtBQUEsRUFBQSxVQUNBLE1BQUEsS0FDQSxRQUFBLEtBQUEsUUFFQSxLQUFBLEVBQUEsaUNBQ0EsSUFBQSxpQkFDQSxNQUFBLEtBQ0EsS0FBQSxFQUNBLFFBQUEsS0FBQSxTQUVBLEtBQUEsRUFBQSxzQ0FDQSxJQUFBLGlCQUNBLE1BQUEsS0FDQSxLQUFBLEVBQ0EsUUFBQSxLQUFBLFNBRUEsV0FDQSxNQUNBLEdBQUEsV0FDQSxHQUFBLEtBQ0EsTUFBQSxXQUFBLEVBQUEsSUFBQSxLQUFBLEdBQUEsSUFBQSxFQUFBLGlCQUVBLEVBQUEsS0FBQSxTQUFBLEdBQ0EsS0FBQSxXQUNBLFFBQUEsRUFBQSxFQUNBLE9BQUEsRUFBQSxFQUNBLFlBQUEsRUFBQSxPQUNBLFdBQUEsRUFBQSxNQUNBLFlBQUEsRUFBQSxPQUFBLEtBQ0EsUUFDQSxLQUFBLE1BRUEsS0FBQSxXQUFBLFFBQUEsRUFFQSxJQUFBLEdBQUEsSUFBQSxPQUFBLEVBQUEsb0JBQUEsTUFBQSxNQUFBLEVBQ0EsTUFBQSxxQkFBQSxFQUFBLE9BRUEsTUFBQSxTQUlBLGVBQUEsT0FBQSxRQUFBLFdBQUEsWUFBQSxLQUFBLEtBQUEsR0FDQSxLQUFBLE9BQUEsR0FHQSxJQUFBLE9BQUEsZUFBQSxPQUFBLFFBQUEsSUFBQSxRQUNBLFVBQUEsR0FDQSxnQkFBQSxLQUFBLElBRUEscUJBQUEsU0FBQSxTQUNBLEdBQUEsTUFFQSxJQUFBLElBQUEsUUFBQSxNQUNBLE1BQUEsUUFBQSxNQUNBLE1BQUEsUUFBQSxrQkFBQSxJQUNBLE1BQUEsS0FBQSxRQUFBLFFBRUEsSUFBQSxRQUFBLE9BQUEsUUFBQSxPQUFBLENBQ0EsR0FBQSxPQUFBLFNBQUEsUUFBQSxPQUNBLE9BQUEsU0FBQSxRQUFBLE9BRUEsT0FEQSxNQUFBLEdBQUEsT0FBQSxFQUNBLE1BQUEsT0FFQSxRQUdBLE9BQUEsR0FJQSxNQUFBLGVBQUEsUUFFQSxLQUFBLG1CQUFBLE9BQUEsaUJBQUEsTUFBQSxTQUdBLE9BQUEsU0FBQSxHQUNBLEdBQUEsR0FBQSxLQUFBLE9BQUEsR0FBQSxlQUFBLFFBQUEsS0FBQSxPQUFBLEtBQUEsTUFFQSxFQUFBLEdBQUEsU0FDQSxHQUFBLE9BQUEsT0FBQSxLQUFBLE9BQUEsTUFDQSxFQUFBLE9BQUEsU0FBQSwwQkFDQSxFQUFBLE9BQUEsWUFBQSxLQUFBLFdBQ0EsRUFBQSxPQUFBLE9BQUEsS0FBQSxPQUFBLEtBQUEsTUFDQSxFQUFBLE9BQUEsT0FBQSxFQUFBLE1BQ0EsRUFBQSxPQUFBLFdBQUEsS0FBQSxPQUFBLEdBQUEsT0FBQSxVQUNBLEVBQUEsT0FBQSxTQUFBLEtBQUEsT0FBQSxRQUNBLEVBQUEsT0FBQSxVQUFBLEtBQUEsZUFBQSxLQUVBLElBQUEsR0FBQSxHQUFBLGVBQ0EsR0FBQSxLQUFBLE9BQUEsZUFBQSxPQUFBLGNBQ0EsRUFBQSxpQkFBQSxhQUFBLFFBQ0EsRUFBQSxpQkFBQSxVQUFBLElBQUEsS0FBQSxlQUFBLFNBRUEsRUFBQSxPQUFBLFdBQUEsU0FBQSxHQUNBLEdBQUEsRUFBQSxpQkFBQSxDQUNBLEdBQUEsR0FBQSxFQUFBLE9BQUEsRUFBQSxNQUFBLElBQUEsQ0FDQSxHQUFBLE1BQUEsYUFBQSxTQUFBLEVBQUEsT0FFQSxLQUFBLE1BRUEsRUFBQSxPQUFBLFdBQ0EsR0FBQSxNQUFBLEVBQUEsT0FBQSxDQUNBLEdBQUEsR0FBQSxLQUFBLE1BQUEsRUFBQSxhQUVBLElBQUEsRUFBQSxTQUNBLEVBQUEsU0FDQSxLQUFBLE9BQUEsR0FBQSxPQUFBLE9BQUEsS0FBQSxFQUFBLE9BQUEsS0FBQSxLQUFBLEVBQUEsT0FBQSxLQUFBLEtBQUEsRUFBQSxPQUFBLEtBQUEsV0FFQSxLQUFBLE9BQUEsR0FBQSxhQUFBLEVBQUEsRUFBQSxXQUdBLEtBQUEsTUFFQSxFQUFBLEtBQUEsR0FFQSxLQUFBLFNBR0Esa0JBQUEsU0FBQSxHQUNBLEtBQUEsV0FBQSxRQUFBLEVBQUEsT0FBQSxFQUFBLFFBR0EsTUFBQSxXQUNBLEtBQUEsV0FBQSxRQUFBLFdBRUEsZUFBQSxPQUFBLFFBQUEsV0FBQSxNQUFBLEtBQUEsTUFDQSxLQUFBLE9BQUEsR0FBQSxPQUFBLFdBR0EsSUFBQSxJQUFBLGdDQUFBLGVBQUEsT0FBQSxTQ3hQQSxlQUFBLE9BQUEsT0FBQSxTQUFBLEdBQ0EsRUFBQSxNQUNBLElBQUEsUUFBQSxHQUNBLE1BQUEsRUFBQSxtQ0FDQSxZQUFBLFFBQ0EsV0FBQSxFQUNBLGFBQUEsRUFDQSxhQUFBLEVBQ0EsT0FBQSxJQUNBLE9BQUEsRUFDQSxPQUFBLEtBQUEsVUFBQSxLQUVBLGVBQUEsT0FBQSxPQUFBLFdBQUEsWUFBQSxLQUFBLEtBQUEsSUFFQSxJQUFBLE9BQUEsZUFBQSxPQUFBLE9BQUEsS0FBQSxRQUNBLFVBQUEsV0FDQSxRQUNBLE1BQUEsWUFDQSxLQUFBLE1BQ0EsV0FBQSxFQUFBLDZCQUNBLFlBQUEsRUFDQSxPQUFBLE9BQ0EsTUFBQSxTQUlBLE9BQUEsV0FDQSxHQUFBLEdBQUEsS0FBQSxHQUFBLFNBRUEsR0FBQSxZQUNBLEtBQUEsT0FBQSxTQUNBLElBQUEsU0FBQSxLQUFBLE9BQUEsUUFBQSxLQUFBLE9BQUEsT0FBQSxNQUFBLEVBQUEsY0FHQSxLQUFBLFlBSUEsSUFBQSxJQUFBLCtCQUFBLGVBQUEsT0FBQSIsImZpbGUiOiJhcHAuanMiLCJzb3VyY2VzQ29udGVudCI6WyJFeHQubnMoJ01hcmtkb3duRWRpdG9yJyk7XG5NYXJrZG93bkVkaXRvciA9IGZ1bmN0aW9uKGNvbmZpZykge1xuICAgIGNvbmZpZyA9IGNvbmZpZyB8fCB7fTtcbiAgICBNYXJrZG93bkVkaXRvci5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcyxjb25maWcpO1xufTtcbkV4dC5leHRlbmQoTWFya2Rvd25FZGl0b3IsRXh0LkNvbXBvbmVudCx7XG4gICAgd2luZG93Ont9LGNvbWJvOnt9LGNvbmZpZzoge31cbn0pO1xuRXh0LnJlZygnbWFya2Rvd25lZGl0b3InLE1hcmtkb3duRWRpdG9yKTtcbm1hcmtkb3duRWRpdG9yID0gbmV3IE1hcmtkb3duRWRpdG9yKCk7XG5cbm1hcmtkb3duRWRpdG9yLmxvYWRlZEVsZW1lbnRzID0ge307XG5cbm1hcmtkb3duRWRpdG9yLkVkaXRvciA9IGZ1bmN0aW9uKGNvbmZpZykge1xuICAgIGNvbmZpZyA9IGNvbmZpZyB8fCB7fTtcbiAgICBjb25maWcucmVzb3VyY2UgPSBNT0R4LnJlcXVlc3QuaWQgfHwgMDtcbiAgICBtYXJrZG93bkVkaXRvci5FZGl0b3Iuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsY29uZmlnKTtcbiAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbn07XG5FeHQuZXh0ZW5kKG1hcmtkb3duRWRpdG9yLkVkaXRvcixFeHQuQ29tcG9uZW50LHtcbiAgICByZW1hcmthYmxlOiAnJ1xuICAgICxmdWxsU2NyZWVuOiBmYWxzZVxuICAgICxkaWZmRE9NOiBudWxsXG4gICAgLGxvY2FsQ2FjaGU6IHtcbiAgICAgICAgb0VtYmVkOiB7fVxuICAgIH1cbiAgICAsaW5pdENvbXBvbmVudDogZnVuY3Rpb24oKSB7XG4gICAgICAgIE1hcmtkb3duRWRpdG9yLnN1cGVyY2xhc3MuaW5pdENvbXBvbmVudC5jYWxsKHRoaXMpO1xuXG4gICAgICAgIHRoaXMuZGlmZkRPTSA9IG5ldyBkaWZmRE9NKCk7XG4gICAgICAgIFxuICAgICAgICBpZiAodGhpcy5tZEVsZW1lbnRJZCl7XG4gICAgICAgICAgICBFeHQub25SZWFkeSh0aGlzLnJlbmRlciwgdGhpcyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAsZGVzdHJveTogZnVuY3Rpb24oKXtcbiAgICAgICAgdGhpcy5lZGl0b3IuZGVzdHJveSgpO1xuXG4gICAgICAgIHRoaXMubWRDb250YWluZXIucmVtb3ZlKCk7XG4gICAgICAgIHRoaXMudGFNYXJrZG93bi5yZW1vdmUoKTtcblxuICAgICAgICB0aGlzLnRleHRhcmVhLmRvbS5zdHlsZS5kaXNwbGF5ID0gbnVsbDtcbiAgICAgICAgdGhpcy50ZXh0YXJlYS5kb20uc3R5bGUud2lkdGggPSBudWxsO1xuICAgICAgICB0aGlzLnRleHRhcmVhLmRvbS5zdHlsZS5oZWlnaHQgPSBudWxsO1xuXG4gICAgICAgIE1hcmtkb3duRWRpdG9yLnN1cGVyY2xhc3MuZGVzdHJveS5jYWxsKHRoaXMpO1xuICAgIH1cblxuICAgICxyZW5kZXI6IGZ1bmN0aW9uKGNvbnRhaW5lciwgcG9zaXRpb24pIHtcbiAgICAgICAgdGhpcy50ZXh0YXJlYSA9IEV4dC5nZXQodGhpcy5tZEVsZW1lbnRJZCk7XG4gICAgICAgIHRoaXMubWRFbGVtZW50TmFtZSA9IHRoaXMudGV4dGFyZWEuZG9tLm5hbWU7XG5cbiAgICAgICAgaWYgKCF0aGlzLnRleHRhcmVhKSByZXR1cm47XG5cbiAgICAgICAgdGhpcy5idWlsZFVJKCk7XG4gICAgICAgIHRoaXMucmVnaXN0ZXJBY2UoKTtcbiAgICAgICAgdGhpcy5yZWdpc3RlclJlbWFya2FibGUoKTtcbiAgICAgICAgdGhpcy5idWlsZFRvb2xib3goKTtcblxuICAgICAgICB2YXIgcHJldmlld0J1dHRvbiA9IHRoaXMudG9vbEJveC5jaGlsZCgnLnByZXZpZXctYnV0dG9uJyk7XG4gICAgICAgIHZhciBmdWxsc2NyZWVuQnV0dG9uID0gdGhpcy50b29sQm94LmNoaWxkKCcuZnVsbHNjcmVlbi1idXR0b24nKTtcbiAgICAgICAgdmFyIHNwbGl0c2NyZWVuQnV0dG9uID0gdGhpcy50b29sQm94LmNoaWxkKCcuc3BsaXRzY3JlZW4tYnV0dG9uJyk7XG5cbiAgICAgICAgdmFyIGNvbnRlbnQgPSB0aGlzLmNvbnRlbnRNRDtcblxuICAgICAgICB2YXIgcHJldmlld0J1dHRvbk9mZiA9IEV4dC5nZXQoRXh0LkRvbUhlbHBlci5hcHBlbmQoY29udGVudC5wYXJlbnQoKSx7XG4gICAgICAgICAgICB0YWc6ICdkaXYnLFxuICAgICAgICAgICAgY2xhc3M6ICdwcmV2aWV3LWJ1dHRvbi1vZmYnLFxuICAgICAgICAgICAgaHRtbDogJzxpIGNsYXNzPVwiaWNvbiBpY29uLWV5ZS1zbGFzaCBpY29uLWxhcmdlXCI+PC9pPicsXG4gICAgICAgICAgICBoaWRkZW46IHRydWVcbiAgICAgICAgfSkpO1xuXG4gICAgICAgIHZhciBkcm9wVGFyZ2V0ID0gTU9EeC5sb2FkKHtcbiAgICAgICAgICAgIHh0eXBlOiAnbW9keC10cmVlZHJvcCcsXG4gICAgICAgICAgICB0YXJnZXQ6IGNvbnRlbnQsXG4gICAgICAgICAgICB0YXJnZXRFbDogY29udGVudCxcbiAgICAgICAgICAgIG9uSW5zZXJ0OiAoZnVuY3Rpb24ocyl7XG4gICAgICAgICAgICAgICAgdGhpcy5pbnNlcnQocyk7XG4gICAgICAgICAgICAgICAgdGhpcy5mb2N1cygpO1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfSkuYmluZCh0aGlzLmVkaXRvciksXG4gICAgICAgICAgICBpZnJhbWU6IHRydWVcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMudGV4dGFyZWEub24oJ2Rlc3Ryb3knLCBmdW5jdGlvbigpIHtkcm9wVGFyZ2V0LmRlc3Ryb3koKTt9KTtcblxuICAgICAgICB2YXIgZGVmYXVsdFNwbGl0ID0gcGFyc2VJbnQoTU9EeC5jb25maWdbJ21hcmtkb3duZWRpdG9yLmdlbmVyYWwuc3BsaXQnXSB8fCAwKTtcbiAgICAgICAgaWYgKGRlZmF1bHRTcGxpdCA9PSAxKSB7XG4gICAgICAgICAgICBzcGxpdHNjcmVlbkJ1dHRvbi50dXJuT24oKTtcbiAgICAgICAgfVxuICAgICAgICBwcmV2aWV3QnV0dG9uLmFkZExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHRoaXMuc2hvd1ByZXZpZXcoKTtcbiAgICAgICAgICAgIHRoaXMuaGlkZUNvbnRlbnQoKTtcbiAgICAgICAgICAgIHRoaXMuc3RhdHVzQmFyLnNldERpc3BsYXllZCgnbm9uZScpO1xuXG4gICAgICAgICAgICB0aGlzLmNvbnRlbnRNRC5wYXJlbnQoKS5wYXJlbnQoKS5hZGRDbGFzcygncHJldmlldycpO1xuXG4gICAgICAgICAgICBwcmV2aWV3QnV0dG9uT2ZmLnNob3coKVxuICAgICAgICB9LCB0aGlzKTtcblxuICAgICAgICBwcmV2aWV3QnV0dG9uT2ZmLmFkZExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHRoaXMuaGlkZVByZXZpZXcoKTtcbiAgICAgICAgICAgIHRoaXMuc2hvd0NvbnRlbnQoKTtcbiAgICAgICAgICAgIHRoaXMuc3RhdHVzQmFyLnNldERpc3BsYXllZCgnYmxvY2snKTtcblxuICAgICAgICAgICAgdGhpcy5jb250ZW50TUQucGFyZW50KCkucGFyZW50KCkucmVtb3ZlQ2xhc3MoJ3ByZXZpZXcnKTtcblxuICAgICAgICAgICAgdGhpcy5lZGl0b3IuZm9jdXMoKTtcblxuICAgICAgICAgICAgcHJldmlld0J1dHRvbk9mZi5oaWRlKCk7XG4gICAgICAgIH0sIHRoaXMpO1xuXG4gICAgICAgIHNwbGl0c2NyZWVuQnV0dG9uLmFkZExpc3RlbmVyKCdjbGljaycsIGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICBpZiAoc3BsaXRzY3JlZW5CdXR0b24uY2hpbGQoJ2knKS5oYXNDbGFzcygnaWNvbi1wYXVzZScpKSB7XG4gICAgICAgICAgICAgICAgc3BsaXRzY3JlZW5CdXR0b24udHVybk9uKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHNwbGl0c2NyZWVuQnV0dG9uLnR1cm5PZmYoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSwgdGhpcyk7XG5cbiAgICAgICAgZnVsbHNjcmVlbkJ1dHRvbi5hZGRMaXN0ZW5lcignY2xpY2snLCBmdW5jdGlvbigpe1xuICAgICAgICAgICAgaWYgKHRoaXMuZnVsbFNjcmVlbiA9PSBmYWxzZSkge1xuICAgICAgICAgICAgICAgIGZ1bGxzY3JlZW5CdXR0b24udHVybk9uKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGZ1bGxzY3JlZW5CdXR0b24udHVybk9mZigpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLnN0YXR1c0Jhci5zZXREaXNwbGF5ZWQoJ2Jsb2NrJyk7XG4gICAgICAgICAgICB0aGlzLmVkaXRvci5yZXNpemUodHJ1ZSk7XG5cbiAgICAgICAgfSwgdGhpcyk7XG5cbiAgICAgICAgaWYgKG1hcmtkb3duRWRpdG9yLmNvbnRlbnRbdGhpcy5tZEVsZW1lbnROYW1lXSkge1xuICAgICAgICAgICAgdGhpcy5lZGl0b3Iuc2V0VmFsdWUobWFya2Rvd25FZGl0b3IuY29udGVudFt0aGlzLm1kRWxlbWVudE5hbWVdKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmVkaXRvci5zZWxlY3Rpb24uY2xlYXJTZWxlY3Rpb24oKTtcblxuICAgICAgICB0aGlzLnByZXZpZXcudXBkYXRlKHRoaXMucGFyc2UodGhpcy5lZGl0b3IuZ2V0VmFsdWUoKSkpO1xuXG4gICAgICAgIHRoaXMucHJldmlldy5maXhIZWlnaHQoKTtcblxuICAgICAgICB0aGlzLmVkaXRvci5nZXRTZXNzaW9uKCkub24oJ2NoYW5nZScsIGZ1bmN0aW9uKGUsYixjLGQpe1xuICAgICAgICAgICAgaWYgKGUuZGF0YS5hY3Rpb24gPT0gJ2luc2VydFRleHQnICYmIHRoaXMuZWRpdG9yLmdldFNlc3Npb24oKS5nZXREb2N1bWVudCgpLmlzTmV3TGluZShlLmRhdGEudGV4dCkpIHtcbiAgICAgICAgICAgICAgICB2YXIgc2Vzc2lvbiA9IHRoaXMuZWRpdG9yLmdldFNlc3Npb24oKTtcbiAgICAgICAgICAgICAgICB2YXIgZG9jdW1lbnQgPSBzZXNzaW9uLmdldERvY3VtZW50KCk7XG5cbiAgICAgICAgICAgICAgICBpZiAoL15cXHMqKD86WyorLV18XFxkK1xcLilcXHMqJC8uZXhlYyhkb2N1bWVudC5nZXRMaW5lKGUuZGF0YS5yYW5nZS5zdGFydC5yb3cpKSAhPSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICAgIGRvY3VtZW50LnJlbW92ZUxpbmVzKGUuZGF0YS5yYW5nZS5zdGFydC5yb3csIGUuZGF0YS5yYW5nZS5zdGFydC5yb3cpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5wYXJzZSh0aGlzLmVkaXRvci5nZXRWYWx1ZSgpKTtcbiAgICAgICAgfS5iaW5kKHRoaXMpKTtcbiAgICB9XG5cbiAgICAsc2hvd0NvbnRlbnQ6IGZ1bmN0aW9uKCl7XG4gICAgICAgIHRoaXMuY29udGVudE1ELnNldERpc3BsYXllZCgnYmxvY2snKTtcbiAgICB9XG5cbiAgICAsaGlkZUNvbnRlbnQ6IGZ1bmN0aW9uKCl7XG4gICAgICAgIHRoaXMuY29udGVudE1ELnNldERpc3BsYXllZCgnbm9uZScpO1xuICAgIH1cblxuICAgICxzaG93UHJldmlldzogZnVuY3Rpb24oKXtcbiAgICAgICAgdGhpcy5wcmV2aWV3LnBhcmVudCgpLnNldERpc3BsYXllZCgnYmxvY2snKTtcbiAgICB9XG5cbiAgICAsaGlkZVByZXZpZXc6IGZ1bmN0aW9uKCl7XG4gICAgICAgIHRoaXMucHJldmlldy5wYXJlbnQoKS5zZXREaXNwbGF5ZWQoJ25vbmUnKTtcbiAgICB9XG5cbiAgICAsYnVpbGRVSTogZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMudGV4dGFyZWEuc2V0RGlzcGxheWVkKCdub25lJyk7XG4gICAgICAgIHRoaXMudGV4dGFyZWEuc2V0V2lkdGgoMCk7XG4gICAgICAgIHRoaXMudGV4dGFyZWEuc2V0SGVpZ2h0KDApO1xuXG4gICAgICAgIHRoaXMudGFNYXJrZG93biA9IEV4dC5nZXQoRXh0LkRvbUhlbHBlci5pbnNlcnRCZWZvcmUodGhpcy50ZXh0YXJlYSwge1xuICAgICAgICAgICAgdGFnOiAndGV4dGFyZWEnLFxuICAgICAgICAgICAgbmFtZTogdGhpcy5tZEVsZW1lbnROYW1lICsgJ19tYXJrZG93bicsXG4gICAgICAgICAgICBjbGFzczogdGhpcy5tZEVsZW1lbnROYW1lICsgJ19tYXJrZG93bidcbiAgICAgICAgfSkpO1xuXG4gICAgICAgIHRoaXMudGFNYXJrZG93bi5zZXREaXNwbGF5ZWQoJ25vbmUnKTtcbiAgICAgICAgdGhpcy50YU1hcmtkb3duLnNldFdpZHRoKDApO1xuICAgICAgICB0aGlzLnRhTWFya2Rvd24uc2V0SGVpZ2h0KDApO1xuXG4gICAgICAgIHRoaXMubWRDb250YWluZXIgPSBFeHQuZ2V0KEV4dC5Eb21IZWxwZXIuaW5zZXJ0QmVmb3JlKHRoaXMudGV4dGFyZWEsIHtcbiAgICAgICAgICAgIHRhZzogJ2RpdicsXG4gICAgICAgICAgICBjbGFzczogJ21hcmtkb3duLWNvbnRhaW5lciBhY2UtJyArIChNT0R4LmNvbmZpZ1snbWFya2Rvd25lZGl0b3IuZ2VuZXJhbC50aGVtZSddIHx8ICdtb25va2FpJykudG9Mb3dlckNhc2UoKS5yZXBsYWNlKC9fL2csICctJylcbiAgICAgICAgfSkpO1xuXG4gICAgICAgIHZhciBmdWxsU2NyZWVuSGVhZGVyID0gRXh0LmdldChFeHQuRG9tSGVscGVyLmFwcGVuZCh0aGlzLm1kQ29udGFpbmVyLmRvbSx7XG4gICAgICAgICAgICB0YWc6ICdkaXYnLFxuICAgICAgICAgICAgY2xhc3M6ICdmdWxsc2NyZWVuLWhlYWRlciBhY2VfZ3V0dGVyJyxcbiAgICAgICAgICAgIGh0bWw6ICc8aW5wdXQgdHlwZT1cInRleHRcIiAvPidcbiAgICAgICAgfSkpO1xuXG4gICAgICAgIHZhciBwYWdlVGl0bGUgPSBFeHQuZ2V0Q21wKCdtb2R4LXJlc291cmNlLXBhZ2V0aXRsZScpO1xuICAgICAgICBpZiAocGFnZVRpdGxlKSB7XG4gICAgICAgICAgICB2YXIgaGVhZGVySW5wdXQgPSBmdWxsU2NyZWVuSGVhZGVyLmNoaWxkKCdpbnB1dCcpO1xuICAgICAgICAgICAgaGVhZGVySW5wdXQuZG9tLnZhbHVlID0gcGFnZVRpdGxlLmdldFZhbHVlKCk7XG5cbiAgICAgICAgICAgIGhlYWRlcklucHV0Lm9uKCdjaGFuZ2UnLCBmdW5jdGlvbigpe1xuICAgICAgICAgICAgICAgIHBhZ2VUaXRsZS5zZXRWYWx1ZSh0aGlzLmRvbS52YWx1ZSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgcGFnZVRpdGxlLm9uKCdjaGFuZ2UnLCBmdW5jdGlvbihmaWVsZCx2YWx1ZSl7XG4gICAgICAgICAgICAgICAgaGVhZGVySW5wdXQuZG9tLnZhbHVlID0gdmFsdWU7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHZhciB3cmFwcGVyID0gRXh0LmdldChFeHQuRG9tSGVscGVyLmFwcGVuZCh0aGlzLm1kQ29udGFpbmVyLmRvbSx7XG4gICAgICAgICAgICB0YWc6ICdkaXYnLFxuICAgICAgICAgICAgY2xhc3M6ICdtYXJrZG93bi13cmFwcGVyJ1xuICAgICAgICB9KSk7XG5cbiAgICAgICAgdGhpcy5jb250ZW50TUQgPSBFeHQuZ2V0KEV4dC5Eb21IZWxwZXIuYXBwZW5kKHdyYXBwZXIse1xuICAgICAgICAgICAgdGFnOiAnZGl2JyxcbiAgICAgICAgICAgIGNsYXNzOiB0aGlzLnRleHRhcmVhLmRvbS5jbGFzc05hbWUgKyAnIGNvbnRlbnQtbWQgJyArIHRoaXMubWRFbGVtZW50TmFtZSArICdfbWFya2Rvd24nXG4gICAgICAgIH0pKTtcblxuICAgICAgICB0aGlzLnByZXZpZXcgPSBFeHQuZ2V0KEV4dC5Eb21IZWxwZXIuYXBwZW5kKHdyYXBwZXIse1xuICAgICAgICAgICAgdGFnOiAnZGl2JyxcbiAgICAgICAgICAgIGNsYXNzOiAnbWFya2Rvd24tYm9keSBwcmV2aWV3LW1kJ1xuICAgICAgICB9KSk7XG4gICAgICAgIFxuICAgICAgICB0aGlzLnByZXZpZXcgPSBFeHQuZ2V0KEV4dC5Eb21IZWxwZXIuYXBwZW5kKHRoaXMucHJldmlldy5kb20se1xuICAgICAgICAgICAgdGFnOiAnZGl2J1xuICAgICAgICB9KSk7XG5cbiAgICAgICAgdmFyIHRoYXQgPSB0aGlzO1xuICAgICAgICB0aGlzLnByZXZpZXcuZml4SGVpZ2h0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdGhhdC5lZGl0b3IucmVzaXplKCk7XG4gICAgICAgICAgICB2YXIgaGVpZ2h0ID0gdGhhdC5lZGl0b3IuZ2V0U2Vzc2lvbigpLmdldFNjcmVlbkxlbmd0aCgpICogdGhhdC5lZGl0b3IucmVuZGVyZXIubGluZUhlaWdodCArIHRoYXQuZWRpdG9yLnJlbmRlcmVyLnNjcm9sbEJhci5nZXRXaWR0aCgpICArIDI1O1xuICAgICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLnBhcmVudCgpLnNldEhlaWdodChoZWlnaHQpO1xuICAgICAgICB9O1xuXG4gICAgICAgIGlmIChNT0R4LmNvbmZpZ1snbWFya2Rvd25lZGl0b3IudXBsb2FkLmVuYWJsZV9pbWFnZV91cGxvYWQnXSA9PSAxIHx8IE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci51cGxvYWQuZW5hYmxlX2ZpbGVfdXBsb2FkJ10gPT0gMSkge1xuICAgICAgICAgICAgdGhpcy5zdGF0dXNCYXIgPSBFeHQuZ2V0KEV4dC5Eb21IZWxwZXIuYXBwZW5kKHRoaXMubWRDb250YWluZXIuZG9tLHtcbiAgICAgICAgICAgICAgICB0YWc6ICdkaXYnLFxuICAgICAgICAgICAgICAgIGNsYXNzOiAnc3RhdHVzLWJhciBhY2VfZ3V0dGVyJ1xuICAgICAgICAgICAgfSkpO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5pc01vYmlsZURldmljZSgpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0dXNCYXIuZG9tLmlubmVySFRNTCA9ICc8ZGl2IGNsYXNzPVwidXBsb2FkLWJhclwiPiA8aW5wdXQgY2xhc3M9XCJoaWRkZW5cIiBuYW1lPVwibWRfZmlsZV8nKyB0aGlzLnN0YXR1c0Jhci5pZCArJ1wiIGlkPVwiJyArIHRoaXMuc3RhdHVzQmFyLmlkICsgJy1maWxlXCIgdHlwZT1cImZpbGVcIiBtdWx0aXBsZSAvPjxpbnB1dCBjbGFzcz1cImhpZGRlblwiIG5hbWU9XCJtZF9maWxlXycrIHRoaXMuc3RhdHVzQmFyLmlkICsnLW1vYmlsZVwiIGlkPVwiJyArIHRoaXMuc3RhdHVzQmFyLmlkICsgJy1maWxlLW1vYmlsZVwiIHR5cGU9XCJmaWxlXCIgYWNjZXB0PVwiaW1hZ2UvKlwiIGNhcHR1cmU9XCJjYW1lcmFcIiAvPicgKyBfKCdtYXJrZG93bmVkaXRvci5zdGF0dXNfYmFyX21lc3NhZ2VfbW9iaWxlJywge2lkOiB0aGlzLnN0YXR1c0Jhci5pZCArICctZmlsZScsIGlkX21vYmlsZTogdGhpcy5zdGF0dXNCYXIuaWQgKyAnLWZpbGUtbW9iaWxlJ30pICsgJzwvZGl2Pic7XG5cbiAgICAgICAgICAgICAgICB0aGlzLnN0YXR1c0Jhci5jaGlsZCgnIycgKyB0aGlzLnN0YXR1c0Jhci5pZCArICctZmlsZS1tb2JpbGUnKS5vbignY2hhbmdlJywgZnVuY3Rpb24oZSwgaW5wdXQpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVGaWxlcyhpbnB1dC5maWxlcywgMSk7XG4gICAgICAgICAgICAgICAgICAgIGlucHV0LnZhbHVlID0gXCJcIjtcbiAgICAgICAgICAgICAgICB9LCB0aGlzKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0dXNCYXIuZG9tLmlubmVySFRNTCA9ICc8ZGl2IGNsYXNzPVwidXBsb2FkLWJhclwiPiA8aW5wdXQgY2xhc3M9XCJoaWRkZW5cIiBuYW1lPVwibWRfZmlsZV8nKyB0aGlzLnN0YXR1c0Jhci5pZCArJ1wiIGlkPVwiJyArIHRoaXMuc3RhdHVzQmFyLmlkICsgJy1maWxlXCIgdHlwZT1cImZpbGVcIiBtdWx0aXBsZT4nICsgXygnbWFya2Rvd25lZGl0b3Iuc3RhdHVzX2Jhcl9tZXNzYWdlJywge2lkOiB0aGlzLnN0YXR1c0Jhci5pZCArICctZmlsZSd9KSArICc8L2Rpdj4nO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5zdGF0dXNCYXIuY2hpbGQoJyMnICsgdGhpcy5zdGF0dXNCYXIuaWQgKyAnLWZpbGUnKS5vbignY2hhbmdlJywgZnVuY3Rpb24oZSwgaW5wdXQpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVGaWxlcyhpbnB1dC5maWxlcyk7XG4gICAgICAgICAgICAgICAgICAgIGlucHV0LnZhbHVlID0gXCJcIjtcbiAgICAgICAgICAgICAgICB9LCB0aGlzKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5zdGF0dXNCYXIgPSBFeHQuZ2V0KEV4dC5Eb21IZWxwZXIuYXBwZW5kKHRoaXMubWRDb250YWluZXIuZG9tLHtcbiAgICAgICAgICAgICAgICB0YWc6ICdkaXYnLFxuICAgICAgICAgICAgICAgIGNsYXNzOiAnc3RhdHVzLWJhcicsXG4gICAgICAgICAgICAgICAgaHRtbDogXygnbWFya2Rvd25lZGl0b3Iuc3RhdHVzX2Jhcl9kaXNhYmxlZCcpXG4gICAgICAgICAgICB9KSk7XG4gICAgICAgIH1cblxuICAgICAgICBFeHQuRG9tSGVscGVyLmFwcGVuZCh0aGlzLm1kQ29udGFpbmVyLmRvbSx7XG4gICAgICAgICAgICB0YWc6ICdzcGFuJyxcbiAgICAgICAgICAgIHN0eWxlOiAnY2xlYXI6IGJvdGgnXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgICxidWlsZFRvb2xib3g6IGZ1bmN0aW9uKCl7XG4gICAgICAgIHRoaXMudG9vbEJveCA9IEV4dC5nZXQoRXh0LkRvbUhlbHBlci5hcHBlbmQodGhpcy5zdGF0dXNCYXIse1xuICAgICAgICAgICAgdGFnOiAnZGl2JyxcbiAgICAgICAgICAgIGNsYXNzOiAndG9vbGJveCcsXG4gICAgICAgICAgICBjbjogW3tcbiAgICAgICAgICAgICAgICB0YWc6ICdkaXYnLFxuICAgICAgICAgICAgICAgIGNsYXNzOiAncHJldmlldy1idXR0b24nLFxuICAgICAgICAgICAgICAgIGh0bWw6ICc8aSBjbGFzcz1cImljb24gaWNvbi1leWUgaWNvbi1sYXJnZVwiPjwvaT4nXG4gICAgICAgICAgICB9LHtcbiAgICAgICAgICAgICAgICB0YWc6ICdkaXYnLFxuICAgICAgICAgICAgICAgIGNsYXNzOiAnc3BsaXRzY3JlZW4tYnV0dG9uJyxcbiAgICAgICAgICAgICAgICBodG1sOiAnPGkgY2xhc3M9XCJpY29uIGljb24tcGF1c2UgaWNvbi1sYXJnZVwiPjwvaT4nXG4gICAgICAgICAgICB9LHtcbiAgICAgICAgICAgICAgICB0YWc6ICdkaXYnLFxuICAgICAgICAgICAgICAgIGNsYXNzOiAnZnVsbHNjcmVlbi1idXR0b24nLFxuICAgICAgICAgICAgICAgIGh0bWw6ICc8aSBjbGFzcz1cImljb24gaWNvbi1leHBhbmQgaWNvbi1sYXJnZVwiPjwvaT4nXG4gICAgICAgICAgICB9XVxuICAgICAgICB9KSk7XG5cbiAgICAgICAgdmFyIHRoYXQgPSB0aGlzO1xuXG4gICAgICAgIHRoaXMudG9vbEJveC5jaGlsZCgnLnNwbGl0c2NyZWVuLWJ1dHRvbicpLnR1cm5PbiA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgdGhpcy5jaGlsZCgnaScpLnJlbW92ZUNsYXNzKCdpY29uLXBhdXNlJyk7XG4gICAgICAgICAgICB0aGlzLmNoaWxkKCdpJykuYWRkQ2xhc3MoJ2ljb24tc3RvcCcpO1xuXG4gICAgICAgICAgICB0aGF0LmNvbnRlbnRNRC5wYXJlbnQoKS5wYXJlbnQoKS5hZGRDbGFzcygnc3BsaXQnKTtcbiAgICAgICAgICAgIHRoYXQuZWRpdG9yLnJlc2l6ZSgpO1xuICAgICAgICAgICAgdGhhdC5wcmV2aWV3LmZpeEhlaWdodCgpO1xuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMudG9vbEJveC5jaGlsZCgnLnNwbGl0c2NyZWVuLWJ1dHRvbicpLnR1cm5PZmYgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHRoaXMuY2hpbGQoJ2knKS5hZGRDbGFzcygnaWNvbi1wYXVzZScpO1xuICAgICAgICAgICAgdGhpcy5jaGlsZCgnaScpLnJlbW92ZUNsYXNzKCdpY29uLXN0b3AnKTtcblxuICAgICAgICAgICAgdGhhdC5jb250ZW50TUQucGFyZW50KCkucGFyZW50KCkucmVtb3ZlQ2xhc3MoJ3NwbGl0Jyk7XG4gICAgICAgICAgICB0aGF0LmVkaXRvci5yZXNpemUoKTtcbiAgICAgICAgfTtcblxuICAgICAgICB0aGlzLnRvb2xCb3guY2hpbGQoJy5mdWxsc2NyZWVuLWJ1dHRvbicpLnR1cm5PbiA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgdGhpcy5jaGlsZCgnaScpLnJlbW92ZUNsYXNzKCdpY29uLWV4cGFuZCcpO1xuICAgICAgICAgICAgdGhpcy5jaGlsZCgnaScpLmFkZENsYXNzKCdpY29uLWNvbXByZXNzJyk7XG5cbiAgICAgICAgICAgIHZhciBtb2R4QnV0dG9ucyA9IEV4dC5nZXQoJ21vZHgtYWN0aW9uLWJ1dHRvbnMnKTtcbiAgICAgICAgICAgIGlmIChtb2R4QnV0dG9ucykge1xuICAgICAgICAgICAgICAgIG1vZHhCdXR0b25zLmFkZENsYXNzKCdtYXJrZG93bmVkaXRvci1mdWxsc2NyZWVuJyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoYXQuZnVsbFNjcmVlbiA9IHRydWU7XG5cbiAgICAgICAgICAgIGlmIChwYXJzZUludChNT0R4LmNvbmZpZ1snbWFya2Rvd25lZGl0b3IuZ2VuZXJhbC5zcGxpdF9mdWxsc2NyZWVuJ10gfHwgMSkgPT0gMSkge1xuICAgICAgICAgICAgICAgIHRoYXQudG9vbEJveC5jaGlsZCgnLnNwbGl0c2NyZWVuLWJ1dHRvbicpLnR1cm5PbigpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGF0LnRvb2xCb3guY2hpbGQoJy5zcGxpdHNjcmVlbi1idXR0b24nKS50dXJuT2ZmKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoYXQuc2hvd1ByZXZpZXcoKTtcbiAgICAgICAgICAgIHRoYXQuc2hvd0NvbnRlbnQoKTtcblxuICAgICAgICAgICAgdGhhdC5lZGl0b3IuZm9jdXMoKTtcblxuICAgICAgICAgICAgdGhhdC5jb250ZW50TUQucGFyZW50KCkucGFyZW50KCkuYWRkQ2xhc3MoJ2Z1bGxzY3JlZW4nKTtcblxuICAgICAgICAgICAgdGhhdC5lZGl0b3Iuc2V0T3B0aW9uKCdtYXhMaW5lcycsIG51bGwpO1xuICAgICAgICAgICAgdGhhdC5lZGl0b3IucmVzaXplKCk7XG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy50b29sQm94LmNoaWxkKCcuZnVsbHNjcmVlbi1idXR0b24nKS50dXJuT2ZmID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICB0aGlzLmNoaWxkKCdpJykuYWRkQ2xhc3MoJ2ljb24tZXhwYW5kJyk7XG4gICAgICAgICAgICB0aGlzLmNoaWxkKCdpJykucmVtb3ZlQ2xhc3MoJ2ljb24tY29tcHJlc3MnKTtcblxuICAgICAgICAgICAgdmFyIG1vZHhCdXR0b25zID0gRXh0LmdldCgnbW9keC1hY3Rpb24tYnV0dG9ucycpO1xuICAgICAgICAgICAgaWYgKG1vZHhCdXR0b25zKSB7XG4gICAgICAgICAgICAgICAgbW9keEJ1dHRvbnMucmVtb3ZlQ2xhc3MoJ21hcmtkb3duZWRpdG9yLWZ1bGxzY3JlZW4nKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhhdC5mdWxsU2NyZWVuID0gZmFsc2U7XG5cbiAgICAgICAgICAgIGlmIChwYXJzZUludChNT0R4LmNvbmZpZ1snbWFya2Rvd25lZGl0b3IuZ2VuZXJhbC5zcGxpdCddIHx8IDApID09IDEpIHtcbiAgICAgICAgICAgICAgICB0aGF0LnRvb2xCb3guY2hpbGQoJy5zcGxpdHNjcmVlbi1idXR0b24nKS50dXJuT24oKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhhdC50b29sQm94LmNoaWxkKCcuc3BsaXRzY3JlZW4tYnV0dG9uJykudHVybk9mZigpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGF0LmhpZGVQcmV2aWV3KCk7XG4gICAgICAgICAgICB0aGF0LnNob3dDb250ZW50KCk7XG5cbiAgICAgICAgICAgIHRoYXQuZWRpdG9yLmZvY3VzKCk7XG5cbiAgICAgICAgICAgIHRoYXQuY29udGVudE1ELnBhcmVudCgpLnBhcmVudCgpLnJlbW92ZUNsYXNzKCdmdWxsc2NyZWVuJyk7XG5cbiAgICAgICAgICAgIHRoYXQuZWRpdG9yLnNldE9wdGlvbignbWF4TGluZXMnLCBJbmZpbml0eSk7XG5cbiAgICAgICAgICAgIHRoYXQucHJldmlldy5maXhIZWlnaHQoKTtcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAscmVnaXN0ZXJBY2U6IGZ1bmN0aW9uKCkge1xuICAgICAgICB0aGlzLmVkaXRvciA9IGFjZS5lZGl0KEV4dC5Eb21RdWVyeS5zZWxlY3ROb2RlKCdkaXYuJyArIHRoaXMubWRFbGVtZW50TmFtZSArICdfbWFya2Rvd24nKSk7XG4gICAgICAgIGFjZS5yZXF1aXJlKFwiYWNlL2xheWVyL2d1dHRlcl90b29sYmFyXCIpO1xuXG4gICAgICAgIHRoaXMuZWRpdG9yLnNldE9wdGlvbnMoe1xuICAgICAgICAgICAgbWF4TGluZXM6IEluZmluaXR5LFxuICAgICAgICAgICAgbWluTGluZXM6IDI1LFxuICAgICAgICAgICAgZW5hYmxlQmFzaWNBdXRvY29tcGxldGlvbjogdHJ1ZSxcbiAgICAgICAgICAgIHByaW50TWFyZ2luOiBmYWxzZSxcbiAgICAgICAgICAgIHNob3dHdXR0ZXI6IHRydWUsXG4gICAgICAgICAgICB1c2VTb2Z0VGFiczogdHJ1ZSxcbiAgICAgICAgICAgIHNob3dGb2xkV2lkZ2V0czogZmFsc2UsXG4gICAgICAgICAgICBzaG93TGluZU51bWJlcnM6IGZhbHNlLFxuICAgICAgICAgICAgZm9udFNpemU6IHBhcnNlSW50KE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci5nZW5lcmFsLmZvbnRfc2l6ZSddKSB8fCAxMixcbiAgICAgICAgICAgIGZvbnRGYW1pbHk6IE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci5nZW5lcmFsLmZvbnRfZmFtaWx5J10gfHwgJydcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuZWRpdG9yLiRibG9ja1Njcm9sbGluZyA9IEluZmluaXR5O1xuICAgICAgICB0aGlzLmVkaXRvci5zZXNzaW9uLnNldFVzZVdyYXBNb2RlKHRydWUpO1xuICAgICAgICB0aGlzLmVkaXRvci5zZXNzaW9uLnNldFdyYXBMaW1pdFJhbmdlKCk7XG4gICAgICAgIHRoaXMuZWRpdG9yLnJlbmRlcmVyLnNldFNjcm9sbE1hcmdpbigxMCwgMTApO1xuICAgICAgICB0aGlzLmVkaXRvci5zZXNzaW9uLnNldFZhbHVlKHRoaXMudGV4dGFyZWEuZ2V0VmFsdWUoKSk7XG4gICAgICAgIHRoaXMuZWRpdG9yLnNlc3Npb24uc2V0TW9kZShcImFjZS9tb2RlL21hcmtkb3duZWRpdG9yXCIpO1xuICAgICAgICB0aGlzLmVkaXRvci5zZXRUaGVtZShcImFjZS90aGVtZS9cIiArIChNT0R4LmNvbmZpZ1snbWFya2Rvd25lZGl0b3IuZ2VuZXJhbC50aGVtZSddIHx8ICdtb25va2FpJykpO1xuXG4gICAgICAgIGlmICh0aGlzLmNvbnRlbnRNRC5oYXNDbGFzcygnYWNlX2RhcmsnKSkge1xuICAgICAgICAgICAgdGhpcy5tZENvbnRhaW5lci5hZGRDbGFzcygndGhlbWUtZGFyaycpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5tZENvbnRhaW5lci5hZGRDbGFzcygndGhlbWUtbGlnaHQnKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgXG4gICAgICAgIHRoaXMuZWRpdG9yLnNlbGVjdGlvbi5vbignY2hhbmdlQ3Vyc29yJywgZnVuY3Rpb24gKGUsIHNlbGVjdGlvbikge1xuICAgICAgICAgICAgaWYgKHRoaXMuZ3V0dGVyVG9vbGJhcikge1xuICAgICAgICAgICAgICAgIHRoaXMuZ3V0dGVyVG9vbGJhci51cGRhdGUoJycpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB2YXIgcmFuZ2UgPSBzZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcbiAgICAgICAgICAgIGlmIChyYW5nZS5zdGFydC5yb3cgIT0gcmFuZ2UuZW5kLnJvdykgcmV0dXJuO1xuXG4gICAgICAgICAgICB0aGlzLmVkaXRvci5zZXNzaW9uLmFkZEd1dHRlckRlY29yYXRpb24ocmFuZ2Uuc3RhcnQucm93LCAnJyk7XG4gICAgICAgIH0uYmluZCh0aGlzKSk7XG5cbiAgICAgICAgdGhpcy5lZGl0b3Iuc2Vzc2lvbi5ndXR0ZXJSZW5kZXJlciA9ICB7XG4gICAgICAgICAgICBnZXRXaWR0aDogZnVuY3Rpb24oc2Vzc2lvbiwgbGFzdExpbmVOdW1iZXIsIGNvbmZpZykge1xuICAgICAgICAgICAgICAgIHJldHVybiBjb25maWcuY2hhcmFjdGVyV2lkdGg7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgZ2V0VGV4dDogZnVuY3Rpb24oc2Vzc2lvbiwgcm93LCBjZWxsKSB7XG4gICAgICAgICAgICAgICAgaWYgKGNlbGwuZWxlbWVudCAmJiB0aGlzLmVkaXRvci5nZXRDdXJzb3JQb3NpdGlvbigpLnJvdyA9PSByb3cgJiYgc2Vzc2lvbi5kb2MuJGxpbmVzW3Jvd10gPT0gXCJcIikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZEd1dHRlclRvb2xiYXIoY2VsbC5lbGVtZW50KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjZWxsLmVsZW1lbnQuaW5uZXJIVE1MID0gJyc7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgcmV0dXJuICcnO1xuICAgICAgICAgICAgfS5iaW5kKHRoaXMpXG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5lZGl0b3IuY29tbWFuZHMuYWRkQ29tbWFuZCh7XG4gICAgICAgICAgICBuYW1lOiBcIkluZGVudCBsaXN0XCIsXG4gICAgICAgICAgICBiaW5kS2V5OiB7d2luOiBcIlRhYlwiLCBtYWM6IFwiVGFiXCJ9LFxuICAgICAgICAgICAgZXhlYzogZnVuY3Rpb24oZWRpdG9yKSB7XG4gICAgICAgICAgICAgICAgdmFyIGxpbmUgPSBlZGl0b3Iuc2Vzc2lvbi5nZXRMaW5lKGVkaXRvci5nZXRDdXJzb3JQb3NpdGlvbigpLnJvdyk7XG4gICAgICAgICAgICAgICAgdmFyIG1hdGNoID0gL14oXFxzKikoPzooWy0rKl0pfChcXGQrKVxcLikoXFxzKykvLmV4ZWMobGluZSk7XG4gICAgICAgICAgICAgICAgaWYgKG1hdGNoKSB7XG4gICAgICAgICAgICAgICAgICAgIGVkaXRvci5zZXNzaW9uLmluZGVudFJvd3MoZWRpdG9yLmdldEN1cnNvclBvc2l0aW9uKCkucm93LCBlZGl0b3IuZ2V0Q3Vyc29yUG9zaXRpb24oKS5yb3csICdcXHQnKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBlZGl0b3IuaW5kZW50KCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmVkaXRvci5jb21tYW5kcy5hZGRDb21tYW5kKHtcbiAgICAgICAgICAgIG5hbWU6IFwiRXhpdCBmdWxsc2NyZWVuXCIsXG4gICAgICAgICAgICBiaW5kS2V5OiB7d2luOiBcIkVzY1wiLCBtYWM6IFwiRXNjXCJ9LFxuICAgICAgICAgICAgZXhlYzogZnVuY3Rpb24oZWRpdG9yKSB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuZnVsbFNjcmVlbikge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnRvb2xCb3guY2hpbGQoJy5mdWxsc2NyZWVuLWJ1dHRvbicpLnR1cm5PZmYoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LmJpbmQodGhpcylcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdmFyIGxhbmdUb29scyA9IGFjZS5yZXF1aXJlKFwiYWNlL2V4dC9sYW5ndWFnZV90b29sc1wiKTtcbiAgICAgICAgdmFyIHJlc291cmNlc0NvbXBsZXRlciA9IHtcbiAgICAgICAgICAgIGdldENvbXBsZXRpb25zOiBmdW5jdGlvbihlZGl0b3IsIHNlc3Npb24sIHBvcywgcHJlZml4LCBjYWxsYmFjaykge1xuICAgICAgICAgICAgICAgIGlmIChwcmVmaXgubGVuZ3RoID09PSAwKSB7IGNhbGxiYWNrKG51bGwsIFtdKTsgcmV0dXJuIH1cblxuICAgICAgICAgICAgICAgIE1PRHguQWpheC5yZXF1ZXN0KHtcbiAgICAgICAgICAgICAgICAgICAgdXJsOiBtYXJrZG93bkVkaXRvci5jb25maWcuY29ubmVjdG9yVXJsXG4gICAgICAgICAgICAgICAgICAgICxwYXJhbXM6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGlvbjogJ21nci9yZXNvdXJjZS9nZXRsaXN0J1xuICAgICAgICAgICAgICAgICAgICAgICAgLHByZWZpeDogcHJlZml4XG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIGxpc3RlbmVyczoge1xuICAgICAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm46IGZ1bmN0aW9uKHIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgci5yZXN1bHRzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjb3BlOiB0aGlzXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICBsYW5nVG9vbHMuYWRkQ29tcGxldGVyKHJlc291cmNlc0NvbXBsZXRlcik7XG5cbiAgICAgICAgdGhpcy5lZGl0b3IuY29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoXCJkcmFnZW50ZXJcIiwgdGhpcy5jYXRjaEFuZERvTm90aGluZywgZmFsc2UpO1xuICAgICAgICB0aGlzLmVkaXRvci5jb250YWluZXIuYWRkRXZlbnRMaXN0ZW5lcihcImRyYWdvdmVyXCIsIHRoaXMuY2F0Y2hBbmREb05vdGhpbmcsIGZhbHNlKTtcbiAgICAgICAgdGhpcy5lZGl0b3IuY29udGFpbmVyLmFkZEV2ZW50TGlzdGVuZXIoXCJkcm9wXCIsIHRoaXMuZHJvcC5iaW5kKHRoaXMpLCBmYWxzZSk7XG4gICAgfVxuXG4gICAgLGFkZEd1dHRlclRvb2xiYXI6IGZ1bmN0aW9uKGNlbGwpe1xuICAgICAgICB0aGlzLmd1dHRlclRvb2xiYXIgPSBFeHQuZ2V0KGNlbGwpO1xuXG4gICAgICAgIGlmICh0aGlzLmlzTW9iaWxlRGV2aWNlKCkpIHtcbiAgICAgICAgICAgIHRoaXMuZ3V0dGVyVG9vbGJhci51cGRhdGUoJzxpIGNsYXNzPVwiaWNvbiBpY29uLXBsdXMgaWNvbi1maXhlZC13aWR0aFwiPjwvaT4nICtcbiAgICAgICAgICAgICc8ZGl2IGNsYXNzPVwiaW5saW5lLXRvb2xiYXJcIj4nICtcbiAgICAgICAgICAgICAgICAnPGkgY2xhc3M9XCJpY29uIGljb24tYXJjaGl2ZSBpY29uLWZpeGVkLXdpZHRoXCI+PC9pPicgK1xuICAgICAgICAgICAgICAgICc8bGFiZWwgZm9yPVwiJyt0aGlzLnN0YXR1c0Jhci5pZCsnLWZpbGVcIj48aSBjbGFzcz1cImljb24gaWNvbi11cGxvYWQgaWNvbi1maXhlZC13aWR0aFwiPjwvaT48L2xhYmVsPicgK1xuICAgICAgICAgICAgICAgICc8bGFiZWwgZm9yPVwiJyt0aGlzLnN0YXR1c0Jhci5pZCsnLWZpbGUtbW9iaWxlXCI+PGkgY2xhc3M9XCJpY29uIGljb24tY2FtZXJhIGljb24tZml4ZWQtd2lkdGhcIj48L2k+PC9sYWJlbD4nICtcbiAgICAgICAgICAgICAgICAnPGkgY2xhc3M9XCJpY29uIGljb24tY29kZSBpY29uLWZpeGVkLXdpZHRoXCI+PC9pPicgK1xuICAgICAgICAgICAgJzwvZGl2PicpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5ndXR0ZXJUb29sYmFyLnVwZGF0ZSgnPGkgY2xhc3M9XCJpY29uIGljb24tcGx1cyBpY29uLWZpeGVkLXdpZHRoXCI+PC9pPicgK1xuICAgICAgICAgICAgJzxkaXYgY2xhc3M9XCJpbmxpbmUtdG9vbGJhclwiPicgK1xuICAgICAgICAgICAgICAgICc8aSBjbGFzcz1cImljb24gaWNvbi1hcmNoaXZlIGljb24tZml4ZWQtd2lkdGhcIj48L2k+JyArXG4gICAgICAgICAgICAgICAgJzxsYWJlbCBmb3I9XCInK3RoaXMuc3RhdHVzQmFyLmlkKyctZmlsZVwiPjxpIGNsYXNzPVwiaWNvbiBpY29uLXVwbG9hZCBpY29uLWZpeGVkLXdpZHRoXCI+PC9pPjwvbGFiZWw+JyArXG4gICAgICAgICAgICAgICAgJzxpIGNsYXNzPVwiaWNvbiBpY29uLWNvZGUgaWNvbi1maXhlZC13aWR0aFwiPjwvaT4nICtcbiAgICAgICAgICAgICc8L2Rpdj4nKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHZhciBzd2l0Y2hlciA9IHRoaXMuZ3V0dGVyVG9vbGJhci5jaGlsZCgnaS5pY29uLXBsdXMnKTtcbiAgICAgICAgdmFyIGlubGluZVRvb2xiYXIgPSB0aGlzLmd1dHRlclRvb2xiYXIuY2hpbGQoJy5pbmxpbmUtdG9vbGJhcicpO1xuXG4gICAgICAgIHN3aXRjaGVyLnR1cm5PbiA9IGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICBzd2l0Y2hlci5hZGRDbGFzcygnbWQtaWNvbi1yb3RhdGUtNDUnKTtcbiAgICAgICAgICAgIGlubGluZVRvb2xiYXIuc2hvdygpO1xuICAgICAgICB9O1xuXG4gICAgICAgIHN3aXRjaGVyLnR1cm5PZmYgPSBmdW5jdGlvbigpe1xuICAgICAgICAgICAgc3dpdGNoZXIucmVtb3ZlQ2xhc3MoJ21kLWljb24tcm90YXRlLTQ1Jyk7XG4gICAgICAgICAgICBpbmxpbmVUb29sYmFyLmhpZGUoKTtcbiAgICAgICAgfTtcblxuICAgICAgICBzd2l0Y2hlci5vbignY2xpY2snLCBmdW5jdGlvbigpe1xuICAgICAgICAgICAgaWYoIXN3aXRjaGVyLmhhc0NsYXNzKCdtZC1pY29uLXJvdGF0ZS00NScpKSB7XG4gICAgICAgICAgICAgICAgc3dpdGNoZXIudHVybk9uKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHN3aXRjaGVyLnR1cm5PZmYoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfS5iaW5kKHRoaXMpKTtcblxuICAgICAgICB0aGlzLmd1dHRlclRvb2xiYXIuY2hpbGQoJ2kuaWNvbi1jb2RlJykub24oJ2NsaWNrJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgTU9EeC5sb2FkKHtcbiAgICAgICAgICAgICAgICB4dHlwZTogJ21hcmtkb3duZWRpdG9yLXdpbmRvdy1vZW1iZWQnXG4gICAgICAgICAgICAgICAgLHN1Y2Nlc3M6IGZ1bmN0aW9uKHZhbHVlcyl7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZWRpdG9yLmluc2VydCgnW2VtYmVkICcgKyB2YWx1ZXMudXJsICsgJ10nKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lZGl0b3IuZm9jdXMoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLHNjb3BlOiB0aGlzXG4gICAgICAgICAgICB9KS5zaG93KCk7XG4gICAgICAgIH0uYmluZCh0aGlzKSk7XG4gICAgICAgIFxuICAgICAgICB0aGlzLmd1dHRlclRvb2xiYXIuY2hpbGQoJ2kuaWNvbi1hcmNoaXZlJykub24oJ2NsaWNrJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgTU9EeC5sb2FkKHtcbiAgICAgICAgICAgICAgICB4dHlwZTogJ21vZHgtYnJvd3Nlci13aW5kb3cnXG4gICAgICAgICAgICAgICAgLHNvdXJjZTogcGFyc2VJbnQoTU9EeC5jb25maWdbJ21hcmtkb3duZWRpdG9yLmdlbmVyYWwuc291cmNlJ10pXG4gICAgICAgICAgICAgICAgLGhpZGVTb3VyY2VDb21ibzogcGFyc2VJbnQoTU9EeC5jb25maWdbJ21hcmtkb3duZWRpdG9yLmdlbmVyYWwuc291cmNlX3NlbGVjdCddIHx8IDApICE9IDFcbiAgICAgICAgICAgICAgICAsb25TZWxlY3Q6IGZ1bmN0aW9uKGRhdGEpe1xuICAgICAgICAgICAgICAgICAgICB2YXIgbWFya3VwID0gJyc7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkYXRhLnByZXZpZXcpIG1hcmt1cCA9ICchJztcbiAgICAgICAgICAgICAgICAgICAgbWFya3VwID0gbWFya3VwICsgJ1snICsgZGF0YS5uYW1lICsgJ10oJyArIGRhdGEuZnVsbFJlbGF0aXZlVXJsICsgJyBcIicgKyBkYXRhLm5hbWUgKyAnXCIpJztcblxuICAgICAgICAgICAgICAgICAgICB0aGlzLmVkaXRvci5pbnNlcnQobWFya3VwKTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5lZGl0b3IuZm9jdXMoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLHNjb3BlOiB0aGlzXG4gICAgICAgICAgICB9KS5zaG93KCk7XG4gICAgICAgIH0uYmluZCh0aGlzKSk7XG4gICAgfVxuXG4gICAgLHJlZ2lzdGVyUmVtYXJrYWJsZTogZnVuY3Rpb24oKSB7XG4gICAgICAgIGhsanMucmVnaXN0ZXJMYW5ndWFnZShcIm1vZHhcIiwgZnVuY3Rpb24oaGxqcykge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBjSTogdHJ1ZSxcbiAgICAgICAgICAgICAgICBjOiBbe1xuICAgICAgICAgICAgICAgICAgICBjTjogJ2NvbW1lbnQnLFxuICAgICAgICAgICAgICAgICAgICBiOiAnXFxcXFtcXFxcW1xcXFxzKi0nLFxuICAgICAgICAgICAgICAgICAgICBlOiAnXFxcXF1cXFxcXScsXG4gICAgICAgICAgICAgICAgICAgIGM6IFtdXG4gICAgICAgICAgICAgICAgfSx7XG4gICAgICAgICAgICAgICAgICAgIGNOOiAndmFyaWFibGUnLFxuICAgICAgICAgICAgICAgICAgICByRTogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgYjogJyYnLFxuICAgICAgICAgICAgICAgICAgICBlOiAnPScsXG4gICAgICAgICAgICAgICAgICAgIGM6IFtdXG4gICAgICAgICAgICAgICAgfSx7XG4gICAgICAgICAgICAgICAgICAgIGNOOiAnY2xhc3MnLFxuICAgICAgICAgICAgICAgICAgICBiOiAnXFxcXFtcXFxcWycsXG4gICAgICAgICAgICAgICAgICAgIGU6ICdbXFxcXD9dJyxcbiAgICAgICAgICAgICAgICAgICAgckI6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGM6IFt7XG4gICAgICAgICAgICAgICAgICAgICAgICBiOiAnXFxcXFtcXFxcWycsXG4gICAgICAgICAgICAgICAgICAgICAgICBlOiAnWzpAXFxcXD9dJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHJFOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgYzogW3tcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjTjogJ3RpdGxlJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiOiAnW2EtekEtWjAtOV0rJ1xuICAgICAgICAgICAgICAgICAgICAgICAgfSx7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY046ICdzdHJpbmcnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGI6ICdbXFxcXCRcXFxcKyElXSdcbiAgICAgICAgICAgICAgICAgICAgICAgIH1dXG4gICAgICAgICAgICAgICAgICAgIH0se1xuICAgICAgICAgICAgICAgICAgICAgICAgY046ICd2YXJpYWJsZScsXG4gICAgICAgICAgICAgICAgICAgICAgICBiOiAnQFthLXpBLVowLTldKydcbiAgICAgICAgICAgICAgICAgICAgfSx7XG4gICAgICAgICAgICAgICAgICAgICAgICBjTjogJ3ZhcmlhYmxlJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGI6ICc6W2EtekEtWjAtOV0rJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGU6ICc9JyxcbiAgICAgICAgICAgICAgICAgICAgICAgIGVFOiB0cnVlIFxuICAgICAgICAgICAgICAgICAgICB9XVxuICAgICAgICAgICAgICAgIH1dXG4gICAgICAgICAgICB9O1xuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIHRoaXMucmVtYXJrYWJsZSA9IG5ldyBSZW1hcmthYmxlKHtcbiAgICAgICAgICAgIGh0bWw6IHRydWUsXG4gICAgICAgICAgICBoaWdobGlnaHQ6IGZ1bmN0aW9uIChzdHIsIGxhbmcpIHtcbiAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSAnJztcbiAgICAgICAgICAgICAgICBpZiAobGFuZyAmJiBobGpzLmdldExhbmd1YWdlKGxhbmcpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IGhsanMuaGlnaGxpZ2h0KGxhbmcsIHN0cikudmFsdWU7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlID0gdmFsdWUucmVwbGFjZSgvXFxbXFxbL2csICcmIzkxOyYjOTE7Jyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZSA9IHZhbHVlLnJlcGxhY2UoL11dL2csICcmIzkzOyYjOTM7Jyk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7fVxuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIHZhbHVlID0gaGxqcy5oaWdobGlnaHRBdXRvKHN0cikudmFsdWU7XG5cbiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKC9cXFtcXFsvZywgJyYjOTE7JiM5MTsnKTtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKC9dXS9nLCAnJiM5MzsmIzkzOycpO1xuXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHt9XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gJyc7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnJlbWFya2FibGUuaW5saW5lLnJ1bGVyLmRpc2FibGUoWyAnYmFja3RpY2tzJyBdKTtcblxuICAgICAgICB2YXIgb0VtYmVkUmVuZGVyZXIgPSBmdW5jdGlvbih0b2tlbnMsIGlkeCwgb3B0aW9ucykge1xuICAgICAgICAgICAgaWYgKHRoaXMubG9jYWxDYWNoZS5vRW1iZWRbdG9rZW5zW2lkeF0udXJsXSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmxvY2FsQ2FjaGUub0VtYmVkW3Rva2Vuc1tpZHhdLnVybF07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHZhciBlbWJlZElEID0gRXh0LmlkKCk7XG5cbiAgICAgICAgICAgICAgICBNT0R4LkFqYXgucmVxdWVzdCh7XG4gICAgICAgICAgICAgICAgICAgIHVybDogbWFya2Rvd25FZGl0b3IuY29uZmlnLmNvbm5lY3RvclVybFxuICAgICAgICAgICAgICAgICAgICAscGFyYW1zOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhY3Rpb246ICdtZ3IvZWRpdG9yL29lbWJlZCdcbiAgICAgICAgICAgICAgICAgICAgICAgICx1cmw6IHRva2Vuc1tpZHhdLnVybFxuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnM6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJzoge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuOiBmdW5jdGlvbihyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlbWJlZERpdiA9IEV4dC5nZXQoZW1iZWRJRCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlbWJlZERpdikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZW1iZWREaXYudXBkYXRlKHIuZGF0YSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbWJlZERpdi5kb20ucmVtb3ZlQXR0cmlidXRlKCdpZCcpO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5sb2NhbENhY2hlLm9FbWJlZFt0b2tlbnNbaWR4XS51cmxdID0gZW1iZWREaXYuZG9tLm91dGVySFRNTDtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciB0ZXh0YXJlYUNvbnRlbnQgPSBFeHQuZ2V0KEV4dC5Eb21IZWxwZXIuY3JlYXRlRG9tKHt0YWc6ICdkaXYnLCBodG1sOiB0aGlzLnRleHRhcmVhLmRvbS52YWx1ZX0pKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHRhcmVhQ29udGVudC5jaGlsZCgnIycgKyBlbWJlZElEKS51cGRhdGUoci5kYXRhKS5kb20ucmVtb3ZlQXR0cmlidXRlKCdpZCcpO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy50ZXh0YXJlYS5kb20udmFsdWUgPSB0ZXh0YXJlYUNvbnRlbnQuZG9tLmlubmVySFRNTDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuICc8ZGl2IGlkPVwiJyArIGVtYmVkSUQgKyAnXCIgY2xhc3M9XCJtYXJrZG93bmVkaXRvci1vZW1iZWQtY29udGVudFwiPltlbWJlZCAnICsgdG9rZW5zW2lkeF0udXJsICsgJ108L2Rpdj4nO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LmJpbmQodGhpcyk7XG5cbiAgICAgICAgdmFyIHJlbWFya2FibGUgPSB0aGlzLnJlbWFya2FibGU7XG4gICAgICAgIHJlbWFya2FibGUucmVuZGVyZXIucnVsZXMuY29kZSA9IChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHZhciBvcmlnaW5hbCA9IHJlbWFya2FibGUucmVuZGVyZXIucnVsZXMuY29kZTtcbiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICB2YXIgY29udGVudCA9IG9yaWdpbmFsLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgICAgICAgICAgICAgY29udGVudCA9IGNvbnRlbnQucmVwbGFjZSgvXFxbXFxbL2csICcmIzkxOyYjOTE7Jyk7XG4gICAgICAgICAgICAgICAgY29udGVudCA9IGNvbnRlbnQucmVwbGFjZSgvXV0vZywgJyYjOTM7JiM5MzsnKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICByZXR1cm4gY29udGVudDtcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0pKCk7XG4gICAgICAgIFxuICAgICAgICB2YXIgb0VtYmVkID0gZnVuY3Rpb24obWQpIHtcbiAgICAgICAgICAgIG1kLmlubGluZS5ydWxlci5wdXNoKCdvRW1iZWQnLCB0aGlzLm9FbWJlZFBhcnNlcik7XG4gICAgICAgICAgICBtZC5yZW5kZXJlci5ydWxlcy5vRW1iZWQgPSBvRW1iZWRSZW5kZXJlcjtcbiAgICAgICAgfS5iaW5kKHRoaXMpO1xuICAgICAgICBcbiAgICAgICAgdmFyIG1vZHhUYWdzID0gZnVuY3Rpb24obWQpIHtcbiAgICAgICAgICAgIG1kLmlubGluZS5ydWxlci5wdXNoKCdtb2R4Q29kZScsIHRoaXMubW9keENvZGVQYXJzZXIpO1xuICAgICAgICB9LmJpbmQodGhpcyk7XG5cbiAgICAgICAgdGhpcy5yZW1hcmthYmxlLnVzZShvRW1iZWQpO1xuICAgICAgICB0aGlzLnJlbWFya2FibGUudXNlKG1vZHhUYWdzKTtcbiAgICB9XG5cbiAgICAscGFyc2U6IGZ1bmN0aW9uKGlucHV0KSB7XG4gICAgICAgIHZhciBvdXRwdXQgPSB0aGlzLnJlbWFya2FibGUucmVuZGVyKGlucHV0KTtcblxuICAgICAgICBvdXRwdXQgPSBvdXRwdXQucmVwbGFjZSgvJTVCL2csICdbJyk7XG4gICAgICAgIG91dHB1dCA9IG91dHB1dC5yZXBsYWNlKC8lNUQvZywgJ10nKTtcblxuICAgICAgICBpZiAoTU9EeC5jb25maWdbJ21hcmtkb3duZWRpdG9yLmxwLnBhcnNlX21vZHhfdGFncyddID09IDEpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLnBhcnNlUmVxdWVzdCkge1xuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLnBhcnNlUmVxdWVzdCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHZhciB0aW1lb3V0ID0gcGFyc2VJbnQoTU9EeC5jb25maWdbJ21hcmtkb3duZWRpdG9yLmxwLnBhcnNlX21vZHhfdGFnc190aW1lb3V0J10gfHwgMzAwKTtcblxuICAgICAgICAgICAgdGhpcy5wYXJzZVJlcXVlc3QgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7XG4gICAgICAgICAgICAgICAgTU9EeC5BamF4LnJlcXVlc3Qoe1xuICAgICAgICAgICAgICAgICAgICB1cmw6IG1hcmtkb3duRWRpdG9yLmNvbmZpZy5jb25uZWN0b3JVcmxcbiAgICAgICAgICAgICAgICAgICAgLHBhcmFtczoge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWN0aW9uOiAnbWdyL2VkaXRvci9wcm9jZXNzY29udGVudCdcbiAgICAgICAgICAgICAgICAgICAgICAgICxjb250ZW50OiBvdXRwdXRcbiAgICAgICAgICAgICAgICAgICAgICAgICxyZXNvdXJjZTogTU9EeC5yZXF1ZXN0LmlkXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIGlzVXBsb2FkIDogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAnc3VjY2Vzcyc6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmbjogZnVuY3Rpb24ocikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmV3UHJldmlldyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuZXdQcmV2aWV3LmlubmVySFRNTCA9IHIuZGF0YTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRpZmZET00uYXBwbHkodGhpcy5wcmV2aWV3LmRvbSwgdGhpcy5kaWZmRE9NLmRpZmYodGhpcy5wcmV2aWV3LmRvbSwgbmV3UHJldmlldykpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucHJldmlldy5maXhIZWlnaHQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgodGhpcy5lZGl0b3IuZ2V0Q3Vyc29yUG9zaXRpb24oKS5yb3cgKyAyKSA+PSB0aGlzLmVkaXRvci5nZXRTZXNzaW9uKCkuZ2V0RG9jdW1lbnQoKS5nZXRMZW5ndGgoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wcmV2aWV3LnBhcmVudCgpLmRvbS5zY3JvbGxUb3AgPSB0aGlzLnByZXZpZXcucGFyZW50KCkuZG9tLnNjcm9sbEhlaWdodFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfS5iaW5kKHRoaXMpLCB0aW1lb3V0KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHZhciBuZXdQcmV2aWV3ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICAgICAgICBuZXdQcmV2aWV3LmlubmVySFRNTCA9IG91dHB1dDtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhpcy5kaWZmRE9NLmFwcGx5KHRoaXMucHJldmlldy5kb20sIHRoaXMuZGlmZkRPTS5kaWZmKHRoaXMucHJldmlldy5kb20sIG5ld1ByZXZpZXcpKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhpcy5wcmV2aWV3LmZpeEhlaWdodCgpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoKHRoaXMuZWRpdG9yLmdldEN1cnNvclBvc2l0aW9uKCkucm93ICsgMikgPj0gdGhpcy5lZGl0b3IuZ2V0U2Vzc2lvbigpLmdldERvY3VtZW50KCkuZ2V0TGVuZ3RoKCkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnByZXZpZXcucGFyZW50KCkuZG9tLnNjcm9sbFRvcCA9IHRoaXMucHJldmlldy5wYXJlbnQoKS5kb20uc2Nyb2xsSGVpZ2h0O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy50YU1hcmtkb3duLmRvbS52YWx1ZSA9IHRoaXMuZWRpdG9yLmdldFZhbHVlKCk7XG4gICAgICAgIHRoaXMudGV4dGFyZWEuZG9tLnZhbHVlID0gb3V0cHV0O1xuXG4gICAgICAgIHJldHVybiBvdXRwdXQ7XG4gICAgfVxuXG4gICAgLG9FbWJlZFBhcnNlcjogZnVuY3Rpb24oc3RhdGUpIHtcbiAgICAgICAgLy8gR2l2ZW4gc3RhdGUuc3JjIFtlbWJlZCB1cmxdXG4gICAgICAgIC8vIFdlIGFyZSBoZXJlOiAgICBeXG4gICAgICAgIHZhciBwb3MgPSBzdGF0ZS5wb3M7XG4gICAgICAgIHZhciBtYXJrZXIgPSBzdGF0ZS5zcmMuY2hhckNvZGVBdChzdGF0ZS5wb3MpO1xuICAgICAgICBpZiAobWFya2VyICE9PSAweDVCLyogWyAqLykge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gR2l2ZW4gc3RhdGUuc3JjIFtlbWJlZCB1cmxdXG4gICAgICAgIC8vIFdlIGFyZSBoZXJlOiAgICAgXlxuICAgICAgICBwb3MrKztcbiAgICAgICAgbWFya2VyID0gc3RhdGUuc3JjLmNoYXJDb2RlQXQocG9zKTtcbiAgICAgICAgaWYgKG1hcmtlciAhPT0gMHg2NS8qIGUgKi8pIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEdpdmVuIHN0YXRlLnNyYyBbZW1iZWQgdXJsXVxuICAgICAgICAvLyBXZSBhcmUgaGVyZTogICAgICBeXG4gICAgICAgIHBvcysrO1xuICAgICAgICBtYXJrZXIgPSBzdGF0ZS5zcmMuY2hhckNvZGVBdChwb3MpO1xuICAgICAgICBpZiAobWFya2VyICE9PSAweDZELyogbSAqLykge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gR2l2ZW4gc3RhdGUuc3JjIFtlbWJlZCB1cmxdXG4gICAgICAgIC8vIFdlIGFyZSBoZXJlOiAgICAgICBeXG4gICAgICAgIHBvcysrO1xuICAgICAgICBtYXJrZXIgPSBzdGF0ZS5zcmMuY2hhckNvZGVBdChwb3MpO1xuICAgICAgICBpZiAobWFya2VyICE9PSAweDYyLyogYiAqLykge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gR2l2ZW4gc3RhdGUuc3JjIFtlbWJlZCB1cmxdXG4gICAgICAgIC8vIFdlIGFyZSBoZXJlOiAgICAgICAgXlxuICAgICAgICBwb3MrKztcbiAgICAgICAgbWFya2VyID0gc3RhdGUuc3JjLmNoYXJDb2RlQXQocG9zKTtcbiAgICAgICAgaWYgKG1hcmtlciAhPT0gMHg2NS8qIGUgKi8pIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEdpdmVuIHN0YXRlLnNyYyBbZW1iZWQgdXJsXVxuICAgICAgICAvLyBXZSBhcmUgaGVyZTogICAgICAgICBeXG4gICAgICAgIHBvcysrO1xuICAgICAgICBtYXJrZXIgPSBzdGF0ZS5zcmMuY2hhckNvZGVBdChwb3MpO1xuICAgICAgICBpZiAobWFya2VyICE9PSAweDY0LyogZCAqLykge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gR2l2ZW4gc3RhdGUuc3JjIFtlbWJlZCB1cmxdXG4gICAgICAgIC8vIFdlIGFyZSBoZXJlOiAgICAgICAgICBeXG4gICAgICAgIHBvcysrO1xuICAgICAgICBtYXJrZXIgPSBzdGF0ZS5zcmMuY2hhckNvZGVBdChwb3MpO1xuICAgICAgICBpZiAobWFya2VyICE9PSAweDIwLyogICAqLykge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgcG9zKys7XG5cbiAgICAgICAgdmFyIHN0YXJ0ID0gcG9zO1xuICAgICAgICB2YXIgbWF4ID0gc3RhdGUucG9zTWF4O1xuICAgICAgICB2YXIgZW5kRm91bmQgPSBmYWxzZTtcbiAgICAgICAgd2hpbGUgKHBvcyA8IG1heCkge1xuICAgICAgICAgICAgaWYgKHN0YXRlLnNyYy5jaGFyQ29kZUF0KHBvcykgPT09IDB4NUQvKiBdICovKSB7XG4gICAgICAgICAgICAgICAgZW5kRm91bmQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoc3RhdGUuc3JjLmNoYXJDb2RlQXQocG9zKSA9PT0gMHgyMC8qICAqLykge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcG9zKys7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWVuZEZvdW5kKSByZXR1cm4gZmFsc2U7XG5cbiAgICAgICAgc3RhdGUucG9zID0gcG9zKzE7XG5cbiAgICAgICAgaWYgKHN0YXRlLnBvcyA+IHN0YXRlLnBvc01heCkge1xuICAgICAgICAgICAgc3RhdGUucG9zID0gc3RhdGUucG9zTWF4O1xuICAgICAgICB9XG5cbiAgICAgICAgdmFyIHVybCA9IHN0YXRlLnNyYy5zbGljZShzdGFydCwgcG9zKTtcblxuICAgICAgICAvLyBIYXZpbmcgbWF0Y2hlZCBhbGwgdGhyZWUgY2hhcmFjdGVycyB3ZSBhZGQgYSB0b2tlbiB0byB0aGUgc3RhdGUgbGlzdFxuICAgICAgICB2YXIgdG9rZW4gPSB7XG4gICAgICAgICAgICB0eXBlOiBcIm9FbWJlZFwiLFxuICAgICAgICAgICAgbGV2ZWw6IHN0YXRlLmxldmVsLFxuICAgICAgICAgICAgY29udGVudDogbWFya2VyLFxuICAgICAgICAgICAgdXJsOiB1cmxcbiAgICAgICAgfTtcblxuICAgICAgICBzdGF0ZS5wdXNoKHRva2VuKTtcblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgXG4gICAgLG1vZHhDb2RlUGFyc2VyOiBmdW5jdGlvbihzdGF0ZSwgc2lsZW50KSB7XG4gICAgICAgIHZhciBtYXgsIG1hcmtlciwgbWF0Y2hTdGFydCwgbWF0Y2hFbmQsXG4gICAgICAgICAgICBwb3MgPSBzdGF0ZS5wb3M7XG5cbiAgICAgICAgaWYgKHN0YXRlLnNyYy5jaGFyQ29kZUF0KHBvcykgIT09IDB4NjAvKiBgICovKSB7IHJldHVybiBmYWxzZTsgfVxuICAgICAgICBwb3MrKztcbiAgICAgICAgaWYgKHN0YXRlLnNyYy5jaGFyQ29kZUF0KHBvcykgIT09IDB4NjAvKiBgICovKSB7IHJldHVybiBmYWxzZTsgfVxuICAgICAgICBwb3MrKztcbiAgICAgICAgaWYgKHN0YXRlLnNyYy5jaGFyQ29kZUF0KHBvcykgIT09IDB4NjAvKiBgICovKSB7IHJldHVybiBmYWxzZTsgfVxuICAgICAgICBcbiAgICAgICAgcG9zKys7XG4gICAgICAgIG1heCA9IHN0YXRlLnBvc01heDtcblxuICAgICAgICBtYXJrZXIgPSAnYGBgJztcblxuICAgICAgICBtYXRjaFN0YXJ0ID0gbWF0Y2hFbmQgPSBwb3M7XG5cbiAgICAgICAgd2hpbGUgKChtYXRjaFN0YXJ0ID0gc3RhdGUuc3JjLmluZGV4T2YoJ2AnLCBtYXRjaEVuZCkpICE9PSAtMSkge1xuICAgICAgICAgICAgbWF0Y2hFbmQgPSBtYXRjaFN0YXJ0ICsgMTtcblxuICAgICAgICAgICAgd2hpbGUgKG1hdGNoRW5kIDwgbWF4ICYmIHN0YXRlLnNyYy5jaGFyQ29kZUF0KG1hdGNoRW5kKSA9PT0gMHg2MC8qIGAgKi8pIHsgbWF0Y2hFbmQrKzsgfVxuXG4gICAgICAgICAgICBpZiAobWF0Y2hFbmQgLSBtYXRjaFN0YXJ0ID09PSBtYXJrZXIubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFzaWxlbnQpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdGUucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnY29kZScsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50OiBzdGF0ZS5zcmMuc2xpY2UocG9zLCBtYXRjaFN0YXJ0KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5yZXBsYWNlKC9bIFxcbl0rL2csICcgJylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAudHJpbSgpLFxuICAgICAgICAgICAgICAgICAgICAgICAgYmxvY2s6IGZhbHNlLFxuICAgICAgICAgICAgICAgICAgICAgICAgbGV2ZWw6IHN0YXRlLmxldmVsXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBzdGF0ZS5wb3MgPSBtYXRjaEVuZDtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghc2lsZW50KSB7IHN0YXRlLnBlbmRpbmcgKz0gbWFya2VyOyB9XG4gICAgICAgIHN0YXRlLnBvcyArPSBtYXJrZXIubGVuZ3RoO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICAsY2F0Y2hBbmREb05vdGhpbmc6IGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIH1cblxuICAgICxkcm9wOiBmdW5jdGlvbihlKSB7XG4gICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcblxuICAgICAgICBpZiAoTU9EeC5jb25maWdbJ21hcmtkb3duZWRpdG9yLnVwbG9hZC5lbmFibGVfaW1hZ2VfdXBsb2FkJ10gPT0gMSB8fCBNT0R4LmNvbmZpZ1snbWFya2Rvd25lZGl0b3IudXBsb2FkLmVuYWJsZV9maWxlX3VwbG9hZCddID09IDEpIHtcbiAgICAgICAgICAgIHRoaXMuaGFuZGxlRmlsZXMoZS5kYXRhVHJhbnNmZXIuZmlsZXMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLGhhbmRsZUZpbGVzOiBmdW5jdGlvbihmaWxlcywgbW9iaWxlKSB7XG4gICAgICAgIG1vYmlsZSA9IG1vYmlsZSB8fCAwO1xuXG4gICAgICAgIEV4dC5lYWNoKGZpbGVzLCBmdW5jdGlvbihmaWxlKSB7XG4gICAgICAgICAgICB2YXIgaXNJbWFnZSA9IC9eaW1hZ2VcXC8vLnRlc3QoZmlsZS50eXBlKTtcblxuICAgICAgICAgICAgaWYgKGlzSW1hZ2UpIHtcbiAgICAgICAgICAgICAgICBpZiAoTU9EeC5jb25maWdbJ21hcmtkb3duZWRpdG9yLnVwbG9hZC5lbmFibGVfaW1hZ2VfdXBsb2FkJ10gPT0gMCkgcmV0dXJuIHRydWU7XG5cbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuY2hlY2tUeXBlKE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci51cGxvYWQuaW1hZ2VfdHlwZXMnXSwgZmlsZSkpe1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmZhaWxNZXNzYWdlKGZpbGUsICdpbWFnZScsIF8oJ21hcmtkb3duZWRpdG9yLmVyci51cGxvYWQudW5zdXBwb3J0ZWRfaW1hZ2UnKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuY2hlY2tTaXplKGZpbGUuc2l6ZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5mYWlsTWVzc2FnZShmaWxlLCAnaW1hZ2UnLCBfKCdtYXJrZG93bmVkaXRvci5lcnIudXBsb2FkLnRvb19iaWcnKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci5jcm9wcGVyLmVuYWJsZV9jcm9wcGVyJ10gPT0gMSkge1xuICAgICAgICAgICAgICAgICAgICBNT0R4LmxvYWQoe1xuICAgICAgICAgICAgICAgICAgICAgICAgeHR5cGU6ICdtYXJrZG93bmVkaXRvci13aW5kb3ctY3JvcHBlcidcbiAgICAgICAgICAgICAgICAgICAgICAgICxmaWxlOiBmaWxlXG4gICAgICAgICAgICAgICAgICAgICAgICAsbWQ6IHRoaXNcbiAgICAgICAgICAgICAgICAgICAgICAgICxtb2JpbGU6IG1vYmlsZVxuICAgICAgICAgICAgICAgICAgICB9KS5zaG93KCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy51cGxvYWRGaWxlKGZpbGUsICdpbWFnZScsIG1vYmlsZSk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZWRpdG9yLmZvY3VzKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoTU9EeC5jb25maWdbJ21hcmtkb3duZWRpdG9yLnVwbG9hZC5lbmFibGVfZmlsZV91cGxvYWQnXSA9PSAwKSByZXR1cm4gdHJ1ZTtcblxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5jaGVja1R5cGUoTU9EeC5jb25maWdbJ21hcmtkb3duZWRpdG9yLnVwbG9hZC5maWxlX3R5cGVzJ10sIGZpbGUpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmFpbE1lc3NhZ2UoZmlsZSwgJ2ZpbGUnLCBfKCdtYXJrZG93bmVkaXRvci5lcnIudXBsb2FkLnVuc3VwcG9ydGVkX2ZpbGUnKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKCF0aGlzLmNoZWNrU2l6ZShmaWxlLnNpemUpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmFpbE1lc3NhZ2UoZmlsZSwgJ2ZpbGUnLCBfKCdtYXJrZG93bmVkaXRvci5lcnIudXBsb2FkLnRvb19iaWcnKSk7XG5cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgdGhpcy51cGxvYWRGaWxlKGZpbGUsICdmaWxlJyk7XG4gICAgICAgICAgICAgICAgdGhpcy5lZGl0b3IuZm9jdXMoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICB9LCB0aGlzKTtcbiAgICB9XG5cbiAgICAsY2hlY2tTaXplOiBmdW5jdGlvbihzaXplKXtcbiAgICAgICAgdmFyIG1heFNpemUgPSBNT0R4LmNvbmZpZ1snbWFya2Rvd25lZGl0b3IudXBsb2FkLm1heF9zaXplJ107XG4gICAgICAgIGlmICghbWF4U2l6ZSB8fCBtYXhTaXplID09ICcnKSBtYXhTaXplID0gKE1PRHguY29uZmlnWyd1cGxvYWRfbWF4c2l6ZSddIHx8ICcyMDk3MTUyJyk7XG5cbiAgICAgICAgbWF4U2l6ZSA9IHBhcnNlSW50KG1heFNpemUpO1xuXG4gICAgICAgIGlmIChtYXhTaXplID09IDApIHJldHVybiB0cnVlO1xuXG4gICAgICAgIHJldHVybiBzaXplIDw9IG1heFNpemU7XG4gICAgfVxuXG4gICAgLGNoZWNrVHlwZTogZnVuY3Rpb24oYWxsb3dlZFR5cGVzLCBmaWxlKSB7XG4gICAgICAgIGFsbG93ZWRUeXBlcyA9IGFsbG93ZWRUeXBlcy5zcGxpdCgnLCcpO1xuICAgICAgICB2YXIgZXh0ID0gZmlsZS5uYW1lLnNwbGl0KCcuJykucG9wKCk7XG4gICAgICAgIHJldHVybiBhbGxvd2VkVHlwZXMuaW5kZXhPZihleHQudG9Mb3dlckNhc2UoKSkgIT0gLTE7XG4gICAgfVxuXG4gICAgLHVwbG9hZEZpbGU6IGZ1bmN0aW9uKGZpbGUsIHR5cGUsIG1vYmlsZSkge1xuICAgICAgICB0eXBlID0gdHlwZSB8fCAnZmlsZSc7XG4gICAgICAgIG1vYmlsZSA9IG1vYmlsZSB8fCAwO1xuXG4gICAgICAgIHZhciB1cGxvYWRlciA9IHRoaXMuY3JlYXRlVXBsb2FkZXIodHlwZSwgZmlsZS5uYW1lKTtcblxuICAgICAgICB2YXIgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcbiAgICAgICAgZm9ybURhdGEuYXBwZW5kKCdmaWxlJywgZmlsZSk7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnYWN0aW9uJywgJ21nci9lZGl0b3IvJyArIHR5cGUgKyAndXBsb2FkJyk7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnbmFtZScsIGZpbGUubmFtZSk7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgncmVzb3VyY2UnLCB0aGlzLmNvbmZpZy5yZXNvdXJjZSk7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnbW9iaWxlJywgbW9iaWxlKTtcblxuICAgICAgICB2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG4gICAgICAgIHhoci5vcGVuKCdQT1NUJywgbWFya2Rvd25FZGl0b3IuY29uZmlnLmNvbm5lY3RvclVybCk7XG4gICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdQb3dlcmVkLUJ5JywgJ01PRHgnKTtcbiAgICAgICAgeGhyLnNldFJlcXVlc3RIZWFkZXIoJ21vZEF1dGgnLCBFeHQuQWpheC5kZWZhdWx0SGVhZGVycy5tb2RBdXRoKTtcblxuICAgICAgICB4aHIudXBsb2FkLm9ucHJvZ3Jlc3MgPSBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgICAgICAgIGlmIChldmVudC5sZW5ndGhDb21wdXRhYmxlKSB7XG4gICAgICAgICAgICAgICAgdmFyIGNvbXBsZXRlID0gKGV2ZW50LmxvYWRlZCAvIGV2ZW50LnRvdGFsICogMTAwIHwgMCk7XG4gICAgICAgICAgICAgICAgdXBsb2FkZXIuY2hpbGQoJy5wcm9ncmVzcycpLnNldFdpZHRoKGNvbXBsZXRlICsgJyUnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfS5iaW5kKHRoaXMpO1xuXG4gICAgICAgIHhoci5vbmxvYWQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBpZiAoeGhyLnN0YXR1cyA9PT0gMjAwKSB7XG4gICAgICAgICAgICAgICAgdmFyIHJlcyA9IEpTT04ucGFyc2UoeGhyLnJlc3BvbnNlVGV4dCk7XG4gICAgICAgICAgICAgICAgaWYgKHJlcy5zdWNjZXNzID09IHRydWUpIHtcbiAgICAgICAgICAgICAgICAgICAgdXBsb2FkZXIucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBpbWFnZVByZWZpeCA9ICh0eXBlID09ICdpbWFnZScpID8gJyEnIDogJyc7XG4gICAgICAgICAgICAgICAgICAgIHZhciBlbmRMaW5lID0gKHR5cGUgPT0gJ2ltYWdlJykgPyAnXFxuXFxuJyA6ICdcXG4nO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVkaXRvci5pbnNlcnQoaW1hZ2VQcmVmaXggKyAnWycgKyByZXMub2JqZWN0Lm5hbWUgKyAnXSgnICsgcmVzLm9iamVjdC5wYXRoICsgJyBcIicgKyByZXMub2JqZWN0Lm5hbWUgKyAnXCIpJyArIGVuZExpbmUpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZmFpbFVwbG9hZGVyKHVwbG9hZGVyLCByZXMubWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9LmJpbmQodGhpcyk7XG5cbiAgICAgICAgeGhyLnNlbmQoZm9ybURhdGEpO1xuICAgIH1cblxuICAgICxjcmVhdGVVcGxvYWRlcjogZnVuY3Rpb24odHlwZSwgZmlsZU5hbWUpIHtcbiAgICAgICAgdmFyIHVwbG9hZGVyID0gRXh0LkRvbUhlbHBlci5pbnNlcnRGaXJzdCh0aGlzLnN0YXR1c0Jhcix7XG4gICAgICAgICAgICB0YWc6ICdkaXYnLFxuICAgICAgICAgICAgaHRtbDogJzxkaXYgY2xhc3M9XCJwcm9ncmVzc1wiPjxpIGNsYXNzPVwiaWNvbiBpY29uLXNwaW5uZXIgaWNvbi1zcGluXCI+PC9pPiA8c3Bhbj4nICsgXygnbWFya2Rvd25lZGl0b3IudXBsb2FkaW5nXycgKyB0eXBlKSArIGZpbGVOYW1lICsgJzwvc3Bhbj48L2Rpdj4nXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBFeHQuZ2V0KHVwbG9hZGVyKTtcbiAgICB9XG5cbiAgICAsZmFpbFVwbG9hZGVyOiBmdW5jdGlvbih1cGxvYWRlciwgbWVzc2FnZSkge1xuICAgICAgICB1cGxvYWRlci5jaGlsZCgnLnByb2dyZXNzJykuYWRkQ2xhc3MoJ2Vycm9yJyk7XG4gICAgICAgIHVwbG9hZGVyLmNoaWxkKCcucHJvZ3Jlc3MnKS5zZXRXaWR0aCgnMTAwJScpO1xuXG4gICAgICAgIHVwbG9hZGVyLmNoaWxkKCdpJykuYWRkQ2xhc3MoJ3JlbW92ZS1tZXNzYWdlJyk7XG4gICAgICAgIHVwbG9hZGVyLmNoaWxkKCdpJykucmVwbGFjZUNsYXNzKCdpY29uLXNwaW5uZXInLCAnaWNvbi1yZW1vdmUnKTtcbiAgICAgICAgdXBsb2FkZXIuY2hpbGQoJ2knKS5yZW1vdmVDbGFzcygnaWNvbi1zcGluJyk7XG5cbiAgICAgICAgdXBsb2FkZXIuY2hpbGQoJ3NwYW4nKS5kb20uaW5uZXJIVE1MICs9ICcgZmFpbGVkLiAnICsgbWVzc2FnZTtcbiAgICAgICAgdXBsb2FkZXIuY2hpbGQoJy5yZW1vdmUtbWVzc2FnZScpLm9uKCdjbGljaycsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgdXBsb2FkZXIucmVtb3ZlKCk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgICxmYWlsTWVzc2FnZTogZnVuY3Rpb24oZmlsZSwgdHlwZSwgbWVzc2FnZSkge1xuICAgICAgICB2YXIgdXBsb2FkZXIgPSB0aGlzLmNyZWF0ZVVwbG9hZGVyKHR5cGUsIGZpbGUubmFtZSk7XG4gICAgICAgIHRoaXMuZmFpbFVwbG9hZGVyKHVwbG9hZGVyLCBtZXNzYWdlKTtcbiAgICB9XG5cbiAgICAsaXNNb2JpbGVEZXZpY2U6IGZ1bmN0aW9uKCkge1xuICAgICAgICByZXR1cm4gKHR5cGVvZiB3aW5kb3cub3JpZW50YXRpb24gIT09IFwidW5kZWZpbmVkXCIpIHx8IChuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoJ0lFTW9iaWxlJykgIT09IC0xKTtcbiAgICB9XG59KTtcblxuTU9EeC5sb2FkUlRFID0gZnVuY3Rpb24oaWQpIHtcbiAgICBuZXcgbWFya2Rvd25FZGl0b3IuRWRpdG9yKHtcbiAgICAgICAgbWRFbGVtZW50SWQ6IGlkXG4gICAgfSk7XG59O1xuXG5NT0R4LmFmdGVyVFZMb2FkID0gZnVuY3Rpb24oKSB7XG4gICAgdmFyIGVscyA9IEV4dC5xdWVyeSgndGV4dGFyZWEubW9keC1yaWNodGV4dCcpO1xuXG4gICAgRXh0LmVhY2goZWxzLCBmdW5jdGlvbihlbGVtZW50KXtcbiAgICAgICAgZWxlbWVudCA9IEV4dC5nZXQoZWxlbWVudCk7XG4gICAgICAgIGlmICghZWxlbWVudCkgcmV0dXJuIHRydWU7XG5cbiAgICAgICAgaWYgKG1hcmtkb3duRWRpdG9yLmxvYWRlZEVsZW1lbnRzW2VsZW1lbnQuaWRdKSByZXR1cm4gdHJ1ZTtcblxuICAgICAgICBtYXJrZG93bkVkaXRvci5sb2FkZWRFbGVtZW50c1tlbGVtZW50LmlkXSA9IG5ldyBtYXJrZG93bkVkaXRvci5FZGl0b3Ioe1xuICAgICAgICAgICAgbWRFbGVtZW50SWQ6IGVsZW1lbnQuaWRcbiAgICAgICAgfSk7XG5cbiAgICB9KTtcblxufTtcblxuTU9EeC51bmxvYWRUVlJURSA9IGZ1bmN0aW9uKCkge1xuICAgIHZhciBlbHMgPSBFeHQucXVlcnkoJy5tb2R4LXJpY2h0ZXh0Jyk7XG5cbiAgICBFeHQuZWFjaChlbHMsIGZ1bmN0aW9uKGVsZW1lbnQpe1xuICAgICAgICBlbGVtZW50ID0gRXh0LmdldChlbGVtZW50KTtcbiAgICAgICAgaWYgKCFlbGVtZW50KSByZXR1cm4gdHJ1ZTtcblxuICAgICAgICBpZiAoIW1hcmtkb3duRWRpdG9yLmxvYWRlZEVsZW1lbnRzW2VsZW1lbnQuaWRdKSByZXR1cm4gdHJ1ZTtcblxuICAgICAgICBtYXJrZG93bkVkaXRvci5sb2FkZWRFbGVtZW50c1tlbGVtZW50LmlkXS5kZXN0cm95KCk7XG5cbiAgICB9KTtcbn07IiwibWFya2Rvd25FZGl0b3IuY29tYm8uQ3JvcHBlclByb2ZpbGUgPSBmdW5jdGlvbihjb25maWcpIHtcbiAgICB2YXIgZGF0YSA9IEpTT04ucGFyc2UoTU9EeC5jb25maWdbJ21hcmtkb3duZWRpdG9yLmNyb3BwZXIucHJvZmlsZXMnXSB8fCAnW10nKTtcblxuICAgIGNvbmZpZyA9IGNvbmZpZyB8fCB7fTtcbiAgICBFeHQuYXBwbHlJZihjb25maWcse1xuICAgICAgICBzdG9yZTogbmV3IEV4dC5kYXRhLkpzb25TdG9yZSh7XG4gICAgICAgICAgICBkYXRhOiBkYXRhXG4gICAgICAgICAgICAsZmllbGRzOiBbJ25hbWUnLCAnd2lkdGgnLCAnaGVpZ2h0JywgJ3JhdGlvJ11cbiAgICAgICAgfSlcbiAgICAgICAgLGRpc3BsYXlGaWVsZDogJ25hbWUnXG4gICAgICAgICxtb2RlOiAnbG9jYWwnXG4gICAgICAgICx2YWx1ZUZpZWxkOiAnbmFtZSdcbiAgICAgICAgLGVkaXRhYmxlOiBmYWxzZVxuICAgICAgICAsdmFsdWU6IGRhdGFbMF0gPyBkYXRhWzBdLm5hbWUgOiAnJ1xuICAgIH0pO1xuXG4gICAgdmFyIHNob3dEZXNjcmlwdGlvbiA9IHBhcnNlSW50KE1PRHguY29uZmlnWydtYXJrZG93bmVkaXRvci5jcm9wcGVyLnNob3dfZGVzY3JpcHRpb24nXSB8fCAwKTtcbiAgICBpZiAoc2hvd0Rlc2NyaXB0aW9uKSB7XG4gICAgICAgIGNvbmZpZy50cGwgPSBuZXcgRXh0LlhUZW1wbGF0ZSgnPHRwbCBmb3I9XCIuXCI+PGRpdiBjbGFzcz1cIngtY29tYm8tbGlzdC1pdGVtXCI+PHNwYW4gc3R5bGU9XCJmb250LXdlaWdodDogYm9sZFwiPntuYW1lfTwvc3Bhbj4nXG4gICAgICAgICAgICAsJzxiciAvPjx0cGwgaWY9XCJ3aWR0aFwiPlc6e3dpZHRofSA8L3RwbD48dHBsIGlmPVwiaGVpZ2h0XCI+SDp7aGVpZ2h0fSA8L3RwbD48dHBsIGlmPVwicmF0aW9cIj5SOntyYXRpb308L3RwbD48L2Rpdj48L3RwbD4nKTtcbiAgICB9XG5cbiAgICBtYXJrZG93bkVkaXRvci5jb21iby5Dcm9wcGVyUHJvZmlsZS5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcyxjb25maWcpO1xufTtcbkV4dC5leHRlbmQobWFya2Rvd25FZGl0b3IuY29tYm8uQ3JvcHBlclByb2ZpbGUsTU9EeC5jb21iby5Db21ib0JveCk7XG5FeHQucmVnKCdtYXJrZG93bmVkaXRvci1jb21iby1jcm9wcGVyLXByb2ZpbGUnLG1hcmtkb3duRWRpdG9yLmNvbWJvLkNyb3BwZXJQcm9maWxlKTsiLCJtYXJrZG93bkVkaXRvci53aW5kb3cuQ3JvcHBlciA9IGZ1bmN0aW9uKGNvbmZpZykge1xuICAgIGNvbmZpZyA9IGNvbmZpZyB8fCB7fTtcbiAgICBjb25maWcuY3JvcHBlclNlbGVjdG9yID0gY29uZmlnLmNyb3BwZXJTZWxlY3RvciB8fCAnLmltYWdlLXVwbG9hZC13cmFwcGVyID4gaW1nJztcblxuICAgIHZhciBpZCA9IEV4dC5pZCgpO1xuXG4gICAgRXh0LmFwcGx5SWYoY29uZmlnLHtcbiAgICAgICAgbW9kYWw6IGZhbHNlXG4gICAgICAgICxsYXlvdXQ6ICdhdXRvJ1xuICAgICAgICAsY2xvc2VBY3Rpb246ICdoaWRlJ1xuICAgICAgICAsc2hhZG93OiB0cnVlXG4gICAgICAgICxyZXNpemFibGU6IHRydWVcbiAgICAgICAgLGNvbGxhcHNpYmxlOiB0cnVlXG4gICAgICAgICxtYXhpbWl6YWJsZTogZmFsc2VcbiAgICAgICAgLGF1dG9IZWlnaHQ6IGZhbHNlXG4gICAgICAgICxhdXRvU2Nyb2xsOiB0cnVlXG4gICAgICAgICxhbGxvd0Ryb3A6IHRydWVcbiAgICAgICAgLHdpZHRoOiA4MDBcbiAgICAgICAgLG1vYmlsZTogMFxuICAgICAgICAsdGl0bGU6IF8oJ21hcmtkb3duZWRpdG9yLmNyb3BwZXIuY3JvcF9pbWFnZScpXG4gICAgICAgICxjbHM6ICdtb2R4LXdpbmRvdyBtYXJrZG93bmVkaXRvci1jcm9wcGVyLXdpbmRvdydcbiAgICAgICAgLGl0ZW1zOlt7XG4gICAgICAgICAgICBsYXlvdXQ6ICdjb2x1bW4nXG4gICAgICAgICAgICAsYm9yZGVyOiBmYWxzZVxuICAgICAgICAgICAgLGRlZmF1bHRzOiB7XG4gICAgICAgICAgICAgICAgbGF5b3V0OiAnZm9ybSdcbiAgICAgICAgICAgICAgICAsbGFiZWxBbGlnbjogJ3RvcCdcbiAgICAgICAgICAgICAgICAsbGFiZWxTZXBhcmF0b3I6ICcnXG4gICAgICAgICAgICAgICAgLGFuY2hvcjogJzEwMCUnXG4gICAgICAgICAgICAgICAgLGJvcmRlcjogZmFsc2VcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgICxpdGVtczogW3tcbiAgICAgICAgICAgICAgICBjb2x1bW5XaWR0aDogMC4xXG4gICAgICAgICAgICAgICAgLGRlZmF1bHRzOiB7XG4gICAgICAgICAgICAgICAgICAgIG1zZ1RhcmdldDogJ3VuZGVyJ1xuICAgICAgICAgICAgICAgICAgICAsYW5jaG9yOiAnMTAwJSdcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLGNsczogJ21hcmtkb3duZWRpdG9yLXRvb2xiYXInXG4gICAgICAgICAgICAgICAgLGl0ZW1zOiBbe1xuICAgICAgICAgICAgICAgICAgICB4dHlwZTogJ2J1dHRvbidcbiAgICAgICAgICAgICAgICAgICAgLHRleHQ6ICc8aSBjbGFzcz1cImljb24gaWNvbi1hcnJvd3MgaWNvbi1sYXJnZVwiPjwvaT4nXG4gICAgICAgICAgICAgICAgICAgICx0b29sdGlwOiBfKCdtYXJrZG93bmVkaXRvci5jcm9wcGVyLm1vdmUnKVxuICAgICAgICAgICAgICAgICAgICAsc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICAgICAgICAgLHBhcmFtOiAnbW92ZSdcbiAgICAgICAgICAgICAgICAgICAgLGFjdGlvbjogJ3NldERyYWdNb2RlJ1xuICAgICAgICAgICAgICAgICAgICAsaGFuZGxlcjogdGhpcy5jYWxsQ3JvcHBlckFjdGlvblxuICAgICAgICAgICAgICAgIH0se1xuICAgICAgICAgICAgICAgICAgICB4dHlwZTogJ2J1dHRvbidcbiAgICAgICAgICAgICAgICAgICAgLHRleHQ6ICc8aSBjbGFzcz1cImljb24gaWNvbi1jcm9wIGljb24tbGFyZ2VcIj48L2k+J1xuICAgICAgICAgICAgICAgICAgICAsdG9vbHRpcDogXygnbWFya2Rvd25lZGl0b3IuY3JvcHBlci5jcm9wJylcbiAgICAgICAgICAgICAgICAgICAgLHNjb3BlOiB0aGlzXG4gICAgICAgICAgICAgICAgICAgICxwYXJhbTogJ2Nyb3AnXG4gICAgICAgICAgICAgICAgICAgICxhY3Rpb246ICdzZXREcmFnTW9kZSdcbiAgICAgICAgICAgICAgICAgICAgLGhhbmRsZXI6IHRoaXMuY2FsbENyb3BwZXJBY3Rpb25cbiAgICAgICAgICAgICAgICB9LHtcbiAgICAgICAgICAgICAgICAgICAgeHR5cGU6ICdidXR0b24nXG4gICAgICAgICAgICAgICAgICAgICx0ZXh0OiAnPGkgY2xhc3M9XCJpY29uIGljb24tc2VhcmNoLXBsdXMgaWNvbi1sYXJnZVwiPjwvaT4nXG4gICAgICAgICAgICAgICAgICAgICx0b29sdGlwOiBfKCdtYXJrZG93bmVkaXRvci5jcm9wcGVyLnpvb21faW4nKVxuICAgICAgICAgICAgICAgICAgICAsc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICAgICAgICAgLHBhcmFtOiAwLjFcbiAgICAgICAgICAgICAgICAgICAgLGFjdGlvbjogJ3pvb20nXG4gICAgICAgICAgICAgICAgICAgICxoYW5kbGVyOiB0aGlzLmNhbGxDcm9wcGVyQWN0aW9uXG4gICAgICAgICAgICAgICAgfSx7XG4gICAgICAgICAgICAgICAgICAgIHh0eXBlOiAnYnV0dG9uJ1xuICAgICAgICAgICAgICAgICAgICAsdGV4dDogJzxpIGNsYXNzPVwiaWNvbiBpY29uLXNlYXJjaC1taW51cyBpY29uLWxhcmdlXCI+PC9pPidcbiAgICAgICAgICAgICAgICAgICAgLHRvb2x0aXA6IF8oJ21hcmtkb3duZWRpdG9yLmNyb3BwZXIuem9vbV9vdXQnKVxuICAgICAgICAgICAgICAgICAgICAsc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICAgICAgICAgLHBhcmFtOiAtMC4xXG4gICAgICAgICAgICAgICAgICAgICxhY3Rpb246ICd6b29tJ1xuICAgICAgICAgICAgICAgICAgICAsaGFuZGxlcjogdGhpcy5jYWxsQ3JvcHBlckFjdGlvblxuICAgICAgICAgICAgICAgIH0se1xuICAgICAgICAgICAgICAgICAgICB4dHlwZTogJ2J1dHRvbidcbiAgICAgICAgICAgICAgICAgICAgLHRleHQ6ICc8aSBjbGFzcz1cImljb24gaWNvbi1yb3RhdGUtbGVmdCBpY29uLWxhcmdlXCI+PC9pPidcbiAgICAgICAgICAgICAgICAgICAgLHRvb2x0aXA6IF8oJ21hcmtkb3duZWRpdG9yLmNyb3BwZXIucm90YXRlX2xlZnQnKVxuICAgICAgICAgICAgICAgICAgICAsc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICAgICAgICAgLHBhcmFtOiAtOTBcbiAgICAgICAgICAgICAgICAgICAgLGFjdGlvbjogJ3JvdGF0ZSdcbiAgICAgICAgICAgICAgICAgICAgLGhhbmRsZXI6IHRoaXMuY2FsbENyb3BwZXJBY3Rpb25cbiAgICAgICAgICAgICAgICB9LHtcbiAgICAgICAgICAgICAgICAgICAgeHR5cGU6ICdidXR0b24nXG4gICAgICAgICAgICAgICAgICAgICx0ZXh0OiAnPGkgY2xhc3M9XCJpY29uIGljb24tcm90YXRlLXJpZ2h0IGljb24tbGFyZ2VcIj48L2k+J1xuICAgICAgICAgICAgICAgICAgICAsdG9vbHRpcDogXygnbWFya2Rvd25lZGl0b3IuY3JvcHBlci5yb3RhdGVfcmlnaHQnKVxuICAgICAgICAgICAgICAgICAgICAsc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICAgICAgICAgLHBhcmFtOiA5MFxuICAgICAgICAgICAgICAgICAgICAsYWN0aW9uOiAncm90YXRlJ1xuICAgICAgICAgICAgICAgICAgICAsaGFuZGxlcjogdGhpcy5jYWxsQ3JvcHBlckFjdGlvblxuICAgICAgICAgICAgICAgIH0se1xuICAgICAgICAgICAgICAgICAgICB4dHlwZTogJ2J1dHRvbidcbiAgICAgICAgICAgICAgICAgICAgLHRleHQ6ICc8aSBjbGFzcz1cImljb24gaWNvbi1yZW1vdmUgaWNvbi1sYXJnZVwiPjwvaT4nXG4gICAgICAgICAgICAgICAgICAgICx0b29sdGlwOiBfKCdtYXJrZG93bmVkaXRvci5jcm9wcGVyLmNsZWFyX2Nyb3BwZXInKVxuICAgICAgICAgICAgICAgICAgICAsc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICAgICAgICAgLHBhcmFtOiBudWxsXG4gICAgICAgICAgICAgICAgICAgICxhY3Rpb246ICdjbGVhcidcbiAgICAgICAgICAgICAgICAgICAgLGhhbmRsZXI6IHRoaXMuY2FsbENyb3BwZXJBY3Rpb25cbiAgICAgICAgICAgICAgICB9XVxuICAgICAgICAgICAgfSx7XG4gICAgICAgICAgICAgICAgY29sdW1uV2lkdGg6IDAuOVxuICAgICAgICAgICAgICAgICxkZWZhdWx0czoge1xuICAgICAgICAgICAgICAgICAgICBtc2dUYXJnZXQ6ICd1bmRlcidcbiAgICAgICAgICAgICAgICAgICAgLGFuY2hvcjogJzEwMCUnXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICxjbHM6ICdtYXJrZG93bmVkaXRvci1jcm9wcGVyJ1xuICAgICAgICAgICAgICAgICxpdGVtczogW3tcbiAgICAgICAgICAgICAgICAgICAgaHRtbDogJzxkaXYgY2xhc3M9XCJpbWFnZS11cGxvYWQtd3JhcHBlclwiPjxpbWcgc3JjPVwiJyArIFVSTC5jcmVhdGVPYmplY3RVUkwoY29uZmlnLmZpbGUpICsgJ1wiPjwvZGl2PidcbiAgICAgICAgICAgICAgICB9XVxuICAgICAgICAgICAgfV1cbiAgICAgICAgfV1cbiAgICAgICAgLGJiYXI6IFt7XG4gICAgICAgICAgICB4dHlwZTogJ21hcmtkb3duZWRpdG9yLWNvbWJvLWNyb3BwZXItcHJvZmlsZSdcbiAgICAgICAgICAgICxpZDogaWQgKyAnLWNyb3BwZXItcHJvZmlsZSdcbiAgICAgICAgICAgICxsaXN0ZW5lcnM6IHtcbiAgICAgICAgICAgICAgICBzZWxlY3Q6IHtcbiAgICAgICAgICAgICAgICAgICAgZm46IGZ1bmN0aW9uKGNvbWJvLCB2YWx1ZSl7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYW5nZUNyb3BwZXJQcm9maWxlKHZhbHVlLmRhdGEpO1xuICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICBzY29wZTogdGhpc1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSwnLT4nLHtcbiAgICAgICAgICAgIHRleHQ6IF8oJ2NhbmNlbCcpXG4gICAgICAgICAgICAsc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICxoYW5kbGVyOiB0aGlzLmNsb3NlXG4gICAgICAgIH0se1xuICAgICAgICAgICAgdGV4dDogXygnbWFya2Rvd25lZGl0b3IuY3JvcHBlci51cGxvYWQnKVxuICAgICAgICAgICAgLGNsczogJ3ByaW1hcnktYnV0dG9uJ1xuICAgICAgICAgICAgLHNjb3BlOiB0aGlzXG4gICAgICAgICAgICAsY3JvcDogMFxuICAgICAgICAgICAgLGhhbmRsZXI6IHRoaXMudXBsb2FkXG4gICAgICAgIH0se1xuICAgICAgICAgICAgdGV4dDogXygnbWFya2Rvd25lZGl0b3IuY3JvcHBlci5jcm9wX3VwbG9hZCcpXG4gICAgICAgICAgICAsY2xzOiAncHJpbWFyeS1idXR0b24nXG4gICAgICAgICAgICAsc2NvcGU6IHRoaXNcbiAgICAgICAgICAgICxjcm9wOiAxXG4gICAgICAgICAgICAsaGFuZGxlcjogdGhpcy51cGxvYWRcbiAgICAgICAgfV1cbiAgICAgICAgLGxpc3RlbmVyczoge1xuICAgICAgICAgICAgJ3Nob3cnOiB7XG4gICAgICAgICAgICAgICAgZm46IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgICAgICB2YXIgY3JvcHBlck9wdGlvbnMgPSB7fTtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy4kY3JvcHBlckVsID0gJCgnIycgKyB0aGlzLmlkICsgJyAnICsgY29uZmlnLmNyb3BwZXJTZWxlY3Rvcik7XG5cbiAgICAgICAgICAgICAgICAgICAgY3JvcHBlck9wdGlvbnMuY3JvcCA9IGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmltYWdlRGF0YSA9IFtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAne1wieFwiOicgKyBkYXRhLngsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ1wieVwiOicgKyBkYXRhLnksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ1wiaGVpZ2h0XCI6JyArIGRhdGEuaGVpZ2h0LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICdcIndpZHRoXCI6JyArIGRhdGEud2lkdGgsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgJ1wicm90YXRlXCI6JyArIGRhdGEucm90YXRlICsgJ30nXG4gICAgICAgICAgICAgICAgICAgICAgICBdLmpvaW4oKTtcbiAgICAgICAgICAgICAgICAgICAgfS5iaW5kKHRoaXMpO1xuXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuJGNyb3BwZXJFbC5jcm9wcGVyKGNyb3BwZXJPcHRpb25zKTtcblxuICAgICAgICAgICAgICAgICAgICB2YXIgcHJvZmlsZSA9IEV4dC5nZXRDbXAoaWQgKyAnLWNyb3BwZXItcHJvZmlsZScpLnN0b3JlLmdldEF0KDApO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNoYW5nZUNyb3BwZXJQcm9maWxlKHByb2ZpbGUuZGF0YSk7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBzY29wZTogdGhpc1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSk7XG4gICAgbWFya2Rvd25FZGl0b3Iud2luZG93LkNyb3BwZXIuc3VwZXJjbGFzcy5jb25zdHJ1Y3Rvci5jYWxsKHRoaXMsY29uZmlnKTtcbiAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcblxufTtcbkV4dC5leHRlbmQobWFya2Rvd25FZGl0b3Iud2luZG93LkNyb3BwZXIsIEV4dC5XaW5kb3cse1xuICAgIGltYWdlRGF0YTogJydcbiAgICAsY3JvcHBlclByb2ZpbGU6IHtuYW1lOiAnJ31cblxuICAgICxjaGFuZ2VDcm9wcGVyUHJvZmlsZTogZnVuY3Rpb24ocHJvZmlsZSl7XG4gICAgICAgIHZhciByYXRpbztcblxuICAgICAgICBpZiAocHJvZmlsZS5yYXRpbyAhPSBcIlwiKSB7XG4gICAgICAgICAgICByYXRpbyA9IHByb2ZpbGUucmF0aW87XG4gICAgICAgICAgICByYXRpby5yZXBsYWNlKC9bXi06eCgpXFxkLyorLl0vZywgJycpO1xuICAgICAgICAgICAgcmF0aW8gPSBldmFsKHJhdGlvKSB8fCBOYU47XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAocHJvZmlsZS53aWR0aCAmJiBwcm9maWxlLmhlaWdodCkge1xuICAgICAgICAgICAgICAgIHZhciB3aWR0aCA9IHBhcnNlSW50KHByb2ZpbGUud2lkdGgpO1xuICAgICAgICAgICAgICAgIHZhciBoZWlnaHQgPSBwYXJzZUludChwcm9maWxlLmhlaWdodCk7XG4gICAgICAgICAgICAgICAgaWYgKHdpZHRoID4gMCAmJiBoZWlnaHQgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJhdGlvID0gd2lkdGggLyBoZWlnaHQ7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmF0aW8gPSBOYU47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByYXRpbyA9IE5hTjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY3JvcHBlclByb2ZpbGUgPSBwcm9maWxlO1xuXG4gICAgICAgIHRoaXMuY2FsbENyb3BwZXJBY3Rpb24oe2FjdGlvbjogJ3NldEFzcGVjdFJhdGlvJywgcGFyYW06IHJhdGlvfSk7XG4gICAgfVxuXG4gICAgLHVwbG9hZDogZnVuY3Rpb24oYnV0dG9uKSB7XG4gICAgICAgIHZhciB1cGxvYWRlciA9IHRoaXMuY29uZmlnLm1kLmNyZWF0ZVVwbG9hZGVyKCdpbWFnZScsIHRoaXMuY29uZmlnLmZpbGUubmFtZSk7XG5cbiAgICAgICAgdmFyIGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnZmlsZScsIHRoaXMuY29uZmlnLmZpbGUpO1xuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ2FjdGlvbicsICdtZ3IvZWRpdG9yL2ltYWdldXBsb2FkJyk7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgnaW1hZ2VEYXRhJywgdGhpcy5pbWFnZURhdGEpO1xuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ25hbWUnLCB0aGlzLmNvbmZpZy5maWxlLm5hbWUpO1xuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ2Nyb3AnLCBidXR0b24uY3JvcCk7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgncmVzb3VyY2UnLCB0aGlzLmNvbmZpZy5tZC5jb25maWcucmVzb3VyY2UpO1xuICAgICAgICBmb3JtRGF0YS5hcHBlbmQoJ21vYmlsZScsIHRoaXMuY29uZmlnLm1vYmlsZSk7XG4gICAgICAgIGZvcm1EYXRhLmFwcGVuZCgncHJvZmlsZScsIHRoaXMuY3JvcHBlclByb2ZpbGUubmFtZSk7XG5cbiAgICAgICAgdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgICAgICB4aHIub3BlbignUE9TVCcsIG1hcmtkb3duRWRpdG9yLmNvbmZpZy5jb25uZWN0b3JVcmwpO1xuICAgICAgICB4aHIuc2V0UmVxdWVzdEhlYWRlcignUG93ZXJlZC1CeScsICdNT0R4Jyk7XG4gICAgICAgIHhoci5zZXRSZXF1ZXN0SGVhZGVyKCdtb2RBdXRoJywgRXh0LkFqYXguZGVmYXVsdEhlYWRlcnMubW9kQXV0aCk7XG5cbiAgICAgICAgeGhyLnVwbG9hZC5vbnByb2dyZXNzID0gZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgICAgICBpZiAoZXZlbnQubGVuZ3RoQ29tcHV0YWJsZSkge1xuICAgICAgICAgICAgICAgIHZhciBjb21wbGV0ZSA9IChldmVudC5sb2FkZWQgLyBldmVudC50b3RhbCAqIDEwMCB8IDApO1xuICAgICAgICAgICAgICAgIHVwbG9hZGVyLmNoaWxkKCcucHJvZ3Jlc3MnKS5zZXRXaWR0aChjb21wbGV0ZSArICclJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0uYmluZCh0aGlzKTtcblxuICAgICAgICB4aHIub25sb2FkID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKHhoci5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgICAgICAgICAgIHZhciByZXMgPSBKU09OLnBhcnNlKHhoci5yZXNwb25zZVRleHQpO1xuXG4gICAgICAgICAgICAgICAgaWYgKHJlcy5zdWNjZXNzID09IHRydWUpIHtcbiAgICAgICAgICAgICAgICAgICAgdXBsb2FkZXIucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY29uZmlnLm1kLmVkaXRvci5pbnNlcnQoJyFbJyArIHJlcy5vYmplY3QubmFtZSArICddKCcgKyByZXMub2JqZWN0LnBhdGggKyAnIFwiJyArIHJlcy5vYmplY3QubmFtZSArICdcIilcXG5cXG4nKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZy5tZC5mYWlsVXBsb2FkZXIodXBsb2FkZXIsIHJlcy5tZXNzYWdlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0uYmluZCh0aGlzKTtcblxuICAgICAgICB4aHIuc2VuZChmb3JtRGF0YSk7XG5cbiAgICAgICAgdGhpcy5jbG9zZSgpO1xuICAgIH1cblxuICAgICxjYWxsQ3JvcHBlckFjdGlvbjogZnVuY3Rpb24oYnRuKSB7XG4gICAgICAgIHRoaXMuJGNyb3BwZXJFbC5jcm9wcGVyKGJ0bi5hY3Rpb24sIGJ0bi5wYXJhbSk7XG4gICAgfVxuXG4gICAgLGNsb3NlOiBmdW5jdGlvbigpIHtcbiAgICAgICAgdGhpcy4kY3JvcHBlckVsLmNyb3BwZXIoXCJkZXN0cm95XCIpO1xuXG4gICAgICAgIG1hcmtkb3duRWRpdG9yLndpbmRvdy5Dcm9wcGVyLnN1cGVyY2xhc3MuY2xvc2UuY2FsbCh0aGlzKTtcbiAgICAgICAgdGhpcy5jb25maWcubWQuZWRpdG9yLmZvY3VzKCk7XG4gICAgfVxufSk7XG5FeHQucmVnKCdtYXJrZG93bmVkaXRvci13aW5kb3ctY3JvcHBlcicsbWFya2Rvd25FZGl0b3Iud2luZG93LkNyb3BwZXIpO1xuIiwibWFya2Rvd25FZGl0b3Iud2luZG93Lk9FbWJlZCA9IGZ1bmN0aW9uKGNvbmZpZykge1xuICAgIGNvbmZpZyA9IGNvbmZpZyB8fCB7fTtcbiAgICBFeHQuYXBwbHlJZihjb25maWcse1xuICAgICAgICB0aXRsZTogXygnbWFya2Rvd25lZGl0b3Iub2VtYmVkLmVtYmVkX3VybCcpXG4gICAgICAgICxjbG9zZUFjdGlvbjogJ2Nsb3NlJ1xuICAgICAgICAscmVzaXphYmxlOiBmYWxzZVxuICAgICAgICAsY29sbGFwc2libGU6IGZhbHNlXG4gICAgICAgICxtYXhpbWl6YWJsZTogZmFsc2VcbiAgICAgICAgLGhlaWdodDogMTg1XG4gICAgICAgICxtb2RhbDogdHJ1ZVxuICAgICAgICAsZmllbGRzOiB0aGlzLmdldEZpZWxkcyhjb25maWcpXG4gICAgfSk7XG4gICAgbWFya2Rvd25FZGl0b3Iud2luZG93Lk9FbWJlZC5zdXBlcmNsYXNzLmNvbnN0cnVjdG9yLmNhbGwodGhpcyxjb25maWcpO1xufTtcbkV4dC5leHRlbmQobWFya2Rvd25FZGl0b3Iud2luZG93Lk9FbWJlZCxNT0R4LldpbmRvdywge1xuICAgIGdldEZpZWxkczogZnVuY3Rpb24oY29uZmlnKSB7XG4gICAgICAgIHJldHVybiBbe1xuICAgICAgICAgICAgeHR5cGU6ICd0ZXh0ZmllbGQnXG4gICAgICAgICAgICAsbmFtZTogJ3VybCdcbiAgICAgICAgICAgICxmaWVsZExhYmVsOiBfKCdtYXJrZG93bmVkaXRvci5vZW1iZWQudXJsJylcbiAgICAgICAgICAgICxhbGxvd0JsYW5rOiBmYWxzZVxuICAgICAgICAgICAgLGFuY2hvcjogJzEwMCUnXG4gICAgICAgICAgICAsdnR5cGU6ICd1cmwnXG4gICAgICAgIH1dO1xuICAgIH1cblxuICAgICxzdWJtaXQ6IGZ1bmN0aW9uKCl7XG4gICAgICAgIHZhciBmID0gdGhpcy5mcC5nZXRGb3JtKCk7XG5cbiAgICAgICAgaWYgKGYuaXNWYWxpZCgpKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5jb25maWcuc3VjY2Vzcykge1xuICAgICAgICAgICAgICAgIEV4dC5jYWxsYmFjayh0aGlzLmNvbmZpZy5zdWNjZXNzLHRoaXMuY29uZmlnLnNjb3BlIHx8IHRoaXMsW2YuZ2V0VmFsdWVzKCldKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5jbG9zZSgpO1xuICAgICAgICB9XG4gICAgfVxufSk7XG5FeHQucmVnKCdtYXJrZG93bmVkaXRvci13aW5kb3ctb2VtYmVkJyxtYXJrZG93bkVkaXRvci53aW5kb3cuT0VtYmVkKTsiXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=